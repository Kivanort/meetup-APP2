<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Карта друзей — MeetUP</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="userSystem.js"></script>
  <script src="chatSystem.js"></script>
  <script src="pedometer.js"></script>
  <script src="notifications.js"></script>
  <link rel="icon" href="meetup-logo.png" type="image/x-icon">  
  <style>
    :root {
      --main-bg: #0B1222;
      --container: #181F31;
      --primary: #2CB4FF;
      --primary-gradient: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      --meetup-orange: linear-gradient(135deg, #FFA500 0%, #FF6B6B 100%); /* Оранжевый градиент для встреч */
      --meetup-green: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%); /* Зеленый градиент для публичных встреч */
      --meetup-blue: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%); /* Синий градиент для друзей онлайн */
      --route-color: #34eb89; /* Цвет маршрутов */
      --neon-glow: #00FFFF;
      --text-light: #fff;
      --text-muted: #9FAFD4;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--main-bg);
      color: var(--text-light);
      overflow: hidden;
    }
    #app-root {
      height: 100vh;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }
    .app-header { background: var(--container); box-shadow: 0 2px 20px rgba(0,0,0,0.3); position: relative; z-index: 10; flex-shrink: 0;}
    .header-content { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px;}
    .logo-title { display: flex; align-items: center; gap: 12px;}
    .app-logo { font-size: 24px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .app-subtitle { color: var(--text-muted); font-size: 14px; }
    .header-actions { display: flex; gap: 10px; }
    .profile-btn { width: 50px; height: 50px; border: none; border-radius: 50%; background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
    .profile-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.6);}
    .profile-btn:active { transform: scale(0.95); box-shadow: 0 0 30px rgba(0,255,255,0.8);}
    .map-container { flex: 1; position: relative; overflow: hidden; }
    #map { width: 100%; height: 100%; background: #131827; }
    .map-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #131827; color: var(--text-muted); gap: 15px; position: absolute; top: 0; left: 0; z-index: 20;}
    .map-placeholder.hidden { display: none;}
    .floating-buttons { 
      position: absolute; 
      bottom: 20px; 
      left: 0; 
      right: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 15px; 
      padding: 0 20px; 
      z-index: 100;
    }
    .fab-primary { padding: 16px 20px; background: var(--primary-gradient); border: none; border-radius: 16px; color: white; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 20px rgba(44,180,255,0.4); transition: all 0.2s ease; min-height: 54px; white-space: nowrap;}
    .fab-primary:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(44,180,255,0.6);}
    .fab-primary:active { transform: scale(0.95);}
    .fab-orange { padding: 16px 20px; background: var(--meetup-orange); border: none; border-radius: 16px; color: white; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 20px rgba(255,165,0,0.4); transition: all 0.2s ease; min-height: 54px; white-space: nowrap;}
    .fab-orange:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(255,165,0,0.6);}
    .fab-orange:active { transform: scale(0.95);}
    .fab-secondary { width: 54px; height: 54px; border: none; border-radius: 50%; background: var(--container); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s ease;}
    .fab-secondary:hover { transform: scale(1.05); background: var(--primary); color: white;}
    .fab-secondary:active { transform: scale(0.95);}
    .temp-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 20px; border-radius: 12px; font-size: 14px; z-index: 1000; backdrop-filter: blur(10px); text-align: center; max-width: 80%;}
    .map-controls { position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
    .map-filter-btn { width: 54px; height: 54px; border-radius: 50%; background: var(--container); border: 2px solid var(--primary); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    .map-filter-btn:hover { background: var(--primary); color: white; transform: scale(1.1);}
    .map-filter-btn.active { background: var(--primary); color: white;}
    .filter-panel { position: absolute; top: 70px; right: 20px; background: var(--container); border-radius: 12px; padding: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 99; display: none; min-width: 200px;}
    .filter-panel.active { display: block; animation: slideIn 0.3s ease;}
    @keyframes slideIn {from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);}}
    .filter-option { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: var(--text-light); font-size: 14px; cursor: pointer;}
    .filter-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary);}
    .nearby-notification { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 8px 24px rgba(44,180,255,0.3); z-index: 1000; display: flex; align-items: center; gap: 10px; animation: slideUp 0.5s ease; max-width: 90%;}
    @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(30px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .auto-update-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); color: #34eb89; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; z-index: 100; backdrop-filter: blur(10px);}
    .notification-badge { position: absolute; top: -5px; right: -5px; background: #FF4444; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    /* Панель отображения */
    .display-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 220px;
    }
    .display-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    /* Окно чатов */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .chat-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .chat-container {
      width: 90%;
      max-width: 400px;
      height: 80%;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }
    .chat-close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .chat-item {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    .chat-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2a2a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    .chat-friend-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    .chat-last-message {
      font-size: 14px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }
    .chat-unread {
      background: var(--primary);
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 14px;
    }
    
    /* Окно шагомера */
    .pedometer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .pedometer-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .pedometer-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .pedometer-header {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      padding: 25px;
      text-align: center;
    }
    .pedometer-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    .pedometer-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .pedometer-content {
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .pedometer-stats {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .pedometer-stat {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #34eb89;
    }
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    .stat-subvalue {
      font-size: 16px;
      color: #2CB4FF;
      margin-top: 5px;
    }
    .pedometer-goal {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
    }
    .goal-title {
      font-size: 16px;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }
    .goal-progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34eb89, #08e7bd);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    .goal-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }
    .pedometer-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .pedometer-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-start {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      color: white;
    }
    .btn-simulate {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      color: white;
    }
    .btn-close {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .pedometer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .pedometer-not-supported {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .pedometer-not-supported .material-icons {
      font-size: 60px;
      color: #FF4444;
      margin-bottom: 20px;
    }
    
    /* Кнопка фильтров справа вверху */
    .map-controls-top {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Фильтр и обновление теперь сверху слева */
    .map-filter-btn-left {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid var(--primary);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .map-filter-btn-left:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    /* Стиль для метки призрака на карте */
    .ghost-marker {
      filter: grayscale(100%) brightness(150%);
    }
    
    /* Окно создания встречи */
    .meetup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .meetup-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .meetup-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .meetup-header {
      background: var(--meetup-orange);
      padding: 25px;
      text-align: center;
    }
    .meetup-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    .meetup-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .meetup-content {
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .meetup-form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meetup-label {
      font-size: 14px;
      color: var(--text-muted);
      font-weight: 500;
    }
    .meetup-input, .meetup-textarea, .meetup-select {
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .meetup-input:focus, .meetup-textarea:focus, .meetup-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(44,180,255,0.2);
    }
    .meetup-textarea {
      min-height: 100px;
      resize: vertical;
    }
    .meetup-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 5px;
    }
    .meetup-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }
    .meetup-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    .meetup-checkbox span {
      font-size: 14px;
      color: var(--text-light);
    }
    .meetup-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .meetup-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-create {
      background: var(--meetup-orange);
      color: white;
    }
    .btn-cancel {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .meetup-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    /* Новые стили для выбора типа встречи */
    .meetup-type-selector {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .meetup-type-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .meetup-type-option:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    
    .meetup-type-option.active {
      border-color: var(--primary);
      background: rgba(44,180,255,0.1);
    }
    
    .meetup-type-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }
    
    .meetup-type-info {
      flex: 1;
    }
    
    .meetup-type-title {
      font-weight: 600;
      color: white;
      margin-bottom: 3px;
    }
    
    .meetup-type-desc {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Стили для статуса друзей */
    .friend-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-left: 8px;
      font-size: 12px;
    }
    
    .online-status {
      color: #34eb89;
    }
    
    .offline-status {
      color: var(--text-muted);
    }
    
    .friends-invite-section {
      background: rgba(255,255,255,0.03);
      border-radius: 10px;
      padding: 15px;
      margin-top: 10px;
    }
    
    .invite-methods {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .invite-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: rgba(44,180,255,0.2);
      color: var(--primary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .invite-btn:hover {
      background: rgba(44,180,255,0.3);
      transform: translateY(-2px);
    }
    
    .invite-btn.chat {
      background: rgba(52,235,137,0.2);
      color: #34eb89;
    }
    
    .invite-btn.chat:hover {
      background: rgba(52,235,137,0.3);
    }
    
    /* Стили для маршрутов */
    .route-controls {
      position: absolute;
      bottom: 100px;
      left: 20px;
      z-index: 99;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .route-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid var(--route-color);
      color: var(--route-color);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .route-btn:hover {
      background: var(--route-color);
      color: white;
      transform: scale(1.1);
    }
    
    .route-btn.active {
      background: var(--route-color);
      color: white;
    }
    
    .route-info-panel {
      position: absolute;
      bottom: 170px;
      left: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 98;
      display: none;
      min-width: 250px;
      max-width: 300px;
    }
    
    .route-info-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    .route-info-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .route-info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .route-info-label {
      color: var(--text-muted);
    }
    
    .route-info-value {
      color: var(--route-color);
      font-weight: 500;
    }
    
    .route-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .route-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: rgba(52,235,137,0.2);
      color: var(--route-color);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .route-action-btn:hover {
      background: rgba(52,235,137,0.3);
      transform: translateY(-2px);
    }
    
    .route-action-btn.share {
      background: rgba(44,180,255,0.2);
      color: var(--primary);
    }
    
    .route-action-btn.share:hover {
      background: rgba(44,180,255,0.3);
    }
    
    .friend-routes-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .friend-routes-toggle label {
      font-size: 14px;
      color: var(--text-light);
      cursor: pointer;
    }
    
    /* НОВЫЕ СТИЛИ ДЛЯ МАРКЕРОВ И КАРТОЧЕК ПОЛЬЗОВАТЕЛЕЙ */
    
    /* Окно выбора типа маршрута */
    .route-type-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .route-type-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .route-type-container {
      width: 90%;
      max-width: 400px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    
    .route-type-header {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      padding: 20px;
      text-align: center;
    }
    
    .route-type-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    
    .route-type-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    
    .route-type-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .route-type-option {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border: 2px solid transparent;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .route-type-option:hover {
      background: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }
    
    .route-type-option.active {
      border-color: var(--route-color);
      background: rgba(52,235,137,0.1);
    }
    
    .route-type-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }
    
    .route-type-info {
      flex: 1;
    }
    
    .route-type-name {
      font-weight: 600;
      color: white;
      margin-bottom: 3px;
    }
    
    .route-type-desc {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .route-type-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      padding: 0 20px 20px 20px;
    }
    
    .route-type-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-build-route {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      color: white;
    }
    
    .route-type-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    /* Карточка пользователя */
    .user-card {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--container);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      width: 90%;
      max-width: 400px;
      animation: slideUpCard 0.3s ease;
    }
    
    @keyframes slideUpCard {
      from { opacity: 0; transform: translateX(-50%) translateY(50px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    
    .user-card.active {
      display: block;
    }
    
    .user-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .user-card-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }
    
    .user-card-info {
      flex: 1;
      min-width: 0;
    }
    
    .user-card-name {
      font-size: 18px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    
    .user-card-status {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .user-card-details {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    .user-card-actions {
      display: flex;
      gap: 10px;
    }
    
    .user-card-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-chat {
      background: rgba(44,180,255,0.2);
      color: var(--primary);
    }
    
    .btn-route {
      background: rgba(52,235,137,0.2);
      color: var(--route-color);
    }
    
    .btn-profile {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .user-card-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .user-card-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .user-card-close:hover {
      background: rgba(255,255,255,0.2);
      transform: rotate(90deg);
    }
    
    /* Кнопка маршрута в балуне */
    .route-btn-small {
      padding: 8px 16px;
      background: var(--route-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .route-btn-small:hover {
      background: #2BD489;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(52,235,137,0.3);
    }
    
    /* НОВЫЕ СТИЛИ ДЛЯ ВЫЕЗЖАЮЩЕГО МЕНЮ */
    .balloon-menu {
      position: fixed;
      bottom: -120px;
      left: 0;
      right: 0;
      background: var(--container);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      box-shadow: 0 -5px 30px rgba(0,0,0,0.5);
      z-index: 1001;
      transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      transform: translateY(100%);
      max-width: 500px;
      margin: 0 auto;
    }
    
    .balloon-menu.active {
      transform: translateY(-120px);
      bottom: 0;
    }
    
    .balloon-menu-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .balloon-menu-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
    }
    
    .balloon-menu-close {
      background: rgba(255,255,255,0.1);
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .balloon-menu-close:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .balloon-menu-content {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .balloon-menu-icon {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .balloon-menu-info {
      flex: 1;
      min-width: 0;
    }
    
    .balloon-menu-user-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    
    .balloon-menu-distance {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .balloon-menu-distance-value {
      color: var(--route-color);
      font-weight: 600;
    }
    
    .balloon-menu-route-btn {
      padding: 12px 20px;
      background: var(--route-color);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }
    
    .balloon-menu-route-btn:hover {
      background: #2BD489;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52,235,137,0.3);
    }
    
    .balloon-menu-route-btn:active {
      transform: translateY(0);
    }
    
    .balloon-menu-swipe-handle {
      width: 40px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    @media (max-width: 768px) {
      .header-content {padding: 12px 15px;}
      .app-logo {font-size: 20px;}
      .app-subtitle {font-size: 13px;}
      .profile-btn {width: 45px; height: 45px;}
      .fab-primary, .fab-orange {padding: 14px 18px; font-size: 14px; min-height: 50px; border-radius: 14px;}
      .fab-secondary {width: 50px; height: 50px;}
      .floating-buttons {bottom: 15px; padding: 0 15px; gap: 12px;}
      .map-controls {top: 15px; right: 15px;}
      .map-filter-btn {width: 50px; height: 50px;}
      .map-controls-top {top: 15px; left: 15px;}
      .map-filter-btn-left {width: 50px; height: 50px;}
      .filter-panel {top: 60px; right: 15px; min-width: 180px;}
      .display-panel {top: 60px; right: 15px; min-width: 180px;}
      .meetup-content {padding: 20px;}
      .invite-methods {flex-direction: column;}
      .route-controls {bottom: 90px; left: 15px;}
      .route-btn {width: 50px; height: 50px;}
      .route-info-panel {bottom: 150px; left: 15px; min-width: 200px; max-width: 250px;}
      .user-card {padding: 15px;}
      .user-card-avatar {width: 50px; height: 50px;}
      .user-card-name {font-size: 16px;}
      .user-card-actions {flex-direction: column;}
      .balloon-menu {padding: 15px; max-width: 100%;}
      .balloon-menu-content {gap: 12px;}
      .balloon-menu-icon {width: 45px; height: 45px; font-size: 20px;}
      .balloon-menu-route-btn {padding: 10px 15px; font-size: 13px;}
    }
    
    @media (max-width: 480px) {
      .header-content {padding: 10px 12px;}
      .logo-title {gap: 8px;}
      .app-logo {font-size: 18px;}
      .app-subtitle {display: none;}
      .profile-btn {width: 42px; height: 42px;}
      .profile-btn .material-icons {font-size: 20px;}
      .fab-primary span:last-child, .fab-orange span:last-child {display: none;}
      .fab-primary, .fab-orange {padding: 12px 15px; min-height: 48px; border-radius: 12px;}
      .fab-secondary {width: 48px; height: 48px;}
      .floating-buttons {bottom: 12px; padding: 0 12px;}
      .map-controls {top: 10px; right: 10px;}
      .map-filter-btn {width: 45px; height: 45px;}
      .map-controls-top {top: 10px; left: 10px;}
      .map-filter-btn-left {width: 45px; height: 45px;}
      .pedometer-content {padding: 20px;}
      .stat-value {font-size: 28px;}
      .meetup-actions {flex-direction: column;}
      .route-controls {bottom: 80px; left: 10px;}
      .route-btn {width: 45px; height: 45px;}
      .route-info-panel {bottom: 135px; left: 10px; min-width: 180px; max-width: 220px;}
      .route-actions {flex-direction: column;}
      .route-type-content {padding: 15px;}
      .route-type-option {padding: 12px;}
      .user-card {padding: 12px; border-radius: 12px;}
      .balloon-menu {padding: 12px;}
      .balloon-menu-content {flex-direction: column; text-align: center;}
      .balloon-menu-info {text-align: center;}
      .balloon-menu-route-btn {width: 100%;}
    }
  </style>
</head>
<body>
  <div id="app-root">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-title">
          <div class="app-logo">meetup</div>
          <div class="app-subtitle">Карта друзей</div>
        </div>
        <div class="header-actions">
          <button class="profile-btn" id="btn-profile" title="Профиль">
            <span class="material-icons">person</span>
            <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
          </button>
        </div>
      </div>
    </header>
    <div class="map-container">
      <div id="map"></div>
      <div class="map-placeholder" id="map-placeholder">
        <span class="material-icons" style="font-size: 64px; opacity: 0.5;">map</span>
        <div>Загрузка карты...</div>
      </div>
      
      <!-- Контролы карты справа -->
      <div class="map-controls">
        <button class="map-filter-btn" id="btn-chat" title="Чаты с друзьями">
          <span class="material-icons">chat</span>
          <div class="notification-badge" id="chat-notification-badge" style="display: none;">0</div>
        </button>
        
        <button class="map-filter-btn" id="btn-pedometer" title="Шагомер">
          <span class="material-icons">directions_walk</span>
        </button>
        
        <button class="map-filter-btn" id="btn-incognito" title="Режим инкогнито">
          <span class="material-icons" id="incognito-icon">visibility_off</span>
        </button>
        
        <button class="map-filter-btn" id="btn-display-mode" title="Отображение пользователей">
          <span class="material-icons">people</span>
        </button>
      </div>
      
      <!-- Контролы для маршрутов -->
      <div class="route-controls">
        <button class="route-btn" id="btn-show-routes" title="Показать маршруты друзей">
          <span class="material-icons">route</span>
        </button>
        <button class="route-btn" id="btn-clear-route" title="Очистить маршрут" style="display: none;">
          <span class="material-icons">clear</span>
        </button>
      </div>
      
      <!-- Панель информации о маршруте -->
      <div class="route-info-panel" id="route-info-panel">
        <div class="route-info-title">
          <span class="material-icons">route</span>
          <span>Информация о маршруте</span>
        </div>
        <div class="route-info-item">
          <span class="route-info-label">Куда:</span>
          <span class="route-info-value" id="route-to">-</span>
        </div>
        <div class="route-info-item">
          <span class="route-info-label">Расстояние:</span>
          <span class="route-info-value" id="route-distance">-</span>
        </div>
        <div class="route-info-item">
          <span class="route-info-label">Время:</span>
          <span class="route-info-value" id="route-time">-</span>
        </div>
        <div class="friend-routes-toggle">
          <input type="checkbox" id="show-friend-routes" checked>
          <label for="show-friend-routes">Показывать маршруты друзей</label>
        </div>
        <div class="route-actions">
          <button class="route-action-btn share" id="btn-share-route">
            <span class="material-icons">share</span>
            Поделиться
          </button>
          <button class="route-action-btn" id="btn-close-route-info">
            <span class="material-icons">close</span>
            Закрыть
          </button>
        </div>
      </div>
      
      <!-- Панель фильтров -->
      <div class="filter-panel" id="filter-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">Фильтры карты</h4>
        <label class="filter-option">
          <input type="checkbox" id="filter-friends" checked>
          <span>Друзья</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-online" checked>
          <span>Только онлайн</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-nearby" checked>
          <span>Рядом со мной</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-new" checked>
          <span>Новые пользователи</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            Радиус поиска: <span id="radius-value">5</span> км
          </label>
          <input type="range" id="radius-slider" min="1" max="50" value="5" style="width: 100%;">
        </div>
      </div>
      
      <!-- Панель отображения -->
      <div class="display-panel" id="display-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">Отображение пользователей</h4>
        <label class="filter-option">
          <input type="checkbox" id="display-all" checked>
          <span>Все пользователи</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-friends" checked>
          <span>Только друзья</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-online" checked>
          <span>Только онлайн</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-new" checked>
          <span>Новые пользователи</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            Маркеры друзей: <span id="friend-marker-style">синий</span>
          </label>
          <select id="friend-marker-select" style="width: 100%; padding: 8px; border-radius: 6px; background: var(--container); color: white; border: 1px solid var(--primary);">
            <option value="blue">Синий</option>
            <option value="green">Зеленый</option>
            <option value="red">Красный</option>
            <option value="purple">Фиолетовый</option>
            <option value="gold">Золотой</option>
          </select>
        </div>
      </div>
      
      <!-- Основные плавающие кнопки -->
      <div class="floating-buttons">
        <button class="fab-secondary" id="btn-locate" title="Мое местоположение">
          <span class="material-icons">navigation</span>
        </button>
        <button class="fab-orange" id="btn-create-meetup">
          <span class="material-icons">event</span>
          <span>Создать встречу</span>
        </button>
        <button class="fab-secondary" id="btn-add-friend" title="Добавить друга">
          <span class="material-icons">person_add</span>
        </button>
      </div>
      
      <!-- Карточка пользователя (появляется при клике на маркер) -->
      <div class="user-card" id="user-card">
        <button class="user-card-close" id="user-card-close">
          <span class="material-icons">close</span>
        </button>
        <div class="user-card-header">
          <div class="user-card-avatar" id="user-card-avatar">
            <!-- Инициалы будут вставлены через JS -->
          </div>
          <div class="user-card-info">
            <div class="user-card-name" id="user-card-name"></div>
            <div class="user-card-status" id="user-card-status">
              <!-- Статус будет вставлен через JS -->
            </div>
          </div>
        </div>
        <div class="user-card-details" id="user-card-details">
          <!-- Описание будет вставлено через JS -->
        </div>
        <div class="user-card-actions">
          <button class="user-card-btn btn-chat" id="user-card-chat-btn">
            <span class="material-icons">chat</span>
            Написать
          </button>
          <button class="user-card-btn btn-route" id="user-card-route-btn">
            <span class="material-icons">directions</span>
            Маршрут
          </button>
          <button class="user-card-btn btn-profile" id="user-card-profile-btn">
            <span class="material-icons">person</span>
            Профиль
          </button>
        </div>
      </div>
      
      <!-- Выезжающее меню при нажатии на балун -->
      <div class="balloon-menu" id="balloon-menu">
        <div class="balloon-menu-swipe-handle"></div>
        <div class="balloon-menu-header">
          <div class="balloon-menu-title">Быстрые действия</div>
          <button class="balloon-menu-close" id="balloon-menu-close">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="balloon-menu-content">
          <div class="balloon-menu-icon">
            <span class="material-icons">chat</span>
          </div>
          <div class="balloon-menu-info">
            <div class="balloon-menu-user-name" id="balloon-menu-user-name">Иван Иванов</div>
            <div class="balloon-menu-distance">
              <span class="material-icons">straight</span>
              <span class="balloon-menu-distance-value" id="balloon-menu-distance-value">850 м</span>
              <span>от вас</span>
            </div>
          </div>
          <button class="balloon-menu-route-btn" id="balloon-menu-route-btn">
            <span class="material-icons">directions</span>
            Маршрут
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Индикатор автообновления -->
  <div class="auto-update-indicator" id="auto-update-indicator" style="display: none;">
    <span class="material-icons" style="font-size: 16px;">autorenew</span>
    <span>Автообновление: <span id="update-timer">30</span>с</span>
  </div>
  
  <!-- Окно выбора типа маршрута -->
  <div class="route-type-overlay" id="route-type-overlay">
    <div class="route-type-container">
      <div class="route-type-header">
        <div class="route-type-title">Построить маршрут</div>
        <div class="route-type-subtitle">Выберите тип маршрута</div>
      </div>
      <div class="route-type-content" id="route-type-content">
        <!-- Варианты маршрутов будут добавлены через JS -->
      </div>
      <div class="route-type-actions">
        <button class="route-type-btn" id="route-type-cancel-btn">
          <span class="material-icons">close</span>
          Отмена
        </button>
        <button class="route-type-btn btn-build-route" id="route-type-build-btn">
          <span class="material-icons">check</span>
          Построить
        </button>
      </div>
    </div>
  </div>
  
  <!-- Окно чатов -->
  <div class="chat-overlay" id="chat-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">Чаты с друзьями</div>
        <button class="chat-close-btn" id="chat-close-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="chat-list" id="chat-list">
        <div class="chat-empty">Загрузка чатов...</div>
      </div>
    </div>
  </div>
  
  <!-- Окно шагомера -->
  <div class="pedometer-overlay" id="pedometer-overlay">
    <div class="pedometer-container">
      <div class="pedometer-header">
        <div class="pedometer-title">Шагомер</div>
        <div class="pedometer-subtitle">Отслеживайте вашу активность</div>
      </div>
      <div class="pedometer-content" id="pedometer-content">
        <!-- Контент шагомера будет загружен динамически -->
      </div>
      <div class="pedometer-actions" style="padding: 0 30px 30px 30px;">
        <button class="pedometer-btn btn-close" id="pedometer-close-btn">
          <span class="material-icons">close</span>
          Закрыть
        </button>
      </div>
    </div>
  </div>
  
  <!-- Окно создания встречи -->
  <div class="meetup-overlay" id="meetup-overlay">
    <div class="meetup-container">
      <div class="meetup-header">
        <div class="meetup-title">Создание встречи</div>
        <div class="meetup-subtitle">Пригласите друзей на мероприятие</div>
      </div>
      <div class="meetup-content">
        <div class="meetup-form-group">
          <label class="meetup-label">Название встречи</label>
          <input type="text" class="meetup-input" id="meetup-title" placeholder="Например: Кофе в центре" maxlength="50">
        </div>
        
        <div class="meetup-form-group">
          <label class="meetup-label">Описание</label>
          <textarea class="meetup-textarea" id="meetup-description" placeholder="Опишите детали встречи..."></textarea>
        </div>
        
        <div class="meetup-form-group">
          <label class="meetup-label">Местоположение</label>
          <input type="text" class="meetup-input" id="meetup-location" placeholder="Выберите место на карте или введите адрес">
        </div>
        
        <div class="meetup-form-group">
          <label class="meetup-label">Дата и время</label>
          <input type="datetime-local" class="meetup-input" id="meetup-datetime">
        </div>
        
        <!-- Выбор типа встречи -->
        <div class="meetup-form-group">
          <label class="meetup-label">Тип встречи</label>
          <div class="meetup-type-selector" id="meetup-type-selector">
            <div class="meetup-type-option" data-type="private">
              <div class="meetup-type-icon" style="background: var(--meetup-orange);">
                <span class="material-icons">lock</span>
              </div>
              <div class="meetup-type-info">
                <div class="meetup-type-title">Приватная</div>
                <div class="meetup-type-desc">Только для выбранных друзей</div>
              </div>
            </div>
            
            <div class="meetup-type-option" data-type="public">
              <div class="meetup-type-icon" style="background: var(--meetup-green);">
                <span class="material-icons">public</span>
              </div>
              <div class="meetup-type-info">
                <div class="meetup-type-title">Публичная</div>
                <div class="meetup-type-desc">Видна всем пользователям на карте</div>
              </div>
            </div>
            
            <div class="meetup-type-option" data-type="friends_online">
              <div class="meetup-type-icon" style="background: var(--meetup-blue);">
                <span class="material-icons">group</span>
              </div>
              <div class="meetup-type-info">
                <div class="meetup-type-title">Для друзей онлайн</div>
                <div class="meetup-type-desc">Все друзья в сети автоматически приглашаются</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Приглашение друзей -->
        <div class="meetup-form-group" id="friends-invite-section">
          <label class="meetup-label">Пригласить друзей</label>
          <div class="friends-invite-section">
            <div class="meetup-checkbox-group" id="friends-list">
              <!-- Список друзей будет загружен динамически -->
            </div>
            
            <!-- Кнопки для приглашения -->
            <div class="invite-methods" id="invite-methods" style="display: none;">
              <button class="invite-btn" id="invite-selected-btn">
                <span class="material-icons">send</span>
                Пригласить выбранных
              </button>
              <button class="invite-btn chat" id="invite-chat-btn">
                <span class="material-icons">chat</span>
                Отправить в чаты
              </button>
              <button class="invite-btn" id="select-all-friends-btn">
                <span class="material-icons">check_circle</span>
                Выбрать всех
              </button>
            </div>
          </div>
        </div>
        
        <div class="meetup-actions">
          <button class="meetup-btn btn-cancel" id="meetup-cancel-btn">
            <span class="material-icons">close</span>
            Отмена
          </button>
          <button class="meetup-btn btn-create" id="meetup-create-btn">
            <span class="material-icons">check</span>
            Создать встречу
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ============================================
    // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
    // ============================================
    
    function showTempMessage(message, duration = 3000) {
      const existingMessage = document.querySelector('.temp-message');
      if (existingMessage) existingMessage.remove();
      const messageEl = document.createElement('div');
      messageEl.className = 'temp-message';
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      setTimeout(() => { if (messageEl.parentNode) messageEl.remove(); }, duration);
    }
    
    let isMapsApiLoading = false;
    let mapsApiLoadCallbacks = [];
    
    function loadYandexMapsAPI() {
      return new Promise((resolve, reject) => {
        if (typeof ymaps !== 'undefined') { resolve(ymaps); return; }
        if (isMapsApiLoading) { mapsApiLoadCallbacks.push({ resolve, reject }); return; }
        isMapsApiLoading = true;
        const script = document.createElement('script');
        script.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=ваш_ключ_апи_здесь';
        script.async = true;
        script.onload = () => {
          if (typeof ymaps !== 'undefined' && ymaps.ready) {
            ymaps.ready(() => {
              isMapsApiLoading = false;
              resolve(ymaps);
              mapsApiLoadCallbacks.forEach(cb => cb.resolve(ymaps));
              mapsApiLoadCallbacks = [];
            });
          } else {
            reject(new Error('Yandex Maps API загружен, но не готов'));
          }
        };
        script.onerror = () => {
          isMapsApiLoading = false;
          const error = new Error('Не удалось загрузить Яндекс Карты');
          reject(error);
          mapsApiLoadCallbacks.forEach(cb => cb.reject(error));
          mapsApiLoadCallbacks = [];
        };
        document.head.appendChild(script);
      });
    }
    
    let map = null;
    let currentUser = null;
    let friendsClusterer = null;
    let usersClusterer = null;
    let autoUpdateInterval = null;
    let updateTimer = 30;
    let isIncognitoMode = false;
    let filterSettings = { friends: true, online: true, nearby: true, new: true, radius: 5 };
    let displaySettings = {
      all: true,
      friends: true,
      online: true,
      new: true,
      friendMarker: 'blue'
    };
    
    // Переменные для создания встречи
    let meetupType = 'private';
    
    // Переменные для маршрутов
    let currentRoute = null;
    let routePolyline = null;
    let routeMultiRoute = null;
    let friendRoutes = new Map();
    let showFriendRoutes = true;
    
    // Переменная для метки текущего пользователя
    let currentUserPlacemark = null;
    
    // Переменные для работы с карточкой пользователя
    let currentSelectedUser = null;
    let userPlacemarks = new Map(); // Хранилище меток пользователей для быстрого доступа
    
    // Переменные для работы с окном выбора типа маршрута
    let selectedRouteType = 'auto'; // auto, pedestrian, masstransit, taxi
    let routeToUserId = null;
    
    // Переменные для выезжающего меню
    let balloonMenuUser = null;
    let balloonMenuDistance = 0;
    let balloonMenuIsSwiping = false;
    let balloonMenuStartY = 0;
    let balloonMenuStartHeight = 0;
    
    // Тестовый пользователь для демонстрации
    const testUser = {
      id: 'test_user_001',
      nickname: 'Иван Иванов',
      email: 'ivan@example.com',
      about: 'Разработчик, любит кофе и прогулки. Работает в IT-компании.',
      position: [55.751244, 37.618423], // Координаты рядом с текущим пользователем
      status: 'online',
      invisible: false,
      friends: [],
      avatarColor: '#FF6B6B',
      initials: 'ИИ'
    };
    
    // ============================================
    // ОСНОВНЫЕ ФУНКЦИИ КАРТЫ
    // ============================================
    
    function initializeMap() {
      const mapElement = document.getElementById('map');
      const placeholder = document.getElementById('map-placeholder');
      
      loadYandexMapsAPI()
        .then(ymaps => {
          console.log('✅ Яндекс Карты успешно загружены');
          currentUser = UserSystem.getCurrentUser();
          
          if (!currentUser) {
            showTempMessage('Пользователь не авторизован');
            window.location.href = 'index.html';
            return;
          }
          
          // Добавляем тестового пользователя в систему для демонстрации
          addTestUserForDemo();
          
          // Проверяем состояние инкогнито из профиля
          isIncognitoMode = currentUser.invisible || false;
          updateIncognitoButton();
          
          const defaultPosition = currentUser.position || [55.751244, 37.618423];
          const MIN_ZOOM = 2;
          const MAX_ZOOM = 19;
          const DEFAULT_ZOOM = 12;
          
          try {
            const allUsers = UserSystem.getUsers();
            const positions = allUsers.filter(user => user.position && Array.isArray(user.position) && user.position.length === 2).map(user => user.position);
            let initialCenter = defaultPosition;
            let initialZoom = DEFAULT_ZOOM;
            
            if (positions.length > 1) {
              const validPositions = positions.filter(pos => 
                Array.isArray(pos) && pos.length === 2 && 
                !isNaN(pos[0]) && !isNaN(pos[1]) &&
                pos[0] >= -90 && pos[0] <= 90 &&
                pos[1] >= -180 && pos[1] <= 180
              );
              
              if (validPositions.length > 0) {
                try {
                  // Вычисляем центр вручную
                  let center = [0, 0];
                  let count = 0;
                  
                  validPositions.forEach(pos => {
                    if (pos && pos[0] && pos[1]) {
                      center[0] += pos[0];
                      center[1] += pos[1];
                      count++;
                    }
                  });
                  
                  if (count > 0) {
                    center[0] /= count;
                    center[1] /= count;
                    initialCenter = center;
                  }
                  
                  // Вычисляем зум на основе границ
                  const bounds = ymaps.util.bounds.fromPoints(validPositions);
                  const mapSize = [ mapElement.offsetWidth, mapElement.offsetHeight ];
                  const zoom = ymaps.util.bounds.getZoom(bounds, mapSize);
                  if (!isNaN(zoom)) {
                    initialZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom - 0.5));
                  }
                } catch (e) {
                  console.warn('Ошибка при расчете центра и зума:', e);
                }
              }
            }
            
            // Ограничения для области карты
            const limitBounds = [[85, -179], [-85, 179]];
            
            map = new ymaps.Map('map', {
              center: initialCenter,
              zoom: initialZoom,
              controls: [],
              restrictMapArea: limitBounds,
              suppressMapOpenBlock: true,
              suppressObsoleteBrowserNotifier: true
            }, {
              minZoom: MIN_ZOOM,
              maxZoom: MAX_ZOOM,
              yandexMapDisablePoiInteractivity: true
            });
            
            placeholder.classList.add('hidden');
            
            // Жесткая блокировка выхода за границы карты
            map.options.set({
              restrictMapArea: limitBounds,
              yandexMapDisablePoiInteractivity: true,
              yandexMapDisablePanOnEdge: true,
              suppressMapOpenBlock: true,
              suppressMapDragOutside: true
            });
            
            map.events.add('actiontick', function (e) {
              let bounds = map.getBounds();
              if (
                bounds[0][0] > limitBounds[0][0] || bounds[1][0] < limitBounds[1][0] ||
                bounds[0][1] < limitBounds[0][1] || bounds[1][1] > limitBounds[1][1]
              ) {
                map.setBounds(limitBounds, { checkZoomRange: true, duration: 0 });
              }
            });
            
            map.events.add('boundschange', function (e) {
              const bounds = map.getBounds();
              if (
                bounds[0][0] > limitBounds[0][0] || bounds[1][0] < limitBounds[1][0] ||
                bounds[0][1] < limitBounds[0][1] || bounds[1][1] > limitBounds[1][1]
              ) {
                map.setBounds(limitBounds, { checkZoomRange: true, duration: 0 });
              }
            });
            
            // Добавляем контролы масштабирования
            map.controls.add('zoomControl', {
              size: 'small',
              float: 'none',
              position: { right: 10, top: 100 }
            });
            
            map.controls.add('geolocationControl', {
              float: 'none',
              position: { right: 10, top: 150 }
            });
            
            friendsClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedVioletClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            usersClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedBlueClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            // Инициализируем карту с пользователями
            updateMap();
            
            // Центрируем карту на друзьях
            const friends = UserSystem.getUserFriends(currentUser.id);
            if (friends.length > 0) {
              setTimeout(() => {
                const friendPositions = friends
                  .filter(f => f.position && Array.isArray(f.position) && f.position.length === 2)
                  .map(f => f.position);
                
                if (friendPositions.length > 0) {
                  const validFriendPositions = friendPositions.filter(pos => 
                    Array.isArray(pos) && pos.length === 2 && 
                    !isNaN(pos[0]) || !isNaN(pos[1]) ||
                    pos[0] >= -90 && pos[0] <= 90 ||
                    pos[1] >= -180 && pos[1] <= 180
                  );
                  
                  if (validFriendPositions.length > 0) {
                    try {
                      const bounds = ymaps.util.bounds.fromPoints(validFriendPositions);
                      map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 50 });
                    } catch (e) {
                      console.warn('Ошибка при установке границ для друзей:', e);
                    }
                  }
                }
              }, 1000);
            }
            
            console.log('✅ Карта успешно инициализирована');
            startAutoUpdate();
            updateChatNotificationCount();
            setInterval(updateChatNotificationCount, 30000);
            
            // Загружаем маршруты друзей
            loadFriendRoutes();
            
            // Инициализируем свайп для меню
            initBalloonMenuSwipe();
            
          } catch (error) {
            console.error('❌ Ошибка при инициализации карты:', error);
            placeholder.innerHTML = `
              <span class="material-icons" style="font-size: 64px; opacity: 0.5;">error</span>
              <div>Ошибка загрузки карты</div>
              <div style="font-size: 12px; color: #888; margin-top: 10px;">${error.message}</div>
              <button onclick="location.reload()" style="
                margin-top: 15px;
                padding: 10px 20px;
                background: var(--primary-gradient);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
              ">Обновить</button>
            `;
          }
        })
        .catch(error => {
          console.error('❌ Ошибка загрузки Яндекс Карт:', error);
          const placeholder = document.getElementById('map-placeholder');
          placeholder.innerHTML = `
            <span class="material-icons" style="font-size: 64px; opacity: 0.5;">wifi_off</span>
            <div>Не удалось загрузить карту</div>
            <div style="font-size: 12px; margin-top: 10px; color: #888;">
              Проверьте подключение к интернету
            </div>
            <button onclick="initializeMap()" style="
              margin-top: 15px;
              padding: 10px 20px;
              background: var(--primary-gradient);
              border: none;
              border-radius: 8px;
              color: white;
              cursor: pointer;
            ">Попробовать снова</button>
          `;
        });
    }
    
    // ============================================
    // ФУНКЦИИ ДЛЯ РАБОТЫ С ПОЛЬЗОВАТЕЛЯМИ И МАРКЕРАМИ
    // ============================================
    
    function addTestUserForDemo() {
      // Проверяем, не добавлен ли уже тестовый пользователь
      const users = UserSystem.getUsers();
      const testUserExists = users.some(user => user.id === testUser.id);
      
      if (!testUserExists) {
        // Добавляем тестового пользователя
        users.push(testUser);
        UserSystem.saveUsers(users);
        
        // Добавляем тестового пользователя в друзья к текущему пользователю
        if (currentUser) {
          const currentUserData = users.find(u => u.id === currentUser.id);
          if (currentUserData && !currentUserData.friends) {
            currentUserData.friends = [];
          }
          if (currentUserData && !currentUserData.friends.includes(testUser.id)) {
            currentUserData.friends.push(testUser.id);
            UserSystem.saveUsers(users);
            currentUser = UserSystem.getCurrentUser(); // Обновляем текущего пользователя
          }
        }
        
        console.log('✅ Тестовый пользователь добавлен для демонстрации');
      }
    }
    
    function getInitials(name) {
      if (!name) return '?';
      const parts = name.split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }
    
    function getAvatarColor(name) {
      // Генерируем цвет на основе имени пользователя
      const colors = [
        '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2',
        '#EF476F', '#26547C', '#FF9A76', '#7D5FFF', '#70D6FF'
      ];
      if (!name) return colors[0];
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }
    
    function createUserPlacemark(user) {
      if (!map || !user.position || typeof ymaps === 'undefined') return null;
      
      const isFriend = currentUser.friends && currentUser.friends.includes(user.id);
      const isCurrentUser = user.id === currentUser.id;
      const isOnline = user.status === 'online';
      
      // Определяем цвет метки
      let markerColor;
      if (isCurrentUser) {
        markerColor = isIncognitoMode ? '#FF4444' : '#2CB4FF';
      } else if (isFriend) {
        switch(displaySettings.friendMarker) {
          case 'green': markerColor = isOnline ? '#34eb89' : '#2a7a2a'; break;
          case 'red': markerColor = isOnline ? '#ff4444' : '#992222'; break;
          case 'purple': markerColor = isOnline ? '#B970FE' : '#663399'; break;
          case 'gold': markerColor = isOnline ? '#FFD700' : '#B8860B'; break;
          default: markerColor = isOnline ? '#2CB4FF' : '#1a5a7a';
        }
      } else {
        markerColor = isOnline ? '#A4B0BE' : '#666666';
      }
      
      // Создаем инициалы для аватарки
      const initials = user.initials || getInitials(user.nickname);
      const avatarColor = user.avatarColor || getAvatarColor(user.nickname);
      
      // Создаем HTML для маркера
      const markerHtml = `
        <div style="
          width: 44px;
          height: 44px;
          border-radius: 50%;
          background: ${avatarColor};
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 16px;
          border: 3px solid ${markerColor};
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          cursor: pointer;
          transition: all 0.3s ease;
        ">
          ${initials}
        </div>
      `;
      
      // Создаем иконку для Яндекс.Карт
      const markerIcon = ymaps.templateLayoutFactory.createClass(markerHtml, {
        build: function() {
          this.constructor.superclass.build.call(this);
          this.getParentElement().style.cursor = 'pointer';
        }
      });
      
      // Создаем метку
      const placemark = new ymaps.Placemark(
        user.position,
        {
          hintContent: user.nickname || 'Пользователь',
          balloonContent: createBalloonContent(user, isFriend)
        },
        {
          iconLayout: markerIcon,
          iconShape: {
            type: 'Circle',
            coordinates: [0, 0],
            radius: 22
          },
          hideIconOnBalloonOpen: false,
          balloonOffset: [0, -20],
          balloonCloseButton: false,
          balloonPanelMaxMapArea: 0
        }
      );
      
      // Добавляем обработчик клика на метку
      placemark.events.add('click', function(e) {
        e.preventDefault();
        
        // Закрываем все открытые балуны
        map.balloon.close();
        
        // Показываем выезжающее меню
        showBalloonMenu(user);
        
        // Немного смещаем карту к метке, если она близко к краю
        const pixelPosition = map.getPixelBounds(user.position);
        const mapSize = map.container.getSize();
        
        if (pixelPosition[0] < 100 || pixelPosition[0] > mapSize[0] - 100 ||
            pixelPosition[1] < 150 || pixelPosition[1] > mapSize[1] - 150) {
          map.panTo(user.position, {
            duration: 300,
            timingFunction: 'ease-in-out'
          });
        }
      });
      
      // Добавляем обработчик наведения
      placemark.events.add('mouseenter', function() {
        // Можно добавить анимацию при наведении
      });
      
      placemark.events.add('mouseleave', function() {
        // Можно убрать анимацию
      });
      
      return placemark;
    }
    
    function createBalloonContent(user, isFriend) {
      const initials = user.initials || getInitials(user.nickname);
      const avatarColor = user.avatarColor || getAvatarColor(user.nickname);
      const isOnline = user.status === 'online';
      
      // Вычисляем расстояние до пользователя
      let distanceText = '...';
      if (currentUser && currentUser.position) {
        const distance = calculateDistance(currentUser.position, user.position);
        if (distance < 1) {
          distanceText = `${Math.round(distance * 1000)} м`;
        } else {
          distanceText = `${distance.toFixed(1)} км`;
        }
      }
      
      return `
        <div style="padding: 15px; min-width: 280px; max-width: 320px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
            <div style="
              width: 50px;
              height: 50px;
              border-radius: 50%;
              background: ${avatarColor};
              color: white;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 600;
              font-size: 18px;
              flex-shrink: 0;
            ">
              ${initials}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: white; font-size: 16px; margin-bottom: 4px;">
                ${user.nickname || 'Пользователь'}
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="
                  width: 8px;
                  height: 8px;
                  border-radius: 50%;
                  background: ${isOnline ? '#34eb89' : '#888'};
                "></span>
                <span style="color: ${isOnline ? '#34eb89' : '#888'}; font-size: 12px;">
                  ${isOnline ? 'В сети' : 'Не в сети'}
                </span>
                ${isFriend ? '<span style="color: #2CB4FF; font-size: 12px;">• Друг</span>' : ''}
              </div>
            </div>
          </div>
          
          <div style="color: #aaa; font-size: 13px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
            <span class="material-icons" style="font-size: 14px;">straight</span>
            <span>${distanceText} от вас</span>
          </div>
          
          ${user.about ? `
            <div style="color: #aaa; font-size: 13px; margin-bottom: 15px; line-height: 1.4;">
              ${user.about}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 8px;">
            <button onclick="showUserCardFromBalloon('${user.id}')" style="
              flex: 1;
              padding: 8px 12px;
              background: rgba(44,180,255,0.2);
              color: #2CB4FF;
              border: none;
              border-radius: 6px;
              font-size: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 5px;
              transition: all 0.3s ease;
            ">
              <span class="material-icons" style="font-size: 14px;">info</span>
              Подробнее
            </button>
            
            <button onclick="openRouteTypeSelector('${user.id}')" style="
              flex: 1;
              padding: 8px 12px;
              background: var(--route-color);
              color: white;
              border: none;
              border-radius: 6px;
              font-size: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 5px;
              transition: all 0.3s ease;
            ">
              <span class="material-icons" style="font-size: 14px;">directions</span>
              Маршрут
            </button>
          </div>
        </div>
      `;
    }
    
    function updateMap() {
      if (!map || !currentUser || typeof ymaps === 'undefined') return;
      
      // Обновляем метку текущего пользователя
      updateCurrentUserPlacemark();
      
      // Очищаем кластеризаторы
      friendsClusterer.removeAll();
      usersClusterer.removeAll();
      
      // Очищаем хранилище меток
      userPlacemarks.clear();
      
      // Удаляем все метки кроме текущего пользователя
      map.geoObjects.each(function(geoObject) {
        if (geoObject !== currentUserPlacemark) {
          map.geoObjects.remove(geoObject);
        }
      });
      
      const allUsers = UserSystem.getUsers();
      const friends = UserSystem.getUserFriends(currentUser.id);
      const friendIds = friends.map(f => f.id);
      
      // Фильтрация пользователей
      const filteredUsers = allUsers.filter(user => {
        if (user.id === currentUser.id || !user.position) return false;
        if (user.invisible && !isIncognitoMode) return false;
        
        // Проверяем валидность позиции
        const position = user.position;
        if (!Array.isArray(position) || position.length !== 2 || 
            isNaN(position[0]) || isNaN(position[1]) ||
            position[0] < -90 && position[0] > 90 ||
            position[1] < -180 && position[1] > 180) {
          return false;
        }
        
        const isFriend = friendIds.includes(user.id);
        
        // Применяем настройки отображения
        if (!displaySettings.all && !isFriend) return false;
        if (!displaySettings.friends && isFriend) return false;
        if (displaySettings.online && user.status !== 'online') return false;
        
        // Фильтр по расстоянию
        if (filterSettings.nearby && currentUser.position) {
          const distance = calculateDistance(currentUser.position, user.position);
          if (distance > filterSettings.radius) return false;
        }
        
        return true;
      });
      
      // Создаем метки для пользователей
      filteredUsers.forEach(user => {
        const placemark = createUserPlacemark(user);
        if (placemark) {
          const isFriend = friendIds.includes(user.id);
          
          // Сохраняем метку в хранилище для быстрого доступа
          userPlacemarks.set(user.id, placemark);
          
          // Добавляем в соответствующий кластеризатор
          if (isFriend) {
            friendsClusterer.add(placemark);
          } else {
            usersClusterer.add(placemark);
          }
        }
      });
      
      // Добавляем кластеризаторы на карту
      map.geoObjects.add(friendsClusterer);
      map.geoObjects.add(usersClusterer);
      
      // Обновляем маршруты друзей
      updateFriendRoutes();
    }
    
    function updateCurrentUserPlacemark() {
      if (!map || !currentUser || typeof ymaps === 'undefined') return;
      
      // Удаляем старую метку
      if (currentUserPlacemark) {
        map.geoObjects.remove(currentUserPlacemark);
      }
      
      // Если пользователь скрыт - не показываем его на карте
      if (isIncognitoMode || !currentUser.position) {
        currentUserPlacemark = null;
        return;
      }
      
      // Проверяем валидность позиции
      const position = currentUser.position;
      if (!Array.isArray(position) || position.length !== 2 || 
          isNaN(position[0]) || isNaN(position[1]) ||
          position[0] < -90 && position[0] > 90 ||
          position[1] < -180 && position[1] > 180) {
        console.warn('Некорректная позиция пользователя:', position);
        currentUserPlacemark = null;
        return;
      }
      
      // Создаем метку текущего пользователя
      const initials = getInitials(currentUser.nickname);
      const avatarColor = getAvatarColor(currentUser.nickname);
      const markerColor = isIncognitoMode ? '#FF4444' : '#2CB4FF';
      
      const markerHtml = `
        <div style="
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: ${avatarColor};
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
          font-size: 18px;
          border: 3px solid ${markerColor};
          box-shadow: 0 3px 12px rgba(0,0,0,0.4);
          cursor: pointer;
          position: relative;
        ">
          ${initials}
          ${isIncognitoMode ? `
            <div style="
              position: absolute;
              bottom: -5px;
              right: -5px;
              width: 20px;
              height: 20px;
              border-radius: 50%;
              background: #FF4444;
              display: flex;
              align-items: center;
              justify-content: center;
            ">
              <span class="material-icons" style="font-size: 12px; color: white;">visibility_off</span>
            </div>
          ` : ''}
        </div>
      `;
      
      const markerIcon = ymaps.templateLayoutFactory.createClass(markerHtml, {
        build: function() {
          this.constructor.superclass.build.call(this);
          this.getParentElement().style.cursor = 'pointer';
        }
      });
      
      currentUserPlacemark = new ymaps.Placemark(
        position,
        {
          hintContent: isIncognitoMode ? 'Вы (скрыт)' : 'Ваше местоположение',
          balloonContent: createCurrentUserBalloonContent()
        },
        {
          iconLayout: markerIcon,
          iconShape: {
            type: 'Circle',
            coordinates: [0, 0],
            radius: 25
          },
          hideIconOnBalloonOpen: false,
          balloonOffset: [0, -20],
          balloonCloseButton: false
        }
      );
      
      // Добавляем обработчик клика на свою метку
      currentUserPlacemark.events.add('click', function(e) {
        e.preventDefault();
        showUserCard(currentUser);
        map.balloon.close();
      });
      
      map.geoObjects.add(currentUserPlacemark);
    }
    
    function createCurrentUserBalloonContent() {
      const initials = getInitials(currentUser.nickname);
      const avatarColor = getAvatarColor(currentUser.nickname);
      
      return `
        <div style="padding: 15px; min-width: 280px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
            <div style="
              width: 50px;
              height: 50px;
              border-radius: 50%;
              background: ${avatarColor};
              color: white;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: 600;
              font-size: 18px;
              flex-shrink: 0;
            ">
              ${initials}
            </div>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: white; font-size: 16px; margin-bottom: 4px;">
                ${currentUser.nickname || 'Вы'}
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <span style="
                  width: 8px;
                  height: 8px;
                  border-radius: 50%;
                  background: ${isIncognitoMode ? '#FF4444' : '#34eb89'};
                "></span>
                <span style="color: ${isIncognitoMode ? '#FF4444' : '#34eb89'}; font-size: 12px;">
                  ${isIncognitoMode ? 'Скрыт' : 'В сети'}
                </span>
              </div>
            </div>
          </div>
          
          ${currentUser.about ? `
            <div style="color: #aaa; font-size: 13px; margin-bottom: 15px; line-height: 1.4;">
              ${currentUser.about}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 8px;">
            <button onclick="window.location.href='profile.html'" style="
              flex: 1;
              padding: 8px 12px;
              background: rgba(44,180,255,0.2);
              color: #2CB4FF;
              border: none;
              border-radius: 6px;
              font-size: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 5px;
              transition: all 0.3s ease;
            ">
              <span class="material-icons" style="font-size: 14px;">edit</span>
              Редактировать
            </button>
            
            <button onclick="toggleIncognitoMode()" style="
              flex: 1;
              padding: 8px 12px;
              background: ${isIncognitoMode ? 'rgba(255,107,107,0.2)' : 'rgba(52,235,137,0.2)'};
              color: ${isIncognitoMode ? '#FF6B6B' : '#34eb89'};
              border: none;
              border-radius: 6px;
              font-size: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 5px;
              transition: all 0.3s ease;
            ">
              <span class="material-icons" style="font-size: 14px;">${isIncognitoMode ? 'visibility' : 'visibility_off'}</span>
              ${isIncognitoMode ? 'Показаться' : 'Скрыться'}
            </button>
          </div>
        </div>
      `;
    }
    
    // ============================================
    // ФУНКЦИИ ДЛЯ ВЫЕЗЖАЮЩЕГО МЕНЮ
    // ============================================
    
    function showBalloonMenu(user) {
      balloonMenuUser = user;
      
      // Вычисляем расстояние до пользователя
      if (currentUser && currentUser.position && user.position) {
        balloonMenuDistance = calculateDistance(currentUser.position, user.position);
      } else {
        balloonMenuDistance = 0;
      }
      
      // Обновляем информацию в меню
      document.getElementById('balloon-menu-user-name').textContent = user.nickname || 'Пользователь';
      
      if (balloonMenuDistance < 1) {
        document.getElementById('balloon-menu-distance-value').textContent = `${Math.round(balloonMenuDistance * 1000)} м`;
      } else {
        document.getElementById('balloon-menu-distance-value').textContent = `${balloonMenuDistance.toFixed(1)} км`;
      }
      
      // Показываем меню с анимацией
      const menu = document.getElementById('balloon-menu');
      menu.classList.add('active');
      
      // Добавляем обработчик клика вне меню
      setTimeout(() => {
        document.addEventListener('click', closeBalloonMenuOnClickOutside);
      }, 10);
    }
    
    function hideBalloonMenu() {
      const menu = document.getElementById('balloon-menu');
      menu.classList.remove('active');
      balloonMenuUser = null;
      
      // Удаляем обработчик клика вне меню
      document.removeEventListener('click', closeBalloonMenuOnClickOutside);
    }
    
    function closeBalloonMenuOnClickOutside(event) {
      const menu = document.getElementById('balloon-menu');
      if (menu && !menu.contains(event.target)) {
        hideBalloonMenu();
      }
    }
    
    function initBalloonMenuSwipe() {
      const menu = document.getElementById('balloon-menu');
      const swipeHandle = menu.querySelector('.balloon-menu-swipe-handle');
      
      if (!menu || !swipeHandle) return;
      
      // Обработчики для свайпа вниз
      menu.addEventListener('touchstart', handleTouchStart);
      menu.addEventListener('touchmove', handleTouchMove);
      menu.addEventListener('touchend', handleTouchEnd);
      
      // Также для мыши
      menu.addEventListener('mousedown', handleMouseDown);
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      
      function handleTouchStart(e) {
        if (e.target === swipeHandle || e.target.closest('.balloon-menu-swipe-handle')) {
          balloonMenuIsSwiping = true;
          balloonMenuStartY = e.touches[0].clientY;
          balloonMenuStartHeight = menu.offsetHeight;
          menu.style.transition = 'none';
          e.preventDefault();
        }
      }
      
      function handleTouchMove(e) {
        if (!balloonMenuIsSwiping) return;
        
        const currentY = e.touches[0].clientY;
        const deltaY = currentY - balloonMenuStartY;
        
        if (deltaY > 0) { // Свайп вниз
          menu.style.transform = `translateY(${deltaY}px)`;
        }
        
        e.preventDefault();
      }
      
      function handleTouchEnd(e) {
        if (!balloonMenuIsSwiping) return;
        
        balloonMenuIsSwiping = false;
        menu.style.transition = 'transform 0.3s ease';
        
        const currentY = e.changedTouches[0].clientY;
        const deltaY = currentY - balloonMenuStartY;
        
        // Если свайпнули достаточно далеко вниз, закрываем меню
        if (deltaY > 50) {
          hideBalloonMenu();
        } else {
          // Возвращаем на место
          menu.style.transform = 'translateY(0)';
        }
        
        e.preventDefault();
      }
      
      function handleMouseDown(e) {
        if (e.target === swipeHandle || e.target.closest('.balloon-menu-swipe-handle')) {
          balloonMenuIsSwiping = true;
          balloonMenuStartY = e.clientY;
          balloonMenuStartHeight = menu.offsetHeight;
          menu.style.transition = 'none';
          e.preventDefault();
        }
      }
      
      function handleMouseMove(e) {
        if (!balloonMenuIsSwiping) return;
        
        const currentY = e.clientY;
        const deltaY = currentY - balloonMenuStartY;
        
        if (deltaY > 0) { // Свайп вниз
          menu.style.transform = `translateY(${deltaY}px)`;
        }
        
        e.preventDefault();
      }
      
      function handleMouseUp(e) {
        if (!balloonMenuIsSwiping) return;
        
        balloonMenuIsSwiping = false;
        menu.style.transition = 'transform 0.3s ease';
        
        const currentY = e.clientY;
        const deltaY = currentY - balloonMenuStartY;
        
        // Если свайпнули достаточно далеко вниз, закрываем меню
        if (deltaY > 50) {
          hideBalloonMenu();
        } else {
          // Возвращаем на место
          menu.style.transform = 'translateY(0)';
        }
        
        e.preventDefault();
      }
    }
    
    function buildRouteFromBalloonMenu() {
      if (!balloonMenuUser) {
        showTempMessage('Пользователь не выбран');
        return;
      }
      
      // Закрываем меню
      hideBalloonMenu();
      
      // Открываем окно выбора типа маршрута
      openRouteTypeSelector(balloonMenuUser.id);
    }
    
    // ============================================
    // ФУНКЦИИ ДЛЯ КАРТОЧКИ ПОЛЬЗОВАТЕЛЯ
    // ============================================
    
    function showUserCard(user) {
      currentSelectedUser = user;
      
      const card = document.getElementById('user-card');
      const avatar = document.getElementById('user-card-avatar');
      const name = document.getElementById('user-card-name');
      const status = document.getElementById('user-card-status');
      const details = document.getElementById('user-card-details');
      
      // Устанавливаем цвет аватарки
      const avatarColor = user.avatarColor || getAvatarColor(user.nickname);
      avatar.style.background = avatarColor;
      
      // Устанавливаем инициалы
      const initials = user.initials || getInitials(user.nickname);
      avatar.textContent = initials;
      
      // Устанавливаем имя
      name.textContent = user.nickname || 'Пользователь';
      
      // Устанавливаем статус
      const isOnline = user.status === 'online';
      const isFriend = currentUser.friends && currentUser.friends.includes(user.id);
      const isCurrentUser = user.id === currentUser.id;
      
      let statusHtml = '';
      if (isCurrentUser) {
        statusHtml = `
          <span style="width: 8px; height: 8px; border-radius: 50%; background: ${isIncognitoMode ? '#FF4444' : '#34eb89'};"></span>
          <span style="color: ${isIncognitoMode ? '#FF4444' : '#34eb89'};">${isIncognitoMode ? 'Скрыт' : 'В сети'}</span>
          <span style="color: #2CB4FF; margin-left: 8px;">• Вы</span>
        `;
      } else {
        statusHtml = `
          <span style="width: 8px; height: 8px; border-radius: 50%; background: ${isOnline ? '#34eb89' : '#888'};"></span>
          <span style="color: ${isOnline ? '#34eb89' : '#888'};">${isOnline ? 'В сети' : 'Не в сети'}</span>
          ${isFriend ? '<span style="color: #2CB4FF; margin-left: 8px;">• Друг</span>' : ''}
        `;
      }
      status.innerHTML = statusHtml;
      
      // Устанавливаем описание
      details.textContent = user.about || 'Нет описания профиля';
      
      // Настраиваем кнопки
      const chatBtn = document.getElementById('user-card-chat-btn');
      const routeBtn = document.getElementById('user-card-route-btn');
      const profileBtn = document.getElementById('user-card-profile-btn');
      
      if (isCurrentUser) {
        chatBtn.style.display = 'none';
        routeBtn.style.display = 'none';
        profileBtn.textContent = 'Редактировать';
        profileBtn.innerHTML = '<span class="material-icons">edit</span>Редактировать';
      } else {
        chatBtn.style.display = 'flex';
        routeBtn.style.display = 'flex';
        profileBtn.textContent = 'Профиль';
        profileBtn.innerHTML = '<span class="material-icons">person</span>Профиль';
      }
      
      // Показываем карточку
      card.classList.add('active');
      
      // Добавляем обработчик для закрытия при клике вне карточки
      setTimeout(() => {
        document.addEventListener('click', closeUserCardOnClickOutside);
      }, 10);
    }
    
    function hideUserCard() {
      const card = document.getElementById('user-card');
      card.classList.remove('active');
      currentSelectedUser = null;
      
      // Удаляем обработчик закрытия при клике вне карточки
      document.removeEventListener('click', closeUserCardOnClickOutside);
    }
    
    function closeUserCardOnClickOutside(event) {
      const card = document.getElementById('user-card');
      if (card && !card.contains(event.target)) {
        hideUserCard();
      }
    }
    
    function showUserCardFromBalloon(userId) {
      const user = UserSystem.getUserById(userId);
      if (user) {
        showUserCard(user);
      }
    }
    
    // ============================================
    // ФУНКЦИИ ДЛЯ ПОСТРОЕНИЯ МАРШРУТОВ
    // ============================================
    
    function openRouteTypeSelector(userId) {
      routeToUserId = userId;
      
      const overlay = document.getElementById('route-type-overlay');
      const content = document.getElementById('route-type-content');
      
      // Определяем варианты маршрутов
      const routeTypes = [
        {
          id: 'auto',
          name: 'Автомобиль',
          description: 'Оптимальный маршрут для поездки на автомобиле',
          icon: 'directions_car',
          color: '#FF6B6B'
        },
        {
          id: 'pedestrian',
          name: 'Пешком',
          description: 'Пешеходный маршрут с учетом тротуаров и переходов',
          icon: 'directions_walk',
          color: '#4ECDC4'
        },
        {
          id: 'masstransit',
          name: 'Общественный транспорт',
          description: 'Маршрут на автобусе, метро или другом транспорте',
          icon: 'directions_bus',
          color: '#FFD166'
        },
        {
          id: 'taxi',
          name: 'Такси',
          description: 'Маршрут для поездки на такси',
          icon: 'local_taxi',
          color: '#06D6A0'
        }
      ];
      
      // Создаем HTML для вариантов маршрутов
      let routeTypesHTML = '';
      routeTypes.forEach(type => {
        const isActive = type.id === selectedRouteType;
        routeTypesHTML += `
          <div class="route-type-option ${isActive ? 'active' : ''}" data-type="${type.id}">
            <div class="route-type-icon" style="background: ${type.color};">
              <span class="material-icons">${type.icon}</span>
            </div>
            <div class="route-type-info">
              <div class="route-type-name">${type.name}</div>
              <div class="route-type-desc">${type.description}</div>
            </div>
          </div>
        `;
      });
      
      content.innerHTML = routeTypesHTML;
      
      // Добавляем обработчики выбора типа маршрута
      document.querySelectorAll('.route-type-option').forEach(option => {
        option.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          selectedRouteType = type;
          
          // Обновляем активный класс
          document.querySelectorAll('.route-type-option').forEach(opt => {
            opt.classList.remove('active');
          });
          this.classList.add('active');
        });
      });
      
      // Показываем окно
      overlay.classList.add('active');
    }
    
    function closeRouteTypeSelector() {
      const overlay = document.getElementById('route-type-overlay');
      overlay.classList.remove('active');
      routeToUserId = null;
    }
    
    function buildRouteToUser() {
      if (!routeToUserId || !currentUser || !currentUser.position) {
        showTempMessage('Не удалось построить маршрут');
        closeRouteTypeSelector();
        return;
      }
      
      const user = UserSystem.getUserById(routeToUserId);
      if (!user || !user.position) {
        showTempMessage('Пользователь не найден или у него не указано местоположение');
        closeRouteTypeSelector();
        return;
      }
      
      // Закрываем окно выбора типа маршрута
      closeRouteTypeSelector();
      
      // Очищаем предыдущий маршрут
      clearRoute();
      
      // Определяем режим маршрутизации
      let routingMode;
      switch(selectedRouteType) {
        case 'pedestrian':
          routingMode = 'pedestrian';
          break;
        case 'masstransit':
          routingMode = 'masstransit';
          break;
        case 'taxi':
          routingMode = 'auto'; // Такси использует тот же режим, что и авто
          break;
        default:
          routingMode = 'auto';
      }
      
      // Строим маршрут
      const startPoint = currentUser.position;
      const endPoint = user.position;
      
      buildRouteWithYmaps(startPoint, endPoint, routingMode, user.nickname || 'Пользователь');
      
      // Показываем информацию о маршруте
      showRouteInfo(user.nickname || 'Пользователь');
      
      // Скрываем карточку пользователя, если она открыта
      hideUserCard();
      
      showTempMessage(`Строим ${getRouteTypeName(selectedRouteType)} маршрут до ${user.nickname}`);
    }
    
    function buildRouteWithYmaps(startPoint, endPoint, routingMode, destinationName) {
      if (!map || typeof ymaps === 'undefined') return;
      
      // Создаем мультимаршрут
      routeMultiRoute = new ymaps.multiRouter.MultiRoute({
        referencePoints: [startPoint, endPoint],
        params: {
          routingMode: routingMode
        }
      }, {
        boundsAutoApply: true,
        routeActiveStrokeWidth: 6,
        routeActiveStrokeColor: getRouteTypeColor(selectedRouteType),
        routeStrokeWidth: 4,
        routeStrokeColor: getRouteTypeColor(selectedRouteType) + '99',
        pinIconFillColor: getRouteTypeColor(selectedRouteType)
      });
      
      // Добавляем маршрут на карту
      map.geoObjects.add(routeMultiRoute);
      
      // Сохраняем информацию о маршруте
      currentRoute = {
        start: startPoint,
        end: endPoint,
        destination: destinationName,
        type: selectedRouteType,
        routingMode: routingMode
      };
      
      // Показываем кнопку очистки маршрута
      document.getElementById('btn-clear-route').style.display = 'flex';
      
      // Обновляем информацию о маршруте при получении данных
      routeMultiRoute.model.events.add('requestsuccess', function() {
        const activeRoute = routeMultiRoute.getActiveRoute();
        if (activeRoute) {
          const distance = activeRoute.properties.get('distance');
          const duration = activeRoute.properties.get('duration');
          
          // Форматируем расстояние
          let distanceText;
          if (distance.value < 1000) {
            distanceText = `${distance.text}`;
          } else {
            distanceText = `${(distance.value / 1000).toFixed(1)} км`;
          }
          
          // Форматируем время
          const hours = Math.floor(duration.value / 3600);
          const minutes = Math.floor((duration.value % 3600) / 60);
          let timeText = '';
          if (hours > 0) {
            timeText += `${hours} ч `;
          }
          timeText += `${minutes} мин`;
          
          document.getElementById('route-distance').textContent = distanceText;
          document.getElementById('route-time').textContent = timeText;
        }
      });
      
      // Обрабатываем ошибки при построении маршрута
      routeMultiRoute.model.events.add('requesterror', function() {
        showTempMessage('Не удалось построить маршрут. Попробуйте другой тип маршрута.');
      });
    }
    
    function getRouteTypeName(type) {
      switch(type) {
        case 'pedestrian': return 'пешеходный';
        case 'masstransit': return 'на общественном транспорте';
        case 'taxi': return 'на такси';
        default: return 'автомобильный';
      }
    }
    
    function getRouteTypeColor(type) {
      switch(type) {
        case 'pedestrian': return '#4ECDC4';
        case 'masstransit': return '#FFD166';
        case 'taxi': return '#06D6A0';
        default: return '#FF6B6B';
      }
    }
    
    // ============================================
    // СУЩЕСТВУЮЩИЕ ФУНКЦИИ (остаются без изменений)
    // ============================================
    
    function updateIncognitoButton() {
      const btn = document.getElementById('btn-incognito');
      const icon = document.getElementById('incognito-icon');
      
      if (isIncognitoMode) {
        btn.classList.add('active');
        btn.title = 'Режим инкогнито включен';
        icon.textContent = 'visibility_off';
      } else {
        btn.classList.remove('active');
        btn.title = 'Режим инкогнито';
        icon.textContent = 'visibility_off';
      }
    }
    
    function calculateDistance(pos1, pos2) {
      if (!pos1 || !pos2 || !Array.isArray(pos1) || !Array.isArray(pos2)) return Infinity;
      
      const [lat1, lon1] = pos1;
      const [lat2, lon2] = pos2;
      
      if (isNaN(lat1) || isNaN(lon1) || isNaN(lat2) || isNaN(lon2)) return Infinity;
      
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function addFriend(userId) {
      if (!currentUser) return;
      if (UserSystem.sendFriendRequest(currentUser.id, userId)) {
        showTempMessage('Запрос в друзья отправлен!');
        updateMap();
      } else {
        showTempMessage('Не удалось отправить запрос');
      }
    }
    
    function startAutoUpdate() {
      const autoUpdate = localStorage.getItem('meetup_auto_update') !== 'false';
      if (autoUpdate) {
        document.getElementById('auto-update-indicator').style.display = 'flex';
        updateTimer = 30;
        autoUpdateInterval = setInterval(() => {
          updateTimer--;
          document.getElementById('update-timer').textContent = updateTimer;
          if (updateTimer <= 0) {
            updateLocation();
            updateTimer = 30;
          }
        }, 1000);
      }
    }
    
    function updateLocation() {
      if (!currentUser || !navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        position => {
          const coords = [position.coords.latitude, position.coords.longitude];
          UserSystem.updateUserPosition(currentUser.id, coords);
          currentUser = UserSystem.getCurrentUser();
          checkNearbyFriends();
          updateMap();
          updateFriendRoutes();
        },
        error => {
          console.log('📍 Геолокация недоступна');
        },
        { enableHighAccuracy: false, timeout: 5000 }
      );
    }
    
    function checkNearbyFriends() {
      if (!currentUser || !currentUser.position) return;
      const friends = UserSystem.getUserFriends(currentUser.id);
      const radius = filterSettings.radius;
      const nearbyFriends = friends.filter(friend => {
        if (!friend.position || friend.invisible) return false;
        const distance = calculateDistance(currentUser.position, friend.position);
        return distance <= radius;
      });
      if (nearbyFriends.length > 0) {
        showNearbyNotification(nearbyFriends);
      }
    }
    
    function showNearbyNotification(friends) {
      const notification = document.createElement('div');
      notification.className = 'nearby-notification';
      notification.innerHTML = `
        <span class="material-icons">group</span>
        <div>
          <strong>Друзья поблизости!</strong><br>
          ${friends.length} ${getRussianPlural(friends.length, ['друг', 'друга', 'друзей'])} рядом с вами
        </div>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
          <span class="material-icons">close</span>
        </button>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) notification.remove();
      }, 5000);
    }
    
    function getRussianPlural(number, forms) {
      const cases = [2, 0, 1, 1, 1, 2];
      return forms[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
    }
    
    function highlightUserLocation() {
      if (!currentUser || !currentUser.position || !map || typeof ymaps === 'undefined') return;
      if (window.locationHighlight) {
        map.geoObjects.remove(window.locationHighlight);
      }
      window.locationHighlight = new ymaps.Circle([
        currentUser.position,
        100
      ], {}, {
        fillColor: isIncognitoMode ? '#FF444433' : '#2CB4FF33',
        strokeColor: isIncognitoMode ? '#FF4444' : '#2CB4FF',
        strokeWidth: 2,
        strokeOpacity: 0.8
      });
      map.geoObjects.add(window.locationHighlight);
      setTimeout(() => {
        if (window.locationHighlight && map) {
          map.geoObjects.remove(window.locationHighlight);
          window.locationHighlight = null;
        }
      }, 5000);
    }
    
    function toggleIncognitoMode() {
      isIncognitoMode = !isIncognitoMode;
      
      // Обновляем кнопку
      updateIncognitoButton();
      
      // Обновляем состояние в профиле пользователя
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex !== -1) {
        users[userIndex].invisible = isIncognitoMode;
        UserSystem.saveUsers(users);
        UserSystem.setCurrentUser(users[userIndex]);
        currentUser = users[userIndex];
      }
      
      // Показываем уведомление
      if (isIncognitoMode) {
        showTempMessage('Режим инкогнито включен. Ваше местоположение скрыто на карте.');
      } else {
        showTempMessage('Режим инкогнито выключен. Ваше местоположение видно на карте.');
      }
      
      // Обновляем карту
      updateMap();
    }
    
    function openChat(userId) {
      const user = UserSystem.getUserById(userId);
      if (!user) return;
      
      showTempMessage('Открывается чат с ' + user.nickname);
      // В будущем здесь будет открытие отдельной страницы чата
      // window.location.href = `chat.html?userId=${userId}`;
    }
    
    function showUserProfile(userId) {
      sessionStorage.setItem('viewingUserId', userId);
      window.open('userProfile.html', '_blank');
    }
    
    function openChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.add('active');
      loadChats();
    }
    
    function closeChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.remove('active');
    }
    
    function loadChats() {
      const chatList = document.getElementById('chat-list');
      if (!currentUser) return;
      
      const chats = ChatSystem.getUserChats(currentUser.id);
      const friends = UserSystem.getUserFriends(currentUser.id);
      
      if (chats.length === 0 && friends.length === 0) {
        chatList.innerHTML = `
          <div class="chat-empty">
            <span class="material-icons" style="font-size: 60px; opacity: 0.5; margin-bottom: 20px;">chat</span>
            <div>У вас пока нет чатов</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">Добавьте друзей, чтобы начать общение</div>
          </div>
        `;
        return;
      }
      
      // Создаем HTML для чатов
      let chatHTML = '';
      
      if (chats.length > 0) {
        chats.forEach(chat => {
          const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
          const friend = friends.find(f => f.id === otherParticipantId) || UserSystem.getUserById(otherParticipantId);
          if (!friend) return;
          
          const lastMessage = ChatSystem.getLastMessage(chat);
          const unreadCount = chat.unreadCount || 0;
          const timeAgo = ChatSystem.formatTime(lastMessage.timestamp);
          
          chatHTML += `
            <div class="chat-item" data-chat-id="${chat.id}" data-user-id="${friend.id}">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || 'Пользователь'}</div>
                <div class="chat-last-message">${lastMessage.text || 'Нет сообщений'}</div>
                <div class="chat-time">${timeAgo}</div>
              </div>
              ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
            </div>
          `;
        });
      } else {
        // Показываем друзей для начала чата
        friends.forEach(friend => {
          chatHTML += `
            <div class="chat-item" data-user-id="${friend.id}">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || 'Пользователь'}</div>
                <div class="chat-last-message">Нажмите, чтобы начать чат</div>
                <div class="chat-time">${friend.status === 'online' ? 'В сети' : 'Не в сети'}</div>
              </div>
            </div>
          `;
        });
      }
      
      chatList.innerHTML = chatHTML;
      
      // Добавляем обработчики кликов
      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
          const userId = this.getAttribute('data-user-id');
          const chatId = this.getAttribute('data-chat-id');
          
          if (chatId) {
            // Открываем существующий чат
            window.location.href = `chat.html?chatId=${chatId}&userId=${userId}`;
          } else {
            // Создаем новый чат и открываем его
            const chat = ChatSystem.createChat(currentUser.id, userId);
            window.location.href = `chat.html?chatId=${chat.id}&userId=${userId}`;
          }
        });
      });
    }
    
    function updateChatNotificationCount() {
      if (!currentUser) return;
      const unreadCount = ChatSystem.getUnreadCount(currentUser.id);
      const badge = document.getElementById('chat-notification-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function openPedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      const content = document.getElementById('pedometer-content');
      
      // Проверяем поддержку шагомера
      if (!Pedometer.isSupported()) {
        content.innerHTML = `
          <div class="pedometer-not-supported">
            <span class="material-icons">directions_walk_off</span>
            <div>Шагомер не поддерживается вашим устройством</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">
              Для работы шагомера требуется устройство с акселерометром
            </div>
          </div>
        `;
        overlay.classList.add('active');
        return;
      }
      
      // Инициализируем шагомер
      Pedometer.initialize();
      const stats = Pedometer.getStats();
      
      content.innerHTML = `
        <div class="pedometer-stats">
          <div class="pedometer-stat">
            <div class="stat-value">${stats.today}</div>
            <div class="stat-label">ШАГОВ СЕГОДНЯ</div>
            <div class="stat-subvalue">${stats.distanceToday.toFixed(2)} км</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.week}</div>
            <div class="stat-label">ШАГОВ ЗА НЕДЕЛЮ</div>
            <div class="stat-subvalue">${(stats.week * 0.00076).toFixed(2)} км</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.month}</div>
            <div class="stat-label">ШАГОВ ЗА МЕСЯЦ</div>
            <div class="stat-subvalue">${(stats.month * 0.00076).toFixed(2)} км</div>
          </div>
          
          <div class="pedometer-goal">
            <div class="goal-title">ЦЕЛЬ НА ДЕНЬ: ${stats.goal} шагов</div>
            <div class="goal-progress-bar">
              <div class="goal-progress-fill" style="width: ${stats.goalProgress}%"></div>
            </div>
            <div class="goal-info">
              <span>0</span>
              <span>${Math.round(stats.goalProgress)}%</span>
              <span>${stats.goal}</span>
            </div>
          </div>
        </div>
        
        <div class="pedometer-actions">
          <button class="pedometer-btn btn-start" id="pedometer-start-btn">
            <span class="material-icons">play_arrow</span>
            Запустить шагомер
          </button>
          <button class="pedometer-btn btn-simulate" id="pedometer-simulate-btn">
            <span class="material-icons">shuffle</span>
            Тест (50 шагов)
          </button>
        </div>
      `;
      
      overlay.classList.add('active');
      
      // Обработчики кнопок шагомера
      document.getElementById('pedometer-start-btn')?.addEventListener('click', function() {
        showTempMessage('Шагомер запущен. Носите устройство с собой для отслеживания шагов.');
      });
      
      document.getElementById('pedometer-simulate-btn')?.addEventListener('click', function() {
        const steps = Pedometer.simulateSteps();
        showTempMessage(`Добавлено ${steps} тестовых шагов`);
        updatePedometerStats();
      });
      
      // Обработчик закрытия шагомера
      document.getElementById('pedometer-close-btn').addEventListener('click', function() {
        closePedometerWindow();
      });
      
      // Обновляем статистику каждые 5 секунд
      window.addEventListener('pedometerUpdate', updatePedometerStats);
    }
    
    function updatePedometerStats() {
      const stats = Pedometer.getStats();
      const content = document.getElementById('pedometer-content');
      
      if (content) {
        const statValues = content.querySelectorAll('.stat-value');
        const statSubvalues = content.querySelectorAll('.stat-subvalue');
        const progressFill = content.querySelector('.goal-progress-fill');
        const goalPercent = content.querySelector('.goal-info span:nth-child(2)');
        
        if (statValues[0]) statValues[0].textContent = stats.today;
        if (statValues[1]) statValues[1].textContent = stats.week;
        if (statValues[2]) statValues[2].textContent = stats.month;
        
        if (statSubvalues[0]) statSubvalues[0].textContent = stats.distanceToday.toFixed(2) + ' км';
        if (statSubvalues[1]) statSubvalues[1].textContent = (stats.week * 0.00076).toFixed(2) + ' км';
        if (statSubvalues[2]) statSubvalues[2].textContent = (stats.month * 0.00076).toFixed(2) + ' км';
        
        if (progressFill) progressFill.style.width = stats.goalProgress + '%';
        if (goalPercent) goalPercent.textContent = Math.round(stats.goalProgress) + '%';
      }
    }
    
    function closePedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      overlay.classList.remove('active');
      window.removeEventListener('pedometerUpdate', updatePedometerStats);
    }
    
    // Функции для создания встречи
    function openMeetupWindow() {
      console.log('Открытие окна создания встречи...');
      const overlay = document.getElementById('meetup-overlay');
      overlay.classList.add('active');
      loadFriendsForMeetup();
      
      // Устанавливаем дату по умолчанию (завтра в 18:00)
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(18, 0, 0, 0);
      
      const datetimeInput = document.getElementById('meetup-datetime');
      datetimeInput.value = tomorrow.toISOString().slice(0, 16);
      
      // Если есть текущая позиция пользователя, используем ее для местоположения
      if (currentUser && currentUser.position) {
        // Пробуем получить адрес по координатам
        if (typeof ymaps !== 'undefined') {
          try {
            ymaps.geocode(currentUser.position).then(function(res) {
              const firstGeoObject = res.geoObjects.get(0);
              if (firstGeoObject) {
                const address = firstGeoObject.getAddressLine();
                document.getElementById('meetup-location').value = address;
              } else {
                document.getElementById('meetup-location').value = 'Ваше текущее местоположение';
              }
            }).catch(function() {
              document.getElementById('meetup-location').value = 'Ваше текущее местоположение';
            });
          } catch (e) {
            document.getElementById('meetup-location').value = 'Ваше текущее местоположение';
          }
        } else {
          document.getElementById('meetup-location').value = 'Ваше текущее местоположение';
        }
      }
      
      // Устанавливаем тип встречи по умолчанию (приватная)
      setMeetupType('private');
    }
    
    function closeMeetupWindow() {
      console.log('Закрытие окна создания встречи...');
      const overlay = document.getElementById('meetup-overlay');
      overlay.classList.remove('active');
    }
    
    function loadFriendsForMeetup() {
      const friendsList = document.getElementById('friends-list');
      const friendsInviteSection = document.getElementById('friends-invite-section');
      const inviteMethods = document.getElementById('invite-methods');
      
      if (!currentUser) return;
      
      const friends = UserSystem.getUserFriends(currentUser.id);
      
      if (friends.length === 0) {
        friendsList.innerHTML = `
          <div style="color: var(--text-muted); font-size: 14px; text-align: center; padding: 20px;">
            У вас пока нет друзей. Добавьте друзей, чтобы пригласить их на встречу.
          </div>
        `;
        inviteMethods.style.display = 'none';
        return;
      }
      
      let friendsHTML = '';
      let onlineFriendsCount = 0;
      
      friends.forEach(friend => {
        const isOnline = friend.status === 'online';
        if (isOnline) onlineFriendsCount++;
        
        friendsHTML += `
          <label class="meetup-checkbox">
            <input type="checkbox" class="friend-checkbox" value="${friend.id}" ${meetupType === 'friends_online' && isOnline ? 'checked' : ''}>
            <span>
              ${friend.nickname || 'Пользователь'}
              <span class="friend-status ${isOnline ? 'online-status' : 'offline-status'}">
                <span class="material-icons" style="font-size: 14px;">${isOnline ? 'circle' : 'radio_button_unchecked'}</span>
                ${isOnline ? 'В сети' : 'Не в сети'}
              </span>
            </span>
          </label>
        `;
      });
      
      friendsList.innerHTML = friendsHTML;
      inviteMethods.style.display = 'flex';
      
      // Обновляем информацию о друзьях онлайн
      if (meetupType === 'friends_online') {
        const onlineInfo = document.createElement('div');
        onlineInfo.style.fontSize = '13px';
        onlineInfo.style.color = '#2CB4FF';
        onlineInfo.style.marginTop = '10px';
        onlineInfo.innerHTML = `<span class="material-icons" style="font-size: 16px; vertical-align: middle;">info</span> Автоматически выбраны ${onlineFriendsCount} друзей онлайн`;
        friendsList.appendChild(onlineInfo);
      }
      
      // Обработчики для кнопок приглашения
      document.getElementById('select-all-friends-btn').addEventListener('click', function() {
        const checkboxes = document.querySelectorAll('.friend-checkbox');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(checkbox => {
          checkbox.checked = !allChecked;
        });
        
        showTempMessage(allChecked ? 'Все друзья сняты с выбора' : 'Все друзья выбраны');
      });
      
      document.getElementById('invite-selected-btn').addEventListener('click', function() {
        const selectedFriends = getSelectedFriends();
        if (selectedFriends.length === 0) {
          showTempMessage('Выберите друзей для приглашения');
          return;
        }
        
        showTempMessage(`Приглашения отправлены ${selectedFriends.length} друзьям`);
        // Здесь будет реальная логика отправки приглашений
      });
      
      document.getElementById('invite-chat-btn').addEventListener('click', function() {
        const selectedFriends = getSelectedFriends();
        if (selectedFriends.length === 0) {
          showTempMessage('Выберите друзей для приглашения в чат');
          return;
        }
        
        sendInvitesToChat(selectedFriends);
      });
    }
    
    function getSelectedFriends() {
      const selectedFriends = [];
      document.querySelectorAll('.friend-checkbox:checked').forEach(checkbox => {
        selectedFriends.push(checkbox.value);
      });
      return selectedFriends;
    }
    
    function setMeetupType(type) {
      meetupType = type;
      
      // Обновляем активный класс у вариантов
      document.querySelectorAll('.meetup-type-option').forEach(option => {
        option.classList.remove('active');
        if (option.getAttribute('data-type') === type) {
          option.classList.add('active');
        }
      });
      
      // Обновляем видимость раздела приглашения друзей
      const friendsInviteSection = document.getElementById('friends-invite-section');
      const inviteMethods = document.getElementById('invite-methods');
      
      if (type === 'private') {
        friendsInviteSection.style.display = 'block';
        inviteMethods.style.display = 'flex';
        
        // Сбрасываем выбор друзей
        document.querySelectorAll('.friend-checkbox').forEach(checkbox => {
          checkbox.checked = false;
        });
      } else if (type === 'public') {
        friendsInviteSection.style.display = 'block';
        inviteMethods.style.display = 'none';
        
        // Выбираем всех друзей для публичной встречи
        document.querySelectorAll('.friend-checkbox').forEach(checkbox => {
          checkbox.checked = true;
        });
      } else if (type === 'friends_online') {
        friendsInviteSection.style.display = 'block';
        inviteMethods.style.display = 'flex';
        
        // Выбираем только друзей онлайн
        document.querySelectorAll('.friend-checkbox').forEach(checkbox => {
          const friendId = checkbox.value;
          const friend = UserSystem.getUserById(friendId);
          checkbox.checked = friend && friend.status === 'online';
        });
      }
      
      // Перезагружаем список друзей, чтобы обновить информацию
      loadFriendsForMeetup();
    }
    
    function sendInvitesToChat(friendIds) {
      if (!currentUser) return;
      
      const title = document.getElementById('meetup-title').value.trim();
      const location = document.getElementById('meetup-location').value.trim();
      const datetime = document.getElementById('meetup-datetime').value;
      
      if (!title || !location || !datetime) {
        showTempMessage('Заполните основные поля встречи перед отправкой приглашений');
        return;
      }
      
      let invitedCount = 0;
      
      friendIds.forEach(friendId => {
        const friend = UserSystem.getUserById(friendId);
        if (!friend) return;
        
        // Создаем или получаем чат с другом
        let chat = ChatSystem.getChatByParticipants(currentUser.id, friendId);
        if (!chat) {
          chat = ChatSystem.createChat(currentUser.id, friendId);
        }
        
        // Создаем сообщение с приглашением
        const meetupDate = new Date(datetime);
        const formattedDate = meetupDate.toLocaleDateString('ru-RU', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        const invitationMessage = `🎉 Приглашаю вас на встречу "${title}"!\n\n📅 Когда: ${formattedDate}\n📍 Где: ${location}\n\nХотите присоединиться?`;
        
        ChatSystem.sendMessage(chat.id, currentUser.id, invitationMessage);
        invitedCount++;
      });
      
      showTempMessage(`Приглашения отправлены в чаты ${invitedCount} друзьям`);
    }
    
    function createMeetup() {
      const title = document.getElementById('meetup-title').value.trim();
      const description = document.getElementById('meetup-description').value.trim();
      const location = document.getElementById('meetup-location').value.trim();
      const datetime = document.getElementById('meetup-datetime').value;
      
      // Валидация
      if (!title) {
        showTempMessage('Введите название встречи');
        return;
      }
      
      if (!location) {
        showTempMessage('Укажите местоположение встречи');
        return;
      }
      
      if (!datetime) {
        showTempMessage('Выберите дату и время встречи');
        return;
      }
      
      // Получаем выбранных друзей в зависимости от типа встречи
      let selectedFriends = [];
      
      if (meetupType === 'private') {
        selectedFriends = getSelectedFriends();
        if (selectedFriends.length === 0) {
          showTempMessage('Выберите хотя бы одного друга для приглашения');
          return;
        }
      } else if (meetupType === 'public') {
        // Для публичной встречи выбираем всех друзей
        const friends = UserSystem.getUserFriends(currentUser.id);
        selectedFriends = friends.map(f => f.id);
      } else if (meetupType === 'friends_online') {
        // Для друзей онлайн выбираем только онлайн друзей
        const friends = UserSystem.getUserFriends(currentUser.id);
        selectedFriends = friends.filter(f => f.status === 'online').map(f => f.id);
      }
      
      // Создаем объект встречи
      const meetup = {
        id: 'meetup_' + Date.now(),
        title: title,
        description: description,
        location: location,
        datetime: datetime,
        type: meetupType,
        createdBy: currentUser.id,
        createdByNickname: currentUser.nickname,
        createdAt: new Date().toISOString(),
        participants: [currentUser.id, ...selectedFriends],
        status: 'planned',
        visibility: meetupType === 'public' ? 'public' : 'private'
      };
      
      // Сохраняем встречу в localStorage
      let meetups = JSON.parse(localStorage.getItem('meetup_meetups') || '[]');
      meetups.push(meetup);
      localStorage.setItem('meetup_meetups', JSON.stringify(meetups));
      
      // Отправляем уведомления выбранным друзьям
      if (selectedFriends.length > 0) {
        selectedFriends.forEach(friendId => {
          const notification = {
            id: 'notification_' + Date.now(),
            userId: friendId,
            type: 'meetup_invitation',
            title: 'Приглашение на встречу',
            message: `${currentUser.nickname} приглашает вас на встречу "${title}"`,
            data: { meetupId: meetup.id },
            timestamp: new Date().toISOString(),
            read: false
          };
          
          // Сохраняем уведомление
          let notifications = JSON.parse(localStorage.getItem('meetup_notifications') || '[]');
          notifications.push(notification);
          localStorage.setItem('meetup_notifications', JSON.stringify(notifications));
        });
      }
      
      // Если встреча публичная, также создаем уведомление для всех пользователей
      if (meetupType === 'public') {
        const publicNotification = {
          id: 'notification_public_' + Date.now(),
          type: 'public_meetup',
          title: 'Новая публичная встреча',
          message: `Пользователь ${currentUser.nickname} создал публичную встречу "${title}"`,
          data: { meetupId: meetup.id },
          timestamp: new Date().toISOString(),
          broadcast: true
        };
        
        // Сохраняем публичное уведомление
        let publicNotifications = JSON.parse(localStorage.getItem('meetup_public_notifications') || '[]');
        publicNotifications.push(publicNotification);
        localStorage.setItem('meetup_public_notifications', JSON.stringify(publicNotifications));
      }
      
      showTempMessage(`Встреча "${title}" успешно создана! ${selectedFriends.length > 0 ? `Уведомления отправлены ${selectedFriends.length} друзьям` : 'Публичная встреча создана'}`);
      
      // Закрываем окно создания встречи
      closeMeetupWindow();
      
      // Очищаем форму
      document.getElementById('meetup-title').value = '';
      document.getElementById('meetup-description').value = '';
      document.getElementById('meetup-location').value = '';
      
      // НЕ перенаправляем на другую страницу, остаемся на карте
      // Вместо этого показываем информацию о созданной встречи
      showMeetupCreatedNotification(meetup);
    }
    
    function showMeetupCreatedNotification(meetup) {
      const notification = document.createElement('div');
      notification.className = 'nearby-notification';
      notification.innerHTML = `
        <span class="material-icons">event_available</span>
        <div>
          <strong>Встреча создана!</strong><br>
          "${meetup.title}" успешно создана
        </div>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
          <span class="material-icons">close</span>
        </button>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) notification.remove();
      }, 5000);
    }
    
    // Функции для маршрутов друзей
    function loadFriendRoutes() {
      if (!currentUser) return;
      
      const savedRoutes = JSON.parse(localStorage.getItem('meetup_friend_routes') || '{}');
      friendRoutes.clear();
      
      const friends = UserSystem.getUserFriends(currentUser.id);
      friends.forEach(friend => {
        if (savedRoutes[friend.id]) {
          friendRoutes.set(friend.id, savedRoutes[friend.id]);
        }
      });
      
      updateFriendRoutes();
    }
    
    function updateFriendRoutes() {
      if (!map || typeof ymaps === 'undefined' || !showFriendRoutes) return;
      
      friendRoutes.forEach((routeData, friendId) => {
        if (routeData.polyline && map.geoObjects.indexOf(routeData.polyline) !== -1) {
          map.geoObjects.remove(routeData.polyline);
        }
      });
      
      if (!showFriendRoutes) return;
      
      const friends = UserSystem.getUserFriends(currentUser.id);
      friends.forEach(friend => {
        if (friend.id === currentUser.id || !friend.position || !friend.routeTo) return;
        
        const polyline = new ymaps.Polyline(
          [friend.position, friend.routeTo],
          {},
          {
            strokeColor: '#34eb8944',
            strokeWidth: 3,
            strokeOpacity: 0.7,
            hintContent: `Маршрут ${friend.nickname}`
          }
        );
        
        if (friendRoutes.has(friend.id)) {
          friendRoutes.get(friend.id).polyline = polyline;
        } else {
          friendRoutes.set(friend.id, {
            polyline: polyline,
            destination: friend.routeToName || 'Неизвестно'
          });
        }
        
        map.geoObjects.add(polyline);
      });
    }
    
    function showRouteToFriend(friendId) {
      if (!map || !currentUser || !currentUser.position || typeof ymaps === 'undefined') {
        showTempMessage('Не удалось построить маршрут');
        return;
      }
      
      const friend = UserSystem.getUserById(friendId);
      if (!friend || !friend.position) {
        showTempMessage('Друг не найден или у него не указано местоположение');
        return;
      }
      
      clearRoute();
      
      const startPoint = currentUser.position;
      const endPoint = friend.position;
      
      buildRouteWithYmaps(startPoint, endPoint, 'auto', friend.nickname || 'Друг');
      showRouteInfo(friend.nickname || 'Друг');
      showTempMessage(`Строим маршрут до ${friend.nickname}`);
    }
    
    function clearRoute() {
      if (routeMultiRoute) {
        map.geoObjects.remove(routeMultiRoute);
        routeMultiRoute = null;
      }
      
      if (routePolyline) {
        map.geoObjects.remove(routePolyline);
        routePolyline = null;
      }
      
      currentRoute = null;
      document.getElementById('btn-clear-route').style.display = 'none';
      document.getElementById('route-info-panel').classList.remove('active');
    }
    
    function showRouteInfo(destinationName) {
      document.getElementById('route-to').textContent = destinationName;
      document.getElementById('route-info-panel').classList.add('active');
    }
    
    function shareCurrentRoute() {
      if (!currentRoute) {
        showTempMessage('Нет активного маршрута для sharing');
        return;
      }
      
      if (currentUser) {
        const userData = UserSystem.getUsers();
        const userIndex = userData.findIndex(u => u.id === currentUser.id);
        
        if (userIndex !== -1) {
          userData[userIndex].routeTo = currentRoute.end;
          userData[userIndex].routeToName = currentRoute.destination;
          UserSystem.saveUsers(userData);
          currentUser = userData[userIndex];
        }
        
        const savedRoutes = JSON.parse(localStorage.getItem('meetup_friend_routes') || '{}');
        savedRoutes[currentUser.id] = {
          destination: currentRoute.destination,
          timestamp: new Date().toISOString()
        };
        localStorage.setItem('meetup_friend_routes', JSON.stringify(savedRoutes));
      }
      
      showTempMessage('Маршрут доступен вашим друзьям!');
      updateFriendRoutes();
    }
    
    function toggleFriendRoutes() {
      showFriendRoutes = !showFriendRoutes;
      document.getElementById('show-friend-routes').checked = showFriendRoutes;
      
      if (showFriendRoutes) {
        updateFriendRoutes();
        showTempMessage('Маршруты друзей включены');
      } else {
        friendRoutes.forEach((routeData, friendId) => {
          if (routeData.polyline && map.geoObjects.indexOf(routeData.polyline) !== -1) {
            map.geoObjects.remove(routeData.polyline);
          }
        });
        showTempMessage('Маршруты друзей выключены');
      }
    }
    
    function saveDisplaySettings() {
      localStorage.setItem('meetup_display_settings', JSON.stringify(displaySettings));
    }
    
    function loadDisplaySettings() {
      const saved = localStorage.getItem('meetup_display_settings');
      if (saved) {
        displaySettings = { ...displaySettings, ...JSON.parse(saved) };
        
        document.getElementById('display-all').checked = displaySettings.all;
        document.getElementById('display-friends').checked = displaySettings.friends;
        document.getElementById('display-online').checked = displaySettings.online;
        document.getElementById('display-new').checked = displaySettings.new;
        
        const markerSelect = document.getElementById('friend-marker-select');
        if (markerSelect) {
          markerSelect.value = displaySettings.friendMarker;
          document.getElementById('friend-marker-style').textContent = 
            markerSelect.options[markerSelect.selectedIndex].text;
        }
      }
    }
    
    // ============================================
    // ИНИЦИАЛИЗАЦИЯ ОБРАБОТЧИКОВ СОБЫТИЙ
    // ============================================
    
    function initializeEventHandlers() {
      document.getElementById('btn-profile').addEventListener('click', function() {
        window.location.href = 'profile.html';
      });
      
      document.getElementById('btn-create-meetup').addEventListener('click', function() {
        console.log('Кнопка "Создать встречу" нажата');
        openMeetupWindow();
      });
      
      document.getElementById('btn-add-friend').addEventListener('click', function() {
        window.location.href = 'addfriend.html';
      });
      
      document.getElementById('btn-locate').addEventListener('click', function() {
        if (!navigator.geolocation) { return; }
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            if (currentUser) {
              UserSystem.updateUserPosition(currentUser.id, coords);
              currentUser = UserSystem.getCurrentUser();
            }
            if (map) {
              const TARGET_ZOOM = 15;
              map.setCenter(coords, TARGET_ZOOM, {
                duration: 1000,
                timingFunction: 'ease-in-out'
              });
              highlightUserLocation();
            }
          },
          (error) => {
            if (currentUser && currentUser.position && map) {
              const TARGET_ZOOM = 15;
              map.setCenter(currentUser.position, TARGET_ZOOM, {
                duration: 1000,
                timingFunction: 'ease-in-out'
              });
              highlightUserLocation();
            }
          },
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
          }
        );
      });
      
      // Чаты
      document.getElementById('btn-chat').addEventListener('click', openChatsWindow);
      document.getElementById('chat-close-btn').addEventListener('click', closeChatsWindow);
      
      // Шагомер
      document.getElementById('btn-pedometer').addEventListener('click', openPedometerWindow);
      
      // Инкогнито
      document.getElementById('btn-incognito').addEventListener('click', toggleIncognitoMode);
      
      // Отображение
      document.getElementById('btn-display-mode').addEventListener('click', function() {
        const panel = document.getElementById('display-panel');
        panel.classList.toggle('active');
      });
      
      // Обработчики для окна создания встречи
      document.getElementById('meetup-cancel-btn').addEventListener('click', closeMeetupWindow);
      document.getElementById('meetup-create-btn').addEventListener('click', createMeetup);
      
      // Обработчики выбора типа встречи
      document.querySelectorAll('.meetup-type-option').forEach(option => {
        option.addEventListener('click', function() {
          const type = this.getAttribute('data-type');
          setMeetupType(type);
        });
      });
      
      // Обработчики для маршрутов
      document.getElementById('btn-show-routes').addEventListener('click', function() {
        showFriendRoutes = !showFriendRoutes;
        this.classList.toggle('active', showFriendRoutes);
        toggleFriendRoutes();
      });
      
      document.getElementById('btn-clear-route').addEventListener('click', clearRoute);
      document.getElementById('btn-share-route').addEventListener('click', shareCurrentRoute);
      document.getElementById('btn-close-route-info').addEventListener('click', function() {
        document.getElementById('route-info-panel').classList.remove('active');
      });
      
      document.getElementById('show-friend-routes').addEventListener('change', function() {
        toggleFriendRoutes();
      });
      
      // Обработчики для карточки пользователя
      document.getElementById('user-card-close').addEventListener('click', hideUserCard);
      
      document.getElementById('user-card-chat-btn').addEventListener('click', function() {
        if (currentSelectedUser) {
          openChat(currentSelectedUser.id);
          hideUserCard();
        }
      });
      
      document.getElementById('user-card-route-btn').addEventListener('click', function() {
        if (currentSelectedUser) {
          openRouteTypeSelector(currentSelectedUser.id);
        }
      });
      
      document.getElementById('user-card-profile-btn').addEventListener('click', function() {
        if (currentSelectedUser) {
          if (currentSelectedUser.id === currentUser.id) {
            window.location.href = 'profile.html';
          } else {
            showUserProfile(currentSelectedUser.id);
          }
          hideUserCard();
        }
      });
      
      // Обработчики для выезжающего меню
      document.getElementById('balloon-menu-close').addEventListener('click', hideBalloonMenu);
      document.getElementById('balloon-menu-route-btn').addEventListener('click', buildRouteFromBalloonMenu);
      
      // Обработчики для окна выбора типа маршрута
      document.getElementById('route-type-cancel-btn').addEventListener('click', closeRouteTypeSelector);
      document.getElementById('route-type-build-btn').addEventListener('click', buildRouteToUser);
      
      // Закрытие окон при клике вне
      document.getElementById('meetup-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeMeetupWindow();
        }
      });
      
      document.getElementById('route-type-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeRouteTypeSelector();
        }
      });
      
      // Закрытие окон при нажатии Escape
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const meetupOverlay = document.getElementById('meetup-overlay');
          if (meetupOverlay.classList.contains('active')) {
            closeMeetupWindow();
          }
          
          const routeTypeOverlay = document.getElementById('route-type-overlay');
          if (routeTypeOverlay.classList.contains('active')) {
            closeRouteTypeSelector();
          }
          
          const userCard = document.getElementById('user-card');
          if (userCard.classList.contains('active')) {
            hideUserCard();
          }
          
          const balloonMenu = document.getElementById('balloon-menu');
          if (balloonMenu.classList.contains('active')) {
            hideBalloonMenu();
          }
        }
      });
    }
    
    function adjustLayout() {
      const header = document.querySelector('.app-header');
      const mapContainer = document.querySelector('.map-container');
      if (header && mapContainer) {
        const headerHeight = header.offsetHeight;
        mapContainer.style.height = `calc(100vh - ${headerHeight}px)`;
      }
    }
    
    function initializeApp() {
      console.log('Инициализация приложения...');
      currentUser = UserSystem.getCurrentUser();
      if (!currentUser) {
        console.log('Пользователь не авторизован, перенаправление...');
        window.location.href = 'index.html';
        return;
      }
      
      console.log('Пользователь авторизован:', currentUser.nickname);
      
      // Загружаем настройки фильтров
      const savedFilters = localStorage.getItem('meetup_map_filters');
      if (savedFilters) {
        filterSettings = { ...filterSettings, ...JSON.parse(savedFilters) };
        document.getElementById('filter-friends').checked = filterSettings.friends;
        document.getElementById('filter-online').checked = filterSettings.online;
        document.getElementById('filter-nearby').checked = filterSettings.nearby;
        document.getElementById('filter-new').checked = filterSettings.new;
        document.getElementById('radius-slider').value = filterSettings.radius;
        document.getElementById('radius-value').textContent = filterSettings.radius;
      }
      
      // Загружаем настройки отображения
      loadDisplaySettings();
      
      // Инициализируем кнопку инкогнито
      updateIncognitoButton();
      
      // Загружаем настройки маршрутов
      showFriendRoutes = localStorage.getItem('meetup_show_friend_routes') !== 'false';
      document.getElementById('show-friend-routes').checked = showFriendRoutes;
      
      adjustLayout();
      initializeEventHandlers();
      setTimeout(initializeMap, 500);
      
      updateChatNotificationCount();
      setInterval(updateChatNotificationCount, 30000);
      
      window.addEventListener('resize', adjustLayout);
      window.addEventListener('orientationchange', function() {
        setTimeout(adjustLayout, 300);
      });
    }
    
    function saveFilterSettings() {
      localStorage.setItem('meetup_map_filters', JSON.stringify(filterSettings));
    }
    
    window.addEventListener('beforeunload', function() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      saveFilterSettings();
      saveDisplaySettings();
      localStorage.setItem('meetup_show_friend_routes', showFriendRoutes);
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM загружен, запуск приложения...');
      setTimeout(initializeApp, 100);
    });
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(initializeApp, 100);
    }
  </script>
</body>
</html>
