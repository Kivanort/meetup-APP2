<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>Карта друзей — MeetUP</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="userSystem.js"></script>
  <script src="chatSystem.js"></script>
  <script src="pedometer.js"></script>
  <script src="notifications.js"></script>
  <link rel="icon" href="meetup-logo.png" type="image/x-icon">  
  <style>
    :root {
      --main-bg: #0B1222;
      --container: #181F31;
      --primary: #2CB4FF;
      --primary-gradient: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      --neon-glow: #00FFFF;
      --text-light: #fff;
      --text-muted: #9FAFD4;
      --meeting-color: #FF6B6B;
      --meeting-gradient: linear-gradient(135deg, #FF6B6B 0%, #FFD166 100%);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--main-bg);
      color: var(--text-light);
      overflow: hidden;
    }
    #app-root {
      height: 100vh;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }
    .app-header { background: var(--container); box-shadow: 0 2px 20px rgba(0,0,0,0.3); position: relative; z-index: 10; flex-shrink: 0;}
    .header-content { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px;}
    .logo-title { display: flex; align-items: center; gap: 12px;}
    .app-logo { font-size: 24px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .app-subtitle { color: var(--text-muted); font-size: 14px; }
    .header-actions { display: flex; gap: 10px; }
    .profile-btn { width: 50px; height: 50px; border: none; border-radius: 50%; background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
    .profile-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.6);}
    .profile-btn:active { transform: scale(0.95); box-shadow: 0 0 30px rgba(0,255,255,0.8);}
    .map-container { flex: 1; position: relative; overflow: hidden; }
    #map { width: 100%; height: 100%; background: #131827; }
    .map-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #131827; color: var(--text-muted); gap: 15px; position: absolute; top: 0; left: 0; z-index: 20;}
    .map-placeholder.hidden { display: none;}
    .floating-buttons { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 15px; padding: 0 20px; z-index: 5; }
    .fab-primary { padding: 16px 20px; background: var(--primary-gradient); border: none; border-radius: 16px; color: white; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; min-height: 54px; white-space: nowrap;}
    .fab-primary:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(44,180,255,0.6);}
    .fab-primary:active { transform: scale(0.95);}
    .fab-secondary { width: 54px; height: 54px; border: none; border-radius: 50%; background: var(--container); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s ease;}
    .fab-secondary:hover { transform: scale(1.05); background: var(--primary); color: white;}
    .fab-secondary:active { transform: scale(0.95);}
    .fab-meeting { width: 54px; height: 54px; border: none; border-radius: 50%; background: var(--meeting-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(255,107,107,0.4); transition: all 0.3s ease; animation: pulse 2s infinite;}
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(255,107,107,0.7); }
      70% { box-shadow: 0 0 0 15px rgba(255,107,107,0); }
      100% { box-shadow: 0 0 0 0 rgba(255,107,107,0); }
    }
    .fab-meeting:hover { transform: scale(1.1); animation: none; box-shadow: 0 0 20px rgba(255,107,107,0.8);}
    .fab-meeting:active { transform: scale(0.95);}
    .temp-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 20px; border-radius: 12px; font-size: 14px; z-index: 1000; backdrop-filter: blur(10px); text-align: center; max-width: 80%;}
    .map-controls { position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
    .map-filter-btn { width: 54px; height: 54px; border-radius: 50%; background: var(--container); border: 2px solid var(--primary); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    .map-filter-btn:hover { background: var(--primary); color: white; transform: scale(1.1);}
    .map-filter-btn.active { background: var(--primary); color: white;}
    .filter-panel { position: absolute; top: 70px; right: 20px; background: var(--container); border-radius: 12px; padding: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 99; display: none; min-width: 200px;}
    .filter-panel.active { display: block; animation: slideIn 0.3s ease;}
    @keyframes slideIn {from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);}}
    .filter-option { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: var(--text-light); font-size: 14px; cursor: pointer;}
    .filter-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary);}
    .nearby-notification { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 8px 24px rgba(44,180,255,0.3); z-index: 1000; display: flex; align-items: center; gap: 10px; animation: slideUp 0.5s ease; max-width: 90%;}
    @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(30px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .auto-update-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); color: #34eb89; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; z-index: 100; backdrop-filter: blur(10px);}
    .notification-badge { position: absolute; top: -5px; right: -5px; background: #FF4444; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    /* Панель отображения */
    .display-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 220px;
    }
    .display-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    /* Окно чатов - ИСПРАВЛЕНО */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .chat-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .chat-container {
      width: 90%;
      max-width: 400px;
      height: 80%;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }
    .chat-close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .chat-item {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
      position: relative;
    }
    .chat-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2a2a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
    }
    .chat-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    .chat-friend-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    .chat-last-message {
      font-size: 14px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }
    .chat-status {
      font-size: 12px;
      color: #34eb89;
    }
    .chat-unread {
      background: var(--primary);
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 14px;
    }
    
    /* Стили для общего чата */
    .global-chat-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--primary);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }
    
    .chat-item.global-chat {
      border: 2px solid var(--primary);
    }
    
    /* Окно шагомера */
    .pedometer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .pedometer-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .pedometer-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .pedometer-header {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      padding: 25px;
      text-align: center;
    }
    .pedometer-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    .pedometer-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .pedometer-content {
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .pedometer-stats {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .pedometer-stat {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #34eb89;
    }
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    .stat-subvalue {
      font-size: 16px;
      color: #2CB4FF;
      margin-top: 5px;
    }
    .pedometer-goal {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
    }
    .goal-title {
      font-size: 16px;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }
    .goal-progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34eb89, #08e7bd);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    .goal-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }
    .pedometer-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .pedometer-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-start {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      color: white;
    }
    .btn-simulate {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      color: white;
    }
    .btn-close {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .pedometer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .pedometer-not-supported {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .pedometer-not-supported .material-icons {
      font-size: 60px;
      color: #FF4444;
      margin-bottom: 20px;
    }
    
    /* Кнопка фильтров справа вверху */
    .map-controls-top {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* Фильтр и обновление теперь сверху слева */
    .map-filter-btn-left {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid var(--primary);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .map-filter-btn-left:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    /* Стиль для метки призрака на карте */
    .ghost-marker {
      filter: grayscale(100%) brightness(150%);
    }
    
    /* Окно создания встречи */
    .meeting-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      backdrop-filter: blur(10px);
    }
    .meeting-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .meeting-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      display: flex;
      flex-direction: column;
      animation: slideUpMeeting 0.4s ease;
    }
    @keyframes slideUpMeeting {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .meeting-header {
      background: var(--meeting-gradient);
      padding: 25px;
      text-align: center;
    }
    .meeting-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    .meeting-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.9);
    }
    .meeting-content {
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .meeting-form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meeting-label {
      font-size: 14px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .meeting-input, .meeting-textarea, .meeting-select, .meeting-datetime {
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: white;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .meeting-input:focus, .meeting-textarea:focus, .meeting-select:focus, .meeting-datetime:focus {
      outline: none;
      border-color: var(--meeting-color);
      box-shadow: 0 0 0 2px rgba(255,107,107,0.2);
    }
    .meeting-textarea {
      min-height: 100px;
      resize: vertical;
    }
    .meeting-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .meeting-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-create-meeting {
      background: var(--meeting-gradient);
      color: white;
    }
    .btn-cancel-meeting {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .meeting-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .meeting-btn:active {
      transform: translateY(0);
    }
    .meeting-privacy {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
    .meeting-privacy-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 15px;
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    .meeting-privacy-option.selected {
      background: rgba(255,107,107,0.1);
      border-color: var(--meeting-color);
    }
    .meeting-privacy-option:hover {
      background: rgba(255,255,255,0.1);
    }
    .meeting-privacy-icon {
      font-size: 24px;
      color: var(--text-muted);
    }
    .meeting-privacy-option.selected .meeting-privacy-icon {
      color: var(--meeting-color);
    }
    .meeting-privacy-text {
      font-size: 12px;
      text-align: center;
    }
    
    /* Панель встреч */
    .meetings-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 300px;
      max-height: 500px;
      overflow-y: auto;
    }
    .meetings-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    .meetings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .meetings-title {
      font-size: 18px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .meeting-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .meeting-item {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
      padding: 15px;
      border-left: 4px solid var(--meeting-color);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .meeting-item:hover {
      background: rgba(255,107,107,0.1);
      transform: translateX(-2px);
    }
    .meeting-item.my-meeting {
      border-left-color: #34eb89;
    }
    .meeting-item-title {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    .meeting-item-host {
      font-size: 12px;
      color: var(--meeting-color);
      background: rgba(255,107,107,0.1);
      padding: 2px 8px;
      border-radius: 10px;
    }
    .meeting-item-description {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .meeting-item-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .meeting-detail {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .meeting-participants {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .participant-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #2a2a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
    }
    .meeting-actions-small {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }
    .meeting-btn-small {
      flex: 1;
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .btn-join {
      background: rgba(52,235,137,0.2);
      color: #34eb89;
    }
    .btn-leave {
      background: rgba(255,68,68,0.2);
      color: #FF4444;
    }
    .btn-chat {
      background: rgba(44,180,255,0.2);
      color: #2CB4FF;
    }
    .meeting-btn-small:hover {
      transform: translateY(-1px);
    }
    .no-meetings {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
      font-size: 14px;
    }
    .create-meeting-btn {
      width: 100%;
      padding: 12px;
      background: var(--meeting-gradient);
      border: none;
      border-radius: 10px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 15px;
      transition: all 0.3s ease;
    }
    .create-meeting-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255,107,107,0.3);
    }
    
    @media (max-width: 768px) {
      .header-content {padding: 12px 15px;}
      .app-logo {font-size: 20px;}
      .app-subtitle {font-size: 13px;}
      .profile-btn {width: 45px; height: 45px;}
      .fab-primary {padding: 14px 18px; font-size: 14px; min-height: 50px; border-radius: 14px;}
      .fab-secondary {width: 50px; height: 50px;}
      .fab-meeting {width: 50px; height: 50px;}
      .floating-buttons {bottom: 15px; padding: 0 15px; gap: 12px;}
      .map-controls {top: 15px; right: 15px;}
      .map-filter-btn {width: 50px; height: 50px;}
      .map-controls-top {top: 15px; left: 15px;}
      .map-filter-btn-left {width: 50px; height: 50px;}
      .filter-panel {top: 60px; right: 15px; min-width: 180px;}
      .display-panel {top: 60px; right: 15px; min-width: 180px;}
      .meetings-panel {top: 60px; right: 15px; min-width: 280px;}
      .meeting-container {width: 95%;}
    }
    @media (max-width: 480px) {
      .header-content {padding: 10px 12px;}
      .logo-title {gap: 8px;}
      .app-logo {font-size: 18px;}
      .app-subtitle {display: none;}
      .profile-btn {width: 42px; height: 42px;}
      .profile-btn .material-icons {font-size: 20px;}
      .fab-primary span:last-child {display: none;}
      .fab-primary {padding: 12px 15px; min-height: 48px; border-radius: 12px;}
      .fab-secondary {width: 48px; height: 48px;}
      .fab-meeting {width: 48px; height: 48px;}
      .floating-buttons {bottom: 12px; padding: 0 12px;}
      .map-controls {top: 10px; right: 10px;}
      .map-filter-btn {width: 45px; height: 45px;}
      .map-controls-top {top: 10px; left: 10px;}
      .map-filter-btn-left {width: 45px; height: 45px;}
      .pedometer-content {padding: 20px;}
      .stat-value {font-size: 28px;}
      .meeting-content {padding: 20px;}
      .meeting-actions {flex-direction: column;}
      .meeting-privacy {flex-direction: column;}
    }
  </style>
</head>
<body>
  <div id="app-root">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-title">
          <div class="app-logo">meetup</div>
          <div class="app-subtitle">Карта друзей</div>
        </div>
        <div class="header-actions">
          <button class="profile-btn" id="btn-profile" title="Профиль">
            <span class="material-icons">person</span>
            <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
          </button>
        </div>
      </div>
    </header>
    <div class="map-container">
      <div id="map"></div>
      <div class="map-placeholder" id="map-placeholder">
        <span class="material-icons" style="font-size: 64px; opacity: 0.5;">map</span>
        <div>Загрузка карты...</div>
      </div>
      
      <!-- Контролы карты справа (инкогнито, шагомер, чаты, отображение, встречи) -->
      <div class="map-controls">
        <button class="map-filter-btn" id="btn-chat" title="Чаты с друзьями">
          <span class="material-icons">chat</span>
          <div class="notification-badge" id="chat-notification-badge" style="display: none;">0</div>
        </button>
        
        <button class="map-filter-btn" id="btn-pedometer" title="Шагомер">
          <span class="material-icons">directions_walk</span>
        </button>
        
        <button class="map-filter-btn" id="btn-meetings" title="Встречи">
          <span class="material-icons">event</span>
          <div class="notification-badge" id="meetings-notification-badge" style="display: none;">0</div>
        </button>
        
        <button class="map-filter-btn" id="btn-incognito" title="Режим инкогнито">
          <span class="material-icons" id="incognito-icon">visibility_off</span>
        </button>
        
        <button class="map-filter-btn" id="btn-display-mode" title="Отображение пользователей">
          <span class="material-icons">people</span>
        </button>
      </div>
      
      <!-- Контролы карты слева (фильтры и обновление) -->
      <div class="map-controls-top">
        <button class="map-filter-btn-left" id="btn-filter" title="Фильтры карты">
          <span class="material-icons">filter_list</span>
        </button>
        <button class="map-filter-btn-left" id="btn-refresh" title="Обновить карту">
          <span class="material-icons">refresh</span>
        </button>
      </div>
      
      <!-- Панель фильтров -->
      <div class="filter-panel" id="filter-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">Фильтры карты</h4>
        <label class="filter-option">
          <input type="checkbox" id="filter-friends" checked>
          <span>Друзья</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-online" checked>
          <span>Только онлайн</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-nearby" checked>
          <span>Рядом со мной</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-new" checked>
          <span>Новые пользователи</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-meetings" checked>
          <span>Показать встречи</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            Радиус поиска: <span id="radius-value">5</span> км
          </label>
          <input type="range" id="radius-slider" min="1" max="50" value="5" style="width: 100%;">
        </div>
      </div>
      
      <!-- Панель отображения -->
      <div class="display-panel" id="display-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">Отображение пользователей</h4>
        <label class="filter-option">
          <input type="checkbox" id="display-all" checked>
          <span>Все пользователи</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-friends" checked>
          <span>Только друзья</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-online" checked>
          <span>Только онлайн</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-new" checked>
          <span>Новые пользователи</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            Маркеры друзей: <span id="friend-marker-style">синий</span>
          </label>
          <select id="friend-marker-select" style="width: 100%; padding: 8px; border-radius: 6px; background: var(--container); color: white; border: 1px solid var(--primary);">
            <option value="blue">Синий</option>
            <option value="green">Зеленый</option>
            <option value="red">Красный</option>
            <option value="purple">Фиолетовый</option>
            <option value="gold">Золотой</option>
          </select>
        </div>
      </div>
      
      <!-- Панель встреч -->
      <div class="meetings-panel" id="meetings-panel">
        <div class="meetings-header">
          <div class="meetings-title">
            <span class="material-icons">event</span>
            Активные встречи
          </div>
          <button class="material-icons" style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px;" id="close-meetings-panel">close</button>
        </div>
        <div class="meeting-list" id="meeting-list">
          <!-- Список встреч будет загружен динамически -->
        </div>
        <button class="create-meeting-btn" id="create-meeting-from-panel">
          <span class="material-icons">add</span>
          Создать встречу
        </button>
      </div>
      
      <!-- Основные плавающие кнопки в центре снизу -->
      <div class="floating-buttons">
        <button class="fab-secondary" id="btn-locate" title="Мое местоположение">
          <span class="material-icons">navigation</span>
        </button>
        <button class="fab-meeting" id="btn-create-meeting" title="Создать встречу">
          <span class="material-icons">add</span>
        </button>
        <button class="fab-primary" id="btn-add-friend">
          <span class="material-icons">person_add</span>
          <span>Добавить друга</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Индикатор автообновления -->
  <div class="auto-update-indicator" id="auto-update-indicator" style="display: none;">
    <span class="material-icons" style="font-size: 16px;">autorenew</span>
    <span>Автообновление: <span id="update-timer">30</span>с</span>
  </div>
  
  <!-- Окно чатов -->
  <div class="chat-overlay" id="chat-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">Чаты</div>
        <button class="chat-close-btn" id="chat-close-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="chat-list" id="chat-list">
        <!-- Чаты будут загружены динамически -->
      </div>
    </div>
  </div>
  
  <!-- Окно шагомера -->
  <div class="pedometer-overlay" id="pedometer-overlay">
    <div class="pedometer-container">
      <div class="pedometer-header">
        <div class="pedometer-title">Шагомер</div>
        <div class="pedometer-subtitle">Отслеживайте вашу активность</div>
      </div>
      <div class="pedometer-content" id="pedometer-content">
        <!-- Контент шагомера будет загружен динамически -->
      </div>
      <div class="pedometer-actions" style="padding: 0 30px 30px 30px;">
        <button class="pedometer-btn btn-close" id="pedometer-close-btn">
          <span class="material-icons">close</span>
          Закрыть
        </button>
      </div>
    </div>
  </div>
  
  <!-- Окно создания встречи -->
  <div class="meeting-overlay" id="meeting-overlay">
    <div class="meeting-container">
      <div class="meeting-header">
        <div class="meeting-title">Создать встречу</div>
        <div class="meeting-subtitle">Пригласите друзей на мероприятие</div>
      </div>
      <div class="meeting-content">
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">title</span>
            Название встречи
          </label>
          <input type="text" class="meeting-input" id="meeting-title" placeholder="Например: Игра в пинг-понг" maxlength="50">
        </div>
        
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">description</span>
            Описание
          </label>
          <textarea class="meeting-textarea" id="meeting-description" placeholder="Опишите детали встречи..."></textarea>
        </div>
        
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">location_on</span>
            Местоположение
          </label>
          <div style="display: flex; gap: 10px;">
            <input type="text" class="meeting-input" id="meeting-location" placeholder="Адрес или место" style="flex: 1;">
            <button class="meeting-btn" id="btn-use-current-location" style="padding: 8px 12px; font-size: 12px;">
              <span class="material-icons">my_location</span>
            </button>
          </div>
        </div>
        
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">event</span>
            Дата и время
          </label>
          <input type="datetime-local" class="meeting-datetime" id="meeting-datetime">
        </div>
        
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">group</span>
            Максимальное количество участников
          </label>
          <select class="meeting-select" id="meeting-max-participants">
            <option value="2">2 человека</option>
            <option value="5" selected>5 человек</option>
            <option value="10">10 человек</option>
            <option value="20">20 человек</option>
            <option value="50">50 человек</option>
            <option value="100">100 человек</option>
          </select>
        </div>
        
        <div class="meeting-form-group">
          <label class="meeting-label">
            <span class="material-icons">visibility</span>
            Приватность встречи
          </label>
          <div class="meeting-privacy">
            <div class="meeting-privacy-option" data-privacy="public">
              <span class="material-icons meeting-privacy-icon">public</span>
              <span class="meeting-privacy-text">Публичная</span>
            </div>
            <div class="meeting-privacy-option selected" data-privacy="friends">
              <span class="material-icons meeting-privacy-icon">group</span>
              <span class="meeting-privacy-text">Только друзья</span>
            </div>
            <div class="meeting-privacy-option" data-privacy="private">
              <span class="material-icons meeting-privacy-icon">lock</span>
              <span class="meeting-privacy-text">Приватная</span>
            </div>
          </div>
        </div>
        
        <div class="meeting-actions">
          <button class="meeting-btn btn-cancel-meeting" id="cancel-meeting-btn">
            <span class="material-icons">close</span>
            Отмена
          </button>
          <button class="meeting-btn btn-create-meeting" id="confirm-meeting-btn">
            <span class="material-icons">check</span>
            Создать встречу
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Основные переменные приложения
    function showTempMessage(message, duration = 3000) {
      const existingMessage = document.querySelector('.temp-message');
      if (existingMessage) existingMessage.remove();
      const messageEl = document.createElement('div');
      messageEl.className = 'temp-message';
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      setTimeout(() => { if (messageEl.parentNode) messageEl.remove(); }, duration);
    }
    
    let isMapsApiLoading = false;
    let mapsApiLoadCallbacks = [];
    
    // Загрузка Яндекс Карт API - УПРОЩЕННАЯ ВЕРСИЯ
    function loadYandexMapsAPI() {
      return new Promise((resolve, reject) => {
        if (typeof ymaps !== 'undefined') { 
          resolve(ymaps); 
          return; 
        }
        
        // Создаем скрипт
        const script = document.createElement('script');
        script.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=ваш_ключ_апи_здесь';
        script.async = true;
        
        script.onload = () => {
          if (typeof ymaps !== 'undefined') {
            ymaps.ready(() => {
              resolve(ymaps);
            });
          } else {
            reject(new Error('Yandex Maps API не загрузился'));
          }
        };
        
        script.onerror = () => {
          reject(new Error('Не удалось загрузить Яндекс Карты'));
        };
        
        document.head.appendChild(script);
      });
    }
    
    let map = null;
    let currentUser = null;
    let friendsClusterer = null;
    let usersClusterer = null;
    let meetingsClusterer = null;
    let autoUpdateInterval = null;
    let updateTimer = 30;
    let isIncognitoMode = false;
    let filterSettings = { friends: true, online: true, nearby: true, new: true, meetings: true, radius: 5 };
    let displaySettings = {
      all: true,
      friends: true,
      online: true,
      new: true,
      friendMarker: 'blue'
    };
    let meetingPrivacy = 'friends';
    
    // Переменная для метки текущего пользователя
    let currentUserPlacemark = null;
    // Переменные для системы встреч
    let meetings = [];
    let meetingPlacemarks = [];
    
    // Инициализация карты - УПРОЩЕННАЯ ВЕРСИЯ
    function initializeMap() {
      const mapElement = document.getElementById('map');
      const placeholder = document.getElementById('map-placeholder');
      
      // Проверяем авторизацию
      currentUser = UserSystem.getCurrentUser();
      if (!currentUser) {
        showTempMessage('Пользователь не авторизован');
        window.location.href = 'index.html';
        return;
      }
      
      // Инициализируем общий чат
      initializeGlobalChat();
      
      // Загружаем встречи
      meetings = getMeetings();
      
      // Пытаемся загрузить Яндекс Карты
      loadYandexMapsAPI()
        .then(ymaps => {
          console.log('✅ Яндекс Карты успешно загружены');
          
          // Скрываем плейсхолдер
          placeholder.classList.add('hidden');
          
          // Получаем позицию пользователя или используем Москву по умолчанию
          const userPosition = currentUser.position || [55.751244, 37.618423];
          
          // Создаем карту
          map = new ymaps.Map('map', {
            center: userPosition,
            zoom: 12,
            controls: []
          });
          
          // Добавляем базовые контролы
          map.controls.add('zoomControl');
          map.controls.add('typeSelector');
          
          // Инициализируем кластеризаторы
          friendsClusterer = new ymaps.Clusterer();
          usersClusterer = new ymaps.Clusterer();
          meetingsClusterer = new ymaps.Clusterer();
          
          // Обновляем карту
          updateMap();
          
          // Запускаем автообновление
          startAutoUpdate();
          
        })
        .catch(error => {
          console.error('❌ Ошибка загрузки карты:', error);
          // Показываем сообщение об ошибке
          placeholder.innerHTML = `
            <span class="material-icons" style="font-size: 64px; opacity: 0.5;">error</span>
            <div>Карта временно недоступна</div>
            <div style="font-size: 14px; margin-top: 10px; color: #888;">Вы можете использовать другие функции приложения</div>
            <button onclick="location.reload()" style="
              margin-top: 15px;
              padding: 10px 20px;
              background: var(--primary-gradient);
              border: none;
              border-radius: 8px;
              color: white;
              cursor: pointer;
            ">Попробовать снова</button>
          `;
        });
    }
    
    // Функции для работы с встречами (упрощенные)
    function getMeetings() {
      try {
        const meetingsData = localStorage.getItem('meetup_meetings');
        return meetingsData ? JSON.parse(meetingsData) : [];
      } catch (e) {
        return [];
      }
    }
    
    // Функция для обновления кнопки инкогнито
    function updateIncognitoButton() {
      const btn = document.getElementById('btn-incognito');
      const icon = document.getElementById('incognito-icon');
      
      if (isIncognitoMode) {
        btn.classList.add('active');
        btn.title = 'Режим инкогнито включен';
        icon.textContent = 'visibility_off';
      } else {
        btn.classList.remove('active');
        btn.title = 'Режим инкогнито';
        icon.textContent = 'visibility_off';
      }
    }
    
    // Обновление карты
    function updateMap() {
      if (!map || !currentUser) return;
      
      // Очищаем карту
      map.geoObjects.removeAll();
      
      // Добавляем метку текущего пользователя
      if (currentUser.position && !isIncognitoMode) {
        const userPlacemark = new ymaps.Placemark(
          currentUser.position,
          {
            hintContent: 'Вы здесь',
            balloonContent: `<strong>${currentUser.nickname || 'Вы'}</strong><br>Ваше местоположение`
          },
          {
            preset: 'islands#blueCircleDotIcon',
            iconColor: '#2CB4FF'
          }
        );
        map.geoObjects.add(userPlacemark);
      }
      
      // Получаем всех пользователей
      const allUsers = UserSystem.getUsers();
      const friends = UserSystem.getUserFriends(currentUser.id);
      const friendIds = friends.map(f => f.id);
      
      // Добавляем метки других пользователей
      allUsers.forEach(user => {
        if (user.id === currentUser.id || !user.position) return;
        if (user.invisible && !isIncognitoMode) return;
        
        const isFriend = friendIds.includes(user.id);
        const isOnline = user.status === 'online';
        
        let preset = 'islands#grayCircleDotIcon';
        let iconColor = isOnline ? '#A4B0BE' : '#666666';
        
        if (isFriend) {
          preset = 'islands#blueCircleDotIcon';
          iconColor = isOnline ? '#2CB4FF' : '#1a5a7a';
        }
        
        const placemark = new ymaps.Placemark(
          user.position,
          {
            hintContent: user.nickname || 'Пользователь',
            balloonContent: `
              <div style="padding: 10px; min-width: 200px;">
                <strong>${user.nickname || 'Пользователь'}</strong><br>
                ${isFriend ? '✓ Друг' : 'Пользователь'} • ${isOnline ? 'В сети' : 'Не в сети'}<br>
                <button onclick="openChat('${user.id}')" style="
                  margin-top: 10px;
                  padding: 5px 10px;
                  background: ${isFriend ? '#34eb89' : '#2CB4FF'};
                  color: white;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                ">
                  ${isFriend ? 'Написать' : 'Добавить в друзья'}
                </button>
              </div>
            `
          },
          { preset, iconColor }
        );
        
        if (isFriend) {
          friendsClusterer.add(placemark);
        } else {
          usersClusterer.add(placemark);
        }
      });
      
      // Добавляем кластеризаторы на карту
      map.geoObjects.add(friendsClusterer);
      map.geoObjects.add(usersClusterer);
    }
    
    function calculateDistance(pos1, pos2) {
      if (!pos1 || !pos2) return Infinity;
      const [lat1, lon1] = pos1;
      const [lat2, lon2] = pos2;
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function addFriend(userId) {
      if (!currentUser) return;
      if (UserSystem.sendFriendRequest(currentUser.id, userId)) {
        showTempMessage('Запрос в друзья отправлен!');
        updateMap();
      } else {
        showTempMessage('Не удалось отправить запрос');
      }
    }
    
    function startAutoUpdate() {
      const autoUpdate = localStorage.getItem('meetup_auto_update') !== 'false';
      if (autoUpdate) {
        document.getElementById('auto-update-indicator').style.display = 'flex';
        updateTimer = 30;
        autoUpdateInterval = setInterval(() => {
          updateTimer--;
          document.getElementById('update-timer').textContent = updateTimer;
          if (updateTimer <= 0) {
            updateLocation();
            updateTimer = 30;
          }
        }, 1000);
      }
    }
    
    function updateLocation() {
      if (!currentUser || !navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        position => {
          const coords = [position.coords.latitude, position.coords.longitude];
          UserSystem.updateUserPosition(currentUser.id, coords);
          currentUser = UserSystem.getCurrentUser();
          updateMap();
        },
        error => {
          console.log('📍 Геолокация недоступна');
        },
        { enableHighAccuracy: false, timeout: 5000 }
      );
    }
    
    function getRussianPlural(number, forms) {
      const cases = [2, 0, 1, 1, 1, 2];
      return forms[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
    }
    
    function highlightUserLocation() {
      if (!currentUser || !currentUser.position || !map || typeof ymaps === 'undefined') return;
      // Просто центрируем карту на пользователе
      map.setCenter(currentUser.position, 15);
    }
    
    function toggleIncognitoMode() {
      isIncognitoMode = !isIncognitoMode;
      
      updateIncognitoButton();
      
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex !== -1) {
        users[userIndex].invisible = isIncognitoMode;
        UserSystem.saveUsers(users);
        UserSystem.setCurrentUser(users[userIndex]);
        currentUser = users[userIndex];
      }
      
      if (isIncognitoMode) {
        showTempMessage('Режим инкогнито включен. Ваше местоположение скрыто на карте.');
      } else {
        showTempMessage('Режим инкогнито выключен. Ваше местоположение видно на карте.');
      }
      
      updateMap();
    }
    
    function openChat(userId) {
      const user = UserSystem.getUserById(userId);
      if (!user) return;
      
      // Ищем существующий чат
      const existingChat = ChatSystem.findChat(currentUser.id, userId);
      if (existingChat) {
        // Переходим в существующий чат
        showTempMessage(`Открываем чат с ${user.nickname}`);
      } else {
        // Создаем новый чат
        const newChat = ChatSystem.createChat(currentUser.id, userId);
        showTempMessage(`Создан новый чат с ${user.nickname}`);
      }
    }
    
    function openMeetingChat(meetingId) {
      showTempMessage('Чат встречи в разработке...');
    }
    
    function showUserProfile(userId) {
      sessionStorage.setItem('viewingUserId', userId);
      window.open('userProfile.html', '_blank');
    }
    
    // ИНИЦИАЛИЗАЦИЯ ОБЩЕГО ЧАТА - КЛЮЧЕВАЯ ФУНКЦИЯ
    function initializeGlobalChat() {
      // Проверяем, есть ли уже общий чат
      let globalChat = localStorage.getItem('meetup_global_chat');
      
      if (!globalChat) {
        // Создаем общий чат для всех пользователей
        const chatData = {
          id: 'global_chat_meetup',
          name: 'MeetUp News',
          description: 'Основной чат сообщества. Здесь публикуются новости и объявления.',
          avatar: 'meetup-logo.png',
          participants: [], // Пустой массив означает, что чат доступен всем
          messages: [
            {
              id: 'welcome_msg_1',
              senderId: 'system',
              senderName: 'Система MeetUP',
              text: 'Добро пожаловать в общий чат MeetUP! Здесь публикуются важные новости сообщества.',
              timestamp: Date.now() - 86400000, // 1 день назад
              type: 'system',
              read: true
            },
            {
              id: 'welcome_msg_2',
              senderId: 'system',
              senderName: 'Система MeetUP',
              text: 'Этот чат доступен всем пользователям. Новые сообщения появляются здесь регулярно.',
              timestamp: Date.now() - 43200000, // 12 часов назад
              type: 'system',
              read: true
            }
          ],
          createdAt: Date.now() - 86400000,
          lastMessageAt: Date.now() - 43200000,
          isGlobal: true,
          cannotBeDeleted: true,
          status: 'online' // Всегда онлайн
        };
        
        localStorage.setItem('meetup_global_chat', JSON.stringify(chatData));
        console.log('✅ Общий чат инициализирован');
      }
    }
    
    // ФУНКЦИЯ ЗАГРУЗКИ ЧАТОВ - ИСПРАВЛЕНА
    function loadChats() {
      const chatList = document.getElementById('chat-list');
      
      if (!currentUser) {
        chatList.innerHTML = '<div class="chat-empty">Пользователь не авторизован</div>';
        return;
      }
      
      // Очищаем список чатов
      chatList.innerHTML = '';
      
      // 1. Всегда добавляем общий чат ПЕРВЫМ
      const globalChat = JSON.parse(localStorage.getItem('meetup_global_chat') || '{}');
      if (globalChat && globalChat.id) {
        const lastMessage = globalChat.messages && globalChat.messages.length > 0 
          ? globalChat.messages[globalChat.messages.length - 1] 
          : { text: 'Добро пожаловать в общий чат!', timestamp: globalChat.createdAt };
        
        const timeAgo = ChatSystem.formatTime(lastMessage.timestamp);
        
        const globalChatHTML = `
          <div class="chat-item global-chat" onclick="showTempMessage('Общий чат открывается...')">
            <div class="chat-avatar">
              <img src="meetup-logo.png" alt="MeetUp News" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
            <div class="chat-info">
              <div class="chat-friend-name">${globalChat.name || 'MeetUp News'}</div>
              <div class="chat-last-message">${lastMessage.text || 'Новости сообщества'}</div>
              <div class="chat-time">${timeAgo}</div>
              <div class="chat-status">✓ В сети</div>
            </div>
            <div class="global-chat-badge">Все</div>
          </div>
        `;
        
        chatList.innerHTML += globalChatHTML;
      }
      
      // 2. Получаем личные чаты пользователя
      const chats = ChatSystem.getUserChats(currentUser.id);
      const friends = UserSystem.getUserFriends(currentUser.id);
      
      if (chats.length === 0 && friends.length === 0) {
        // Если нет личных чатов и друзей
        if (!chatList.innerHTML.includes('global-chat')) {
          chatList.innerHTML = `
            <div class="chat-empty">
              <span class="material-icons" style="font-size: 60px; opacity: 0.5; margin-bottom: 20px;">chat</span>
              <div>Только общий чат доступен</div>
              <div style="font-size: 12px; margin-top: 10px; color: #666;">Добавьте друзей для личных чатов</div>
            </div>
          `;
        }
        return;
      }
      
      // 3. Добавляем личные чаты
      if (chats.length > 0) {
        chats.forEach(chat => {
          const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
          const friend = friends.find(f => f.id === otherParticipantId) || UserSystem.getUserById(otherParticipantId);
          if (!friend) return;
          
          const lastMessage = ChatSystem.getLastMessage(chat);
          const unreadCount = chat.unreadCount || 0;
          const timeAgo = ChatSystem.formatTime(lastMessage.timestamp);
          
          const chatHTML = `
            <div class="chat-item" onclick="showTempMessage('Чат с ${friend.nickname} открывается...')">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || 'Пользователь'}</div>
                <div class="chat-last-message">${lastMessage.text || 'Нет сообщений'}</div>
                <div class="chat-time">${timeAgo}</div>
                <div class="chat-status">${friend.status === 'online' ? '✓ В сети' : 'Не в сети'}</div>
              </div>
              ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
            </div>
          `;
          
          chatList.innerHTML += chatHTML;
        });
      } else {
        // Если нет чатов, но есть друзья - показываем друзей
        friends.forEach(friend => {
          const chatHTML = `
            <div class="chat-item" onclick="ChatSystem.createChat(currentUser.id, '${friend.id}'); showTempMessage('Создан чат с ${friend.nickname}')">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || 'Пользователь'}</div>
                <div class="chat-last-message">Нажмите, чтобы начать чат</div>
                <div class="chat-time">${friend.status === 'online' ? 'Сейчас онлайн' : 'Был(а) недавно'}</div>
                <div class="chat-status">${friend.status === 'online' ? '✓ В сети' : 'Не в сети'}</div>
              </div>
            </div>
          `;
          
          chatList.innerHTML += chatHTML;
        });
      }
    }
    
    function openChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.add('active');
      
      // Загружаем чаты сразу при открытии
      loadChats();
    }
    
    function closeChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.remove('active');
    }
    
    function updateChatNotificationCount() {
      if (!currentUser) return;
      
      // Получаем количество непрочитанных в личных чатах
      const personalUnreadCount = ChatSystem.getUnreadCount(currentUser.id);
      
      // Пока не считаем уведомления для общего чата
      const totalUnreadCount = personalUnreadCount;
      
      const badge = document.getElementById('chat-notification-badge');
      if (totalUnreadCount > 0) {
        badge.textContent = totalUnreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function updateMeetingsNotificationCount() {
      if (!currentUser) return;
      
      // Показываем уведомления только если есть встречи сегодня
      const meetings = getMeetings();
      const today = new Date().toDateString();
      const todayMeetings = meetings.filter(meeting => {
        try {
          const meetingDate = new Date(meeting.datetime).toDateString();
          return meetingDate === today;
        } catch (e) {
          return false;
        }
      });
      
      const badge = document.getElementById('meetings-notification-badge');
      if (todayMeetings.length > 0) {
        badge.textContent = todayMeetings.length;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function openPedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      const content = document.getElementById('pedometer-content');
      
      // Простая заглушка для шагомера
      content.innerHTML = `
        <div class="pedometer-stats">
          <div class="pedometer-stat">
            <div class="stat-value">0</div>
            <div class="stat-label">ШАГОВ СЕГОДНЯ</div>
            <div class="stat-subvalue">0.00 км</div>
          </div>
          
          <div class="pedometer-goal">
            <div class="goal-title">ЦЕЛЬ НА ДЕНЬ: 10000 шагов</div>
            <div class="goal-progress-bar">
              <div class="goal-progress-fill" style="width: 0%"></div>
            </div>
            <div class="goal-info">
              <span>0</span>
              <span>0%</span>
              <span>10000</span>
            </div>
          </div>
        </div>
        
        <div class="pedometer-actions">
          <button class="pedometer-btn btn-start" onclick="showTempMessage('Шагомер запущен')">
            <span class="material-icons">play_arrow</span>
            Запустить шагомер
          </button>
        </div>
      `;
      
      overlay.classList.add('active');
      
      document.getElementById('pedometer-close-btn').addEventListener('click', function() {
        closePedometerWindow();
      });
    }
    
    function closePedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      overlay.classList.remove('active');
    }
    
    // Функции для системы встреч
    function openCreateMeetingDialog() {
      const overlay = document.getElementById('meeting-overlay');
      overlay.classList.add('active');
      
      // Устанавливаем дату и время по умолчанию
      const now = new Date();
      const futureDate = new Date(now.getTime() + 60 * 60 * 1000);
      const datetimeInput = document.getElementById('meeting-datetime');
      datetimeInput.value = futureDate.toISOString().slice(0, 16);
      
      // Сбрасываем форму
      document.getElementById('meeting-title').value = '';
      document.getElementById('meeting-description').value = '';
      document.getElementById('meeting-location').value = '';
      
      // Устанавливаем приватность "друзья" по умолчанию
      document.querySelectorAll('.meeting-privacy-option').forEach(option => {
        option.classList.remove('selected');
        if (option.dataset.privacy === 'friends') {
          option.classList.add('selected');
        }
      });
      meetingPrivacy = 'friends';
    }
    
    function closeCreateMeetingDialog() {
      const overlay = document.getElementById('meeting-overlay');
      overlay.classList.remove('active');
    }
    
    function createMeeting() {
      const title = document.getElementById('meeting-title').value.trim();
      const description = document.getElementById('meeting-description').value.trim();
      const location = document.getElementById('meeting-location').value.trim();
      const datetime = document.getElementById('meeting-datetime').value;
      
      if (!title) {
        showTempMessage('Введите название встречи');
        return;
      }
      
      if (!location) {
        showTempMessage('Введите местоположение встречи');
        return;
      }
      
      if (!datetime) {
        showTempMessage('Выберите дату и время встречи');
        return;
      }
      
      const meetingData = {
        title,
        description,
        location,
        coordinates: currentUser.position || [55.751244, 37.618423],
        datetime,
        maxParticipants: document.getElementById('meeting-max-participants').value,
        privacy: meetingPrivacy
      };
      
      // Сохраняем встречу
      const meetings = getMeetings();
      const newMeeting = {
        id: 'meeting_' + Date.now(),
        ...meetingData,
        hostId: currentUser.id,
        hostName: currentUser.nickname,
        participants: [currentUser.id],
        createdAt: new Date().toISOString(),
        status: 'active'
      };
      
      meetings.push(newMeeting);
      localStorage.setItem('meetup_meetings', JSON.stringify(meetings));
      
      showTempMessage('Встреча создана успешно!');
      closeCreateMeetingDialog();
      updateMap();
      updateMeetingsNotificationCount();
    }
    
    function openMeetingsPanel() {
      const panel = document.getElementById('meetings-panel');
      panel.classList.add('active');
      
      // Простая заглушка для списка встреч
      const meetingList = document.getElementById('meeting-list');
      const meetings = getMeetings();
      
      if (meetings.length === 0) {
        meetingList.innerHTML = `
          <div class="no-meetings">
            <span class="material-icons" style="font-size: 60px; opacity: 0.5; margin-bottom: 20px;">event_busy</span>
            <div>Нет активных встреч</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">Создайте первую встречу</div>
          </div>
        `;
      } else {
        let meetingsHTML = '';
        meetings.forEach(meeting => {
          meetingsHTML += `
            <div class="meeting-item">
              <div class="meeting-item-title">
                <span>${meeting.title}</span>
                ${meeting.hostId === currentUser.id ? '<span class="meeting-item-host">👑 Ваша</span>' : ''}
              </div>
              <div class="meeting-item-description">${meeting.description || 'Нет описания'}</div>
              <div class="meeting-item-details">
                <div class="meeting-detail">
                  <span class="material-icons" style="font-size: 14px;">location_on</span>
                  <span>${meeting.location}</span>
                </div>
                <div class="meeting-detail">
                  <span class="material-icons" style="font-size: 14px;">schedule</span>
                  <span>${new Date(meeting.datetime).toLocaleString('ru-RU')}</span>
                </div>
              </div>
            </div>
          `;
        });
        meetingList.innerHTML = meetingsHTML;
      }
    }
    
    function closeMeetingsPanel() {
      const panel = document.getElementById('meetings-panel');
      panel.classList.remove('active');
    }
    
    function saveDisplaySettings() {
      localStorage.setItem('meetup_display_settings', JSON.stringify(displaySettings));
    }
    
    function loadDisplaySettings() {
      const saved = localStorage.getItem('meetup_display_settings');
      if (saved) {
        displaySettings = { ...displaySettings, ...JSON.parse(saved) };
        
        document.getElementById('display-all').checked = displaySettings.all;
        document.getElementById('display-friends').checked = displaySettings.friends;
        document.getElementById('display-online').checked = displaySettings.online;
        document.getElementById('display-new').checked = displaySettings.new;
        
        const markerSelect = document.getElementById('friend-marker-select');
        if (markerSelect) {
          markerSelect.value = displaySettings.friendMarker;
          document.getElementById('friend-marker-style').textContent = 
            markerSelect.options[markerSelect.selectedIndex].text;
        }
      }
    }
    
    // ИНИЦИАЛИЗАЦИЯ ОБРАБОТЧИКОВ СОБЫТИЙ
    function initializeEventHandlers() {
      // Кнопка профиля
      document.getElementById('btn-profile').addEventListener('click', function() {
        window.location.href = 'profile.html';
      });
      
      // Кнопка добавления друга
      document.getElementById('btn-add-friend').addEventListener('click', function() {
        window.location.href = 'addfriend.html';
      });
      
      // Кнопка локации
      document.getElementById('btn-locate').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const coords = [position.coords.latitude, position.coords.longitude];
              if (currentUser) {
                UserSystem.updateUserPosition(currentUser.id, coords);
                currentUser = UserSystem.getCurrentUser();
              }
              if (map) {
                map.setCenter(coords, 15);
                showTempMessage('Местоположение обновлено');
              }
            },
            (error) => {
              showTempMessage('Не удалось определить местоположение');
            }
          );
        }
      });
      
      // Кнопка чатов - ОСНОВНАЯ ИСПРАВЛЕННАЯ КНОПКА
      document.getElementById('btn-chat').addEventListener('click', openChatsWindow);
      document.getElementById('chat-close-btn').addEventListener('click', closeChatsWindow);
      
      // Кнопка шагомера
      document.getElementById('btn-pedometer').addEventListener('click', openPedometerWindow);
      
      // Кнопка инкогнито
      document.getElementById('btn-incognito').addEventListener('click', toggleIncognitoMode);
      
      // Кнопка отображения
      document.getElementById('btn-display-mode').addEventListener('click', function() {
        const panel = document.getElementById('display-panel');
        panel.classList.toggle('active');
      });
      
      // Кнопка встреч
      document.getElementById('btn-meetings').addEventListener('click', openMeetingsPanel);
      document.getElementById('close-meetings-panel').addEventListener('click', closeMeetingsPanel);
      
      // Кнопка фильтров
      document.getElementById('btn-filter').addEventListener('click', function() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('active');
      });
      
      // Кнопка обновления
      document.getElementById('btn-refresh').addEventListener('click', function() {
        updateMap();
        showTempMessage('Карта обновлена');
      });
      
      // Кнопка создания встречи
      document.getElementById('btn-create-meeting').addEventListener('click', openCreateMeetingDialog);
      document.getElementById('create-meeting-from-panel').addEventListener('click', openCreateMeetingDialog);
      
      // Обработчики окна создания встречи
      document.getElementById('cancel-meeting-btn').addEventListener('click', closeCreateMeetingDialog);
      document.getElementById('confirm-meeting-btn').addEventListener('click', createMeeting);
      
      // Использовать текущее местоположение для встречи
      document.getElementById('btn-use-current-location').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              document.getElementById('meeting-location').value = 'Текущее местоположение';
              showTempMessage('Используется ваше текущее местоположение');
            },
            (error) => {
              showTempMessage('Не удалось определить местоположение');
            }
          );
        }
      });
      
      // Выбор приватности встречи
      document.querySelectorAll('.meeting-privacy-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.meeting-privacy-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          this.classList.add('selected');
          meetingPrivacy = this.dataset.privacy;
        });
      });
      
      // Фильтры
      document.getElementById('filter-friends').addEventListener('change', function() {
        filterSettings.friends = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-online').addEventListener('change', function() {
        filterSettings.online = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-nearby').addEventListener('change', function() {
        filterSettings.nearby = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-new').addEventListener('change', function() {
        filterSettings.new = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-meetings').addEventListener('change', function() {
        filterSettings.meetings = this.checked;
        updateMap();
      });
      
      const radiusSlider = document.getElementById('radius-slider');
      const radiusValue = document.getElementById('radius-value');
      radiusSlider.addEventListener('input', function() {
        radiusValue.textContent = this.value;
        filterSettings.radius = parseInt(this.value);
      });
      
      radiusSlider.addEventListener('change', function() {
        updateMap();
      });
      
      // Настройки отображения
      document.getElementById('display-all').addEventListener('change', function() {
        displaySettings.all = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-friends').addEventListener('change', function() {
        displaySettings.friends = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-online').addEventListener('change', function() {
        displaySettings.online = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-new').addEventListener('change', function() {
        displaySettings.new = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('friend-marker-select').addEventListener('change', function() {
        displaySettings.friendMarker = this.value;
        document.getElementById('friend-marker-style').textContent = this.options[this.selectedIndex].text;
        updateMap();
        saveDisplaySettings();
      });
      
      // Закрытие панелей при клике вне
      document.addEventListener('click', function(event) {
        const filterPanel = document.getElementById('filter-panel');
        const filterBtn = document.getElementById('btn-filter');
        const displayPanel = document.getElementById('display-panel');
        const displayBtn = document.getElementById('btn-display-mode');
        const meetingsPanel = document.getElementById('meetings-panel');
        const meetingsBtn = document.getElementById('btn-meetings');
        const chatOverlay = document.getElementById('chat-overlay');
        const chatBtn = document.getElementById('btn-chat');
        
        if (!filterPanel.contains(event.target) && !filterBtn.contains(event.target)) {
          filterPanel.classList.remove('active');
        }
        
        if (!displayPanel.contains(event.target) && !displayBtn.contains(event.target)) {
          displayPanel.classList.remove('active');
        }
        
        if (!meetingsPanel.contains(event.target) && !meetingsBtn.contains(event.target)) {
          meetingsPanel.classList.remove('active');
        }
        
        // Закрытие окна чатов при клике вне (но не на кнопку чатов)
        if (chatOverlay.classList.contains('active') && 
            !chatOverlay.contains(event.target) && 
            !chatBtn.contains(event.target)) {
          closeChatsWindow();
        }
      });
    }
    
    function adjustLayout() {
      const header = document.querySelector('.app-header');
      const mapContainer = document.querySelector('.map-container');
      if (header && mapContainer) {
        const headerHeight = header.offsetHeight;
        mapContainer.style.height = `calc(100vh - ${headerHeight}px)`;
      }
    }
    
    // ОСНОВНАЯ ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ПРИЛОЖЕНИЯ
    function initializeApp() {
      console.log('Инициализация приложения...');
      
      // Проверяем авторизацию
      currentUser = UserSystem.getCurrentUser();
      if (!currentUser) {
        console.log('Пользователь не авторизован, перенаправление...');
        window.location.href = 'index.html';
        return;
      }
      
      console.log('Пользователь авторизован:', currentUser.nickname);
      
      // Загружаем настройки
      const savedFilters = localStorage.getItem('meetup_map_filters');
      if (savedFilters) {
        filterSettings = { ...filterSettings, ...JSON.parse(savedFilters) };
        document.getElementById('filter-friends').checked = filterSettings.friends;
        document.getElementById('filter-online').checked = filterSettings.online;
        document.getElementById('filter-nearby').checked = filterSettings.nearby;
        document.getElementById('filter-new').checked = filterSettings.new;
        document.getElementById('filter-meetings').checked = filterSettings.meetings;
        document.getElementById('radius-slider').value = filterSettings.radius;
        document.getElementById('radius-value').textContent = filterSettings.radius;
      }
      
      // Загружаем настройки отображения
      loadDisplaySettings();
      
      // Инициализируем кнопку инкогнито
      updateIncognitoButton();
      
      // Настраиваем layout
      adjustLayout();
      
      // Инициализируем обработчики событий
      initializeEventHandlers();
      
      // Запускаем карту
      setTimeout(initializeMap, 500);
      
      // Обновляем уведомления
      updateChatNotificationCount();
      updateMeetingsNotificationCount();
      
      // Автообновление уведомлений
      setInterval(updateChatNotificationCount, 30000);
      setInterval(updateMeetingsNotificationCount, 30000);
      
      // Обработчики изменения размера окна
      window.addEventListener('resize', adjustLayout);
      window.addEventListener('orientationchange', function() {
        setTimeout(adjustLayout, 300);
      });
    }
    
    function saveFilterSettings() {
      localStorage.setItem('meetup_map_filters', JSON.stringify(filterSettings));
    }
    
    // Очистка при закрытии
    window.addEventListener('beforeunload', function() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      saveFilterSettings();
      saveDisplaySettings();
    });
    
    // Запуск приложения при загрузке
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM загружен, запуск приложения...');
      setTimeout(initializeApp, 100);
    });
    
    // Резервный запуск
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(initializeApp, 100);
    }
  </script>
</body>
</html>
