<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes">
  <title>–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π ‚Äî MeetUP</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="userSystem.js"></script>
  <script src="chatSystem.js"></script>
  <script src="pedometer.js"></script>
  <script src="notifications.js"></script>
  <link rel="icon" href="meetup-logo.png" type="image/x-icon">  
  <style>
    /* –í—Å–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    :root {
      --main-bg: #0B1222;
      --container: #181F31;
      --primary: #2CB4FF;
      --primary-gradient: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      --neon-glow: #00FFFF;
      --text-light: #fff;
      --text-muted: #9FAFD4;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--main-bg);
      color: var(--text-light);
      overflow: auto;
    }
    #app-root {
      height: 100vh;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }
    .app-header { background: var(--container); box-shadow: 0 2px 20px rgba(0,0,0,0.3); position: relative; z-index: 10; flex-shrink: 0;}
    .header-content { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px;}
    .logo-title { display: flex; align-items: center; gap: 12px;}
    .app-logo { font-size: 24px; font-weight: 800; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .app-subtitle { color: var(--text-muted); font-size: 14px; }
    .header-actions { display: flex; gap: 10px; }
    .profile-btn { width: 50px; height: 50px; border: none; border-radius: 50%; background: var(--primary-gradient); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3);}
    .profile-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(0,255,255,0.6);}
    .profile-btn:active { transform: scale(0.95); box-shadow: 0 0 30px rgba(0,255,255,0.8);}
    .map-container { flex: 1; position: relative; overflow: hidden; }
    #map { width: 100%; height: 100%; background: #131827; }
    .map-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #131827; color: var(--text-muted); gap: 15px; position: absolute; top: 0; left: 0; z-index: 20;}
    .map-placeholder.hidden { display: none;}
    .floating-buttons { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 15px; padding: 0 20px; z-index: 5; }
    .fab-primary { padding: 16px 20px; background: var(--primary-gradient); border: none; border-radius: 16px; color: white; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; cursor: pointer; box-shadow: 0 4px 20px rgba(44,180,255,0.4); transition: all 0.2s ease; min-height: 54px; white-space: nowrap;}
    .fab-primary:hover { transform: scale(1.05); box-shadow: 0 6px 25px rgba(44,180,255,0.6);}
    .fab-primary:active { transform: scale(0.95);}
    .fab-secondary { width: 54px; height: 54px; border: none; border-radius: 50%; background: var(--container); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.2s ease;}
    .fab-secondary:hover { transform: scale(1.05); background: var(--primary); color: white;}
    .fab-secondary:active { transform: scale(0.95);}
    .temp-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 20px; border-radius: 12px; font-size: 14px; z-index: 1000; backdrop-filter: blur(10px); text-align: center; max-width: 80%;}
    .map-controls { position: absolute; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; }
    .map-filter-btn { width: 54px; height: 54px; border-radius: 50%; background: var(--container); border: 2px solid var(--primary); color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    .map-filter-btn:hover { background: var(--primary); color: white; transform: scale(1.1);}
    .map-filter-btn.active { background: var(--primary); color: white;}
    .filter-panel { position: absolute; top: 70px; right: 20px; background: var(--container); border-radius: 12px; padding: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); z-index: 99; display: none; min-width: 200px;}
    .filter-panel.active { display: block; animation: slideIn 0.3s ease;}
    @keyframes slideIn {from {opacity: 0; transform: translateY(-10px);} to {opacity: 1; transform: translateY(0);}}
    .filter-option { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; color: var(--text-light); font-size: 14px; cursor: pointer;}
    .filter-option input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary);}
    .nearby-notification { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%); color: white; padding: 12px 20px; border-radius: 12px; box-shadow: 0 8px 24px rgba(44,180,255,0.3); z-index: 1000; display: flex; align-items: center; gap: 10px; animation: slideUp 0.5s ease; max-width: 90%;}
    @keyframes slideUp { from { opacity: 0; transform: translateX(-50%) translateY(30px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
    .auto-update-indicator { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(30,30,30,0.9); color: #34eb89; padding: 8px 16px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; z-index: 100; backdrop-filter: blur(10px);}
    .notification-badge { position: absolute; top: -5px; right: -5px; background: #FF4444; color: white; font-size: 10px; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    
    /* –ü–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .display-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 220px;
    }
    .display-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    /* –û–∫–Ω–æ —á–∞—Ç–æ–≤ */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .chat-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .chat-container {
      width: 90%;
      max-width: 400px;
      height: 80%;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }
    .chat-close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .chat-close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .chat-item {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    .chat-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2a2a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    .chat-friend-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    .chat-last-message {
      font-size: 14px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chat-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }
    .chat-unread {
      background: var(--primary);
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 14px;
    }
    
    /* –û–∫–Ω–æ —à–∞–≥–æ–º–µ—Ä–∞ */
    .pedometer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .pedometer-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .pedometer-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    .pedometer-header {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      padding: 25px;
      text-align: center;
    }
    .pedometer-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    .pedometer-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    .pedometer-content {
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    .pedometer-stats {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .pedometer-stat {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: #34eb89;
    }
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    .stat-subvalue {
      font-size: 16px;
      color: #2CB4FF;
      margin-top: 5px;
    }
    .pedometer-goal {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
    }
    .goal-title {
      font-size: 16px;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }
    .goal-progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #34eb89, #08e7bd);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    .goal-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }
    .pedometer-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .pedometer-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-start {
      background: linear-gradient(135deg, #34eb89 0%, #08e7bd 100%);
      color: white;
    }
    .btn-simulate {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      color: white;
    }
    .btn-close {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    .pedometer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .pedometer-not-supported {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    .pedometer-not-supported .material-icons {
      font-size: 60px;
      color: #FF4444;
      margin-bottom: 20px;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É */
    .map-controls-top {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* –§–∏–ª—å—Ç—Ä –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å —Å–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞ */
    .map-filter-btn-left {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid var(--primary);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .map-filter-btn-left:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    /* –°—Ç–∏–ª—å –¥–ª—è –º–µ—Ç–∫–∏ –ø—Ä–∏–∑—Ä–∞–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ */
    .ghost-marker {
      filter: grayscale(100%) brightness(150%);
    }
    
    /* –ú–∞—Ä—à—Ä—É—Ç */
    .route-controls {
      position: absolute;
      top: 150px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
      display: none;
    }
    
    .route-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid #34eb89;
      color: #34eb89;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .route-btn:hover {
      background: #34eb89;
      color: white;
      transform: scale(1.1);
    }
    
    .route-panel {
      position: absolute;
      top: 70px;
      left: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 220px;
      max-width: 300px;
    }
    
    .route-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    .route-info {
      color: var(--text-light);
      margin-bottom: 15px;
    }
    
    .route-details {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
    }
    
    .route-distance, .route-time {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .route-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .route-action-btn {
      flex: 1;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-clear-route {
      background: #FF4444;
      color: white;
    }
    
    .btn-navigate {
      background: #34eb89;
      color: white;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ - –û–†–ê–ù–ñ–ï–í–´–ô –¶–í–ï–¢ */
    .fab-meeting {
      background: linear-gradient(135deg, #FF8A00 0%, #FF5252 100%);
      color: white;
    }
    
    .fab-meeting:hover {
      background: linear-gradient(135deg, #FF9E40 0%, #FF6B6B 100%);
      transform: scale(1.05);
      box-shadow: 0 6px 25px rgba(255, 138, 0, 0.4);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ */
    .meeting-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      backdrop-filter: blur(5px);
    }
    
    .meeting-modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .meeting-modal-container {
      width: 90%;
      max-width: 500px;
      max-height: 85vh;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    
    .meeting-modal-header {
      background: linear-gradient(135deg, #FF8A00 0%, #FF5252 100%);
      padding: 25px;
      text-align: center;
      position: relative;
    }
    
    .meeting-modal-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    
    .meeting-modal-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    
    .meeting-modal-close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .meeting-modal-close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .meeting-modal-content {
      padding: 25px;
      overflow-y: auto;
      flex: 1;
    }
    
    .meeting-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-label {
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-label .material-icons {
      font-size: 18px;
      color: var(--primary);
    }
    
    .form-input, .form-textarea, .form-select {
      padding: 12px 15px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      color: var(--text-light);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(255,255,255,0.08);
    }
    
    .form-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }
    
    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%232CB4FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 16px;
      padding-right: 45px;
    }
    
    .datetime-group {
      display: flex;
      gap: 15px;
    }
    
    .datetime-group .form-group {
      flex: 1;
    }
    
    .form-checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .form-checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-light);
      font-size: 14px;
      cursor: pointer;
    }
    
    .form-checkbox-label input[type="radio"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    
    .privacy-option {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border: 1px solid transparent;
      transition: all 0.3s ease;
    }
    
    .privacy-option:hover {
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.1);
    }
    
    .privacy-option.selected {
      background: rgba(44, 180, 255, 0.1);
      border-color: var(--primary);
    }
    
    .privacy-icon {
      font-size: 20px;
      margin-right: 8px;
      vertical-align: middle;
    }
    
    .privacy-public { color: #34eb89; }
    .privacy-friends { color: #2CB4FF; }
    .privacy-private { color: #FF5252; }
    
    .meeting-modal-actions {
      display: flex;
      gap: 15px;
      padding: 20px 25px 25px;
      background: rgba(0,0,0,0.2);
    }
    
    .meeting-modal-btn {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .meeting-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .meeting-modal-btn:active {
      transform: translateY(0);
    }
    
    .btn-meeting-cancel {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .btn-meeting-create {
      background: linear-gradient(135deg, #FF8A00 0%, #FF5252 100%);
      color: white;
    }
    
    .btn-meeting-cancel:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .btn-meeting-create:hover {
      background: linear-gradient(135deg, #FF9E40 0%, #FF6B6B 100%);
    }
    
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ —Å –∫–Ω–æ–ø–∫–æ–π —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ */
    .location-input-group {
      position: relative;
    }
    
    .location-input-group input {
      padding-right: 50px !important;
    }
    
    .btn-current-location {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: var(--primary);
      border: none;
      border-radius: 6px;
      width: 36px;
      height: 36px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    
    .btn-current-location:hover {
      background: #1a9fff;
      transform: translateY(-50%) scale(1.1);
    }
    
    .btn-current-location:active {
      transform: translateY(-50%) scale(0.95);
    }
    
    .btn-current-location .material-icons {
      font-size: 20px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
    .suggestions-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--container);
      border-radius: 0 0 10px 10px;
      border: 1px solid rgba(255,255,255,0.1);
      border-top: none;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    
    .suggestions-dropdown.active {
      display: block;
      animation: slideIn 0.2s ease;
    }
    
    .suggestion-item {
      padding: 12px 15px;
      color: var(--text-light);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-item:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .suggestion-item.selected {
      background: rgba(44, 180, 255, 0.1);
      color: var(--primary);
    }
    
    .suggestion-item .material-icons {
      font-size: 16px;
      margin-right: 8px;
      vertical-align: middle;
      color: var(--text-muted);
    }
    
    .suggestion-item:hover .material-icons {
      color: var(--primary);
    }
    
    .suggestion-loading {
      padding: 15px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    .suggestion-empty {
      padding: 15px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ */
    .validation-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 5px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .validation-status.visible {
      opacity: 1;
    }
    
    .status-valid {
      color: #34eb89;
    }
    
    .status-invalid {
      color: #FF5252;
    }
    
    .status-loading {
      color: #2CB4FF;
    }
    
    .validation-status .material-icons {
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      .header-content {padding: 12px 15px;}
      .app-logo {font-size: 20px;}
      .app-subtitle {font-size: 13px;}
      .profile-btn {width: 45px; height: 45px;}
      .fab-primary {padding: 14px 18px; font-size: 14px; min-height: 50px; border-radius: 14px;}
      .fab-secondary {width: 50px; height: 50px;}
      .floating-buttons {bottom: 15px; padding: 0 15px; gap: 12px;}
      .map-controls {top: 15px; right: 15px;}
      .map-filter-btn {width: 50px; height: 50px;}
      .map-controls-top {top: 15px; left: 15px;}
      .map-filter-btn-left {width: 50px; height: 50px;}
      .filter-panel {top: 60px; right: 15px; min-width: 180px;}
      .display-panel {top: 60px; right: 15px; min-width: 180px;}
      .route-controls {top: 130px; right: 15px;}
      .route-btn {width: 50px; height: 50px;}
      .route-panel {top: 60px; left: 15px; min-width: 180px;}
      .meeting-modal-container {width: 95%;}
      .datetime-group {flex-direction: column; gap: 15px;}
    }
    
    @media (max-width: 480px) {
      .header-content {padding: 10px 12px;}
      .logo-title {gap: 8px;}
      .app-logo {font-size: 18px;}
      .app-subtitle {display: none;}
      .profile-btn {width: 42px; height: 42px;}
      .profile-btn .material-icons {font-size: 20px;}
      .fab-primary span:last-child {display: none;}
      .fab-primary {padding: 12px 15px; min-height: 48px; border-radius: 12px;}
      .fab-secondary {width: 48px; height: 48px;}
      .floating-buttons {bottom: 12px; padding: 0 12px; gap: 10px;}
      .map-controls {top: 10px; right: 10px;}
      .map-filter-btn {width: 45px; height: 45px;}
      .map-controls-top {top: 10px; left: 10px;}
      .map-filter-btn-left {width: 45px; height: 45px;}
      .pedometer-content {padding: 20px;}
      .stat-value {font-size: 28px;}
      .route-controls {top: 110px; right: 10px;}
      .route-btn {width: 45px; height: 45px;}
      .route-panel {top: 50px; left: 10px; min-width: 160px;}
      .meeting-modal-content {padding: 20px;}
      .meeting-modal-actions {padding: 15px 20px 20px;}
      .meeting-modal-btn {padding: 12px;}
      .btn-current-location {
        width: 32px;
        height: 32px;
      }
      .btn-current-location .material-icons {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="app-root">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-title">
          <div class="app-logo">meetup</div>
          <div class="app-subtitle">–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π</div>
        </div>
        <div class="header-actions">
          <button class="profile-btn" id="btn-profile" title="–ü—Ä–æ—Ñ–∏–ª—å">
            <span class="material-icons">person</span>
            <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
          </button>
        </div>
      </div>
    </header>
    <div class="map-container">
      <div id="map"></div>
      <div class="map-placeholder" id="map-placeholder">
        <span class="material-icons" style="font-size: 64px; opacity: 0.5;">map</span>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
      </div>
      
      <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç—ã —Å–ø—Ä–∞–≤–∞ (–∏–Ω–∫–æ–≥–Ω–∏—Ç–æ, —à–∞–≥–æ–º–µ—Ä, —á–∞—Ç—ã, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ) -->
      <div class="map-controls">
        <button class="map-filter-btn" id="btn-chat" title="–ß–∞—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏">
          <span class="material-icons">chat</span>
          <div class="notification-badge" id="chat-notification-badge" style="display: none;">0</div>
        </button>
        
        <button class="map-filter-btn" id="btn-pedometer" title="–®–∞–≥–æ–º–µ—Ä">
          <span class="material-icons">directions_walk</span>
        </button>
        
        <button class="map-filter-btn" id="btn-incognito" title="–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ">
          <span class="material-icons" id="incognito-icon">visibility_off</span>
        </button>
        
        <button class="map-filter-btn" id="btn-display-mode" title="–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
          <span class="material-icons">people</span>
        </button>
      </div>
      
      <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç—ã —Å–ª–µ–≤–∞ (—Ñ–∏–ª—å—Ç—Ä—ã –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) -->
      <div class="map-controls-top">
        <button class="map-filter-btn-left" id="btn-filter" title="–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ä—Ç—ã">
          <span class="material-icons">filter_list</span>
        </button>
        <button class="map-filter-btn-left" id="btn-refresh" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É">
          <span class="material-icons">refresh</span>
        </button>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="filter-panel" id="filter-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ä—Ç—ã</h4>
        <label class="filter-option">
          <input type="checkbox" id="filter-friends" checked>
          <span>–î—Ä—É–∑—å—è</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-online" checked>
          <span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-nearby" checked>
          <span>–†—è–¥–æ–º —Å–æ –º–Ω–æ–π</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-new" checked>
          <span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <span id="radius-value">5</span> –∫–º
          </label>
          <input type="range" id="radius-slider" min="1" max="50" value="5" style="width: 100%;">
        </div>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
      <div class="display-panel" id="display-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
        <label class="filter-option">
          <input type="checkbox" id="display-all" checked>
          <span>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-friends" checked>
          <span>–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-online" checked>
          <span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-new" checked>
          <span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            –ú–∞—Ä–∫–µ—Ä—ã –¥—Ä—É–∑–µ–π: <span id="friend-marker-style">—Å–∏–Ω–∏–π</span>
          </label>
          <select id="friend-marker-select" style="width: 100%; padding: 8px; border-radius: 6px; background: var(--container); color: white; border: 1px solid var(--primary);">
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
            <option value="gold">–ó–æ–ª–æ—Ç–æ–π</option>
          </select>
        </div>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ -->
      <div class="route-panel" id="route-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">–ú–∞—Ä—à—Ä—É—Ç –¥–æ –≤—Å—Ç—Ä–µ—á–∏</h4>
        <div class="route-info" id="route-info">
          –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...
        </div>
        <div class="route-details" id="route-details" style="display: none;">
          <div class="route-distance" id="route-distance">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: --</div>
          <div class="route-time" id="route-time">–í—Ä–µ–º—è: --</div>
        </div>
        <div class="route-actions">
          <button class="route-action-btn btn-clear-route" id="btn-clear-route">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">close</span>
            –û—á–∏—Å—Ç–∏—Ç—å
          </button>
          <button class="route-action-btn btn-navigate" id="btn-navigate">
            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">navigation</span>
            –ù–∞–≤–∏–≥–∞—Ü–∏—è
          </button>
        </div>
      </div>
      
      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ –≤ —Ü–µ–Ω—Ç—Ä–µ —Å–Ω–∏–∑—É -->
      <div class="floating-buttons">
        <button class="fab-secondary" id="btn-locate" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
          <span class="material-icons">navigation</span>
        </button>
        <button class="fab-primary" id="btn-add-friend">
          <span class="material-icons">person_add</span>
          <span>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</span>
        </button>
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ - —Ç–µ–ø–µ—Ä—å –æ—Ä–∞–Ω–∂–µ–≤–∞—è –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
        <button class="fab-primary fab-meeting" id="btn-create-meeting">
          <span class="material-icons">event</span>
          <span>–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
  <div class="auto-update-indicator" id="auto-update-indicator" style="display: none;">
    <span class="material-icons" style="font-size: 16px;">autorenew</span>
    <span>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="update-timer">30</span>—Å</span>
  </div>
  
  <!-- –û–∫–Ω–æ —á–∞—Ç–æ–≤ -->
  <div class="chat-overlay" id="chat-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">–ß–∞—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏</div>
        <button class="chat-close-btn" id="chat-close-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="chat-list" id="chat-list">
        <div class="chat-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...</div>
      </div>
    </div>
  </div>
  
  <!-- –û–∫–Ω–æ —à–∞–≥–æ–º–µ—Ä–∞ -->
  <div class="pedometer-overlay" id="pedometer-overlay">
    <div class="pedometer-container">
      <div class="pedometer-header">
        <div class="pedometer-title">–®–∞–≥–æ–º–µ—Ä</div>
        <div class="pedometer-subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –≤–∞—à—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      </div>
      <div class="pedometer-content" id="pedometer-content">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —à–∞–≥–æ–º–µ—Ä–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <div class="pedometer-actions" style="padding: 0 30px 30px 30px;">
        <button class="pedometer-btn btn-close" id="pedometer-close-btn">
          <span class="material-icons">close</span>
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ -->
  <div class="meeting-modal-overlay" id="meeting-modal-overlay">
    <div class="meeting-modal-container">
      <div class="meeting-modal-header">
        <div class="meeting-modal-title">–°–æ–∑–¥–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏</div>
        <div class="meeting-modal-subtitle">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–π –≤—Å—Ç—Ä–µ—á–µ</div>
        <button class="meeting-modal-close-btn" id="meeting-modal-close-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      
      <div class="meeting-modal-content">
        <form class="meeting-form" id="meeting-form">
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">description</span>
              –û–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏
            </label>
            <textarea 
              class="form-textarea" 
              id="meeting-description" 
              placeholder="–û–ø–∏—à–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –≤—Å—Ç—Ä–µ—á–∏: —Ç–µ–º–∞, —Ü–µ–ª—å, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å..." 
              required
              rows="4"
            ></textarea>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">location_on</span>
              –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
            </label>
            <div class="location-input-group">
              <input 
                type="text" 
                class="form-input" 
                id="meeting-location" 
                placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞" 
                required
                autocomplete="off"
              >
              <!-- –ö–Ω–æ–ø–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è -->
              <button type="button" class="btn-current-location" id="btn-current-location" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
                <span class="material-icons">my_location</span>
              </button>
              <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
              <div class="suggestions-dropdown" id="suggestions-dropdown"></div>
            </div>
            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤–∞–ª–∏–¥–∞—Ü–∏–∏ -->
            <div class="validation-status" id="location-validation-status">
              <span class="material-icons">check_circle</span>
              <span>–ê–¥—Ä–µ—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω</span>
            </div>
          </div>
          
          <div class="datetime-group">
            <div class="form-group">
              <label class="form-label">
                <span class="material-icons">date_range</span>
                –î–∞—Ç–∞
              </label>
              <input 
                type="date" 
                class="form-input" 
                id="meeting-date" 
                required
              >
            </div>
            
            <div class="form-group">
              <label class="form-label">
                <span class="material-icons">access_time</span>
                –í—Ä–µ–º—è
              </label>
              <input 
                type="time" 
                class="form-input" 
                id="meeting-time" 
                required
              >
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">group</span>
              –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
            </label>
            <input 
              type="number" 
              class="form-input" 
              id="meeting-max-participants" 
              min="2" 
              max="100" 
              value="10" 
              required
            >
          </div>
          
          <div class="form-group">
            <label class="form-label">
              <span class="material-icons">lock</span>
              –ü—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å –≤—Å—Ç—Ä–µ—á–∏
            </label>
            <div class="form-checkbox-group" id="privacy-options">
              <label class="form-checkbox-label privacy-option" id="privacy-public">
                <input type="radio" name="privacy" value="public" checked>
                <div>
                  <span class="material-icons privacy-icon privacy-public">public</span>
                  <strong>–ü—É–±–ª–∏—á–Ω–∞—è</strong>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                    –í–∏–¥–Ω–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –≤—Å–µ –∂–µ–ª–∞—é—â–∏–µ
                  </div>
                </div>
              </label>
              
              <label class="form-checkbox-label privacy-option" id="privacy-friends">
                <input type="radio" name="privacy" value="friends">
                <div>
                  <span class="material-icons privacy-icon privacy-friends">people</span>
                  <strong>–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</strong>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                    –í–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ –≤–∞—à–∏–º –¥—Ä—É–∑—å—è–º, –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è
                  </div>
                </div>
              </label>
              
              <label class="form-checkbox-label privacy-option" id="privacy-private">
                <input type="radio" name="privacy" value="private">
                <div>
                  <span class="material-icons privacy-icon privacy-private">lock</span>
                  <strong>–ü—Ä–∏–≤–∞—Ç–Ω–∞—è</strong>
                  <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">
                    –°–∫—Ä—ã—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö, —É—á–∞—Å—Ç–Ω–∏–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é
                  </div>
                </div>
              </label>
            </div>
          </div>
        </form>
      </div>
      
      <div class="meeting-modal-actions">
        <button class="meeting-modal-btn btn-meeting-cancel" id="btn-meeting-cancel" type="button">
          <span class="material-icons">close</span>
          –û—Ç–º–µ–Ω–∞
        </button>
        <button class="meeting-modal-btn btn-meeting-create" id="btn-meeting-create" type="button">
          <span class="material-icons">check</span>
          –°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É
        </button>
      </div>
    </div>
  </div>
  
  <!-- –î–∏–∞–ª–æ–≥ –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ -->
  <div class="temp-message" id="geolocation-request" style="display: none; z-index: 1001;">
    <div style="text-align: center; padding: 10px;">
      <span class="material-icons" style="font-size: 48px; color: #2CB4FF; margin-bottom: 10px;">location_on</span>
      <h3 style="margin-bottom: 10px;">–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏</h3>
      <p style="margin-bottom: 20px; font-size: 14px; color: #ccc;">–î–ª—è —Ä–∞–±–æ—Ç—ã –∫–∞—Ä—Ç—ã –∏ –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é.</p>
      <div style="display: flex; gap: 10px;">
        <button id="btn-geolocation-allow" style="flex: 1; padding: 10px; background: #2CB4FF; color: white; border: none; border-radius: 8px; cursor: pointer;">–†–∞–∑—Ä–µ—à–∏—Ç—å</button>
        <button id="btn-geolocation-deny" style="flex: 1; padding: 10px; background: #666; color: white; border: none; border-radius: 8px; cursor: pointer;">–ü–æ–∑–∂–µ</button>
      </div>
      <p style="font-size: 12px; color: #888; margin-top: 15px;">
        –í—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞
      </p>
    </div>
  </div>
  
  <script>
    function showTempMessage(message, duration = 3000) {
      const existingMessage = document.querySelector('.temp-message:not(#geolocation-request)');
      if (existingMessage) existingMessage.remove();
      const messageEl = document.createElement('div');
      messageEl.className = 'temp-message';
      messageEl.textContent = message;
      document.body.appendChild(messageEl);
      setTimeout(() => { if (messageEl.parentNode) messageEl.remove(); }, duration);
    }
    
    let isMapsApiLoading = false;
    let mapsApiLoadCallbacks = [];
    
    function loadYandexMapsAPI() {
      return new Promise((resolve, reject) => {
        if (typeof ymaps !== 'undefined') { 
          console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          if (ymaps.ready) {
            ymaps.ready(() => resolve(ymaps));
          } else {
            resolve(ymaps);
          }
          return; 
        }
        
        if (isMapsApiLoading) { 
          mapsApiLoadCallbacks.push({ resolve, reject }); 
          return; 
        }
        
        isMapsApiLoading = true;
        console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç...');
        
        const script = document.createElement('script');
        // –£–±—Ä–∞–ª API-–∫–ª—é—á –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        script.src = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU';
        script.async = true;
        
        script.onload = () => {
          console.log('‚úÖ –°–∫—Ä–∏–ø—Ç –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
          if (typeof ymaps !== 'undefined') {
            if (ymaps.ready) {
              ymaps.ready(() => {
                console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã –≥–æ—Ç–æ–≤—ã –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');
                isMapsApiLoading = false;
                resolve(ymaps);
                mapsApiLoadCallbacks.forEach(cb => cb.resolve(ymaps));
                mapsApiLoadCallbacks = [];
              });
            } else {
              console.log('‚ö†Ô∏è ymaps.ready –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–∞–π–º–∞—É—Ç');
              setTimeout(() => {
                if (typeof ymaps !== 'undefined') {
                  isMapsApiLoading = false;
                  resolve(ymaps);
                  mapsApiLoadCallbacks.forEach(cb => cb.resolve(ymaps));
                  mapsApiLoadCallbacks = [];
                } else {
                  reject(new Error('Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è'));
                }
              }, 1000);
            }
          } else {
            reject(new Error('Yandex Maps API –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è'));
          }
        };
        
        script.onerror = (error) => {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç:', error);
          isMapsApiLoading = false;
          const errorMsg = new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
          reject(errorMsg);
          mapsApiLoadCallbacks.forEach(cb => cb.reject(errorMsg));
          mapsApiLoadCallbacks = [];
        };
        
        document.head.appendChild(script);
      });
    }
    
    let map = null;
    let currentUser = null;
    let friendsClusterer = null;
    let usersClusterer = null;
    let autoUpdateInterval = null;
    let updateTimer = 30;
    let isIncognitoMode = false;
    let filterSettings = { friends: true, online: true, nearby: true, new: true, radius: 5 };
    let displaySettings = {
      all: true,
      friends: true,
      online: true,
      new: true,
      friendMarker: 'blue'
    };
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
    let currentRoute = null;
    let routePanelVisible = false;
    let selectedMeeting = null;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–µ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUserPlacemark = null;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    let userPosition = null;
    let geolocationWatchId = null;
    let hasGeolocationPermission = false;
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    let suggestionsTimeout = null;
    let currentSuggestions = [];
    let selectedSuggestionIndex = -1;
    let isFetchingSuggestions = false;
    let isLocationValid = false;
    let locationValidationInProgress = false;
    let selectedLocationCoordinates = null;
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
    function getAddressFromCoordinates(coords) {
      return new Promise((resolve, reject) => {
        if (typeof ymaps === 'undefined') {
          resolve('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          return;
        }
        
        ymaps.geocode(coords).then(function (res) {
          const firstGeoObject = res.geoObjects.get(0);
          if (firstGeoObject) {
            const address = firstGeoObject.getAddressLine();
            resolve(address || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          } else {
            resolve('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          }
        }).catch(function () {
          resolve('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
        });
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –≤–≤–æ–¥–µ –∞–¥—Ä–µ—Å–∞
    function fetchAddressSuggestions(query) {
      return new Promise((resolve, reject) => {
        if (typeof ymaps === 'undefined' || !query || query.length < 2) {
          resolve([]);
          return;
        }
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º suggest API –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
        const url = `https://suggest-maps.yandex.ru/v1/suggest?apikey=&text=${encodeURIComponent(query)}&lang=ru_RU&types=house,street,metro,district,locality`;
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            if (data.results) {
              const suggestions = data.results.map(item => ({
                displayName: item.title.text || item.subtitle?.text || '',
                fullAddress: item.subtitle?.text ? `${item.title.text}, ${item.subtitle.text}` : item.title.text,
                type: item.tags?.[0] || 'other'
              }));
              resolve(suggestions);
            } else {
              resolve([]);
            }
          })
          .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
            // –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
            const localSuggestions = getLocalSuggestions(query);
            resolve(localSuggestions);
          });
      });
    }
    
    // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API
    function getLocalSuggestions(query) {
      const commonAddresses = [
        { displayName: "–ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å", fullAddress: "–ú–æ—Å–∫–≤–∞, –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å", type: "street" },
        { displayName: "–ú–æ—Å–∫–≤–∞, –¢–≤–µ—Ä—Å–∫–∞—è —É–ª–∏—Ü–∞", fullAddress: "–ú–æ—Å–∫–≤–∞, –¢–≤–µ—Ä—Å–∫–∞—è —É–ª–∏—Ü–∞", type: "street" },
        { displayName: "–ú–æ—Å–∫–≤–∞, –ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ", fullAddress: "–ú–æ—Å–∫–≤–∞, –ü–∞—Ä–∫ –ì–æ—Ä—å–∫–æ–≥–æ", type: "park" },
        { displayName: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç", fullAddress: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ù–µ–≤—Å–∫–∏–π –ø—Ä–æ—Å–ø–µ–∫—Ç", type: "street" },
        { displayName: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –≠—Ä–º–∏—Ç–∞–∂", fullAddress: "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –≠—Ä–º–∏—Ç–∞–∂", type: "museum" },
        { displayName: "–ö–∞—Ñ–µ Starbucks", fullAddress: "–ú–æ—Å–∫–≤–∞, –ö–∞—Ñ–µ Starbucks", type: "cafe" },
        { displayName: "–¢–†–¶ –ê–≤–∏–∞–ø–∞—Ä–∫", fullAddress: "–ú–æ—Å–∫–≤–∞, –¢–†–¶ –ê–≤–∏–∞–ø–∞—Ä–∫", type: "mall" },
        { displayName: "–ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ö—Ä–µ–º–ª—å", fullAddress: "–ú–æ—Å–∫–≤–∞, –ú–æ—Å–∫–æ–≤—Å–∫–∏–π –ö—Ä–µ–º–ª—å", type: "landmark" }
      ];
      
      const lowerQuery = query.toLowerCase();
      return commonAddresses.filter(addr => 
        addr.displayName.toLowerCase().includes(lowerQuery) || 
        addr.fullAddress.toLowerCase().includes(lowerQuery)
      ).slice(0, 5);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–∞
    async function validateAddress(address) {
      if (!address || address.trim().length < 3) {
        return { 
          valid: false, 
          error: '–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å (–º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞)',
          precision: 'none'
        };
      }
      
      if (typeof ymaps === 'undefined') {
        return { 
          valid: true, // –†–∞–∑—Ä–µ—à–∞–µ–º –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –µ—Å–ª–∏ API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
          error: null,
          precision: 'unknown',
          coordinates: null
        };
      }
      
      try {
        const geocodeResult = await ymaps.geocode(address);
        const foundObjects = geocodeResult.geoObjects;
        
        if (foundObjects.getLength() === 0) {
          return { 
            valid: false, 
            error: '–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Ç–æ—á–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥',
            precision: 'none'
          };
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π (–Ω–∞–∏–±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π) —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        const firstObject = foundObjects.get(0);
        const metaData = firstObject.properties.get('metaDataProperty').GeocoderMetaData;
        const precision = metaData.precision || 'other';
        const text = metaData.text || address;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        const coordinates = firstObject.geometry.getCoordinates();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
        const acceptablePrecision = ['exact', 'number', 'range', 'street', 'other'];
        
        if (!acceptablePrecision.includes(precision)) {
          return { 
            valid: false, 
            error: '–ê–¥—Ä–µ—Å —É–∫–∞–∑–∞–Ω —Å–ª–∏—à–∫–æ–º —Ä–∞—Å–ø–ª—ã–≤—á–∞—Ç–æ. –î–æ–±–∞–≤—å—Ç–µ –Ω–æ–º–µ—Ä –¥–æ–º–∞ –∏–ª–∏ —É–ª–∏—Ü—É',
            precision: precision,
            coordinates: coordinates,
            address: text
          };
        }
        
        // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å "other", –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (precision === 'other') {
          return { 
            valid: true, 
            error: '–ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É—Ç–æ—á–Ω–∏—Ç—å (–¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä –¥–æ–º–∞)',
            precision: precision,
            coordinates: coordinates,
            address: text,
            warning: true
          };
        }
        
        return { 
          valid: true, 
          error: null,
          precision: precision,
          coordinates: coordinates,
          address: text
        };
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞–¥—Ä–µ—Å–∞:', error);
        return { 
          valid: false, 
          error: '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É',
          precision: 'error'
        };
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function showSuggestions(suggestions) {
      const dropdown = document.getElementById('suggestions-dropdown');
      const input = document.getElementById('meeting-location');
      
      if (!dropdown || !input) return;
      
      currentSuggestions = suggestions;
      selectedSuggestionIndex = -1;
      
      if (suggestions.length === 0) {
        dropdown.innerHTML = `
          <div class="suggestion-empty">
            <span class="material-icons">search_off</span>
            <div>–ê–¥—Ä–µ—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
          </div>
        `;
        dropdown.classList.add('active');
        return;
      }
      
      let html = '';
      
      suggestions.forEach((suggestion, index) => {
        let icon = 'location_on';
        switch(suggestion.type) {
          case 'house': icon = 'home'; break;
          case 'street': icon = 'road'; break;
          case 'metro': icon = 'subway'; break;
          case 'district': icon = 'location_city'; break;
          case 'locality': icon = 'place'; break;
          case 'park': icon = 'park'; break;
          case 'museum': icon = 'museum'; break;
          case 'cafe': icon = 'restaurant'; break;
          case 'mall': icon = 'store'; break;
          case 'landmark': icon = 'flag'; break;
          default: icon = 'location_on';
        }
        
        html += `
          <div class="suggestion-item" data-index="${index}">
            <span class="material-icons">${icon}</span>
            ${suggestion.displayName}
          </div>
        `;
      });
      
      dropdown.innerHTML = html;
      dropdown.classList.add('active');
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
      dropdown.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          selectSuggestion(index);
        });
      });
      
      // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º dropdown –ø–æ–¥ input
      const inputRect = input.getBoundingClientRect();
      dropdown.style.width = inputRect.width + 'px';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function selectSuggestion(index) {
      if (index < 0 || index >= currentSuggestions.length) return;
      
      const suggestion = currentSuggestions[index];
      const input = document.getElementById('meeting-location');
      const dropdown = document.getElementById('suggestions-dropdown');
      
      if (input && suggestion) {
        input.value = suggestion.fullAddress;
        
        // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
        validateAddressAsync(suggestion.fullAddress);
        
        // –°–∫—Ä—ã–≤–∞–µ–º dropdown
        if (dropdown) {
          dropdown.classList.remove('active');
        }
        
        // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–ª–µ
        setTimeout(() => {
          input.blur();
          document.getElementById('meeting-date')?.focus();
        }, 100);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function hideSuggestions() {
      const dropdown = document.getElementById('suggestions-dropdown');
      if (dropdown) {
        dropdown.classList.remove('active');
      }
    }
    
    // –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –∞–¥—Ä–µ—Å–∞ —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
    async function validateAddressAsync(address) {
      const statusEl = document.getElementById('location-validation-status');
      if (!statusEl) return;
      
      locationValidationInProgress = true;
      selectedLocationCoordinates = null;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      statusEl.innerHTML = `
        <span class="material-icons" style="color: #2CB4FF;">hourglass_empty</span>
        <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞...</span>
      `;
      statusEl.className = 'validation-status visible status-loading';
      
      const result = await validateAddress(address);
      locationValidationInProgress = false;
      
      if (result.valid) {
        isLocationValid = true;
        selectedLocationCoordinates = result.coordinates;
        
        if (result.warning) {
          // –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º
          statusEl.innerHTML = `
            <span class="material-icons" style="color: #FFA726;">warning</span>
            <span>${result.error}</span>
          `;
          statusEl.className = 'validation-status visible status-invalid';
        } else {
          // –ê–¥—Ä–µ—Å –≤–∞–ª–∏–¥–Ω—ã–π
          statusEl.innerHTML = `
            <span class="material-icons" style="color: #34eb89;">check_circle</span>
            <span>–ê–¥—Ä–µ—Å –ø—Ä–æ–≤–µ—Ä–µ–Ω</span>
          `;
          statusEl.className = 'validation-status visible status-valid';
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–º –∞–¥—Ä–µ—Å–æ–º, –µ—Å–ª–∏ –æ–Ω –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
        const input = document.getElementById('meeting-location');
        if (input && result.address && result.address !== input.value) {
          input.value = result.address;
        }
      } else {
        isLocationValid = false;
        selectedLocationCoordinates = null;
        
        statusEl.innerHTML = `
          <span class="material-icons" style="color: #FF5252;">error</span>
          <span>${result.error}</span>
        `;
        statusEl.className = 'validation-status visible status-invalid';
      }
      
      return result;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    function resetValidationStatus() {
      const statusEl = document.getElementById('location-validation-status');
      if (statusEl) {
        statusEl.className = 'validation-status';
        isLocationValid = false;
        selectedLocationCoordinates = null;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∞
    function useCurrentLocationForMeeting() {
      const locationInput = document.getElementById('meeting-location');
      const statusEl = document.getElementById('location-validation-status');
      
      if (!locationInput || !statusEl) return;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
      locationInput.placeholder = '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...';
      locationInput.value = '';
      statusEl.innerHTML = `
        <span class="material-icons" style="color: #2CB4FF;">hourglass_empty</span>
        <span>–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...</span>
      `;
      statusEl.className = 'validation-status visible status-loading';
      
      if (!navigator.geolocation) {
        showTempMessage('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º');
        locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
        statusEl.className = 'validation-status';
        return;
      }
      
      // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      if (hasGeolocationPermission) {
        getUserLocation()
          .then((coords) => {
            // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
            return getAddressFromCoordinates(coords);
          })
          .then((address) => {
            locationInput.value = address;
            locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
            
            // –í–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∞–¥—Ä–µ—Å
            return validateAddressAsync(address);
          })
          .then((result) => {
            if (result.valid) {
              showTempMessage('–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –∞–¥—Ä–µ—Å –≤—Å—Ç—Ä–µ—á–∏');
            }
          })
          .catch(() => {
            locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
            statusEl.className = 'validation-status';
            showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
          });
      } else {
        // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
        requestGeolocationPermission().then(permissionGranted => {
          if (permissionGranted) {
            hasGeolocationPermission = true;
            getUserLocation()
              .then((coords) => {
                return getAddressFromCoordinates(coords);
              })
              .then((address) => {
                locationInput.value = address;
                locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
                return validateAddressAsync(address);
              })
              .then((result) => {
                if (result.valid) {
                  showTempMessage('–¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –∞–¥—Ä–µ—Å –≤—Å—Ç—Ä–µ—á–∏');
                }
              })
              .catch(() => {
                locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
                statusEl.className = 'validation-status';
                showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
              });
          } else {
            locationInput.placeholder = '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞';
            statusEl.className = 'validation-status';
            showTempMessage('–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω');
          }
        });
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏
    function openMeetingModal() {
      const modal = document.getElementById('meeting-modal-overlay');
      modal.classList.add('active');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è)
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      document.getElementById('meeting-date').min = formattedDate;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∑–∞–≤—Ç—Ä–∞)
      const tomorrow = new Date();
      tomorrow.setDate(today.getDate() + 1);
      const formattedTomorrow = tomorrow.toISOString().split('T')[0];
      document.getElementById('meeting-date').value = formattedTomorrow;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (14:00)
      document.getElementById('meeting-time').value = '14:00';
      
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('meeting-description').value = '';
      document.getElementById('meeting-location').value = '';
      document.getElementById('meeting-max-participants').value = '10';
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é
      resetValidationStatus();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∫ –ø—É–±–ª–∏—á–Ω–æ–π
      document.querySelector('input[name="privacy"][value="public"]').checked = true;
      updatePrivacySelection();
      
      // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ
      setTimeout(() => {
        document.getElementById('meeting-description').focus();
      }, 100);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏
    function closeMeetingModal() {
      const modal = document.getElementById('meeting-modal-overlay');
      modal.classList.remove('active');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã
      hideSuggestions();
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      currentSuggestions = [];
      selectedSuggestionIndex = -1;
      isLocationValid = false;
      selectedLocationCoordinates = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
    function updatePrivacySelection() {
      const privacyOptions = document.querySelectorAll('.privacy-option');
      privacyOptions.forEach(option => {
        option.classList.remove('selected');
      });
      
      const selectedOption = document.querySelector('input[name="privacy"]:checked');
      if (selectedOption) {
        const selectedValue = selectedOption.value;
        const selectedElement = document.getElementById(`privacy-${selectedValue}`);
        if (selectedElement) {
          selectedElement.classList.add('selected');
        }
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ (–∏–∑ —Ñ–æ—Ä–º—ã)
    async function createMeetingFromForm() {
      const description = document.getElementById('meeting-description').value.trim();
      const location = document.getElementById('meeting-location').value.trim();
      const date = document.getElementById('meeting-date').value;
      const time = document.getElementById('meeting-time').value;
      const maxParticipants = document.getElementById('meeting-max-participants').value;
      const privacy = document.querySelector('input[name="privacy"]:checked').value;
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è
      if (!description) {
        showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏');
        document.getElementById('meeting-description').focus();
        return;
      }
      
      if (!location) {
        showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏');
        document.getElementById('meeting-location').focus();
        return;
      }
      
      // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥—Ä–µ—Å–∞
      if (!isLocationValid && !locationValidationInProgress) {
        const validationResult = await validateAddressAsync(location);
        if (!validationResult.valid) {
          showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–¥—Ä–µ—Å');
          document.getElementById('meeting-location').focus();
          return;
        }
      } else if (locationValidationInProgress) {
        showTempMessage('–î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥—Ä–µ—Å–∞');
        return;
      }
      
      if (!date) {
        showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤—Å—Ç—Ä–µ—á–∏');
        document.getElementById('meeting-date').focus();
        return;
      }
      
      if (!time) {
        showTempMessage('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏');
        document.getElementById('meeting-time').focus();
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
      const selectedDateTime = new Date(`${date}T${time}`);
      const now = new Date();
      if (selectedDateTime < now) {
        showTempMessage('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É –≤ –ø—Ä–æ—à–ª–æ–º. –í—ã–±–µ—Ä–∏—Ç–µ –±—É–¥—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è.');
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≤—Å—Ç—Ä–µ—á–∏
      const meeting = {
        id: 'meeting_' + Date.now(),
        creatorId: currentUser.id,
        creatorName: currentUser.nickname || currentUser.username,
        description: description,
        location: location,
        date: date,
        time: time,
        dateTime: selectedDateTime.toISOString(),
        maxParticipants: parseInt(maxParticipants),
        privacy: privacy,
        participants: [currentUser.id],
        createdAt: new Date().toISOString(),
        status: 'active',
        coordinates: selectedLocationCoordinates
      };
      
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—Ç—Ä–µ—á—É –≤ localStorage –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      let meetings = JSON.parse(localStorage.getItem('meetup_meetings') || '[]');
      meetings.push(meeting);
      localStorage.setItem('meetup_meetings', JSON.stringify(meetings));
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      closeMeetingModal();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      showTempMessage('–í—Å—Ç—Ä–µ—á–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!');
      
      // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –º–µ—Ç–∫—É –≤—Å—Ç—Ä–µ—á–∏
      console.log('–°–æ–∑–¥–∞–Ω–∞ –≤—Å—Ç—Ä–µ—á–∞:', meeting);
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è)
    function requestGeolocationPermission() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          console.log('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º');
          resolve(false);
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—à–µ–Ω –¥–æ—Å—Ç—É–ø
        const permissionAsked = localStorage.getItem('meetup_geolocation_asked');
        
        // –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏ —Ä–∞–∑—Ä–µ—à–∏–ª–∏, —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        if (permissionAsked === 'allowed') {
          console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ —Ä–∞–Ω–µ–µ');
          getUserLocation()
            .then(() => resolve(true))
            .catch(() => resolve(false));
          return;
        }
        
        // –ï—Å–ª–∏ —É–∂–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª–∏ –∏ –æ—Ç–∫–∞–∑–∞–ª–∏, –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–Ω–æ–≤–∞
        if (permissionAsked === 'denied') {
          console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–Ω–µ–µ –æ—Ç–∫–∞–∑–∞–ª –≤ –¥–æ—Å—Ç—É–ø–µ –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏');
          resolve(false);
          return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–∏–∞–ª–æ–≥ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        const dialog = document.getElementById('geolocation-request');
        dialog.style.display = 'block';
        
        document.getElementById('btn-geolocation-allow').onclick = function() {
          dialog.style.display = 'none';
          localStorage.setItem('meetup_geolocation_asked', 'allowed');
          
          getUserLocation()
            .then(() => {
              hasGeolocationPermission = true;
              resolve(true);
            })
            .catch((error) => {
              console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
              showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
              resolve(false);
            });
        };
        
        document.getElementById('btn-geolocation-deny').onclick = function() {
          dialog.style.display = 'none';
          localStorage.setItem('meetup_geolocation_asked', 'denied');
          showTempMessage('–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –±–µ–∑ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.');
          resolve(false);
        };
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function getUserLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          reject(new Error('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
          return;
        }
        
        // –û–ø—Ü–∏–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
        const options = {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 60000
        };
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            userPosition = coords;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ
            if (currentUser) {
              UserSystem.updateUserPosition(currentUser.id, coords);
              currentUser = UserSystem.getCurrentUser();
            }
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            if (map) {
              centerOnUser(coords);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è
            startGeolocationTracking();
            
            console.log('üìç –ü–æ–ª—É—á–µ–Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è:', coords);
            resolve(coords);
          },
          (error) => {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            
            let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                localStorage.setItem('meetup_geolocation_asked', 'denied');
                hasGeolocationPermission = false;
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                break;
              case error.TIMEOUT:
                errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ';
                break;
            }
            
            showTempMessage(errorMessage);
            reject(new Error(errorMessage));
          },
          options
        );
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
    function startGeolocationTracking() {
      if (!navigator.geolocation || !hasGeolocationPermission) return;
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (geolocationWatchId !== null) {
        navigator.geolocation.clearWatch(geolocationWatchId);
      }
      
      const options = {
        enableHighAccuracy: true,
        timeout: 30000,
        maximumAge: 10000
      };
      
      geolocationWatchId = navigator.geolocation.watchPosition(
        (position) => {
          const coords = [position.coords.latitude, position.coords.longitude];
          userPosition = coords;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ
          if (currentUser) {
            UserSystem.updateUserPosition(currentUser.id, coords);
            currentUser = UserSystem.getCurrentUser();
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ
          updateCurrentUserPlacemark();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–∑–µ–π –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏
          checkNearbyFriends();
          
          console.log('üìç –û–±–Ω–æ–≤–ª–µ–Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è:', coords);
        },
        (error) => {
          console.error('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
        },
        options
      );
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç—ã –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    function centerOnUser(coords = null) {
      if (!map) return;
      
      const position = coords || userPosition || (currentUser ? currentUser.position : null);
      if (!position) return;
      
      const TARGET_ZOOM = 15;
      
      try {
        map.setCenter(position, TARGET_ZOOM, {
          duration: 1000,
          timingFunction: 'ease-in-out'
        });
        
        highlightUserLocation();
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏:', error);
        map.setCenter(position, TARGET_ZOOM);
      }
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –ö–ê–†–¢–´
    function initializeMap() {
      const mapElement = document.getElementById('map');
      const placeholder = document.getElementById('map-placeholder');
      
      console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã...');
      
      loadYandexMapsAPI()
        .then(ymaps => {
          console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
          currentUser = UserSystem.getCurrentUser();
          
          if (!currentUser) {
            showTempMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
            window.location.href = 'index.html';
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
          isIncognitoMode = currentUser.invisible || false;
          updateIncognitoButton();
          
          const defaultPosition = currentUser.position || [55.751244, 37.618423]; // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          const MIN_ZOOM = 2;
          const MAX_ZOOM = 19;
          const DEFAULT_ZOOM = 12;
          
          try {
            const allUsers = UserSystem.getUsers();
            const positions = allUsers.filter(user => user.position && Array.isArray(user.position)).map(user => user.position);
            let initialCenter = defaultPosition;
            let initialZoom = DEFAULT_ZOOM;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨: –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –±–µ–∑ —Å–ª–æ–∂–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
            if (positions.length > 0) {
              // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
              let sumLat = 0;
              let sumLon = 0;
              positions.forEach(pos => {
                sumLat += pos[0];
                sumLon += pos[1];
              });
              
              initialCenter = [sumLat / positions.length, sumLon / positions.length];
              
              // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –∑—É–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–∑–∏—Ü–∏–π
              if (positions.length > 1) {
                // –ù–∞—Ö–æ–¥–∏–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                let minLat = positions[0][0];
                let maxLat = positions[0][0];
                let minLon = positions[0][1];
                let maxLon = positions[0][1];
                
                positions.forEach(pos => {
                  minLat = Math.min(minLat, pos[0]);
                  maxLat = Math.max(maxLat, pos[0]);
                  minLon = Math.min(minLon, pos[1]);
                  maxLon = Math.max(maxLon, pos[1]);
                });
                
                // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                const latDiff = maxLat - minLat;
                const lonDiff = maxLon - minLon;
                const maxDiff = Math.max(latDiff, lonDiff);
                
                // –ü—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç –∑—É–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–∞–∑–Ω–∏—Ü—ã –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                if (maxDiff > 0) {
                  // –≠–º–ø–∏—Ä–∏—á–µ—Å–∫–∞—è —Ñ–æ—Ä–º—É–ª–∞ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∑—É–º–∞
                  initialZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, 14 - Math.log2(maxDiff * 100)));
                }
              }
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã
            const limitBounds = [[85, -179], [-85, 179]];
            
            map = new ymaps.Map('map', {
              center: initialCenter,
              zoom: initialZoom,
              controls: [],
              restrictMapArea: limitBounds,
              suppressMapOpenBlock: true,
              suppressObsoleteBrowserNotifier: true
            }, {
              minZoom: MIN_ZOOM,
              maxZoom: MAX_ZOOM
            });
            
            placeholder.classList.add('hidden');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            map.controls.add('zoomControl', {
              size: 'small',
              float: 'none',
              position: { right: 10, top: 100 }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é, –Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–Ω–æ–ø–∫—É (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ—é)
            map.controls.add('geolocationControl', {
              float: 'none',
              position: { right: 10, top: 150 }
            });
            
            friendsClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedVioletClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            usersClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedBlueClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            updateMap();
            
            const friends = UserSystem.getUserFriends(currentUser.id);
            if (friends.length > 0) {
              setTimeout(() => {
                const friendPositions = friends.filter(f => f.position).map(f => f.position);
                if (friendPositions.length > 0) {
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≥—Ä–∞–Ω–∏—Ü
                  let minLat = friendPositions[0][0];
                  let maxLat = friendPositions[0][0];
                  let minLon = friendPositions[0][1];
                  let maxLon = friendPositions[0][1];
                  
                  friendPositions.forEach(pos => {
                    minLat = Math.min(minLat, pos[0]);
                    maxLat = Math.max(maxLat, pos[0]);
                    minLon = Math.min(minLon, pos[1]);
                    maxLon = Math.max(maxLon, pos[1]);
                  });
                  
                  // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –≥—Ä–∞–Ω–∏—Ü –≤ —Ñ–æ—Ä–º–∞—Ç–µ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç
                  const bounds = [[minLat, minLon], [maxLat, maxLon]];
                  map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 50 });
                }
              }, 1000);
            }
            
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            
            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã
            setTimeout(() => {
              requestGeolocationPermission().then(permissionGranted => {
                if (permissionGranted) {
                  hasGeolocationPermission = true;
                  console.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–æ');
                } else {
                  console.log('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –Ω–µ –ø–æ–ª—É—á–µ–Ω–æ');
                }
              });
            }, 1000);
            
            startAutoUpdate();
            updateChatNotificationCount();
            setInterval(updateChatNotificationCount, 30000);
            
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            placeholder.innerHTML = `
              <span class="material-icons" style="font-size: 64px; opacity: 0.5;">error</span>
              <div>–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã</div>
              <div style="font-size: 12px; margin-top: 10px; color: #888;">${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
              <button onclick="location.reload()" style="
                margin-top: 15px;
                padding: 10px 20px;
                background: var(--primary-gradient);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
              ">–û–±–Ω–æ–≤–∏—Ç—å</button>
            `;
          }
        })
        .catch(error => {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç:', error);
          const placeholder = document.getElementById('map-placeholder');
          placeholder.innerHTML = `
            <span class="material-icons" style="font-size: 64px; opacity: 0.5;">wifi_off</span>
            <div>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</div>
            <div style="font-size: 12px; margin-top: 10px; color: #888;">
              ${error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'}
            </div>
            <button onclick="initializeMap()" style="
              margin-top: 15px;
              padding: 10px 20px;
              background: var(--primary-gradient);
              border: none;
              border-radius: 8px;
              color: white;
              cursor: pointer;
            ">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
          `;
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
    function updateIncognitoButton() {
      const btn = document.getElementById('btn-incognito');
      const icon = document.getElementById('incognito-icon');
      
      if (isIncognitoMode) {
        btn.classList.add('active');
        btn.title = '–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤–∫–ª—é—á–µ–Ω';
        icon.textContent = 'visibility_off';
      } else {
        btn.classList.remove('active');
        btn.title = '–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ';
        icon.textContent = 'visibility_off';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function updateCurrentUserPlacemark() {
      if (!map || !currentUser || typeof ymaps === 'undefined') return;
      
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–µ—Ç–∫—É
      if (currentUserPlacemark) {
        map.geoObjects.remove(currentUserPlacemark);
      }
      
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫—Ä—ã—Ç - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –Ω–∞ –∫–∞—Ä—Ç–µ
      if (isIncognitoMode) {
        currentUserPlacemark = null;
        return;
      }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é
      const position = userPosition || currentUser.position;
      if (!position) {
        currentUserPlacemark = null;
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
      const iconColor = isIncognitoMode ? '#FF4444' : '#2CB4FF';
      const preset = isIncognitoMode ? 'islands#redCircleDotIcon' : 'islands#blueCircleDotIcon';
      const statusText = isIncognitoMode ? '–°–∫—Ä—ã—Ç' : '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
      
      currentUserPlacemark = new ymaps.Placemark(
        position,
        {
          balloonContent: `
            <div style="padding: 10px; min-width: 200px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${isIncognitoMode ? 'linear-gradient(135deg, #FF4444 0%, #992222 100%)' : 'linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%)'}; display: flex; align-items: center; justify-content: center;">
                  <span class="material-icons" style="color: white;">person</span>
                </div>
                <div>
                  <strong style="color: white;">${currentUser.nickname || '–í—ã'}</strong><br>
                  <span style="color: ${isIncognitoMode ? '#FF4444' : '#2CB4FF'}; font-size: 12px;">
                    ${statusText}
                  </span>
                </div>
              </div>
              ${currentUser.about ? `<p style="color: #aaa; font-size: 13px; margin: 10px 0;">${currentUser.about}</p>` : ''}
              <div style="margin-top: 15px;">
                <button onclick="centerOnUser()" style="width: 100%; padding: 8px; background: #2CB4FF; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                  –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –º–Ω–µ
                </button>
              </div>
            </div>
          `,
          iconCaption: isIncognitoMode ? 'üëª –°–∫—Ä—ã—Ç' : '–í—ã'
        },
        { 
          preset: preset, 
          iconColor: iconColor,
          iconCaptionMaxWidth: '150px'
        }
      );
      
      map.geoObjects.add(currentUserPlacemark);
    }
    
    function updateMap() {
      if (!map || !currentUser || typeof ymaps === 'undefined') return;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      updateCurrentUserPlacemark();
      
      // –û—á–∏—â–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä—ã
      if (friendsClusterer) friendsClusterer.removeAll();
      if (usersClusterer) usersClusterer.removeAll();
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      map.geoObjects.each(function(geoObject) {
        if (geoObject !== currentUserPlacemark && 
            geoObject !== friendsClusterer && 
            geoObject !== usersClusterer) {
          map.geoObjects.remove(geoObject);
        }
      });
      
      const allUsers = UserSystem.getUsers();
      const friends = UserSystem.getUserFriends(currentUser.id);
      const friendIds = friends.map(f => f.id);
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const filteredUsers = allUsers.filter(user => {
        if (user.id === currentUser.id || !user.position) return false;
        if (user.invisible && !isIncognitoMode) return false;
        
        const isFriend = friendIds.includes(user.id);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (!displaySettings.all && !isFriend) return false;
        if (!displaySettings.friends && isFriend) return false;
        if (displaySettings.online && user.status !== 'online') return false;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
        if (filterSettings.nearby && userPosition) {
          const distance = calculateDistance(userPosition, user.position);
          if (distance > filterSettings.radius) return false;
        } else if (filterSettings.nearby && currentUser.position) {
          const distance = calculateDistance(currentUser.position, user.position);
          if (distance > filterSettings.radius) return false;
        }
        
        return true;
      });
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ –¥–ª—è –¥—Ä—É–∑–µ–π
      filteredUsers.forEach(user => {
        const isFriend = friendIds.includes(user.id);
        
        // –¶–≤–µ—Ç –º–µ—Ç–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫
        let iconColor, preset, iconCaption;
        if (isFriend) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –¥—Ä—É–∑–µ–π
          switch(displaySettings.friendMarker) {
            case 'green':
              iconColor = user.status === 'online' ? '#34eb89' : '#2a7a2a';
              preset = 'islands#greenCircleDotIcon';
              iconCaption = '‚úì –î—Ä—É–≥';
              break;
            case 'red':
              iconColor = user.status === 'online' ? '#ff4444' : '#992222';
              preset = 'islands#redCircleDotIcon';
              iconCaption = '‚úì –î—Ä—É–≥';
              break;
            case 'purple':
              iconColor = user.status === 'online' ? '#B970FE' : '#663399';
              preset = 'islands#violetCircleDotIcon';
              iconCaption = '‚úì –î—Ä—É–≥';
              break;
            case 'gold':
              iconColor = user.status === 'online' ? '#FFD700' : '#B8860B';
              preset = 'islands#yellowCircleDotIcon';
              iconCaption = '‚úì –î—Ä—É–≥';
              break;
            default: // blue
              iconColor = user.status === 'online' ? '#2CB4FF' : '#1a5a7a';
              preset = 'islands#blueCircleDotIcon';
              iconCaption = '‚úì –î—Ä—É–≥';
          }
        } else {
          // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - —Å–µ—Ä—ã–π —Ü–≤–µ—Ç
          iconColor = user.status === 'online' ? '#A4B0BE' : '#666666';
          preset = 'islands#grayCircleDotIcon';
          iconCaption = user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        const placemark = new ymaps.Placemark(
          user.position,
          {
            balloonContent: `
              <div style="padding: 10px; min-width: 200px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="width: 40px; height: 40px; border-radius: 50%; background: #2a2a3a; display: flex; align-items: center; justify-content: center;">
                    <span class="material-icons" style="color: ${isFriend ? iconColor : '#888'};">person</span>
                  </div>
                  <div>
                    <strong style="color: white;">${user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong><br>
                    <span style="color: ${isFriend ? iconColor : '#888'}; font-size: 12px;">
                      ${isFriend ? '‚úì –î—Ä—É–≥' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ‚Ä¢ ${user.status === 'online' ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}
                    </span>
                  </div>
                </div>
                ${user.about ? `<p style="color: #aaa; font-size: 13px; margin: 10px 0;">${user.about}</p>` : ''}
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                  ${!isFriend ? 
                    `<button onclick="addFriend('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px; background: #2CB4FF; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                      –î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è
                    </button>` : 
                    `<button onclick="openChat('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px; background: #34eb89; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                      –ù–∞–ø–∏—Å–∞—Ç—å
                    </button>`
                  }
                  <button onclick="showUserProfile('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    –ü—Ä–æ—Ñ–∏–ª—å
                  </button>
                  <button onclick="buildRouteToUser('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px; background: #B970FE; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle;">navigation</span>
                    –î–æ–±—Ä–∞—Ç—å—Å—è
                  </button>
                </div>
              </div>
            `,
            iconCaption: iconCaption
          },
          { 
            preset: preset, 
            iconColor: iconColor,
            iconCaptionMaxWidth: '150px',
            iconCaptionOffset: [0, 5]
          }
        );
        
        if (isFriend) {
          friendsClusterer.add(placemark);
        } else {
          usersClusterer.add(placemark);
        }
      });
      
      if (friendsClusterer.getGeoObjects().length > 0) {
        map.geoObjects.add(friendsClusterer);
      }
      
      if (usersClusterer.getGeoObjects().length > 0) {
        map.geoObjects.add(usersClusterer);
      }
    }
    
    function calculateDistance(pos1, pos2) {
      const [lat1, lon1] = pos1;
      const [lat2, lon2] = pos2;
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function addFriend(userId) {
      if (!currentUser) return;
      if (UserSystem.sendFriendRequest(currentUser.id, userId)) {
        showTempMessage('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        updateMap();
      } else {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å');
      }
    }
    
    // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ (–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    function createMeeting() {
      console.log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≤—Å—Ç—Ä–µ—á–∏...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
      if (!currentUser || !currentUser.position) {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ. –í–∫–ª—é—á–∏—Ç–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.');
        return;
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏
      sessionStorage.setItem('meetingCreationPosition', JSON.stringify(currentUser.position));
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏
      window.location.href = 'createmeeting.html';
    }
    
    function startAutoUpdate() {
      const autoUpdate = localStorage.getItem('meetup_auto_update') !== 'false';
      if (autoUpdate) {
        document.getElementById('auto-update-indicator').style.display = 'flex';
        updateTimer = 30;
        autoUpdateInterval = setInterval(() => {
          updateTimer--;
          document.getElementById('update-timer').textContent = updateTimer;
          if (updateTimer <= 0) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            updateMap();
            updateTimer = 30;
          }
        }, 1000);
      }
    }
    
    function highlightUserLocation() {
      if (!map || typeof ymaps === 'undefined') return;
      
      const position = userPosition || (currentUser ? currentUser.position : null);
      if (!position) return;
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
      if (window.locationHighlight) {
        map.geoObjects.remove(window.locationHighlight);
      }
      
      try {
        window.locationHighlight = new ymaps.Circle([
          position,
          100
        ], {}, {
          fillColor: isIncognitoMode ? '#FF444433' : '#2CB4FF33',
          strokeColor: isIncognitoMode ? '#FF4444' : '#2CB4FF',
          strokeWidth: 2,
          strokeOpacity: 0.8
        });
        map.geoObjects.add(window.locationHighlight);
        
        setTimeout(() => {
          if (window.locationHighlight && map) {
            map.geoObjects.remove(window.locationHighlight);
            window.locationHighlight = null;
          }
        }, 5000);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏:', error);
      }
    }
    
    function toggleIncognitoMode() {
      isIncognitoMode = !isIncognitoMode;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
      updateIncognitoButton();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      if (userIndex !== -1) {
        users[userIndex].invisible = isIncognitoMode;
        UserSystem.saveUsers(users);
        UserSystem.setCurrentUser(users[userIndex]);
        currentUser = users[userIndex];
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (isIncognitoMode) {
        showTempMessage('–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤–∫–ª—é—á–µ–Ω. –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ.');
      } else {
        showTempMessage('–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤—ã–∫–ª—é—á–µ–Ω. –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ.');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
      updateMap();
    }
    
    function openChat(userId) {
      const user = UserSystem.getUserById(userId);
      if (!user) return;
      
      showTempMessage('–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–∞—Ç —Å ' + user.nickname);
      // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —á–∞—Ç–∞
      // window.location.href = `chat.html?userId=${userId}`;
    }
    
    function showUserProfile(userId) {
      sessionStorage.setItem('viewingUserId', userId);
      window.open('userProfile.html', '_blank');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—Ä—É–∑–µ–π –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏
    function checkNearbyFriends() {
      if (!currentUser || !userPosition) return;
      const friends = UserSystem.getUserFriends(currentUser.id);
      const radius = filterSettings.radius;
      const nearbyFriends = friends.filter(friend => {
        if (!friend.position || friend.invisible) return false;
        const distance = calculateDistance(userPosition, friend.position);
        return distance <= radius;
      });
      if (nearbyFriends.length > 0) {
        showNearbyNotification(nearbyFriends);
      }
    }
    
    function showNearbyNotification(friends) {
      const notification = document.createElement('div');
      notification.className = 'nearby-notification';
      notification.innerHTML = `
        <span class="material-icons">group</span>
        <div>
          <strong>–î—Ä—É–∑—å—è –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏!</strong><br>
          ${friends.length} ${getRussianPlural(friends.length, ['–¥—Ä—É–≥', '–¥—Ä—É–≥–∞', '–¥—Ä—É–∑–µ–π'])} —Ä—è–¥–æ–º —Å –≤–∞–º–∏
        </div>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
          <span class="material-icons">close</span>
        </button>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) notification.remove();
      }, 5000);
    }
    
    function getRussianPlural(number, forms) {
      const cases = [2, 0, 1, 1, 1, 2];
      return forms[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function buildRouteToUser(userId) {
      const user = UserSystem.getUserById(userId);
      if (!user || !user.position) {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      selectedMeeting = {
        id: userId,
        name: user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        position: user.position
      };
      
      buildRouteToPosition(user.position, user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –¥–æ –ø–æ–∑–∏—Ü–∏–∏
    function buildRouteToPosition(position, name) {
      if (!map || typeof ymaps === 'undefined') {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç: –¥–∞–Ω–Ω—ã–µ –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
        return;
      }
      
      const startPosition = userPosition || (currentUser ? currentUser.position : null);
      if (!startPosition) {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç: –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
        return;
      }
      
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–∞—Ä—à—Ä—É—Ç
      clearRoute();
      
      // –°–æ–∑–¥–∞–µ–º –º—É–ª—å—Ç–∏–º–∞—Ä—à—Ä—É—Ç
      try {
        currentRoute = new ymaps.multiRouter.MultiRoute({
          referencePoints: [
            startPosition,
            position
          ],
          params: {
            routingMode: 'auto',
            results: 1
          }
        }, {
          boundsAutoApply: true,
          routeActiveStrokeWidth: 6,
          routeActiveStrokeColor: "#34eb89",
          routeStrokeColor: "#2CB4FF",
          routeStrokeWidth: 4,
          pinIconFillColor: "#34eb89",
          pinActiveIconFillColor: "#2CB4FF"
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä—à—Ä—É—Ç –Ω–∞ –∫–∞—Ä—Ç—É
        map.geoObjects.add(currentRoute);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞
        showRoutePanel(position, name);
        
        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
        if (currentRoute.model && currentRoute.model.events) {
          currentRoute.model.events.add('requestsuccess', function() {
            updateRouteInfo();
          });
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
        setTimeout(updateRouteInfo, 1000);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ
    function updateRouteInfo() {
      if (!currentRoute) return;
      
      try {
        const routes = currentRoute.getRoutes();
        if (!routes || routes.length === 0) return;
        
        const route = routes.get(0);
        if (!route) return;
        
        const properties = route.properties;
        const distance = properties.get('distance');
        const duration = properties.get('duration');
        
        if (distance && duration) {
          const distanceText = distance.text;
          const durationText = duration.text;
          
          document.getElementById('route-distance').textContent = `–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distanceText}`;
          document.getElementById('route-time').textContent = `–í—Ä–µ–º—è: ${durationText}`;
          document.getElementById('route-details').style.display = 'block';
          
          document.getElementById('route-info').innerHTML = `
            <strong>–ú–∞—Ä—à—Ä—É—Ç –¥–æ ${selectedMeeting?.name || '–º–µ—Å—Ç–∞ –≤—Å—Ç—Ä–µ—á–∏'}</strong><br>
            <span style="color: #34eb89; font-size: 12px;">–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω</span>
          `;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ:', error);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    function showRoutePanel(position, name) {
      const panel = document.getElementById('route-panel');
      panel.classList.add('active');
      routePanelVisible = true;
      
      document.getElementById('route-info').innerHTML = `
        <strong>–ú–∞—Ä—à—Ä—É—Ç –¥–æ ${name}</strong><br>
        <span style="color: #2CB4FF; font-size: 12px;">–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...</span>
      `;
      
      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ
      if (currentRoute) {
        try {
          const bounds = currentRoute.getBounds();
          if (bounds) {
            map.setBounds(bounds, {
              checkZoomRange: true,
              zoomMargin: 100
            });
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–∞—Ä—Ç—ã:', error);
        }
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞
    function clearRoute() {
      if (currentRoute) {
        try {
          map.geoObjects.remove(currentRoute);
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞:', error);
        }
        currentRoute = null;
      }
      
      const panel = document.getElementById('route-panel');
      panel.classList.remove('active');
      routePanelVisible = false;
      selectedMeeting = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö
    function openNavigation() {
      if (!selectedMeeting || !selectedMeeting.position) {
        showTempMessage('–ù–µ –≤—ã–±—Ä–∞–Ω –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è');
        return;
      }
      
      const [lat, lon] = selectedMeeting.position;
      const startPosition = userPosition || (currentUser ? currentUser.position : null);
      
      if (!startPosition) {
        showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é: –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ');
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
      const yandexMapsUrl = `yandexmaps://maps.yandex.ru/?rtext=${startPosition[0]},${startPosition[1]}~${lat},${lon}&rtt=auto`;
      const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}&travelmode=driving`;
      
      // –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã
      window.location.href = yandexMapsUrl;
      
      // –ï—Å–ª–∏ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç—ã –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —á–µ—Ä–µ–∑ 500ms –æ—Ç–∫—Ä—ã–≤–∞–µ–º Google Maps
      setTimeout(function() {
        if (!document.hidden) {
          window.open(googleMapsUrl, '_blank');
        }
      }, 500);
    }
    
    function openChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.add('active');
      loadChats();
    }
    
    function closeChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.remove('active');
    }
    
    function loadChats() {
      const chatList = document.getElementById('chat-list');
      if (!currentUser) return;
      
      const chats = ChatSystem.getUserChats(currentUser.id);
      const friends = UserSystem.getUserFriends(currentUser.id);
      
      if (chats.length === 0 && friends.length === 0) {
        chatList.innerHTML = `
          <div class="chat-empty">
            <span class="material-icons" style="font-size: 60px; opacity: 0.5; margin-bottom: 20px;">chat</span>
            <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</div>
          </div>
        `;
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —á–∞—Ç–æ–≤
      let chatHTML = '';
      
      if (chats.length > 0) {
        chats.forEach(chat => {
          const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
          const friend = friends.find(f => f.id === otherParticipantId) || UserSystem.getUserById(otherParticipantId);
          if (!friend) return;
          
          const lastMessage = ChatSystem.getLastMessage(chat);
          const unreadCount = chat.unreadCount || 0;
          const timeAgo = ChatSystem.formatTime(lastMessage.timestamp);
          
          chatHTML += `
            <div class="chat-item" data-chat-id="${chat.id}" data-user-id="${friend.id}">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                <div class="chat-last-message">${lastMessage.text || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                <div class="chat-time">${timeAgo}</div>
              </div>
              ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
            </div>
          `;
        });
      } else {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—Ä—É–∑–µ–π –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞
        friends.forEach(friend => {
          chatHTML += `
            <div class="chat-item" data-user-id="${friend.id}">
              <div class="chat-avatar">
                <span class="material-icons">person</span>
              </div>
              <div class="chat-info">
                <div class="chat-friend-name">${friend.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                <div class="chat-last-message">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
                <div class="chat-time">${friend.status === 'online' ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</div>
              </div>
            </div>
          `;
        });
      }
      
      chatList.innerHTML = chatHTML;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
      document.querySelectorAll('.chat-item').forEach(item => {
        item.addEventListener('click', function() {
          const userId = this.getAttribute('data-user-id');
          const chatId = this.getAttribute('data-chat-id');
          
          if (chatId) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
            window.location.href = `chat.html?chatId=${chatId}&userId=${userId}`;
          } else {
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
            const chat = ChatSystem.createChat(currentUser.id, userId);
            window.location.href = `chat.html?chatId=${chat.id}&userId=${userId}`;
          }
        });
      });
    }
    
    function updateChatNotificationCount() {
      if (!currentUser) return;
      const unreadCount = ChatSystem.getUnreadCount(currentUser.id);
      const badge = document.getElementById('chat-notification-badge');
      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }
    
    function openPedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      const content = document.getElementById('pedometer-content');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —à–∞–≥–æ–º–µ—Ä–∞
      if (!Pedometer.isSupported()) {
        content.innerHTML = `
          <div class="pedometer-not-supported">
            <span class="material-icons">directions_walk_off</span>
            <div>–®–∞–≥–æ–º–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">
              –î–ª—è —Ä–∞–±–æ—Ç—ã —à–∞–≥–æ–º–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–æ–º
            </div>
          </div>
        `;
        overlay.classList.add('active');
        return;
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∞–≥–æ–º–µ—Ä
      Pedometer.initialize();
      const stats = Pedometer.getStats();
      
      content.innerHTML = `
        <div class="pedometer-stats">
          <div class="pedometer-stat">
            <div class="stat-value">${stats.today}</div>
            <div class="stat-label">–®–ê–ì–û–í –°–ï–ì–û–î–ù–Ø</div>
            <div class="stat-subvalue">${stats.distanceToday.toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.week}</div>
            <div class="stat-label">–®–ê–ì–û–í –ó–ê –ù–ï–î–ï–õ–Æ</div>
            <div class="stat-subvalue">${(stats.week * 0.00076).toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.month}</div>
            <div class="stat-label">–®–ê–ì–û–í –ó–ê –ú–ï–°–Ø–¶</div>
            <div class="stat-subvalue">${(stats.month * 0.00076).toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-goal">
            <div class="goal-title">–¶–ï–õ–¨ –ù–ê –î–ï–ù–¨: ${stats.goal} —à–∞–≥–æ–≤</div>
            <div class="goal-progress-bar">
              <div class="goal-progress-fill" style="width: ${stats.goalProgress}%"></div>
            </div>
            <div class="goal-info">
              <span>0</span>
              <span>${Math.round(stats.goalProgress)}%</span>
              <span>${stats.goal}</span>
            </div>
          </div>
        </div>
        
        <div class="pedometer-actions">
          <button class="pedometer-btn btn-start" id="pedometer-start-btn">
            <span class="material-icons">play_arrow</span>
            –ó–∞–ø—É—Å—Ç–∏—Ç—å —à–∞–≥–æ–º–µ—Ä
          </button>
          <button class="pedometer-btn btn-simulate" id="pedometer-simulate-btn">
            <span class="material-icons">shuffle</span>
            –¢–µ—Å—Ç (50 —à–∞–≥–æ–≤)
          </button>
        </div>
      `;
      
      overlay.classList.add('active');
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —à–∞–≥–æ–º–µ—Ä–∞
      document.getElementById('pedometer-start-btn')?.addEventListener('click', function() {
        showTempMessage('–®–∞–≥–æ–º–µ—Ä –∑–∞–ø—É—â–µ–Ω. –ù–æ—Å–∏—Ç–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å —Å–æ–±–æ–π –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —à–∞–≥–æ–≤.');
      });
      
      document.getElementById('pedometer-simulate-btn')?.addEventListener('click', function() {
        const steps = Pedometer.simulateSteps();
        showTempMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${steps} —Ç–µ—Å—Ç–æ–≤—ã—Ö —à–∞–≥–æ–≤`);
        updatePedometerStats();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —à–∞–≥–æ–º–µ—Ä–∞
      document.getElementById('pedometer-close-btn').addEventListener('click', function() {
        closePedometerWindow();
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      window.addEventListener('pedometerUpdate', updatePedometerStats);
    }
    
    function updatePedometerStats() {
      const stats = Pedometer.getStats();
      const content = document.getElementById('pedometer-content');
      
      if (content) {
        const statValues = content.querySelectorAll('.stat-value');
        const statSubvalues = content.querySelectorAll('.stat-subvalue');
        const progressFill = content.querySelector('.goal-progress-fill');
        const goalPercent = content.querySelector('.goal-info span:nth-child(2)');
        
        if (statValues[0]) statValues[0].textContent = stats.today;
        if (statValues[1]) statValues[1].textContent = stats.week;
        if (statValues[2]) statValues[2].textContent = stats.month;
        
        if (statSubvalues[0]) statSubvalues[0].textContent = stats.distanceToday.toFixed(2) + ' –∫–º';
        if (statSubvalues[1]) statSubvalues[1].textContent = (stats.week * 0.00076).toFixed(2) + ' –∫–º';
        if (statSubvalues[2]) statSubvalues[2].textContent = (stats.month * 0.00076).toFixed(2) + ' –∫–º';
        
        if (progressFill) progressFill.style.width = stats.goalProgress + '%';
        if (goalPercent) goalPercent.textContent = Math.round(stats.goalProgress) + '%';
      }
    }
    
    function closePedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      overlay.classList.remove('active');
      window.removeEventListener('pedometerUpdate', updatePedometerStats);
    }
    
    function saveDisplaySettings() {
      localStorage.setItem('meetup_display_settings', JSON.stringify(displaySettings));
    }
    
    function loadDisplaySettings() {
      const saved = localStorage.getItem('meetup_display_settings');
      if (saved) {
        displaySettings = { ...displaySettings, ...JSON.parse(saved) };
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
        document.getElementById('display-all').checked = displaySettings.all;
        document.getElementById('display-friends').checked = displaySettings.friends;
        document.getElementById('display-online').checked = displaySettings.online;
        document.getElementById('display-new').checked = displaySettings.new;
        
        const markerSelect = document.getElementById('friend-marker-select');
        if (markerSelect) {
          markerSelect.value = displaySettings.friendMarker;
          document.getElementById('friend-marker-style').textContent = 
            markerSelect.options[markerSelect.selectedIndex].text;
        }
      }
    }
    
    function initializeEventHandlers() {
      document.getElementById('btn-profile').addEventListener('click', function() {
        window.location.href = 'profile.html';
      });
      
      document.getElementById('btn-add-friend').addEventListener('click', function() {
        window.location.href = 'addfriend.html';
      });
      
      // –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤—Å—Ç—Ä–µ—á–∏ - —Ç–µ–ø–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      document.getElementById('btn-create-meeting').addEventListener('click', openMeetingModal);
      
      // –ö–Ω–æ–ø–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–µ –≤—Å—Ç—Ä–µ—á–∏
      document.getElementById('btn-current-location').addEventListener('click', useCurrentLocationForMeeting);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Å—Ç—Ä–µ—á–∏
      document.getElementById('meeting-modal-close-btn').addEventListener('click', closeMeetingModal);
      document.getElementById('btn-meeting-cancel').addEventListener('click', closeMeetingModal);
      document.getElementById('btn-meeting-create').addEventListener('click', createMeetingFromForm);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      document.querySelectorAll('input[name="privacy"]').forEach(radio => {
        radio.addEventListener('change', updatePrivacySelection);
      });
      
      // –ö–ª–∏–∫–∏ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      document.querySelectorAll('.privacy-option').forEach(option => {
        option.addEventListener('click', function() {
          const radio = this.querySelector('input[type="radio"]');
          if (radio) {
            radio.checked = true;
            updatePrivacySelection();
          }
        });
      });
      
      // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
      document.getElementById('btn-locate').addEventListener('click', function() {
        if (!navigator.geolocation) {
          showTempMessage('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º');
          return;
        }
        
        // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
        if (hasGeolocationPermission) {
          getUserLocation()
            .then(() => {
              showTempMessage('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏');
            })
            .catch(() => {
              showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ');
            });
        } else {
          // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
          requestGeolocationPermission().then(permissionGranted => {
            if (permissionGranted) {
              hasGeolocationPermission = true;
              showTempMessage('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –≤–∞—à–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏');
            }
          });
        }
      });
      
      // –§–∏–ª—å—Ç—Ä—ã (—Ç–µ–ø–µ—Ä—å —Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É)
      document.getElementById('btn-filter').addEventListener('click', function() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('active');
      });
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã (—Ç–µ–ø–µ—Ä—å —Å–ª–µ–≤–∞ —Å–≤–µ—Ä—Ö—É)
      document.getElementById('btn-refresh').addEventListener('click', function() {
        updateMap();
        showTempMessage('–ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
      });
      
      // –ß–∞—Ç—ã
      document.getElementById('btn-chat').addEventListener('click', openChatsWindow);
      document.getElementById('chat-close-btn').addEventListener('click', closeChatsWindow);
      
      // –®–∞–≥–æ–º–µ—Ä
      document.getElementById('btn-pedometer').addEventListener('click', openPedometerWindow);
      
      // –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
      document.getElementById('btn-incognito').addEventListener('click', toggleIncognitoMode);
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      document.getElementById('btn-display-mode').addEventListener('click', function() {
        const panel = document.getElementById('display-panel');
        panel.classList.toggle('active');
      });
      
      // –§–∏–ª—å—Ç—Ä—ã
      document.getElementById('filter-friends').addEventListener('change', function() {
        filterSettings.friends = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-online').addEventListener('change', function() {
        filterSettings.online = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-nearby').addEventListener('change', function() {
        filterSettings.nearby = this.checked;
        updateMap();
      });
      
      document.getElementById('filter-new').addEventListener('change', function() {
        filterSettings.new = this.checked;
        updateMap();
      });
      
      const radiusSlider = document.getElementById('radius-slider');
      const radiusValue = document.getElementById('radius-value');
      radiusSlider.addEventListener('input', function() {
        radiusValue.textContent = this.value;
        filterSettings.radius = parseInt(this.value);
      });
      
      radiusSlider.addEventListener('change', function() {
        updateMap();
        checkNearbyFriends();
      });
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      document.getElementById('display-all').addEventListener('change', function() {
        displaySettings.all = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-friends').addEventListener('change', function() {
        displaySettings.friends = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-online').addEventListener('change', function() {
        displaySettings.online = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('display-new').addEventListener('change', function() {
        displaySettings.new = this.checked;
        updateMap();
        saveDisplaySettings();
      });
      
      document.getElementById('friend-marker-select').addEventListener('change', function() {
        displaySettings.friendMarker = this.value;
        document.getElementById('friend-marker-style').textContent = this.options[this.selectedIndex].text;
        updateMap();
        saveDisplaySettings();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞
      document.getElementById('btn-clear-route').addEventListener('click', clearRoute);
      document.getElementById('btn-navigate').addEventListener('click', openNavigation);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
      const locationInput = document.getElementById('meeting-location');
      const suggestionsDropdown = document.getElementById('suggestions-dropdown');
      
      if (locationInput) {
        // –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ (–ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º)
        locationInput.addEventListener('input', function(e) {
          const query = e.target.value.trim();
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
          if (suggestionsTimeout) {
            clearTimeout(suggestionsTimeout);
          }
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞
          resetValidationStatus();
          
          // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
          if (query.length < 2) {
            hideSuggestions();
            return;
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
          if (suggestionsDropdown) {
            suggestionsDropdown.innerHTML = `
              <div class="suggestion-loading">
                <span class="material-icons" style="font-size: 24px; margin-bottom: 10px;">search</span>
                <div>–ü–æ–∏—Å–∫ –∞–¥—Ä–µ—Å–æ–≤...</div>
              </div>
            `;
            suggestionsDropdown.classList.add('active');
          }
          
          // –î–µ–±–∞—É–Ω—Å–∏–Ω–≥ 300ms
          suggestionsTimeout = setTimeout(async () => {
            try {
              const suggestions = await fetchAddressSuggestions(query);
              showSuggestions(suggestions);
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫:', error);
              hideSuggestions();
            }
          }, 300);
        });
        
        // –§–æ–∫—É—Å
        locationInput.addEventListener('focus', function(e) {
          const query = e.target.value.trim();
          if (query.length >= 2 && currentSuggestions.length > 0) {
            showSuggestions(currentSuggestions);
          }
        });
        
        // –ü–æ—Ç–µ—Ä—è —Ñ–æ–∫—É—Å–∞ (–≤–∞–ª–∏–¥–∞—Ü–∏—è)
        locationInput.addEventListener('blur', function(e) {
          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –ø–æ–¥—Å–∫–∞–∑–∫–µ —Å—Ä–∞–±–æ—Ç–∞–ª
          setTimeout(async () => {
            const query = e.target.value.trim();
            if (query.length >= 3) {
              await validateAddressAsync(query);
            }
            hideSuggestions();
          }, 200);
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º
        locationInput.addEventListener('keydown', function(e) {
          const dropdown = document.getElementById('suggestions-dropdown');
          if (!dropdown || !dropdown.classList.contains('active')) return;
          
          const items = dropdown.querySelectorAll('.suggestion-item');
          if (items.length === 0) return;
          
          switch(e.key) {
            case 'ArrowDown':
              e.preventDefault();
              selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
              updateSelectedSuggestion(items);
              break;
              
            case 'ArrowUp':
              e.preventDefault();
              selectedSuggestionIndex = selectedSuggestionIndex <= 0 ? items.length - 1 : selectedSuggestionIndex - 1;
              updateSelectedSuggestion(items);
              break;
              
            case 'Enter':
              e.preventDefault();
              if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < items.length) {
                selectSuggestion(selectedSuggestionIndex);
              }
              break;
              
            case 'Escape':
              hideSuggestions();
              break;
          }
        });
      }
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
      function updateSelectedSuggestion(items) {
        items.forEach((item, index) => {
          if (index === selectedSuggestionIndex) {
            item.classList.add('selected');
            item.scrollIntoView({ block: 'nearest' });
          } else {
            item.classList.remove('selected');
          }
        });
      }
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
      document.addEventListener('click', function(event) {
        const filterPanel = document.getElementById('filter-panel');
        const filterBtn = document.getElementById('btn-filter');
        const displayPanel = document.getElementById('display-panel');
        const displayBtn = document.getElementById('btn-display-mode');
        const routePanel = document.getElementById('route-panel');
        const meetingModal = document.getElementById('meeting-modal-overlay');
        const meetingModalContainer = document.querySelector('.meeting-modal-container');
        const locationInput = document.getElementById('meeting-location');
        const suggestionsDropdown = document.getElementById('suggestions-dropdown');
        
        if (filterPanel && !filterPanel.contains(event.target) && filterBtn && !filterBtn.contains(event.target)) {
          filterPanel.classList.remove('active');
        }
        
        if (displayPanel && !displayPanel.contains(event.target) && displayBtn && !displayBtn.contains(event.target)) {
          displayPanel.classList.remove('active');
        }
        
        if (routePanel && !routePanel.contains(event.target)) {
          // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ - —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—á–∏—Å—Ç–∏—Ç—å"
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        if (suggestionsDropdown && suggestionsDropdown.classList.contains('active') &&
            !suggestionsDropdown.contains(event.target) && 
            locationInput && !locationInput.contains(event.target)) {
          hideSuggestions();
        }
        
        if (meetingModal && meetingModal.classList.contains('active') && 
            !meetingModalContainer.contains(event.target) && 
            !event.target.closest('#btn-create-meeting')) {
          closeMeetingModal();
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          const meetingModal = document.getElementById('meeting-modal-overlay');
          if (meetingModal.classList.contains('active')) {
            closeMeetingModal();
          }
        }
      });
    }
    
    function adjustLayout() {
      const header = document.querySelector('.app-header');
      const mapContainer = document.querySelector('.map-container');
      if (header && mapContainer) {
        const headerHeight = header.offsetHeight;
        mapContainer.style.height = `calc(100vh - ${headerHeight}px)`;
      }
    }
    
    function initializeApp() {
      console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      currentUser = UserSystem.getCurrentUser();
      if (!currentUser) {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
        window.location.href = 'index.html';
        return;
      }
      
      console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.nickname);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const savedFilters = localStorage.getItem('meetup_map_filters');
      if (savedFilters) {
        filterSettings = { ...filterSettings, ...JSON.parse(savedFilters) };
        document.getElementById('filter-friends').checked = filterSettings.friends;
        document.getElementById('filter-online').checked = filterSettings.online;
        document.getElementById('filter-nearby').checked = filterSettings.nearby;
        document.getElementById('filter-new').checked = filterSettings.new;
        document.getElementById('radius-slider').value = filterSettings.radius;
        document.getElementById('radius-value').textContent = filterSettings.radius;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      loadDisplaySettings();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
      updateIncognitoButton();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏
      updatePrivacySelection();
      
      adjustLayout();
      initializeEventHandlers();
      setTimeout(initializeMap, 500);
      
      updateChatNotificationCount();
      setInterval(updateChatNotificationCount, 30000);
      
      window.addEventListener('resize', adjustLayout);
      window.addEventListener('orientationchange', function() {
        setTimeout(adjustLayout, 300);
      });
      
      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ APK: –ø—ã—Ç–∞–µ–º—Å—è —Å—Ä–∞–∑—É –∑–∞–ø—Ä–æ—Å–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é
      // –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–∞–Ω–µ–µ —Ä–∞–∑—Ä–µ—à–∏–ª–∏)
      setTimeout(() => {
        const permissionAsked = localStorage.getItem('meetup_geolocation_asked');
        if (permissionAsked === 'allowed') {
          getUserLocation().catch(() => {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –∑–∞–ø—Ä–æ—Å–µ
          });
        }
      }, 2000);
    }
    
    function saveFilterSettings() {
      localStorage.setItem('meetup_map_filters', JSON.stringify(filterSettings));
    }
    
    window.addEventListener('beforeunload', function() {
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
      if (geolocationWatchId !== null && navigator.geolocation) {
        navigator.geolocation.clearWatch(geolocationWatchId);
      }
      
      saveFilterSettings();
      saveDisplaySettings();
    });
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      setTimeout(initializeApp, 100);
    });
    
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(initializeApp, 100);
    }
  </script>
</body>
</html>
