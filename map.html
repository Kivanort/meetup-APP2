<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <title>–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π ‚Äî MeetUP</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <script src="userSystem.js"></script>
  <script src="chatSystem.js"></script>
  <script src="pedometer.js"></script>
  <script src="notifications.js"></script>
  <link rel="icon" href="meetup-logo.png" type="image/x-icon">  
  <style>
    :root {
      --main-bg: #0B1222;
      --container: #181F31;
      --primary: #2CB4FF;
      --primary-gradient: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      --neon-glow: #00FFFF;
      --text-light: #fff;
      --text-muted: #9FAFD4;
      --success: #34eb89;
      --error: #FF4444;
      --warning: #FFA726;
    }
    
    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent; 
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--main-bg);
      color: var(--text-light);
      overflow: hidden;
    }
    
    #app-root {
      height: 100vh;
      height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
    }
    
    .app-header { 
      background: var(--container); 
      box-shadow: 0 2px 20px rgba(0,0,0,0.3); 
      position: relative; 
      z-index: 10; 
      flex-shrink: 0;
    }
    
    .header-content { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 15px 20px;
    }
    
    .logo-title { 
      display: flex; 
      align-items: center; 
      gap: 12px;
    }
    
    .app-logo { 
      font-size: 24px; 
      font-weight: 800; 
      background: var(--primary-gradient); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      background-clip: text; 
    }
    
    .app-subtitle { 
      color: var(--text-muted); 
      font-size: 14px; 
    }
    
    .header-actions { 
      display: flex; 
      gap: 10px; 
    }
    
    .profile-btn { 
      width: 50px; 
      height: 50px; 
      border: none; 
      border-radius: 50%; 
      background: var(--primary-gradient); 
      color: white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      position: relative; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .profile-btn:hover { 
      transform: scale(1.05); 
      box-shadow: 0 0 20px rgba(0,255,255,0.6);
    }
    
    .profile-btn:active { 
      transform: scale(0.95); 
      box-shadow: 0 0 30px rgba(0,255,255,0.8);
    }
    
    .map-container { 
      flex: 1; 
      position: relative; 
      overflow: hidden; 
    }
    
    #map { 
      width: 100%; 
      height: 100%; 
      background: #131827; 
    }
    
    .map-placeholder { 
      width: 100%; 
      height: 100%; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      background: #131827; 
      color: var(--text-muted); 
      gap: 15px; 
      position: absolute; 
      top: 0; 
      left: 0; 
      z-index: 20;
    }
    
    .map-placeholder.hidden { 
      display: none;
    }
    
    .floating-buttons { 
      position: absolute; 
      bottom: 20px; 
      left: 0; 
      right: 0; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 15px; 
      padding: 0 20px; 
      z-index: 5; 
    }
    
    .fab-primary { 
      padding: 16px 20px; 
      background: var(--primary-gradient); 
      border: none; 
      border-radius: 16px; 
      color: white; 
      font-size: 15px; 
      font-weight: 600; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      cursor: pointer; 
      box-shadow: 0 4px 20px rgba(44,180,255,0.4); 
      transition: all 0.2s ease; 
      min-height: 54px; 
      white-space: nowrap;
    }
    
    .fab-primary:hover { 
      transform: scale(1.05); 
      box-shadow: 0 6px 25px rgba(44,180,255,0.6);
    }
    
    .fab-primary:active { 
      transform: scale(0.95);
    }
    
    .fab-secondary { 
      width: 54px; 
      height: 54px; 
      border: none; 
      border-radius: 50%; 
      background: var(--container); 
      color: var(--primary); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
      transition: all 0.2s ease;
    }
    
    .fab-secondary:hover { 
      transform: scale(1.05); 
      background: var(--primary); 
      color: white;
    }
    
    .fab-secondary:active { 
      transform: scale(0.95);
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ */
    .temp-message { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      background: rgba(0,0,0,0.85); 
      color: white; 
      padding: 15px 25px; 
      border-radius: 12px; 
      font-size: 14px; 
      z-index: 1000; 
      backdrop-filter: blur(10px); 
      text-align: center; 
      max-width: 80%;
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      animation: fadeInUp 0.3s ease;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translate(-50%, -40%);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%);
      }
    }
    
    .map-controls { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      z-index: 100; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
    }
    
    .map-filter-btn { 
      width: 54px; 
      height: 54px; 
      border-radius: 50%; 
      background: var(--container); 
      border: 2px solid var(--primary); 
      color: var(--primary); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .map-filter-btn:hover { 
      background: var(--primary); 
      color: white; 
      transform: scale(1.1);
    }
    
    .map-filter-btn.active { 
      background: var(--primary); 
      color: white;
    }
    
    .filter-panel { 
      position: absolute; 
      top: 70px; 
      right: 20px; 
      background: var(--container); 
      border-radius: 12px; 
      padding: 15px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.4); 
      z-index: 99; 
      display: none; 
      min-width: 200px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .filter-panel.active { 
      display: block; 
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0; 
        transform: translateY(-10px);
      } 
      to {
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    .filter-option { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 12px; 
      color: var(--text-light); 
      font-size: 14px; 
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }
    
    .filter-option:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .filter-option input[type="checkbox"] { 
      width: 18px; 
      height: 18px; 
      accent-color: var(--primary);
    }
    
    .nearby-notification { 
      position: fixed; 
      bottom: 100px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 12px; 
      box-shadow: 0 8px 24px rgba(44,180,255,0.3); 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      animation: slideUp 0.5s ease; 
      max-width: 90%;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    @keyframes slideUp { 
      from { 
        opacity: 0; 
        transform: translateX(-50%) translateY(30px); 
      } 
      to { 
        opacity: 1; 
        transform: translateX(-50%) translateY(0); 
      } 
    }
    
    .auto-update-indicator { 
      position: fixed; 
      top: 20px; 
      left: 50%; 
      transform: translateX(-50%); 
      background: rgba(30,30,30,0.9); 
      color: var(--success); 
      padding: 8px 16px; 
      border-radius: 20px; 
      font-size: 12px; 
      display: flex; 
      align-items: center; 
      gap: 8px; 
      z-index: 100; 
      backdrop-filter: blur(10px);
      border: 1px solid rgba(52,235,137,0.3);
    }
    
    .notification-badge { 
      position: absolute; 
      top: -5px; 
      right: -5px; 
      background: var(--error); 
      color: white; 
      font-size: 10px; 
      width: 18px; 
      height: 18px; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-weight: bold;
    }
    
    /* –ü–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .display-panel {
      position: absolute;
      top: 70px;
      right: 20px;
      background: var(--container);
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      z-index: 99;
      display: none;
      min-width: 220px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .display-panel.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    
    /* –û–∫–Ω–æ —á–∞—Ç–æ–≤ */
    .chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .chat-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .chat-container {
      width: 90%;
      max-width: 400px;
      height: 80%;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .chat-header {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }
    
    .chat-close-btn {
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .chat-close-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }
    
    .chat-list {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .chat-item {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }
    
    .chat-item:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--primary);
      transform: translateY(-2px);
    }
    
    .chat-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2a2a3a;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .chat-info {
      flex: 1;
      min-width: 0;
    }
    
    .chat-friend-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
      margin-bottom: 5px;
    }
    
    .chat-last-message {
      font-size: 14px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .chat-time {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 5px;
    }
    
    .chat-unread {
      background: var(--primary);
      color: white;
      font-size: 12px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .chat-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 40px 20px;
      font-size: 14px;
    }
    
    /* –û–∫–Ω–æ —à–∞–≥–æ–º–µ—Ä–∞ */
    .pedometer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .pedometer-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    .pedometer-container {
      width: 90%;
      max-width: 500px;
      background: var(--container);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .pedometer-header {
      background: linear-gradient(135deg, var(--success) 0%, #08e7bd 100%);
      padding: 25px;
      text-align: center;
    }
    
    .pedometer-title {
      font-size: 24px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }
    
    .pedometer-subtitle {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    
    .pedometer-content {
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    .pedometer-stats {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .pedometer-stat {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--success);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .stat-subvalue {
      font-size: 16px;
      color: #2CB4FF;
      margin-top: 5px;
    }
    
    .pedometer-goal {
      background: rgba(255,255,255,0.05);
      border-radius: 15px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .goal-title {
      font-size: 16px;
      color: white;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .goal-progress-bar {
      height: 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .goal-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #08e7bd);
      border-radius: 5px;
      transition: width 0.5s ease;
    }
    
    .goal-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .pedometer-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    
    .pedometer-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-start {
      background: linear-gradient(135deg, var(--success) 0%, #08e7bd 100%);
      color: white;
    }
    
    .btn-simulate {
      background: linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%);
      color: white;
    }
    
    .btn-close {
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .pedometer-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .pedometer-not-supported {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .pedometer-not-supported .material-icons {
      font-size: 60px;
      color: var(--error);
      margin-bottom: 20px;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ —Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö—É */
    .map-controls-top {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .map-filter-btn-left {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--container);
      border: 2px solid var(--primary);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .map-filter-btn-left:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }
    
    /* –°—Ç–∏–ª—å –¥–ª—è –º–µ—Ç–∫–∏ –ø—Ä–∏–∑—Ä–∞–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–µ */
    .ghost-marker {
      filter: grayscale(100%) brightness(150%);
      opacity: 0.7;
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–æ—Ä–º—ã */
    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      outline: none;
      -webkit-appearance: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 0 10px rgba(44,180,255,0.5);
    }
    
    select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      background: var(--container);
      color: white;
      border: 1px solid var(--primary);
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }
    
    select option {
      background: var(--container);
      color: white;
      padding: 10px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    @media (max-width: 768px) {
      .header-content {padding: 12px 15px;}
      .app-logo {font-size: 20px;}
      .app-subtitle {font-size: 13px;}
      .profile-btn {width: 45px; height: 45px;}
      .fab-primary {padding: 14px 18px; font-size: 14px; min-height: 50px; border-radius: 14px;}
      .fab-secondary {width: 50px; height: 50px;}
      .floating-buttons {bottom: 15px; padding: 0 15px; gap: 12px;}
      .map-controls {top: 15px; right: 15px;}
      .map-filter-btn {width: 50px; height: 50px;}
      .map-controls-top {top: 15px; left: 15px;}
      .map-filter-btn-left {width: 50px; height: 50px;}
      .filter-panel {top: 60px; right: 15px; min-width: 180px;}
      .display-panel {top: 60px; right: 15px; min-width: 180px;}
    }
    
    @media (max-width: 480px) {
      .header-content {padding: 10px 12px;}
      .logo-title {gap: 8px;}
      .app-logo {font-size: 18px;}
      .app-subtitle {display: none;}
      .profile-btn {width: 42px; height: 42px;}
      .profile-btn .material-icons {font-size: 20px;}
      .fab-primary span:last-child {display: none;}
      .fab-primary {padding: 12px 15px; min-height: 48px; border-radius: 12px;}
      .fab-secondary {width: 48px; height: 48px;}
      .floating-buttons {bottom: 12px; padding: 0 12px;}
      .map-controls {top: 10px; right: 10px;}
      .map-filter-btn {width: 45px; height: 45px;}
      .map-controls-top {top: 10px; left: 10px;}
      .map-filter-btn-left {width: 45px; height: 45px;}
      .pedometer-content {padding: 20px;}
      .stat-value {font-size: 28px;}
    }
  </style>
</head>
<body>
  <div id="app-root">
    <header class="app-header">
      <div class="header-content">
        <div class="logo-title">
          <div class="app-logo">meetup</div>
          <div class="app-subtitle">–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π</div>
        </div>
        <div class="header-actions">
          <button class="profile-btn" id="btn-profile" title="–ü—Ä–æ—Ñ–∏–ª—å">
            <span class="material-icons">person</span>
            <div class="notification-badge" id="notification-badge" style="display: none;">0</div>
          </button>
        </div>
      </div>
    </header>
    
    <div class="map-container">
      <div id="map"></div>
      <div class="map-placeholder" id="map-placeholder">
        <span class="material-icons" style="font-size: 64px; opacity: 0.5;">map</span>
        <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã...</div>
        <div class="loading-spinner" style="margin-top: 10px;"></div>
      </div>
      
      <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç—ã —Å–ø—Ä–∞–≤–∞ -->
      <div class="map-controls">
        <button class="map-filter-btn" id="btn-chat" title="–ß–∞—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏">
          <span class="material-icons">chat</span>
          <div class="notification-badge" id="chat-notification-badge" style="display: none;">0</div>
        </button>
        
        <button class="map-filter-btn" id="btn-pedometer" title="–®–∞–≥–æ–º–µ—Ä">
          <span class="material-icons">directions_walk</span>
        </button>
        
        <button class="map-filter-btn" id="btn-incognito" title="–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ">
          <span class="material-icons" id="incognito-icon">visibility_off</span>
        </button>
        
        <button class="map-filter-btn" id="btn-display-mode" title="–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π">
          <span class="material-icons">people</span>
        </button>
      </div>
      
      <!-- –ö–æ–Ω—Ç—Ä–æ–ª—ã –∫–∞—Ä—Ç—ã —Å–ª–µ–≤–∞ -->
      <div class="map-controls-top">
        <button class="map-filter-btn-left" id="btn-filter" title="–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ä—Ç—ã">
          <span class="material-icons">filter_list</span>
        </button>
        <button class="map-filter-btn-left" id="btn-refresh" title="–û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É">
          <span class="material-icons">refresh</span>
        </button>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
      <div class="filter-panel" id="filter-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ä—Ç—ã</h4>
        <label class="filter-option">
          <input type="checkbox" id="filter-friends" checked>
          <span>–î—Ä—É–∑—å—è</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-online" checked>
          <span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-nearby" checked>
          <span>–†—è–¥–æ–º —Å–æ –º–Ω–æ–π</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="filter-new" checked>
          <span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            –†–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞: <span id="radius-value">5</span> –∫–º
          </label>
          <input type="range" id="radius-slider" min="1" max="50" value="5">
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button id="btn-apply-filters" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
          </button>
          <button id="btn-reset-filters" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 8px; cursor: pointer;">
            –°–±—Ä–æ—Å–∏—Ç—å
          </button>
        </div>
      </div>
      
      <!-- –ü–∞–Ω–µ–ª—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
      <div class="display-panel" id="display-panel">
        <h4 style="margin: 0 0 15px 0; color: var(--text-light);">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h4>
        <label class="filter-option">
          <input type="checkbox" id="display-all" checked>
          <span>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-friends" checked>
          <span>–¢–æ–ª—å–∫–æ –¥—Ä—É–∑—å—è</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-online" checked>
          <span>–¢–æ–ª—å–∫–æ –æ–Ω–ª–∞–π–Ω</span>
        </label>
        <label class="filter-option">
          <input type="checkbox" id="display-new" checked>
          <span>–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
        </label>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
          <label style="color: var(--text-muted); font-size: 12px; display: block; margin-bottom: 8px;">
            –ú–∞—Ä–∫–µ—Ä—ã –¥—Ä—É–∑–µ–π: <span id="friend-marker-style">—Å–∏–Ω–∏–π</span>
          </label>
          <select id="friend-marker-select">
            <option value="blue">–°–∏–Ω–∏–π</option>
            <option value="green">–ó–µ–ª–µ–Ω—ã–π</option>
            <option value="red">–ö—Ä–∞—Å–Ω—ã–π</option>
            <option value="purple">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π</option>
            <option value="gold">–ó–æ–ª–æ—Ç–æ–π</option>
            <option value="cyan">–ì–æ–ª—É–±–æ–π</option>
            <option value="orange">–û—Ä–∞–Ω–∂–µ–≤—ã–π</option>
          </select>
        </div>
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button id="btn-apply-display" style="flex: 1; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
            –ü—Ä–∏–º–µ–Ω–∏—Ç—å
          </button>
        </div>
      </div>
      
      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞–≤–∞—é—â–∏–µ –∫–Ω–æ–ø–∫–∏ -->
      <div class="floating-buttons">
        <button class="fab-secondary" id="btn-locate" title="–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ">
          <span class="material-icons">navigation</span>
        </button>
        <button class="fab-primary" id="btn-add-friend">
          <span class="material-icons">person_add</span>
          <span>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</span>
        </button>
        <button class="fab-secondary" id="btn-layers" title="–°–ª–æ–∏ –∫–∞—Ä—Ç—ã" style="display: none;">
          <span class="material-icons">layers</span>
        </button>
      </div>
    </div>
  </div>
  
  <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
  <div class="auto-update-indicator" id="auto-update-indicator" style="display: none;">
    <span class="material-icons" style="font-size: 16px;">autorenew</span>
    <span>–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="update-timer">30</span>—Å</span>
  </div>
  
  <!-- –û–∫–Ω–æ —á–∞—Ç–æ–≤ -->
  <div class="chat-overlay" id="chat-overlay">
    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">–ß–∞—Ç—ã —Å –¥—Ä—É–∑—å—è–º–∏</div>
        <button class="chat-close-btn" id="chat-close-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="chat-list" id="chat-list">
        <div class="chat-empty">
          <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...
        </div>
      </div>
    </div>
  </div>
  
  <!-- –û–∫–Ω–æ —à–∞–≥–æ–º–µ—Ä–∞ -->
  <div class="pedometer-overlay" id="pedometer-overlay">
    <div class="pedometer-container">
      <div class="pedometer-header">
        <div class="pedometer-title">–®–∞–≥–æ–º–µ—Ä</div>
        <div class="pedometer-subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –≤–∞—à—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
      </div>
      <div class="pedometer-content" id="pedometer-content">
        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç —à–∞–≥–æ–º–µ—Ä–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>
      <div class="pedometer-actions" style="padding: 0 30px 30px 30px;">
        <button class="pedometer-btn btn-close" id="pedometer-close-btn">
          <span class="material-icons">close</span>
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    </div>
  </div>
  
  <script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    const CONFIG = {
      MAP_API_KEY: '–≤–∞—à_–∫–ª—é—á_–∞–ø–∏_–∑–¥–µ—Å—å', // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á
      AUTO_UPDATE_INTERVAL: 30000, // 30 —Å–µ–∫—É–Ω–¥
      MAX_RETRIES: 3,
      DEFAULT_RADIUS: 5,
      DEFAULT_ZOOM: 12,
      MIN_ZOOM: 2,
      MAX_ZOOM: 19
    };
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let map = null;
    let currentUser = null;
    let friendsClusterer = null;
    let usersClusterer = null;
    let autoUpdateInterval = null;
    let updateTimer = 30;
    let isIncognitoMode = false;
    let isMapsApiLoading = false;
    let mapsApiLoadCallbacks = [];
    let retryCount = 0;
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    let filterSettings = {
      friends: true,
      online: true,
      nearby: true,
      new: true,
      radius: CONFIG.DEFAULT_RADIUS
    };
    
    let displaySettings = {
      all: true,
      friends: true,
      online: true,
      new: true,
      friendMarker: 'blue'
    };
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –º–µ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    let currentUserPlacemark = null;
    let locationCircleHighlight = null;
    
    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    
    function showTempMessage(message, duration = 3000, type = 'info') {
      const existingMessage = document.querySelector('.temp-message');
      if (existingMessage) existingMessage.remove();
      
      const messageEl = document.createElement('div');
      messageEl.className = 'temp-message';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
      let icon = 'info';
      if (type === 'success') icon = 'check_circle';
      if (type === 'error') icon = 'error';
      if (type === 'warning') icon = 'warning';
      
      messageEl.innerHTML = `
        <span class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 18px;">
          ${icon}
        </span>
        <span style="vertical-align: middle;">${message}</span>
      `;
      
      document.body.appendChild(messageEl);
      
      setTimeout(() => {
        if (messageEl.parentNode) {
          messageEl.style.opacity = '0';
          messageEl.style.transform = 'translate(-50%, -60%)';
          setTimeout(() => {
            if (messageEl.parentNode) messageEl.remove();
          }, 300);
        }
      }, duration);
    }
    
    function showLoading(show = true, message = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
      const placeholder = document.getElementById('map-placeholder');
      if (!placeholder) return;
      
      if (show) {
        placeholder.classList.remove('hidden');
        placeholder.innerHTML = `
          <span class="material-icons" style="font-size: 64px; opacity: 0.5;">map</span>
          <div>${message}</div>
          <div class="loading-spinner" style="margin-top: 10px;"></div>
        `;
      } else {
        placeholder.classList.add('hidden');
      }
    }
    
    function calculateDistance(pos1, pos2) {
      const [lat1, lon1] = pos1;
      const [lat2, lon2] = pos2;
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    function getRussianPlural(number, forms) {
      const cases = [2, 0, 1, 1, 1, 2];
      return forms[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[Math.min(number % 10, 5)]];
    }
    
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
    
    // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–ê–†–¢–û–ô ==========
    
    function loadYandexMapsAPI() {
      return new Promise((resolve, reject) => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ª–∏ –∫–∞—Ä—Ç–∞ —É–∂–µ
        if (typeof ymaps !== 'undefined') {
          ymaps.ready(() => resolve(ymaps));
          return;
        }
        
        if (isMapsApiLoading) {
          mapsApiLoadCallbacks.push({ resolve, reject });
          return;
        }
        
        isMapsApiLoading = true;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        showLoading(true, '–ó–∞–≥—Ä—É–∑–∫–∞ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç...');
        
        const script = document.createElement('script');
        script.src = `https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=${CONFIG.MAP_API_KEY}`;
        script.async = true;
        
        script.onload = () => {
          if (typeof ymaps !== 'undefined' && ymaps.ready) {
            ymaps.ready(() => {
              isMapsApiLoading = false;
              console.log('‚úÖ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
              resolve(ymaps);
              
              // –í—ã–∑—ã–≤–∞–µ–º –≤—Å–µ –æ–∂–∏–¥–∞—é—â–∏–µ –∫–æ–ª–ª–±—ç–∫–∏
              mapsApiLoadCallbacks.forEach(cb => cb.resolve(ymaps));
              mapsApiLoadCallbacks = [];
            });
          } else {
            const error = new Error('Yandex Maps API –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –Ω–µ –≥–æ—Ç–æ–≤');
            reject(error);
            mapsApiLoadCallbacks.forEach(cb => cb.reject(error));
            mapsApiLoadCallbacks = [];
          }
        };
        
        script.onerror = () => {
          isMapsApiLoading = false;
          const error = new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
          reject(error);
          
          mapsApiLoadCallbacks.forEach(cb => cb.reject(error));
          mapsApiLoadCallbacks = [];
        };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
        setTimeout(() => {
          if (isMapsApiLoading) {
            const error = new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç');
            reject(error);
            mapsApiLoadCallbacks.forEach(cb => cb.reject(error));
            mapsApiLoadCallbacks = [];
          }
        }, 10000);
        
        document.head.appendChild(script);
      });
    }
    
    function attemptLoadMaps() {
      return loadYandexMapsAPI()
        .catch(error => {
          retryCount++;
          console.warn(`–ü–æ–ø—ã—Ç–∫–∞ ${retryCount}/${CONFIG.MAX_RETRIES} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error.message);
          
          if (retryCount < CONFIG.MAX_RETRIES) {
            showLoading(true, `–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏... (${retryCount}/${CONFIG.MAX_RETRIES})`);
            return new Promise(resolve => {
              setTimeout(() => {
                attemptLoadMaps().then(resolve);
              }, 2000 * retryCount); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
            });
          } else {
            throw error;
          }
        });
    }
    
    function initializeMap() {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
      retryCount = 0;
      
      attemptLoadMaps()
        .then(ymaps => {
          currentUser = UserSystem.getCurrentUser();
          
          if (!currentUser) {
            showTempMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω', 3000, 'error');
            setTimeout(() => window.location.href = 'index.html', 1000);
            return;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
          isIncognitoMode = currentUser.invisible || false;
          updateIncognitoButton();
          
          const defaultPosition = currentUser.position || [55.751244, 37.618423];
          
          try {
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
            const allUsers = UserSystem.getUsers();
            const positions = allUsers
              .filter(user => user.position && Array.isArray(user.position))
              .map(user => user.position);
            
            let initialCenter = defaultPosition;
            let initialZoom = CONFIG.DEFAULT_ZOOM;
            
            if (positions.length > 1) {
              const collection = new ymaps.GeoObjectCollection();
              positions.forEach(pos => {
                collection.add(new ymaps.Placemark(pos));
              });
              
              const bounds = ymaps.util.bounds.fromPoints(positions);
              const mapSize = [document.getElementById('map').offsetWidth, document.getElementById('map').offsetHeight];
              const center = ymaps.geoQuery(positions).getCenter();
              
              if (center) initialCenter = center;
              
              const zoom = ymaps.util.bounds.getZoom(bounds, mapSize);
              initialZoom = Math.max(CONFIG.MIN_ZOOM, Math.min(CONFIG.MAX_ZOOM, zoom - 0.5));
            }
            
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã (–≤–µ—Å—å –º–∏—Ä)
            const limitBounds = [[85, -179], [-85, 179]];
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            map = new ymaps.Map('map', {
              center: initialCenter,
              zoom: initialZoom,
              controls: [],
              restrictMapArea: limitBounds,
              suppressMapOpenBlock: true,
              suppressObsoleteBrowserNotifier: true
            }, {
              minZoom: CONFIG.MIN_ZOOM,
              maxZoom: CONFIG.MAX_ZOOM,
              yandexMapDisablePoiInteractivity: true
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showLoading(false);
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
            map.options.set({
              restrictMapArea: limitBounds,
              yandexMapDisablePoiInteractivity: true,
              yandexMapDisablePanOnEdge: true,
              suppressMapOpenBlock: true,
              suppressMapDragOutside: true
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã
            map.events.add('boundschange', function(e) {
              const bounds = map.getBounds();
              if (
                bounds[0][0] > limitBounds[0][0] || bounds[1][0] < limitBounds[1][0] ||
                bounds[0][1] < limitBounds[0][1] || bounds[1][1] > limitBounds[1][1]
              ) {
                map.setBounds(limitBounds, { checkZoomRange: true, duration: 0 });
              }
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
            map.controls.add('zoomControl', {
              size: 'small',
              float: 'none',
              position: { right: 10, top: 100 }
            });
            
            map.controls.add('geolocationControl', {
              float: 'none',
              position: { right: 10, top: 150 }
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä—ã
            friendsClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedVioletClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            usersClusterer = new ymaps.Clusterer({
              preset: 'islands#invertedBlueClusterIcons',
              clusterDisableClickZoom: true,
              clusterHideIconOnBalloonOpen: false,
              geoObjectHideIconOnBalloonOpen: false
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
            updateMap();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–±–ª–∏–∂–∞–µ–º –∫ –¥—Ä—É–∑—å—è–º, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
            const friends = UserSystem.getUserFriends(currentUser.id);
            if (friends.length > 0) {
              setTimeout(() => {
                const friendPositions = friends
                  .filter(f => f.position && !f.invisible)
                  .map(f => f.position);
                
                if (friendPositions.length > 0) {
                  try {
                    const bounds = ymaps.util.bounds.fromPoints(friendPositions);
                    map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 50 });
                  } catch (e) {
                    console.log('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ä—Ç—ã:', e);
                  }
                }
              }, 1000);
            }
            
            console.log('‚úÖ –ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            startAutoUpdate();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            updateChatNotificationCount();
            setInterval(updateChatNotificationCount, 30000);
            
          } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error);
            showLoading(true, '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã');
            
            const placeholder = document.getElementById('map-placeholder');
            placeholder.innerHTML = `
              <span class="material-icons" style="font-size: 64px; color: var(--error);">error</span>
              <div style="margin: 10px 0;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã</div>
              <div style="font-size: 12px; margin-bottom: 20px; color: var(--text-muted);">
                ${error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
              </div>
              <button onclick="location.reload()" style="
                padding: 10px 20px;
                background: var(--primary-gradient);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                font-weight: 600;
              ">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
            `;
          }
        })
        .catch(error => {
          console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç:', error);
          
          const placeholder = document.getElementById('map-placeholder');
          placeholder.innerHTML = `
            <span class="material-icons" style="font-size: 64px; color: var(--error);">wifi_off</span>
            <div style="margin: 10px 0;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É</div>
            <div style="font-size: 12px; margin-bottom: 20px; color: var(--text-muted);">
              ${error.message || '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É'}
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="initializeMap()" style="
                flex: 1;
                padding: 10px;
                background: var(--primary-gradient);
                border: none;
                border-radius: 8px;
                color: white;
                cursor: pointer;
                font-weight: 600;
              ">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
              <button onclick="window.location.href='profile.html'" style="
                flex: 1;
                padding: 10px;
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.2);
                border-radius: 8px;
                color: white;
                cursor: pointer;
              ">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
            </div>
          `;
        });
    }
    
    function updateIncognitoButton() {
      const btn = document.getElementById('btn-incognito');
      const icon = document.getElementById('incognito-icon');
      
      if (isIncognitoMode) {
        btn.classList.add('active');
        btn.title = '–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤–∫–ª—é—á–µ–Ω';
        icon.textContent = 'visibility_off';
        icon.style.color = '#FF4444';
      } else {
        btn.classList.remove('active');
        btn.title = '–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ';
        icon.textContent = 'visibility_off';
        icon.style.color = '';
      }
    }
    
    function updateCurrentUserPlacemark() {
      if (!map || !currentUser || typeof ymaps === 'undefined') return;
      
      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –º–µ—Ç–∫—É
      if (currentUserPlacemark) {
        map.geoObjects.remove(currentUserPlacemark);
      }
      
      // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∫—Ä—ã—Ç –∏–ª–∏ –Ω–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ - –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
      if (isIncognitoMode || !currentUser.position) {
        currentUserPlacemark = null;
        return;
      }
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
      const iconColor = isIncognitoMode ? '#FF4444' : '#2CB4FF';
      const preset = isIncognitoMode ? 'islands#redCircleDotIcon' : 'islands#blueCircleDotIcon';
      const statusText = isIncognitoMode ? '–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ' : '–í—ã –æ–Ω–ª–∞–π–Ω';
      
      currentUserPlacemark = new ymaps.Placemark(
        currentUser.position,
        {
          balloonContent: `
            <div style="padding: 10px; min-width: 200px;">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${isIncognitoMode ? 'linear-gradient(135deg, #FF4444 0%, #992222 100%)' : 'linear-gradient(135deg, #2CB4FF 0%, #B970FE 100%)'}; display: flex; align-items: center; justify-content: center;">
                  <span class="material-icons" style="color: white;">person</span>
                </div>
                <div>
                  <strong style="color: white;">${currentUser.nickname || '–í—ã'}</strong><br>
                  <span style="color: ${isIncognitoMode ? '#FF4444' : '#2CB4FF'}; font-size: 12px;">
                    ${statusText}
                  </span>
                </div>
              </div>
              ${currentUser.about ? `<p style="color: #aaa; font-size: 13px; margin: 10px 0;">${currentUser.about}</p>` : ''}
              <div style="margin-top: 15px; display: flex; gap: 10px;">
                <button onclick="window.location.href='profile.html'" style="flex: 1; padding: 8px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                  –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                </button>
              </div>
            </div>
          `,
          iconCaption: isIncognitoMode ? 'üëª –°–∫—Ä—ã—Ç' : '–í—ã'
        },
        { 
          preset: preset, 
          iconColor: iconColor,
          iconCaptionMaxWidth: '150px',
          hasBalloon: true,
          openBalloonOnClick: true
        }
      );
      
      map.geoObjects.add(currentUserPlacemark);
    }
    
    function updateMap() {
      if (!map || !currentUser || typeof ymaps === 'undefined') {
        console.log('–ö–∞—Ä—Ç–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
        return;
      }
      
      console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã...');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–∫—É —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      updateCurrentUserPlacemark();
      
      // –û—á–∏—â–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä—ã
      if (friendsClusterer) friendsClusterer.removeAll();
      if (usersClusterer) usersClusterer.removeAll();
      
      // –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ç–∫–∏ –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      map.geoObjects.each(function(geoObject) {
        if (geoObject !== currentUserPlacemark && 
            geoObject !== locationCircleHighlight &&
            geoObject !== friendsClusterer && 
            geoObject !== usersClusterer) {
          map.geoObjects.remove(geoObject);
        }
      });
      
      const allUsers = UserSystem.getUsers();
      const friends = UserSystem.getUserFriends(currentUser.id);
      const friendIds = friends.map(f => f.id);
      
      // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      const filteredUsers = allUsers.filter(user => {
        if (user.id === currentUser.id || !user.position) return false;
        
        const isFriend = friendIds.includes(user.id);
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–∂–∏–º—É –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
        if (user.invisible && !isIncognitoMode) return false;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (!displaySettings.all && !isFriend) return false;
        if (!displaySettings.friends && isFriend) return false;
        if (displaySettings.online && user.status !== 'online') return false;
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é
        if (filterSettings.nearby && currentUser.position) {
          const distance = calculateDistance(currentUser.position, user.position);
          if (distance > filterSettings.radius) return false;
        }
        
        return true;
      });
      
      console.log(`–ü–æ–∫–∞–∑–∞–Ω–æ ${filteredUsers.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ ${allUsers.length}`);
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç—É
      filteredUsers.forEach(user => {
        const isFriend = friendIds.includes(user.id);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ —Å—Ç–∏–ª—å –º–µ—Ç–∫–∏
        let iconColor, preset, iconCaption;
        
        if (isFriend) {
          // –¶–≤–µ—Ç –¥–ª—è –¥—Ä—É–∑–µ–π –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
          switch(displaySettings.friendMarker) {
            case 'green':
              iconColor = user.status === 'online' ? '#34eb89' : '#2a7a2a';
              preset = 'islands#greenCircleDotIcon';
              break;
            case 'red':
              iconColor = user.status === 'online' ? '#ff4444' : '#992222';
              preset = 'islands#redCircleDotIcon';
              break;
            case 'purple':
              iconColor = user.status === 'online' ? '#B970FE' : '#663399';
              preset = 'islands#violetCircleDotIcon';
              break;
            case 'gold':
              iconColor = user.status === 'online' ? '#FFD700' : '#B8860B';
              preset = 'islands#yellowCircleDotIcon';
              break;
            case 'cyan':
              iconColor = user.status === 'online' ? '#00FFFF' : '#008B8B';
              preset = 'islands#lightBlueCircleDotIcon';
              break;
            case 'orange':
              iconColor = user.status === 'online' ? '#FFA726' : '#FF8C00';
              preset = 'islands#orangeCircleDotIcon';
              break;
            default: // blue
              iconColor = user.status === 'online' ? '#2CB4FF' : '#1a5a7a';
              preset = 'islands#blueCircleDotIcon';
          }
          iconCaption = `‚úì ${user.nickname || '–î—Ä—É–≥'}`;
        } else {
          // –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
          iconColor = user.status === 'online' ? '#A4B0BE' : '#666666';
          preset = 'islands#grayCircleDotIcon';
          iconCaption = user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–µ—Ç–∫—É
        const placemark = new ymaps.Placemark(
          user.position,
          {
            balloonContent: `
              <div style="padding: 10px; min-width: 250px;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="width: 50px; height: 50px; border-radius: 50%; background: #2a2a3a; display: flex; align-items: center; justify-content: center;">
                    <span class="material-icons" style="color: ${isFriend ? iconColor : '#888'}; font-size: 24px;">person</span>
                  </div>
                  <div>
                    <strong style="color: white; font-size: 16px;">${user.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</strong><br>
                    <span style="color: ${isFriend ? iconColor : '#888'}; font-size: 12px;">
                      ${isFriend ? '‚úì –î—Ä—É–≥' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'} ‚Ä¢ ${user.status === 'online' ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏'}
                    </span>
                  </div>
                </div>
                ${user.about ? `<p style="color: #aaa; font-size: 13px; margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px;">${user.about}</p>` : ''}
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                  ${!isFriend ? 
                    `<button onclick="addFriend('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                      <span class="material-icons" style="font-size: 14px; vertical-align: middle;">person_add</span>
                      –î–æ–±–∞–≤–∏—Ç—å
                    </button>` : 
                    `<button onclick="openChat('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px 12px; background: var(--success); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                      <span class="material-icons" style="font-size: 14px; vertical-align: middle;">chat</span>
                      –ù–∞–ø–∏—Å–∞—Ç—å
                    </button>`
                  }
                  <button onclick="showUserProfile('${user.id}')" style="flex: 1; min-width: 120px; padding: 8px 12px; background: #555; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">
                    <span class="material-icons" style="font-size: 14px; vertical-align: middle;">visibility</span>
                    –ü—Ä–æ—Ñ–∏–ª—å
                  </button>
                </div>
              </div>
            `,
            iconCaption: iconCaption
          },
          { 
            preset: preset, 
            iconColor: iconColor,
            iconCaptionMaxWidth: '150px',
            iconCaptionOffset: [0, 5],
            hasBalloon: true,
            openBalloonOnClick: true,
            hideIconOnBalloonOpen: false
          }
        );
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä
        if (isFriend) {
          friendsClusterer.add(placemark);
        } else {
          usersClusterer.add(placemark);
        }
      });
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ç–æ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç—É
      if (friendsClusterer.getGeoObjects().length > 0) {
        map.geoObjects.add(friendsClusterer);
      }
      
      if (usersClusterer.getGeoObjects().length > 0) {
        map.geoObjects.add(usersClusterer);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–∑–µ–π –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏
      if (currentUser.position) {
        checkNearbyFriends();
      }
    }
    
    function addFriend(userId) {
      if (!currentUser) return;
      
      try {
        if (UserSystem.sendFriendRequest(currentUser.id, userId)) {
          showTempMessage('–ó–∞–ø—Ä–æ—Å –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 3000, 'success');
          updateMap();
        } else {
          showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å', 3000, 'error');
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–∑—å—è:', error);
        showTempMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞', 3000, 'error');
      }
    }
    
    function startAutoUpdate() {
      const autoUpdate = localStorage.getItem('meetup_auto_update') !== 'false';
      
      if (autoUpdate) {
        const indicator = document.getElementById('auto-update-indicator');
        if (indicator) {
          indicator.style.display = 'flex';
        }
        
        updateTimer = 30;
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
        if (autoUpdateInterval) {
          clearInterval(autoUpdateInterval);
        }
        
        autoUpdateInterval = setInterval(() => {
          updateTimer--;
          
          const timerElement = document.getElementById('update-timer');
          if (timerElement) {
            timerElement.textContent = updateTimer;
          }
          
          if (updateTimer <= 0) {
            updateLocation();
            updateTimer = 30;
          }
        }, 1000);
      }
    }
    
    function updateLocation() {
      if (!currentUser || !navigator.geolocation) return;
      
      showTempMessage('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...', 2000, 'info');
      
      navigator.geolocation.getCurrentPosition(
        position => {
          const coords = [
            position.coords.latitude, 
            position.coords.longitude
          ];
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          UserSystem.updateUserPosition(currentUser.id, coords);
          
          // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          currentUser = UserSystem.getCurrentUser();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
          updateMap();
          
          showTempMessage('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 2000, 'success');
        },
        error => {
          console.warn('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', error.message);
          
          let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
          switch(error.code) {
            case error.PERMISSION_DENIED:
              errorMessage = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
              break;
            case error.TIMEOUT:
              errorMessage = '–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫–ª–æ';
              break;
          }
          
          showTempMessage(errorMessage, 3000, 'warning');
        },
        { 
          enableHighAccuracy: false, 
          timeout: 10000, 
          maximumAge: 60000 
        }
      );
    }
    
    function checkNearbyFriends() {
      if (!currentUser || !currentUser.position) return;
      
      const friends = UserSystem.getUserFriends(currentUser.id);
      const radius = filterSettings.radius;
      
      const nearbyFriends = friends.filter(friend => {
        if (!friend.position || friend.invisible) return false;
        
        const distance = calculateDistance(currentUser.position, friend.position);
        return distance <= radius;
      });
      
      if (nearbyFriends.length > 0) {
        showNearbyNotification(nearbyFriends);
      }
    }
    
    function showNearbyNotification(friends) {
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      const existingNotification = document.querySelector('.nearby-notification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      const notification = document.createElement('div');
      notification.className = 'nearby-notification';
      notification.innerHTML = `
        <span class="material-icons">group</span>
        <div>
          <strong>–î—Ä—É–∑—å—è –ø–æ–±–ª–∏–∑–æ—Å—Ç–∏!</strong><br>
          ${friends.length} ${getRussianPlural(friends.length, ['–¥—Ä—É–≥', '–¥—Ä—É–≥–∞', '–¥—Ä—É–∑–µ–π'])} –≤ —Ä–∞–¥–∏—É—Å–µ ${filterSettings.radius} –∫–º
        </div>
        <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: white; cursor: pointer;">
          <span class="material-icons">close</span>
        </button>
      `;
      
      document.body.appendChild(notification);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.opacity = '0';
          notification.style.transform = 'translateX(-50%) translateY(-10px)';
          setTimeout(() => {
            if (notification.parentNode) notification.remove();
          }, 300);
        }
      }, 5000);
    }
    
    function highlightUserLocation() {
      if (!currentUser || !currentUser.position || !map || typeof ymaps === 'undefined') return;
      
      // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
      if (locationCircleHighlight) {
        map.geoObjects.remove(locationCircleHighlight);
      }
      
      // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
      locationCircleHighlight = new ymaps.Circle([
        currentUser.position,
        200 // —Ä–∞–¥–∏—É—Å –≤ –º–µ—Ç—Ä–∞—Ö
      ], {}, {
        fillColor: isIncognitoMode ? '#FF444433' : '#2CB4FF33',
        strokeColor: isIncognitoMode ? '#FF4444' : '#2CB4FF',
        strokeWidth: 2,
        strokeOpacity: 0.8,
        fillOpacity: 0.3
      });
      
      map.geoObjects.add(locationCircleHighlight);
      
      // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
      map.setCenter(currentUser.position, 15, {
        duration: 1000,
        timingFunction: 'ease-in-out'
      });
      
      // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        if (locationCircleHighlight && map) {
          map.geoObjects.remove(locationCircleHighlight);
          locationCircleHighlight = null;
        }
      }, 3000);
    }
    
    function toggleIncognitoMode() {
      isIncognitoMode = !isIncognitoMode;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
      updateIncognitoButton();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      
      if (userIndex !== -1) {
        users[userIndex].invisible = isIncognitoMode;
        UserSystem.saveUsers(users);
        UserSystem.setCurrentUser(users[userIndex]);
        currentUser = users[userIndex];
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (isIncognitoMode) {
        showTempMessage('–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤–∫–ª—é—á–µ–Ω. –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ.', 4000, 'warning');
      } else {
        showTempMessage('–†–µ–∂–∏–º –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ –≤—ã–∫–ª—é—á–µ–Ω. –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ.', 4000, 'success');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç—É
      updateMap();
    }
    
    function openChat(userId) {
      const user = UserSystem.getUserById(userId);
      if (!user) return;
      
      showTempMessage(`–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —á–∞—Ç —Å ${user.nickname}`, 2000, 'info');
      
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–∞—Ç–∞
      // window.location.href = `chat.html?userId=${userId}`;
      
      // –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞
      setTimeout(() => {
        showTempMessage('–§—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 3000, 'info');
      }, 500);
    }
    
    function showUserProfile(userId) {
      sessionStorage.setItem('viewingUserId', userId);
      window.open('userProfile.html', '_blank');
    }
    
    // ========== –§–£–ù–ö–¶–ò–ò –ß–ê–¢–û–í ==========
    
    function openChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.add('active');
      loadChats();
    }
    
    function closeChatsWindow() {
      const overlay = document.getElementById('chat-overlay');
      overlay.classList.remove('active');
    }
    
    function loadChats() {
      const chatList = document.getElementById('chat-list');
      if (!currentUser) return;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      chatList.innerHTML = `
        <div class="chat-empty">
          <div class="loading-spinner" style="margin: 0 auto 15px;"></div>
          –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...
        </div>
      `;
      
      // –ò–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      setTimeout(() => {
        const chats = ChatSystem.getUserChats(currentUser.id);
        const friends = UserSystem.getUserFriends(currentUser.id);
        
        if (chats.length === 0 && friends.length === 0) {
          chatList.innerHTML = `
            <div class="chat-empty">
              <span class="material-icons" style="font-size: 60px; opacity: 0.5; margin-bottom: 20px;">chat</span>
              <div>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤</div>
              <div style="font-size: 12px; margin-top: 10px; color: #666;">–î–æ–±–∞–≤—å—Ç–µ –¥—Ä—É–∑–µ–π, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</div>
            </div>
          `;
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —á–∞—Ç–æ–≤
        let chatHTML = '';
        
        if (chats.length > 0) {
          chats.forEach(chat => {
            const otherParticipantId = chat.participants.find(id => id !== currentUser.id);
            const friend = friends.find(f => f.id === otherParticipantId) || UserSystem.getUserById(otherParticipantId);
            if (!friend) return;
            
            const lastMessage = ChatSystem.getLastMessage(chat);
            const unreadCount = chat.unreadCount || 0;
            const timeAgo = ChatSystem.formatTime(lastMessage.timestamp);
            
            chatHTML += `
              <div class="chat-item" data-chat-id="${chat.id}" data-user-id="${friend.id}">
                <div class="chat-avatar" style="background: linear-gradient(135deg, ${friend.status === 'online' ? '#34eb89' : '#666'}, #2a2a3a);">
                  <span class="material-icons">person</span>
                </div>
                <div class="chat-info">
                  <div class="chat-friend-name">${friend.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                  <div class="chat-last-message">${lastMessage.text || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                  <div class="chat-time">${timeAgo}</div>
                </div>
                ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
              </div>
            `;
          });
        } else {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—Ä—É–∑–µ–π –¥–ª—è –Ω–∞—á–∞–ª–∞ —á–∞—Ç–∞
          friends.forEach(friend => {
            chatHTML += `
              <div class="chat-item" data-user-id="${friend.id}">
                <div class="chat-avatar" style="background: linear-gradient(135deg, ${friend.status === 'online' ? '#34eb89' : '#666'}, #2a2a3a);">
                  <span class="material-icons">person</span>
                </div>
                <div class="chat-info">
                  <div class="chat-friend-name">${friend.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                  <div class="chat-last-message">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç</div>
                  <div class="chat-time">${friend.status === 'online' ? 'üü¢ –í —Å–µ—Ç–∏' : '‚ö´ –ù–µ –≤ —Å–µ—Ç–∏'}</div>
                </div>
              </div>
            `;
          });
        }
        
        chatList.innerHTML = chatHTML;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
        document.querySelectorAll('.chat-item').forEach(item => {
          item.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const chatId = this.getAttribute('data-chat-id');
            
            closeChatsWindow();
            
            if (chatId) {
              // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —á–∞—Ç
              window.location.href = `chat.html?chatId=${chatId}&userId=${userId}`;
            } else {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —á–∞—Ç –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
              const chat = ChatSystem.createChat(currentUser.id, userId);
              window.location.href = `chat.html?chatId=${chat.id}&userId=${userId}`;
            }
          });
        });
      }, 500);
    }
    
    function updateChatNotificationCount() {
      if (!currentUser) return;
      
      try {
        const unreadCount = ChatSystem.getUnreadCount(currentUser.id);
        const badge = document.getElementById('chat-notification-badge');
        
        if (unreadCount > 0) {
          badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      }
    }
    
    // ========== –§–£–ù–ö–¶–ò–ò –®–ê–ì–û–ú–ï–†–ê ==========
    
    function openPedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      const content = document.getElementById('pedometer-content');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —à–∞–≥–æ–º–µ—Ä–∞
      if (!Pedometer.isSupported()) {
        content.innerHTML = `
          <div class="pedometer-not-supported">
            <span class="material-icons">directions_walk_off</span>
            <div>–®–∞–≥–æ–º–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º</div>
            <div style="font-size: 12px; margin-top: 10px; color: #666;">
              –î–ª—è —Ä–∞–±–æ—Ç—ã —à–∞–≥–æ–º–µ—Ä–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å –∞–∫—Å–µ–ª–µ—Ä–æ–º–µ—Ç—Ä–æ–º
            </div>
          </div>
        `;
        overlay.classList.add('active');
        return;
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —à–∞–≥–æ–º–µ—Ä
      Pedometer.initialize();
      const stats = Pedometer.getStats();
      
      content.innerHTML = `
        <div class="pedometer-stats">
          <div class="pedometer-stat">
            <div class="stat-value">${stats.today.toLocaleString()}</div>
            <div class="stat-label">–®–ê–ì–û–í –°–ï–ì–û–î–ù–Ø</div>
            <div class="stat-subvalue">${stats.distanceToday.toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.week.toLocaleString()}</div>
            <div class="stat-label">–®–ê–ì–û–í –ó–ê –ù–ï–î–ï–õ–Æ</div>
            <div class="stat-subvalue">${(stats.week * 0.00076).toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-stat">
            <div class="stat-value">${stats.month.toLocaleString()}</div>
            <div class="stat-label">–®–ê–ì–û–í –ó–ê –ú–ï–°–Ø–¶</div>
            <div class="stat-subvalue">${(stats.month * 0.00076).toFixed(2)} –∫–º</div>
          </div>
          
          <div class="pedometer-goal">
            <div class="goal-title">–¶–ï–õ–¨ –ù–ê –î–ï–ù–¨: ${stats.goal.toLocaleString()} —à–∞–≥–æ–≤</div>
            <div class="goal-progress-bar">
              <div class="goal-progress-fill" style="width: ${Math.min(100, stats.goalProgress)}%"></div>
            </div>
            <div class="goal-info">
              <span>0</span>
              <span>${Math.round(Math.min(100, stats.goalProgress))}%</span>
              <span>${stats.goal.toLocaleString()}</span>
            </div>
          </div>
        </div>
        
        <div class="pedometer-actions">
          <button class="pedometer-btn btn-start" id="pedometer-start-btn">
            <span class="material-icons">play_arrow</span>
            ${stats.isActive ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'}
          </button>
          <button class="pedometer-btn btn-simulate" id="pedometer-simulate-btn">
            <span class="material-icons">shuffle</span>
            –¢–µ—Å—Ç (+100 —à–∞–≥–æ–≤)
          </button>
        </div>
      `;
      
      overlay.classList.add('active');
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —à–∞–≥–æ–º–µ—Ä–∞
      document.getElementById('pedometer-start-btn')?.addEventListener('click', function() {
        if (stats.isActive) {
          Pedometer.stop();
          showTempMessage('–®–∞–≥–æ–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 3000, 'info');
        } else {
          Pedometer.start();
          showTempMessage('–®–∞–≥–æ–º–µ—Ä –∑–∞–ø—É—â–µ–Ω', 3000, 'success');
        }
        setTimeout(updatePedometerStats, 500);
      });
      
      document.getElementById('pedometer-simulate-btn')?.addEventListener('click', function() {
        const steps = Pedometer.simulateSteps(100);
        showTempMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${steps} —Ç–µ—Å—Ç–æ–≤—ã—Ö —à–∞–≥–æ–≤`, 3000, 'success');
        updatePedometerStats();
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —à–∞–≥–æ–º–µ—Ä–∞
      document.getElementById('pedometer-close-btn').addEventListener('click', function() {
        closePedometerWindow();
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
      window.pedometerUpdateInterval = setInterval(updatePedometerStats, 5000);
    }
    
    function updatePedometerStats() {
      const stats = Pedometer.getStats();
      const content = document.getElementById('pedometer-content');
      
      if (!content) return;
      
      const statValues = content.querySelectorAll('.stat-value');
      const statSubvalues = content.querySelectorAll('.stat-subvalue');
      const progressFill = content.querySelector('.goal-progress-fill');
      const goalPercent = content.querySelector('.goal-info span:nth-child(2)');
      const startBtn = content.querySelector('#pedometer-start-btn');
      
      if (statValues[0]) statValues[0].textContent = stats.today.toLocaleString();
      if (statValues[1]) statValues[1].textContent = stats.week.toLocaleString();
      if (statValues[2]) statValues[2].textContent = stats.month.toLocaleString();
      
      if (statSubvalues[0]) statSubvalues[0].textContent = stats.distanceToday.toFixed(2) + ' –∫–º';
      if (statSubvalues[1]) statSubvalues[1].textContent = (stats.week * 0.00076).toFixed(2) + ' –∫–º';
      if (statSubvalues[2]) statSubvalues[2].textContent = (stats.month * 0.00076).toFixed(2) + ' –∫–º';
      
      if (progressFill) progressFill.style.width = Math.min(100, stats.goalProgress) + '%';
      if (goalPercent) goalPercent.textContent = Math.round(Math.min(100, stats.goalProgress)) + '%';
      
      if (startBtn) {
        startBtn.innerHTML = `
          <span class="material-icons">${stats.isActive ? 'pause' : 'play_arrow'}</span>
          ${stats.isActive ? '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å' : '–ó–∞–ø—É—Å—Ç–∏—Ç—å'}
        `;
      }
    }
    
    function closePedometerWindow() {
      const overlay = document.getElementById('pedometer-overlay');
      overlay.classList.remove('active');
      
      // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      if (window.pedometerUpdateInterval) {
        clearInterval(window.pedometerUpdateInterval);
        window.pedometerUpdateInterval = null;
      }
    }
    
    // ========== –ù–ê–°–¢–†–û–ô–ö–ò –ò –§–ò–õ–¨–¢–†–´ ==========
    
    function saveFilterSettings() {
      try {
        localStorage.setItem('meetup_map_filters', JSON.stringify(filterSettings));
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
      }
    }
    
    function loadFilterSettings() {
      try {
        const savedFilters = localStorage.getItem('meetup_map_filters');
        if (savedFilters) {
          filterSettings = { ...filterSettings, ...JSON.parse(savedFilters) };
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
          document.getElementById('filter-friends').checked = filterSettings.friends;
          document.getElementById('filter-online').checked = filterSettings.online;
          document.getElementById('filter-nearby').checked = filterSettings.nearby;
          document.getElementById('filter-new').checked = filterSettings.new;
          document.getElementById('radius-slider').value = filterSettings.radius;
          document.getElementById('radius-value').textContent = filterSettings.radius;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
      }
    }
    
    function saveDisplaySettings() {
      try {
        localStorage.setItem('meetup_display_settings', JSON.stringify(displaySettings));
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      }
    }
    
    function loadDisplaySettings() {
      try {
        const saved = localStorage.getItem('meetup_display_settings');
        if (saved) {
          displaySettings = { ...displaySettings, ...JSON.parse(saved) };
          
          // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
          document.getElementById('display-all').checked = displaySettings.all;
          document.getElementById('display-friends').checked = displaySettings.friends;
          document.getElementById('display-online').checked = displaySettings.online;
          document.getElementById('display-new').checked = displaySettings.new;
          
          const markerSelect = document.getElementById('friend-marker-select');
          if (markerSelect) {
            markerSelect.value = displaySettings.friendMarker;
            document.getElementById('friend-marker-style').textContent = 
              markerSelect.options[markerSelect.selectedIndex].text;
          }
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      }
    }
    
    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
    
    function initializeEventHandlers() {
      // –ü—Ä–æ—Ñ–∏–ª—å
      document.getElementById('btn-profile').addEventListener('click', function() {
        window.location.href = 'profile.html';
      });
      
      // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞
      document.getElementById('btn-add-friend').addEventListener('click', function() {
        window.location.href = 'addfriend.html';
      });
      
      // –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
      document.getElementById('btn-locate').addEventListener('click', function() {
        if (!navigator.geolocation) {
          showTempMessage('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º', 3000, 'error');
          return;
        }
        
        showTempMessage('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...', 2000, 'info');
        
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const coords = [position.coords.latitude, position.coords.longitude];
            
            if (currentUser) {
              UserSystem.updateUserPosition(currentUser.id, coords);
              currentUser = UserSystem.getCurrentUser();
            }
            
            if (map) {
              map.setCenter(coords, 15, {
                duration: 1000,
                timingFunction: 'ease-in-out'
              });
              
              highlightUserLocation();
              
              showTempMessage('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 2000, 'success');
            }
          },
          (error) => {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:', error);
            
            if (currentUser && currentUser.position && map) {
              map.setCenter(currentUser.position, 15, {
                duration: 1000,
                timingFunction: 'ease-in-out'
              });
              
              highlightUserLocation();
              
              showTempMessage('–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 3000, 'warning');
            } else {
              showTempMessage('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 3000, 'error');
            }
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
          }
        );
      });
      
      // –§–∏–ª—å—Ç—Ä—ã
      document.getElementById('btn-filter').addEventListener('click', function() {
        const panel = document.getElementById('filter-panel');
        panel.classList.toggle('active');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        document.getElementById('display-panel').classList.remove('active');
      });
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
      document.getElementById('btn-refresh').addEventListener('click', function() {
        this.classList.add('loading');
        this.innerHTML = '<span class="loading-spinner"></span>';
        
        setTimeout(() => {
          updateMap();
          this.classList.remove('loading');
          this.innerHTML = '<span class="material-icons">refresh</span>';
          showTempMessage('–ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 2000, 'success');
        }, 500);
      });
      
      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      document.getElementById('btn-apply-filters').addEventListener('click', function() {
        filterSettings.friends = document.getElementById('filter-friends').checked;
        filterSettings.online = document.getElementById('filter-online').checked;
        filterSettings.nearby = document.getElementById('filter-nearby').checked;
        filterSettings.new = document.getElementById('filter-new').checked;
        filterSettings.radius = parseInt(document.getElementById('radius-slider').value);
        
        saveFilterSettings();
        updateMap();
        
        document.getElementById('filter-panel').classList.remove('active');
        showTempMessage('–§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 2000, 'success');
      });
      
      // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
      document.getElementById('btn-reset-filters').addEventListener('click', function() {
        document.getElementById('filter-friends').checked = true;
        document.getElementById('filter-online').checked = true;
        document.getElementById('filter-nearby').checked = true;
        document.getElementById('filter-new').checked = true;
        document.getElementById('radius-slider').value = CONFIG.DEFAULT_RADIUS;
        document.getElementById('radius-value').textContent = CONFIG.DEFAULT_RADIUS;
        
        filterSettings = {
          friends: true,
          online: true,
          nearby: true,
          new: true,
          radius: CONFIG.DEFAULT_RADIUS
        };
        
        saveFilterSettings();
        updateMap();
        
        showTempMessage('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 2000, 'success');
      });
      
      // –°–ª–∞–π–¥–µ—Ä —Ä–∞–¥–∏—É—Å–∞
      const radiusSlider = document.getElementById('radius-slider');
      const radiusValue = document.getElementById('radius-value');
      
      radiusSlider.addEventListener('input', debounce(function() {
        radiusValue.textContent = this.value;
      }, 100));
      
      radiusSlider.addEventListener('change', debounce(function() {
        filterSettings.radius = parseInt(this.value);
        saveFilterSettings();
        updateMap();
      }, 300));
      
      // –ß–∞—Ç—ã
      document.getElementById('btn-chat').addEventListener('click', openChatsWindow);
      document.getElementById('chat-close-btn').addEventListener('click', closeChatsWindow);
      
      // –®–∞–≥–æ–º–µ—Ä
      document.getElementById('btn-pedometer').addEventListener('click', openPedometerWindow);
      
      // –ò–Ω–∫–æ–≥–Ω–∏—Ç–æ
      document.getElementById('btn-incognito').addEventListener('click', toggleIncognitoMode);
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      document.getElementById('btn-display-mode').addEventListener('click', function() {
        const panel = document.getElementById('display-panel');
        panel.classList.toggle('active');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        document.getElementById('filter-panel').classList.remove('active');
      });
      
      // –ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      document.getElementById('btn-apply-display').addEventListener('click', function() {
        displaySettings.all = document.getElementById('display-all').checked;
        displaySettings.friends = document.getElementById('display-friends').checked;
        displaySettings.online = document.getElementById('display-online').checked;
        displaySettings.new = document.getElementById('display-new').checked;
        displaySettings.friendMarker = document.getElementById('friend-marker-select').value;
        
        saveDisplaySettings();
        updateMap();
        
        document.getElementById('display-panel').classList.remove('active');
        showTempMessage('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã', 2000, 'success');
      });
      
      // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
      document.getElementById('display-all').addEventListener('change', function() {
        displaySettings.all = this.checked;
        saveDisplaySettings();
        updateMap();
      });
      
      document.getElementById('display-friends').addEventListener('change', function() {
        displaySettings.friends = this.checked;
        saveDisplaySettings();
        updateMap();
      });
      
      document.getElementById('display-online').addEventListener('change', function() {
        displaySettings.online = this.checked;
        saveDisplaySettings();
        updateMap();
      });
      
      document.getElementById('display-new').addEventListener('change', function() {
        displaySettings.new = this.checked;
        saveDisplaySettings();
        updateMap();
      });
      
      document.getElementById('friend-marker-select').addEventListener('change', function() {
        displaySettings.friendMarker = this.value;
        document.getElementById('friend-marker-style').textContent = 
          this.options[this.selectedIndex].text;
        saveDisplaySettings();
        updateMap();
      });
      
      // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
      document.addEventListener('click', function(event) {
        const filterPanel = document.getElementById('filter-panel');
        const filterBtn = document.getElementById('btn-filter');
        const displayPanel = document.getElementById('display-panel');
        const displayBtn = document.getElementById('btn-display-mode');
        
        if (filterPanel && filterBtn && 
            !filterPanel.contains(event.target) && 
            !filterBtn.contains(event.target)) {
          filterPanel.classList.remove('active');
        }
        
        if (displayPanel && displayBtn && 
            !displayPanel.contains(event.target) && 
            !displayBtn.contains(event.target)) {
          displayPanel.classList.remove('active');
        }
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à–∏ Escape
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          document.getElementById('filter-panel').classList.remove('active');
          document.getElementById('display-panel').classList.remove('active');
          closeChatsWindow();
          closePedometerWindow();
        }
      });
    }
    
    function adjustLayout() {
      const header = document.querySelector('.app-header');
      const mapContainer = document.querySelector('.map-container');
      
      if (header && mapContainer) {
        const headerHeight = header.offsetHeight;
        mapContainer.style.height = `calc(100vh - ${headerHeight}px)`;
      }
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞—Ä—Ç—É –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
      if (map) {
        setTimeout(() => {
          map.container.fitToViewport();
        }, 300);
      }
    }
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========
    
    function initializeApp() {
      console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è MeetUP...');
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
      currentUser = UserSystem.getCurrentUser();
      if (!currentUser) {
        console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...');
        showTempMessage('–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 2000, 'warning');
        setTimeout(() => window.location.href = 'index.html', 1000);
        return;
      }
      
      console.log(`üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: ${currentUser.nickname}`);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      loadFilterSettings();
      loadDisplaySettings();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏–Ω–∫–æ–≥–Ω–∏—Ç–æ
      updateIncognitoButton();
      
      // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º layout
      adjustLayout();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      initializeEventHandlers();
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(initializeMap, 100);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      updateChatNotificationCount();
      setInterval(updateChatNotificationCount, 30000);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
      window.addEventListener('resize', debounce(adjustLayout, 250));
      window.addEventListener('orientationchange', function() {
        setTimeout(adjustLayout, 300);
      });
      
      console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
      // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
      if (autoUpdateInterval) {
        clearInterval(autoUpdateInterval);
      }
      
      if (window.pedometerUpdateInterval) {
        clearInterval(window.pedometerUpdateInterval);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      saveFilterSettings();
      saveDisplaySettings();
    });
    
    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
      setTimeout(initializeApp, 100);
    });
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setTimeout(initializeApp, 100);
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
    window.addFriend = addFriend;
    window.openChat = openChat;
    window.showUserProfile = showUserProfile;
    window.toggleIncognitoMode = toggleIncognitoMode;
    window.initializeMap = initializeMap;
    
  </script>
</body>
</html>
