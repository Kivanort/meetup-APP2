<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Настройки профиля — MeetUP</title>
  <!-- Material Icons (Google Fonts) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- User System -->
  <script src="userSystem.js"></script>
  <link rel="icon" href="meetup-logo.png" type="image/x-icon"> 
  <style>
    :root {
      --modal-bg: rgba(30, 30, 30, 0.95);
      --modal-shadow: 0 4px 16px rgba(0,0,0,0.5);
      --modal-radius: 12px;
      --red: #FF4757;
      --green: #2ED573;
      --blue: #00A8FF;
      --cyan: #00FFFF;
      --purple: #9400D3;
      --grey: #A4B0BE;
      --dark-grey: #747D8C;
      --btn-cancel-bg: #2F3542;
      --btn-cancel-color: #fff;
      --btn-radius: 10px;
      --btn-delete-bg: #FF4757;
      --btn-delete-shadow-hover: 0 4px 12px rgba(255, 71, 87, 0.3);
      --spinner-color: #00FFFF;
      --card-bg: rgba(35, 35, 45, 0.95);
      --border-color: rgba(255, 255, 255, 0.08);
      --hover-bg: rgba(255, 255, 255, 0.05);
    }
    
    body {
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 100%);
      color: #fff;
      min-height: 100vh;
      margin: 0;
      font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    
    .settings-card {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      width: 520px;
      max-width: 98vw;
      margin: 0 auto;
      padding: 50px 45px 45px 45px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      animation: settings-fadein 0.55s cubic-bezier(.27,.69,.51,1.35);
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
    }
    
    @media (max-width: 600px) {
      .settings-card {
        width: 100vw;
        min-width: 0;
        max-width: 100vw;
        border-radius: 0;
        padding: 30px 20px;
        border: none;
        box-shadow: none;
      }
    }
    
    .settings-title {
      font-size: 26px;
      font-weight: 700;
      letter-spacing: 0.02em;
      margin-bottom: 30px;
      opacity: 0.98;
      text-align: center;
      background: linear-gradient(90deg, var(--cyan), var(--purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .settings-options {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }
    
    .settings-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      padding: 22px;
      border: 1px solid var(--border-color);
      transition: all 0.25s ease;
    }
    
    .settings-section:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.12);
    }
    
    .section-label {
      color: #E0E0E0;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
    }
    
    .section-label .material-icons {
      color: var(--cyan);
      font-size: 20px;
    }
    
    /* Стили для формы смены пароля */
    .password-form {
      display: none;
      flex-direction: column;
      gap: 18px;
      margin-top: 15px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .password-form.active {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }
    
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .form-label {
      color: #B0B0B0;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .form-label .material-icons {
      font-size: 16px;
      opacity: 0.8;
    }
    
    .form-input {
      background: rgba(255, 255, 255, 0.07);
      border: 2px solid #2A2A3A;
      border-radius: 10px;
      padding: 14px 16px;
      color: #fff;
      font-size: 15px;
      font-family: inherit;
      outline: none;
      transition: all 0.25s ease;
    }
    
    .form-input:focus {
      border-color: var(--cyan);
      background: rgba(0, 255, 255, 0.05);
      box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.15);
    }
    
    .form-input.error {
      border-color: var(--red);
      background: rgba(255, 71, 87, 0.05);
    }
    
    .form-hint {
      color: var(--dark-grey);
      font-size: 12px;
      margin-top: 5px;
      line-height: 1.4;
      padding-left: 5px;
    }
    
    .form-error {
      color: var(--red);
      font-size: 12px;
      margin-top: 5px;
      display: none;
      align-items: center;
      gap: 5px;
      font-weight: 500;
    }
    
    .form-error.active {
      display: flex;
    }
    
    .password-actions {
      display: flex;
      gap: 12px;
      margin-top: 15px;
    }
    
    .btn-save-password {
      background: linear-gradient(135deg, var(--cyan) 0%, var(--blue) 100%);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
    }
    
    .btn-save-password:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0, 255, 255, 0.3);
    }
    
    .btn-cancel-password {
      background: var(--btn-cancel-bg);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--btn-radius);
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    
    .btn-cancel-password:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    /* Стиль для чекбокса уведомлений */
    .notif-toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      padding: 8px;
      border-radius: 10px;
      transition: background 0.2s;
    }
    
    .notif-toggle-container:hover {
      background: rgba(255, 255, 255, 0.05);
    }
    
    #notif-toggle {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .notif-label {
      font-size: 15px;
      color: #E0E0E0;
      font-weight: 500;
    }
    
    .delete-account-row {
      margin-top: 50px;
      width: 100%;
      display: flex;
      justify-content: center;
    }
    
    .btn-delete-account {
      background: linear-gradient(135deg, var(--red) 0%, #FF3838 100%);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      padding: 16px 28px 16px 22px;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.25);
      position: relative;
      overflow: hidden;
    }
    
    .btn-delete-account::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.6s;
    }
    
    .btn-delete-account:hover::before {
      left: 100%;
    }
    
    .btn-delete-account:hover {
      transform: translateY(-3px);
      box-shadow: var(--btn-delete-shadow-hover);
    }
    
    .btn-delete-account:active {
      transform: translateY(-1px);
    }
    
    .btn-delete-account .material-icons {
      font-size: 20px;
      vertical-align: middle;
    }
    
    /* Кнопка назад */
    .back-arrow-btn {
      position: absolute;
      left: 28px;
      top: 26px;
      background: rgba(35, 35, 45, 0.8);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.25s ease;
      z-index: 3;
      outline: none;
      text-decoration: none;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(5px);
    }
    
    .back-arrow-btn:hover {
      background: rgba(45, 45, 55, 0.9);
      border-color: var(--cyan);
      transform: translateX(-2px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    .back-arrow-btn .material-icons {
      font-size: 24px;
      color: var(--cyan);
      vertical-align: middle;
    }
    
    @media (max-width: 600px) {
      .back-arrow-btn {
        left: 15px;
        top: 15px;
        width: 44px;
        height: 44px;
      }
      .back-arrow-btn .material-icons {
        font-size: 22px;
      }
    }
    
    /* Информация об удалении */
    .deletion-info {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.1), rgba(255, 71, 87, 0.05));
      border: 1px solid rgba(255, 71, 87, 0.3);
      border-radius: 14px;
      padding: 22px;
      margin-top: 30px;
      width: 100%;
      display: none;
      animation: fadeIn 0.4s ease-out;
    }
    
    .deletion-info.active {
      display: block;
    }
    
    .deletion-title {
      color: var(--red);
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .deletion-text {
      color: var(--grey);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 15px;
    }
    
    .deletion-timer {
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      background: rgba(255, 71, 87, 0.2);
      padding: 12px 18px;
      border-radius: 10px;
      display: inline-block;
      font-family: monospace;
      letter-spacing: 1px;
      border: 1px solid rgba(255, 71, 87, 0.3);
    }
    
    .btn-cancel-deletion {
      background: linear-gradient(135deg, var(--green) 0%, #1DD1A1 100%);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.25s ease;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(46, 213, 115, 0.25);
    }
    
    .btn-cancel-deletion:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(46, 213, 115, 0.35);
    }
    
    /* МОДАЛЬНОЕ ОКНО */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      z-index: 1010;
      backdrop-filter: blur(5px);
    }
    
    .modal-backdrop.active {
      display: block;
      animation: modal-fade-bg 0.3s;
    }
    
    @keyframes modal-fade-bg {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-dialog {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(0.9);
      width: 440px;
      max-width: 94vw;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      z-index: 1020;
      opacity: 0;
      pointer-events: none;
      display: flex;
      flex-direction: column;
      border: 1px solid var(--border-color);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    
    .modal-dialog.active {
      opacity: 1;
      pointer-events: auto;
      animation: modal-dialog-pop-in 0.4s cubic-bezier(.34,1.56,.64,1) forwards;
    }
    
    .modal-content {
      display: flex;
      flex-direction: column;
      padding: 30px;
      gap: 20px;
    }
    
    .modal-title {
      color: var(--red);
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin-bottom: 10px;
      letter-spacing: 0.02em;
    }
    
    .modal-warning {
      color: var(--grey);
      font-size: 15px;
      line-height: 1.6;
      text-align: center;
      margin-bottom: 10px;
    }
    
    .modal-actions {
      display: flex;
      gap: 15px;
      margin-top: 15px;
      width: 100%;
      flex-direction: row;
      justify-content: center;
    }
    
    .btn-modal-cancel {
      background: var(--btn-cancel-bg);
      color: var(--btn-cancel-color);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--btn-radius);
      font-size: 14px;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.25s ease;
      font-weight: 600;
      flex: 1;
    }
    
    .btn-modal-cancel:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    .btn-modal-delete {
      background: linear-gradient(135deg, var(--red) 0%, #FF3838 100%);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      font-size: 14px;
      padding: 12px 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: all 0.25s ease;
      cursor: pointer;
      flex: 1;
      box-shadow: 0 4px 12px rgba(255, 71, 87, 0.25);
    }
    
    .btn-modal-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 71, 87, 0.35);
    }
    
    .modal-spinner-wrap {
      width: 100%;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 255, 255, 0.3);
      border-top: 3px solid var(--cyan);
      border-radius: 50%;
      animation: modal-spin 0.8s linear infinite;
    }
    
    .modal-error {
      color: var(--red);
      font-size: 15px;
      margin-bottom: 15px;
      text-align: center;
      width: 100%;
      font-weight: 500;
    }
    
    .btn-retry-delete {
      background: var(--btn-cancel-bg);
      color: #fff;
      border: none;
      border-radius: var(--btn-radius);
      font-size: 14px;
      padding: 10px 20px;
      cursor: pointer;
      transition: all 0.25s ease;
      font-weight: 600;
      margin: 0 auto;
      display: block;
    }
    
    .btn-retry-delete:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }
    
    /* Анимации */
    @keyframes settings-fadein {
      from { 
        opacity: 0; 
        transform: translateY(30px) scale(0.98); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0) scale(1); 
      }
    }
    
    @keyframes modal-dialog-pop-in {
      from { 
        opacity: 0; 
        transform: translate(-50%,-50%) scale(0.9); 
      }
      to { 
        opacity: 1; 
        transform: translate(-50%,-50%) scale(1); 
      }
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(-10px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }
    
    @keyframes modal-spin {
      to { transform: rotate(360deg); }
    }
    
    /* Улучшенный чекбокс */
    input[type="checkbox"] {
      appearance: none;
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      border: 2px solid var(--dark-grey);
      border-radius: 6px;
      outline: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s;
    }
    
    input[type="checkbox"]:checked {
      background: var(--cyan);
      border-color: var(--cyan);
    }
    
    input[type="checkbox"]:checked::after {
      content: '✓';
      position: absolute;
      color: #000;
      font-size: 14px;
      font-weight: bold;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    
    input[type="checkbox"]:hover {
      border-color: var(--cyan);
    }
  </style>
</head>
<body>
  <div class="settings-card" role="main" tabindex="-1">
    <!-- Кнопка "назад" -->
    <a class="back-arrow-btn" id="btn-back-arrow" href="profile.html" title="Назад в профиль" aria-label="Вернуться в профиль">
      <span class="material-icons" aria-hidden="true">arrow_back</span>
    </a>
    
    <div class="settings-title">Настройки профиля</div>
    
    <div class="settings-options">
      <!-- Смена пароля -->
      <div class="settings-section">
        <div class="section-label">
          <span class="material-icons">lock</span>
          Безопасность аккаунта
        </div>
        
        <button style="
          background: rgba(0, 255, 255, 0.1);
          color: var(--cyan);
          border: 1px solid rgba(0, 255, 255, 0.3);
          border-radius: var(--btn-radius);
          padding: 12px 20px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.25s ease;
          display: flex;
          align-items: center;
          gap: 8px;
          width: 100%;
          justify-content: center;
        " id="btn-change-password">
          <span class="material-icons">key</span>
          Сменить пароль
        </button>
        
        <!-- Форма смены пароля -->
        <div class="password-form" id="password-form">
          <div class="form-field">
            <label class="form-label">
              <span class="material-icons">vpn_key</span>
              Текущий пароль
            </label>
            <input type="password" class="form-input" id="current-password" placeholder="Введите текущий пароль">
            <div class="form-error" id="current-password-error">
              <span class="material-icons" style="font-size:14px;">error</span>
              Неверный текущий пароль
            </div>
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="material-icons">lock_reset</span>
              Новый пароль
            </label>
            <input type="password" class="form-input" id="new-password" placeholder="Введите новый пароль">
            <div class="form-hint">Пароль должен содержать минимум 8 символов, буквы и цифры</div>
            <div class="form-error" id="new-password-error">
              <span class="material-icons" style="font-size:14px;">error</span>
              Слабый пароль
            </div>
          </div>
          
          <div class="form-field">
            <label class="form-label">
              <span class="material-icons">check_circle</span>
              Подтвердите новый пароль
            </label>
            <input type="password" class="form-input" id="confirm-password" placeholder="Повторите новый пароль">
            <div class="form-error" id="confirm-password-error">
              <span class="material-icons" style="font-size:14px;">error</span>
              Пароли не совпадают
            </div>
          </div>
          
          <div class="password-actions">
            <button class="btn-save-password" id="btn-save-password">
              <span class="material-icons">save</span>
              Сохранить
            </button>
            <button class="btn-cancel-password" id="btn-cancel-password">Отменить</button>
          </div>
        </div>
      </div>
      
      <!-- Уведомления -->
      <div class="settings-section">
        <div class="section-label">
          <span class="material-icons">notifications</span>
          Уведомления
        </div>
        
        <div class="notif-toggle-container">
          <input type="checkbox" id="notif-toggle">
          <label for="notif-toggle" class="notif-label">Push-уведомления</label>
        </div>
      </div>
    </div>

    <!-- Информация об отложенном удалении -->
    <div class="deletion-info" id="deletion-info">
      <div class="deletion-title">
        <span class="material-icons">warning</span>
        Аккаунт помечен на удаление
      </div>
      <div class="deletion-text">
        Ваш аккаунт будет полностью удален через:
      </div>
      <div class="deletion-timer" id="deletion-timer"></div>
      <button class="btn-cancel-deletion" id="btn-cancel-deletion">
        <span class="material-icons">undo</span>
        Отменить удаление
      </button>
    </div>

    <!-- Кнопка удаления аккаунта -->
    <div class="delete-account-row">
      <button class="btn-delete-account" id="btn-delete-account" type="button">
        <span class="material-icons" aria-hidden="true">delete_forever</span>
        Удалить аккаунт
      </button>
    </div>
  </div>

  <!-- Модальное окно подтверждения удаления -->
  <div class="modal-backdrop" id="modal-delete-backdrop" tabindex="-1" aria-hidden="true"></div>
  <div class="modal-dialog" id="modal-delete-dialog" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
    <form class="modal-content" id="delete-modal-content" autocomplete="off" onsubmit="return false;">
      <div class="modal-title" id="delete-modal-title">Удалить аккаунт?</div>
      <div class="modal-warning">
        Ваш аккаунт будет немедленно деактивирован и вы больше не сможете входить в систему.<br><br>
        Все данные будут полностью удалены через 30 дней. В течение этого времени вы можете отменить удаление, войдя в систему.
      </div>
      <div class="modal-actions">
        <button type="button" class="btn-modal-cancel" id="btn-modal-cancel">Отменить</button>
        <button type="submit" class="btn-modal-delete" id="btn-modal-delete">
          <span class="material-icons" aria-hidden="true">delete_forever</span>
          Удалить аккаунт
        </button>
      </div>
    </form>
    
    <!-- Спиннер -->
    <div id="modal-spinner-block" style="display:none;">
      <div class="modal-spinner-wrap">
        <div class="modal-spinner" role="status" aria-label="Загрузка"></div>
      </div>
    </div>
    
    <!-- Блок ошибки -->
    <div id="modal-error-block" style="display:none;">
      <div class="modal-error" id="delete-error-text"></div>
      <button type="button" class="btn-retry-delete" id="btn-retry-delete">Повторить</button>
    </div>
  </div>

  <!-- Скрипт остается таким же как в исходном файле -->
  <script>
    // Переменные элементов
    const btnDelete = document.getElementById('btn-delete-account');
    const modalBackdrop = document.getElementById('modal-delete-backdrop');
    const modalDialog = document.getElementById('modal-delete-dialog');
    const modalContent = document.getElementById('delete-modal-content');
    const btnModalCancel = document.getElementById('btn-modal-cancel');
    const btnModalDelete = document.getElementById('btn-modal-delete');
    const spinnerBlock = document.getElementById('modal-spinner-block');
    const errorBlock = document.getElementById('modal-error-block');
    const errorText = document.getElementById('delete-error-text');
    const btnRetryDelete = document.getElementById('btn-retry-delete');
    const deletionInfo = document.getElementById('deletion-info');
    const deletionTimer = document.getElementById('deletion-timer');
    const btnCancelDeletion = document.getElementById('btn-cancel-deletion');

    // Элементы для смены пароля
    const btnChangePassword = document.getElementById('btn-change-password');
    const passwordForm = document.getElementById('password-form');
    const btnSavePassword = document.getElementById('btn-save-password');
    const btnCancelPassword = document.getElementById('btn-cancel-password');
    const currentPasswordInput = document.getElementById('current-password');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');

    let modalPreviouslyFocused = null;
    let modalOpen = false;
    let errorTimeout = null;
    let timerInterval = null;

    // Функция для проверки статуса удаления аккаунта
    function checkDeletionStatus() {
      const currentUser = UserSystem.getCurrentUser();
      if (!currentUser) return;

      // Проверяем, помечен ли аккаунт на удаление
      if (currentUser.scheduledForDeletion) {
        const deletionTime = currentUser.scheduledForDeletion;
        const now = Date.now();
        
        if (now >= deletionTime) {
          // Время удаления наступило - удаляем аккаунт
          deleteUserAccount(currentUser.id);
          UserSystem.logout();
          // Перенаправляем на страницу входа с сообщением
          showDeletionCompleteMessage();
          return;
        }
        
        // Показываем информацию об отложенном удалении
        showDeletionInfo(deletionTime);
        btnDelete.style.display = 'none';
      } else {
        // Аккаунт не помечен на удаление
        deletionInfo.classList.remove('active');
        btnDelete.style.display = 'flex';
      }
    }

    // Функция для показа сообщения о завершении удаления
    function showDeletionCompleteMessage() {
      // Создаем модальное окно с сообщением
      const messageModal = document.createElement('div');
      messageModal.innerHTML = `
        <div style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:9999;">
          <div style="background:var(--card-bg); padding:30px; border-radius:12px; text-align:center; max-width:400px;">
            <div style="color:var(--red); font-size:20px; margin-bottom:15px;">
              <span class="material-icons" style="font-size:40px;">delete</span>
            </div>
            <div style="color:#fff; font-size:18px; margin-bottom:10px;">Аккаунт удален</div>
            <div style="color:var(--grey); margin-bottom:20px;">Ваш аккаунт был полностью удален из системы.</div>
            <button onclick="redirectToRegistration()" style="background:var(--btn-delete-bg); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer;">
              Перейти к регистрации
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(messageModal);
    }

    // Функция для перенаправления на регистрацию
    function redirectToRegistration() {
      window.location.href = 'registration.html?deleted=true';
    }

    // Функция для показа информации об отложенном удалении
    function showDeletionInfo(deletionTime) {
      deletionInfo.classList.add('active');
      
      function updateTimer() {
        const now = Date.now();
        const timeLeft = deletionTime - now;
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          deletionTimer.textContent = 'Удаление...';
          return;
        }
        
        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        
        deletionTimer.textContent = `${days}д ${hours}ч ${minutes}м`;
      }
      
      updateTimer();
      timerInterval = setInterval(updateTimer, 60000); // Обновляем каждую минуту
    }

    // Функция для пометки аккаунта на удаление
    function scheduleAccountDeletion(userId) {
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex !== -1) {
        // Помечаем аккаунт на удаление через 30 дней
        users[userIndex].scheduledForDeletion = Date.now() + (30 * 24 * 60 * 60 * 1000);
        // Деактивируем аккаунт
        users[userIndex].active = false;
        users[userIndex].status = 'deactivated';
        UserSystem.saveUsers(users);
        return true;
      }
      return false;
    }

    // Функция для отмены удаления аккаунта
    function cancelAccountDeletion(userId) {
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === userId);
      
      if (userIndex !== -1) {
        // Убираем пометку на удаление
        delete users[userIndex].scheduledForDeletion;
        // Активируем аккаунт
        users[userIndex].active = true;
        users[userIndex].status = 'online';
        UserSystem.saveUsers(users);
        
        // Обновляем текущего пользователя
        UserSystem.setCurrentUser(users[userIndex]);
        return true;
      }
      return false;
    }

    // Функция для полного удаления аккаунта
    function deleteUserAccount(userId) {
      const users = UserSystem.getUsers();
      const updatedUsers = users.filter(u => u.id !== userId);
      UserSystem.saveUsers(updatedUsers);
      
      // Также удаляем связанные данные
      const requests = JSON.parse(localStorage.getItem('meetup_friend_requests') || '[]');
      const updatedRequests = requests.filter(req => 
        req.fromUserId !== userId && req.toUserId !== userId
      );
      localStorage.setItem('meetup_friend_requests', JSON.stringify(updatedRequests));
      
      // Удаляем активность пользователя
      localStorage.removeItem(`user_activity_${userId}`);
      localStorage.removeItem(`user_online_${userId}`);
    }

    // Функция для смены пароля
    function changePassword() {
      const currentUser = UserSystem.getCurrentUser();
      if (!currentUser) return false;

      const currentPassword = currentPasswordInput.value;
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      // Сбрасываем ошибки
      resetPasswordErrors();

      let hasErrors = false;

      // Проверка текущего пароля
      if (UserSystem.hashPassword(currentPassword) !== currentUser.password) {
        showPasswordError('current-password-error', 'Неверный текущий пароль');
        currentPasswordInput.classList.add('error');
        hasErrors = true;
      }

      // Проверка нового пароля
      if (!/^.{8,}$/.test(newPassword) || !/[a-zа-я]/i.test(newPassword) || !/\d/.test(newPassword)) {
        showPasswordError('new-password-error', 'Пароль должен содержать минимум 8 символов, буквы и цифры');
        newPasswordInput.classList.add('error');
        hasErrors = true;
      }

      // Проверка подтверждения пароля
      if (newPassword !== confirmPassword) {
        showPasswordError('confirm-password-error', 'Пароли не совпадают');
        confirmPasswordInput.classList.add('error');
        hasErrors = true;
      }

      if (hasErrors) return false;

      // Обновляем пароль
      const users = UserSystem.getUsers();
      const userIndex = users.findIndex(u => u.id === currentUser.id);
      
      if (userIndex !== -1) {
        users[userIndex].password = UserSystem.hashPassword(newPassword);
        UserSystem.saveUsers(users);
        
        // Обновляем текущего пользователя
        UserSystem.setCurrentUser(users[userIndex]);
        return true;
      }

      return false;
    }

    // Функция для показа ошибок пароля
    function showPasswordError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.classList.add('active');
    }

    // Функция для сброса ошибок пароля
    function resetPasswordErrors() {
      const errorElements = document.querySelectorAll('.form-error');
      errorElements.forEach(element => {
        element.classList.remove('active');
      });
      
      const inputElements = document.querySelectorAll('.form-input');
      inputElements.forEach(element => {
        element.classList.remove('error');
      });
    }

    // Функция для сброса формы пароля
    function resetPasswordForm() {
      currentPasswordInput.value = '';
      newPasswordInput.value = '';
      confirmPasswordInput.value = '';
      resetPasswordErrors();
      passwordForm.classList.remove('active');
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
      const currentUser = UserSystem.getCurrentUser();
      
      if (!currentUser) {
        window.location.href = 'registration.html';
        return;
      }
      
      // Проверяем статус удаления
      checkDeletionStatus();

      // Обработчики для смены пароля
      btnChangePassword.addEventListener('click', function() {
        passwordForm.classList.toggle('active');
        if (passwordForm.classList.contains('active')) {
          currentPasswordInput.focus();
        }
      });

      btnCancelPassword.addEventListener('click', resetPasswordForm);

      btnSavePassword.addEventListener('click', function() {
        if (changePassword()) {
          alert('Пароль успешно изменен!');
          resetPasswordForm();
        }
      });

      // Обработчики Enter в полях пароля
      [currentPasswordInput, newPasswordInput, confirmPasswordInput].forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            if (changePassword()) {
              alert('Пароль успешно изменен!');
              resetPasswordForm();
            }
          }
        });
      });
    });

    // Обработчик отмены удаления
    btnCancelDeletion.onclick = function() {
      const currentUser = UserSystem.getCurrentUser();
      if (currentUser && cancelAccountDeletion(currentUser.id)) {
        deletionInfo.classList.remove('active');
        btnDelete.style.display = 'flex';
        clearInterval(timerInterval);
        showMsg('Удаление аккаунта отменено');
      }
    };

    function showMsg(message) {
      // Простая реализация показа сообщения
      alert(message);
    }

    // Модальное окно удаления
    function openDeleteModal() {
      modalBackdrop.classList.add('active');
      modalDialog.classList.add('active');
      modalDialog.classList.remove('hide');
      modalOpen = true;
      modalContent.style.display = '';
      spinnerBlock.style.display = 'none';
      errorBlock.style.display = 'none';
      btnModalDelete.disabled = false;
      btnModalDelete.tabIndex = 0;
      btnModalCancel.disabled = false;
      btnModalCancel.tabIndex = 0;
      document.body.style.overflow = 'hidden';
      modalPreviouslyFocused = document.activeElement;
      setTimeout(() => btnModalDelete.focus(), 50);
    }

    function closeDeleteModal() {
      modalDialog.classList.add('hide');
      setTimeout(() => {
        modalBackdrop.classList.remove('active');
        modalDialog.classList.remove('active','hide');
        document.body.style.overflow = '';
        modalOpen = false;
        if (modalPreviouslyFocused && typeof modalPreviouslyFocused.focus === "function") {
          setTimeout(()=>modalPreviouslyFocused.focus(), 120);
        }
      }, 220);
    }

    // Открытие по кнопке
    btnDelete.addEventListener('click', (e) => {
      e.preventDefault();
      openDeleteModal();
    });

    // "Отмена" - закрыть модалку
    btnModalCancel.addEventListener('click', (e) => {
      e.preventDefault();
      closeDeleteModal();
    });

    // Закрытие модалки по клику вне
    modalBackdrop.addEventListener('mousedown', (e) => {
      if (modalOpen) closeDeleteModal();
    });
    
    // Escape закрывает модалку
    document.addEventListener('keydown', function(e){
      if (modalOpen && (e.key === "Escape" || e.key === "Esc")) {
        closeDeleteModal();
      }
    });

    // Модальная форма отправки (удаление аккаунта)
    modalContent.addEventListener('submit', (e) => {
      e.preventDefault();
      btnModalDelete.disabled = true;
      btnModalCancel.disabled = true;
      btnModalDelete.tabIndex = -1;
      btnModalCancel.tabIndex = -1;
      modalContent.style.display = 'none';
      errorBlock.style.display = 'none';
      spinnerBlock.style.display = '';
      
      const currentUser = UserSystem.getCurrentUser();
      if (currentUser && scheduleAccountDeletion(currentUser.id)) {
        // Успешно помечен на удаление
        setTimeout(() => {
          spinnerBlock.style.display = 'none';
          closeDeleteModal();
          // Сначала выходим из системы
          UserSystem.logout();
          // Показываем сообщение о успешном удалении
          setTimeout(() => {
            const message = document.createElement('div');
            message.innerHTML = `
              <div style="position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:9999;">
                <div style="background:var(--card-bg); padding:30px; border-radius:12px; text-align:center; max-width:400px;">
                  <div style="color:var(--red); font-size:20px; margin-bottom:15px;">
                    <span class="material-icons" style="font-size:40px;">warning</span>
                  </div>
                  <div style="color:#fff; font-size:18px; margin-bottom:10px;">Аккаунт деактивирован</div>
                  <div style="color:var(--grey); margin-bottom:20px;">
                    Ваш аккаунт помечен на удаление. Полное удаление произойдет через 30 дней.<br><br>
                    В течение этого времени вы можете отменить удаление, войдя в систему.
                  </div>
                  <button onclick="window.location.href='registration.html'" style="background:var(--btn-delete-bg); color:#fff; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; font-size:14px;">
                    Перейти к регистрации
                  </button>
                </div>
              </div>
            `;
            document.body.appendChild(message);
          }, 100);
        }, 1500);
      } else {
        showDeleteError('Ошибка при удалении аккаунта');
      }
    });

    // Попытка повторения удаления после ошибки
    btnRetryDelete.addEventListener('click', () => {
      errorBlock.style.display = 'none';
      spinnerBlock.style.display = '';
      const currentUser = UserSystem.getCurrentUser();
      if (currentUser && scheduleAccountDeletion(currentUser.id)) {
        setTimeout(() => {
          spinnerBlock.style.display = 'none';
          closeDeleteModal();
          UserSystem.logout();
          setTimeout(() => {
            window.location.href = 'registration.html?deletion_scheduled=true';
          }, 300);
        }, 1500);
      } else {
        showDeleteError('Ошибка при удалении аккаунта');
      }
    });

    function showDeleteError(message) {
      spinnerBlock.style.display = 'none';
      errorBlock.style.display = '';
      errorText.textContent = message;
      btnModalDelete.disabled = false;
      btnModalCancel.disabled = false;
      btnModalDelete.tabIndex = 0;
      btnModalCancel.tabIndex = 0;
      modalContent.style.display = '';
    }

    function clearDeleteError() {
      if (errorTimeout) {
        clearTimeout(errorTimeout);
        errorTimeout = null;
      }
      errorBlock.style.display = 'none';
    }

    // Фокусировка/доступность
    modalDialog.addEventListener('animationend', function(ev){
      if (modalOpen && modalDialog.classList.contains('active')) {
        btnModalDelete.focus();
      }
    });

    // Перехват Esc/tab фокусов на модалке
    modalDialog.addEventListener('keydown', function(e){
      if (!modalOpen) return;
      if (e.key === "Tab") {
        const focusable = modalDialog.querySelectorAll('button,[tabindex="0"]');
        const arr = Array.prototype.slice.call(focusable);
        if (!arr.length) return;
        const first = arr[0], last = arr[arr.length-1];
        if (e.shiftKey && document.activeElement === first) {
          e.preventDefault();
          last.focus();
        } else if (!e.shiftKey && document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    });

    // Сброс всего состояния при закрытии
    modalBackdrop.addEventListener('transitionend', function() {
      if (!modalBackdrop.classList.contains('active')) clearDeleteError();
    });
  </script>
</body>
</html>
