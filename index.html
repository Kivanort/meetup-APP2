<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#121212">
  <meta name="description" content="–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π - –Ω–∞—Ö–æ–¥–∏—Ç–µ –∏ –æ—Ç–º–µ—á–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –Ω–∞ –∫–∞—Ä—Ç–µ">
  <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Äî –ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π</title>
  
  <!-- PWA –º–µ—Ç–∞-—Ç–µ–≥–∏ -->
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="meetup-logo.png" type="image/x-icon">
  <link rel="apple-touch-icon" href="meetup-logo.png">
  
  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ JavaScript –º–æ–¥—É–ª—è -->
  <script src="userSystem.js" defer></script>
  <script src="telegram-bot-api.js" defer></script>
  
  <style>
    /* –ë–õ–û–ö–ò–†–û–í–ö–ê –°–ö–†–û–õ–õ–ê –ò –ú–ê–°–®–¢–ê–ë–ò–†–û–í–ê–ù–ò–Ø */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
      -webkit-overflow-scrolling: touch;
      touch-action: none;
    }
    
    /* CSS –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
    :root {
      --bg-primary: #121212;
      --bg-secondary: rgba(30, 30, 30, 0.95);
      --bg-surface: #1a1a1a;
      --text-primary: #ffffff;
      --text-secondary: #888888;
      --text-disabled: #666666;
      --border-default: #333333;
      --border-active: #00FFFF;
      --border-error: #FF4444;
      --border-success: #00C853;
      --gradient-primary: linear-gradient(135deg, #00FFFF 0%, #9400D3 100%);
      --gradient-hover: linear-gradient(135deg, #00FFFF 20%, #9400D3 100%);
      --accent-cyan: #00FFFF;
      --accent-violet: #9400D3;
      --overlay-dark: rgba(0, 0, 0, 0.7);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
      --shadow-button: 0 4px 12px rgba(0, 255, 255, 0.2);
      --radius-large: 12px;
      --radius-medium: 10px;
      --radius-small: 6px;
      --transition-fast: 0.2s ease;
      --transition-normal: 0.3s ease;
    }
    
    /* –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
        'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      position: relative;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ä–º—ã */
    .form-container {
      width: 100%;
      max-width: 400px;
      background: var(--bg-secondary);
      border-radius: var(--radius-large);
      padding: 20px 15px;
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 10;
      overflow-y: auto;
      max-height: 95vh;
      -webkit-overflow-scrolling: touch;
      box-sizing: border-box;
    }
    
    /* –õ–æ–≥–æ—Ç–∏–ø –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
    .logo-section {
      text-align: center;
      margin-bottom: 20px;
    }
    
    .logo-icon {
      width: 70px;
      height: 70px;
      margin: 0 auto 12px;
      background: black;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--accent-cyan);
      transition: transform var(--transition-normal);
    }
    
    .logo-icon:hover {
      transform: scale(1.05);
    }
    
    .logo-icon svg {
      width: 40px;
      height: 40px;
    }
    
    .main-title {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-violet));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: -0.5px;
    }
    
    /* –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .referral-badge {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(148, 0, 211, 0.1));
      border: 1px solid var(--accent-cyan);
      border-radius: var(--radius-medium);
      padding: 8px 12px;
      margin: 12px 0;
      font-size: 13px;
      text-align: center;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
      animation: fadeIn 0.5s ease;
      word-break: break-word;
    }
    
    .referral-badge .material-icons {
      color: var(--accent-cyan);
      font-size: 16px;
      flex-shrink: 0;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: var(--radius-medium);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all var(--transition-fast);
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
      min-height: 48px;
      box-sizing: border-box;
    }
    
    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%);
      transform-origin: 50% 50%;
    }
    
    .btn:active::after {
      animation: ripple 1s ease-out;
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--gradient-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-button);
    }
    
    .btn-primary:active {
      transform: translateY(0);
    }
    
    .btn-secondary {
      background: var(--bg-surface);
      color: var(--text-primary);
      border: 1px solid var(--border-default);
    }
    
    .btn-secondary:hover {
      background: #2a2a2a;
      border-color: var(--text-secondary);
    }
    
    /* –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
    .divider {
      display: flex;
      align-items: center;
      margin: 20px 0;
      color: var(--text-secondary);
      font-size: 13px;
    }
    
    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: var(--border-default);
    }
    
    .divider::before {
      margin-right: 12px;
    }
    
    .divider::after {
      margin-left: 12px;
    }
    
    /* –§–æ—Ä–º—ã */
    .form-view {
      display: none;
      animation: fadeIn 0.3s ease;
      width: 100%;
      box-sizing: border-box;
    }
    
    .form-view.active {
      display: block;
    }
    
    .form-title {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 20px;
      text-align: center;
      color: var(--text-primary);
    }
    
    .form-group {
      margin-bottom: 16px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .input-wrapper {
      position: relative;
      width: 100%;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 45px 14px 45px;
      background: var(--bg-surface);
      border: 2px solid var(--border-default);
      border-radius: var(--radius-small);
      color: var(--text-primary);
      font-size: 15px;
      transition: all var(--transition-fast);
      box-sizing: border-box;
      min-height: 48px;
    }
    
    .form-input:focus {
      border-color: var(--accent-cyan);
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 255, 255, 0.1);
    }
    
    .form-input::placeholder {
      color: var(--text-disabled);
    }
    
    .input-icon {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-secondary);
      pointer-events: none;
    }
    
    .toggle-password {
      position: absolute;
      right: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .toggle-password:hover {
      color: var(--text-primary);
    }
    
    /* –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö/—É—Å–ø–µ—Ö–µ */
    .message {
      display: none;
      align-items: flex-start;
      gap: 6px;
      margin-top: 6px;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: var(--radius-small);
      animation: slideIn 0.3s ease;
      width: 100%;
      box-sizing: border-box;
      word-break: break-word;
    }
    
    .message.error {
      background: rgba(255, 68, 68, 0.1);
      color: var(--border-error);
      border-left: 3px solid var(--border-error);
    }
    
    .message.success {
      background: rgba(0, 200, 83, 0.1);
      color: var(--border-success);
      border-left: 3px solid var(--border-success);
    }
    
    .message.info {
      background: rgba(0, 255, 255, 0.1);
      color: var(--accent-cyan);
      border-left: 3px solid var(--accent-cyan);
    }
    
    /* –°—Å—ã–ª–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ö */
    .form-links {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
      width: 100%;
    }
    
    .form-link {
      color: var(--accent-cyan);
      text-decoration: none;
      text-align: center;
      font-size: 14px;
      padding: 6px;
      transition: opacity var(--transition-fast);
      position: relative;
      word-break: break-word;
    }
    
    .form-link:hover {
      opacity: 0.8;
    }
    
    .form-link::after {
      content: '';
      position: absolute;
      bottom: 4px;
      left: 50%;
      width: 0;
      height: 1px;
      background: var(--accent-cyan);
      transition: all var(--transition-fast);
      transform: translateX(-50%);
    }
    
    .form-link:hover::after {
      width: 80%;
    }
    
    /* –ê–≤–∞—Ç–∞—Ä */
    .avatar-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin: 20px 0;
      justify-content: center;
      width: 100%;
    }
    
    .avatar-preview {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--bg-surface);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid transparent;
      overflow: hidden;
      position: relative;
    }
    
    .avatar-preview.has-image {
      border-color: var(--accent-cyan);
    }
    
    .avatar-preview::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent, rgba(0, 255, 255, 0.1));
      opacity: 0;
      transition: opacity var(--transition-fast);
    }
    
    .avatar-preview:hover::before {
      opacity: 1;
    }
    
    .btn-avatar {
      padding: 10px 16px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-small);
      color: var(--text-primary);
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all var(--transition-fast);
      width: 100%;
      justify-content: center;
      min-height: 44px;
      box-sizing: border-box;
    }
    
    .btn-avatar:hover {
      background: #2a2a2a;
      border-color: var(--accent-cyan);
    }
    
    /* –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
    .code-inputs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin: 20px 0;
      width: 100%;
      flex-wrap: wrap;
    }
    
    .code-input {
      width: 42px;
      height: 50px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      background: var(--bg-surface);
      border: 2px solid var(--border-default);
      border-radius: var(--radius-small);
      color: var(--text-primary);
      transition: all var(--transition-fast);
      flex: 1;
      max-width: 50px;
      min-width: 40px;
      box-sizing: border-box;
    }
    
    .code-input:focus {
      border-color: var(--accent-cyan);
      outline: none;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
    }
    
    /* –¢–∞–π–º–µ—Ä */
    .timer {
      text-align: center;
      color: var(--text-secondary);
      font-size: 13px;
      margin: 12px 0;
      font-variant-numeric: tabular-nums;
      display: none; /* –°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
      word-break: break-word;
    }
    
    .resend-link {
      text-align: center;
      margin: 12px 0;
      width: 100%;
    }
    
    .resend-btn {
      background: none;
      border: none;
      color: var(--accent-cyan);
      font-size: 13px;
      cursor: pointer;
      text-decoration: underline;
      transition: opacity var(--transition-fast);
      padding: 6px 12px;
      border-radius: var(--radius-small);
      word-break: break-word;
    }
    
    .resend-btn:hover:not(:disabled) {
      opacity: 0.8;
      background: rgba(0, 255, 255, 0.1);
    }
    
    .resend-btn:disabled {
      color: var(--text-disabled);
      cursor: not-allowed;
      text-decoration: none;
      background: none;
    }
    
    /* –°–ø–∏–Ω–Ω–µ—Ä */
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid var(--bg-surface);
      border-top: 3px solid var(--accent-cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 16px auto;
      display: none;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA */
    .install-btn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: var(--radius-medium);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1000;
      box-shadow: var(--shadow-card);
      display: none;
      align-items: center;
      gap: 6px;
      transition: all var(--transition-fast);
      min-height: 44px;
      box-sizing: border-box;
    }
    
    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.3);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes ripple {
      0% { transform: scale(0, 0); opacity: 0.5; }
      100% { transform: scale(40, 40); opacity: 0; }
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è shake –¥–ª—è –æ—à–∏–±–æ–∫ */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
    @media (max-width: 380px) {
      body {
        padding: 10px;
      }
      
      .form-container {
        padding: 15px 10px;
        max-height: 98vh;
      }
      
      .logo-icon {
        width: 60px;
        height: 60px;
      }
      
      .logo-icon svg {
        width: 32px;
        height: 32px;
      }
      
      .main-title {
        font-size: 22px;
      }
      
      .form-title {
        font-size: 20px;
        margin-bottom: 16px;
      }
      
      .btn {
        padding: 12px;
        font-size: 14px;
        min-height: 44px;
      }
      
      .form-input {
        padding: 12px 40px 12px 40px;
        font-size: 14px;
        min-height: 44px;
      }
      
      .avatar-section {
        gap: 10px;
        margin: 16px 0;
      }
      
      .avatar-preview {
        width: 65px;
        height: 65px;
      }
      
      .btn-avatar {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .code-input {
        width: 38px;
        height: 46px;
        font-size: 18px;
        max-width: 45px;
        min-width: 35px;
      }
      
      .code-inputs {
        gap: 6px;
      }
      
      .install-btn {
        bottom: 8px;
        right: 8px;
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .referral-badge {
        font-size: 12px;
        padding: 6px 10px;
      }
      
      .divider {
        margin: 16px 0;
        font-size: 12px;
      }
    }
    
    @media (max-width: 320px) {
      .form-container {
        padding: 12px 8px;
      }
      
      .code-input {
        width: 35px;
        height: 42px;
        font-size: 16px;
      }
      
      .main-title {
        font-size: 20px;
      }
      
      .form-title {
        font-size: 18px;
      }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .form-container::-webkit-scrollbar {
      width: 4px;
    }
    
    .form-container::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .form-container::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
    }
    
    /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ iOS */
    * {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ iOS */
    @supports (-webkit-touch-callout: none) {
      body {
        min-height: -webkit-fill-available;
      }
      
      input, textarea, select {
        font-size: 16px !important; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–∞ iOS */
      }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ touch –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (hover: none) and (pointer: coarse) {
      .btn:active {
        transform: scale(0.98);
      }
      
      .form-input:focus {
        transform: scale(1.01);
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div class="form-view active" id="main-view">
      <div class="logo-section">
        <div class="logo-icon">
          <svg viewBox="0 0 48 48">
            <circle cx="24" cy="24" r="24" fill="#000"/>
            <ellipse cx="24" cy="20" rx="10" ry="11" fill="#fff"/>
            <ellipse cx="24" cy="36" rx="15" ry="10" fill="#fff"/>
          </svg>
        </div>
        <h1 class="main-title">–ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π</h1>
      </div>
      
      <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
      <div class="referral-badge" id="referral-info" style="display: none;">
        <span class="material-icons">person_add</span>
        <span id="referral-text">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</span>
      </div>
      
      <button class="btn btn-primary" id="btn-login-view">
        <span class="material-icons">vpn_key</span>
        –í–æ–π—Ç–∏
      </button>
      
      <button class="btn btn-primary" id="btn-register-view">
        <span class="material-icons">person_add</span>
        –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
      </button>
      
      <div class="divider">–∏–ª–∏</div>
      
      <button class="btn btn-secondary" id="btn-google">
        <span style="font-weight:bold;color:#4285F4;">G</span>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
      </button>
      
      <button class="btn btn-secondary" id="btn-apple">
        <span class="material-icons">apple</span>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Apple
      </button>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div class="form-view" id="login-view">
      <h2 class="form-title">–í—Ö–æ–¥</h2>
      <form id="login-form">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="text" class="form-input" id="login-identity" placeholder="Email –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º" required>
            <span class="material-icons input-icon">person</span>
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <input type="password" class="form-input" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <span class="material-icons input-icon">lock</span>
            <button type="button" class="toggle-password" id="toggle-login-password">
              <span class="material-icons">visibility_off</span>
            </button>
          </div>
          <div class="message error" id="login-error">
            <span class="material-icons">error</span>
            <div>
              <span id="login-error-text">–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞</span>
              <br>
              <small style="opacity: 0.8; font-size: 11px;">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ email/–Ω–∏–∫–Ω–µ–π–º –∏ –ø–∞—Ä–æ–ª—å</small>
            </div>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">login</span>
          –í–æ–π—Ç–∏
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-forgot">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</a>
        <a href="#" class="form-link" id="link-to-register">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="form-view" id="register-view">
      <h2 class="form-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      
      <!-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ —Ñ–æ—Ä–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
      <div class="referral-badge" id="referral-info-register" style="display: none;">
        <span class="material-icons">person_add</span>
        <span id="referral-text-register">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é</span>
      </div>
      
      <form id="register-form">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="text" class="form-input" id="register-nickname" placeholder="–ù–∏–∫–Ω–µ–π–º" required>
            <span class="material-icons input-icon">person</span>
          </div>
          <div class="message error" id="nickname-error">
            <span class="material-icons">error</span>
            <span id="nickname-error-text"></span>
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <input type="email" class="form-input" id="register-email" placeholder="Email" required>
            <span class="material-icons input-icon">email</span>
          </div>
          <div class="message error" id="email-error">
            <span class="material-icons">error</span>
            <span id="email-error-text"></span>
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <input type="password" class="form-input" id="register-password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <span class="material-icons input-icon">lock</span>
            <button type="button" class="toggle-password" id="toggle-register-password">
              <span class="material-icons">visibility_off</span>
            </button>
          </div>
          <div class="message error" id="password-error">
            <span class="material-icons">error</span>
            –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <input type="password" class="form-input" id="register-confirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
            <span class="material-icons input-icon">check_circle</span>
          </div>
          <div class="message error" id="confirm-error">
            <span class="material-icons">error</span>
            –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
          </div>
        </div>
        
        <div class="avatar-section">
          <div class="avatar-preview" id="avatar-preview">
            <span class="material-icons" id="avatar-icon" style="font-size: 28px; color: var(--text-secondary);">person</span>
            <img id="avatar-image" style="display: none; width: 100%; height: 100%; object-fit: cover;">
          </div>
          <button type="button" class="btn-avatar" id="btn-avatar">
            <span class="material-icons">photo_camera</span>
            –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
          </button>
          <input type="file" id="avatar-input" accept="image/*" style="display: none;">
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">person_add</span>
          –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-to-login">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π—Ç–∏</a>
      </div>
    </div>

    <!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - Email -->
    <div class="form-view" id="forgot-email-view">
      <h2 class="form-title">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
      <form id="forgot-email-form">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="email" class="form-input" id="forgot-email" placeholder="–í–∞—à email" required>
            <span class="material-icons input-icon">email</span>
          </div>
          <div class="message error" id="forgot-email-error">
            <span class="material-icons">error</span>
            <span id="forgot-email-error-text"></span>
          </div>
          <div class="message success" id="forgot-email-success">
            <span class="material-icons">check_circle</span>
            –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à email
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">send</span>
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-back-to-login-from-email">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É</a>
      </div>
    </div>

    <!-- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è - –ö–æ–¥ -->
    <div class="form-view" id="forgot-code-view">
      <h2 class="form-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 13px;">
        –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ <span id="user-email" style="color: var(--accent-cyan); font-weight: 600;"></span>
      </p>
      
      <form id="forgot-code-form">
        <div class="code-inputs">
          <input type="text" class="code-input" id="code-1" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="code-2" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="code-3" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="code-4" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="code-5" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="code-6" maxlength="1" required inputmode="numeric">
        </div>
        
        <div class="message error" id="code-error">
          <span class="material-icons">error</span>
          –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥
        </div>
        
        <div class="timer" id="timer">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑: <span id="time-left">05:00</span>
        </div>
        
        <div class="resend-link">
          <button type="button" class="resend-btn" id="resend-btn" disabled>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
          </button>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">check_circle</span>
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-back-to-email">–ò–∑–º–µ–Ω–∏—Ç—å email</a>
      </div>
    </div>

    <!-- –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å -->
    <div class="form-view" id="new-password-view">
      <h2 class="form-title">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</h2>
      
      <form id="new-password-form">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="password" class="form-input" id="new-password" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
            <span class="material-icons input-icon">lock</span>
            <button type="button" class="toggle-password" id="toggle-new-password">
              <span class="material-icons">visibility_off</span>
            </button>
          </div>
          <div class="message error" id="new-password-error">
            <span class="material-icons">error</span>
            –ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤ –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã
          </div>
        </div>
        
        <div class="form-group">
          <div class="input-wrapper">
            <input type="password" class="form-input" id="new-password-confirm" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
            <span class="material-icons input-icon">check_circle</span>
          </div>
          <div class="message error" id="new-password-confirm-error">
            <span class="material-icons">error</span>
            –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">lock_reset</span>
          –°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å
        </button>
      </form>
      
      <div class="message success" id="password-reset-success" style="display: none;">
        <span class="material-icons">check_circle</span>
        –ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Telegram -->
    <div class="form-view" id="forgot-telegram-view">
      <h2 class="form-title">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Telegram</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 13px;">
        –í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram username –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞
      </p>
      
      <form id="forgot-telegram-form">
        <div class="form-group">
          <div class="input-wrapper">
            <input type="text" class="form-input" id="telegram-username-reset" placeholder="@username" required>
            <span class="material-icons input-icon">telegram</span>
          </div>
          <div class="message error" id="telegram-username-error">
            <span class="material-icons">error</span>
            <span id="telegram-username-error-text"></span>
          </div>
          <div class="message success" id="telegram-username-success">
            <span class="material-icons">check_circle</span>
            <span id="telegram-success-text">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≤–∞—à Telegram</span>
          </div>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">send</span>
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –≤ Telegram
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-back-to-email-reset">–°–±—Ä–æ—Å–∏—Ç—å —á–µ—Ä–µ–∑ email</a>
        <a href="#" class="form-link" id="link-back-to-login-from-telegram">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É</a>
      </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ Telegram –∫–æ–¥–∞ -->
    <div class="form-view" id="forgot-telegram-code-view">
      <h2 class="form-title">–ö–æ–¥ –∏–∑ Telegram</h2>
      <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px; font-size: 13px;">
        –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram <span id="telegram-username-display" style="color: var(--accent-cyan); font-weight: 600;"></span>
      </p>
      
      <form id="forgot-telegram-code-form">
        <div class="code-inputs">
          <input type="text" class="code-input" id="tg-code-1" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="tg-code-2" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="tg-code-3" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="tg-code-4" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="tg-code-5" maxlength="1" required inputmode="numeric">
          <input type="text" class="code-input" id="tg-code-6" maxlength="1" required inputmode="numeric">
        </div>
        
        <div class="message error" id="tg-code-error">
          <span class="material-icons">error</span>
          <span id="tg-error-text">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</span>
        </div>
        
        <div class="timer" id="tg-timer">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ —á–µ—Ä–µ–∑: <span id="tg-time-left">10:00</span>
        </div>
        
        <div class="resend-link">
          <button type="button" class="resend-btn" id="tg-resend-btn" disabled>
            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ
          </button>
        </div>
        
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">check_circle</span>
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
      </form>
      
      <div class="form-links">
        <a href="#" class="form-link" id="link-back-to-telegram">–ò–∑–º–µ–Ω–∏—Ç—å Telegram username</a>
      </div>
    </div>

    <div class="spinner" id="form-spinner"></div>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PWA -->
  <button class="install-btn" id="install-btn" style="display: none;">
    <span class="material-icons">download</span>
    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
  </button>

  <script>
    // –û—Å–Ω–æ–≤–Ω–æ–π JavaScript –º–æ–¥—É–ª—å
    (function() {
      'use strict';
      
      // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–∫—Ä–æ–ª–ª–∞
      function preventDefault(e) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∂–µ—Å—Ç—ã –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–∫—Ä–æ–ª–ª–∞
      document.addEventListener('touchmove', function(e) {
        // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã
        if (e.target.closest('.form-container')) {
          return;
        }
        e.preventDefault();
      }, { passive: false });

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, false);

      // –ë–ª–æ–∫–∏—Ä—É–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
      document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
          e.preventDefault();
        }
      }, { passive: false });

      // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      let resetEmail = '';
      let resetTimer = null;
      let timeLeft = 300; // 5 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
      let deferredPrompt = null;
      let currentRefCode = null; // –¢–µ–∫—É—â–∏–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL
      let tgTimer = null;
      let tgTimeLeft = 600; // 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö –¥–ª—è Telegram
      let currentTelegramUsername = '';
      let currentTelegramUserId = '';
      
      // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
      const elements = {
        views: document.querySelectorAll('.form-view'),
        spinner: document.getElementById('form-spinner'),
        installBtn: document.getElementById('install-btn'),
        referralInfo: document.getElementById('referral-info'),
        referralInfoRegister: document.getElementById('referral-info-register'),
        codeInputs: [
          document.getElementById('code-1'),
          document.getElementById('code-2'),
          document.getElementById('code-3'),
          document.getElementById('code-4'),
          document.getElementById('code-5'),
          document.getElementById('code-6')
        ],
        telegramResetUsername: document.getElementById('telegram-username-reset'),
        tgCodeInputs: [
          document.getElementById('tg-code-1'),
          document.getElementById('tg-code-2'),
          document.getElementById('tg-code-3'),
          document.getElementById('tg-code-4'),
          document.getElementById('tg-code-5'),
          document.getElementById('tg-code-6')
        ]
      };
      
      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ñ–æ—Ä–º
      function showView(viewId) {
        console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–∏–¥:', viewId);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã
        document.querySelectorAll('.form-view').forEach(view => {
          view.classList.remove('active');
        });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
        const targetView = document.getElementById(viewId + '-view');
        if (targetView) {
          targetView.classList.add('active');
          console.log('‚úÖ –ü–æ–∫–∞–∑–∞–Ω–∞ —Ñ–æ—Ä–º–∞:', viewId + '-view');
        } else {
          console.error('‚ùå –§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', viewId + '-view');
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        hideAllMessages();
        
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
        const spinner = document.getElementById('form-spinner');
        if (spinner) {
          spinner.style.display = 'none';
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ –Ω–∞—á–∞–ª—É —Ñ–æ—Ä–º—ã
        const formContainer = document.querySelector('.form-container');
        if (formContainer) {
          formContainer.scrollTop = 0;
        }
      }
      
      function hideAllMessages() {
        document.querySelectorAll('.message').forEach(msg => {
          msg.style.display = 'none';
        });
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
      function checkReferralCode() {
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (refCode && refCode.trim() !== '') {
          currentRefCode = refCode.trim();
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
          try {
            console.log('üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω:', currentRefCode);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            showReferralInfo(currentRefCode);
          } catch (error) {
            console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞:', error);
            currentRefCode = null;
          }
        }
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      function showReferralInfo(refCode) {
        // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–µ—Ä–µ
        let referrer = null;
        
        try {
          if (typeof UserSystem !== 'undefined' && UserSystem.getUserByReferralCode) {
            referrer = UserSystem.getUserByReferralCode(refCode);
          }
        } catch (error) {
          console.log('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ—Ñ–µ—Ä–µ—Ä–µ:', error);
        }
        
        if (referrer) {
          const displayName = referrer.nickname || referrer.email.split('@')[0];
          const text = `–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –æ—Ç ${displayName}`;
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞ –≥–ª–∞–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ
          if (elements.referralInfo) {
            document.getElementById('referral-text').textContent = text;
            elements.referralInfo.style.display = 'flex';
          }
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Ñ–æ—Ä–º–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
          if (elements.referralInfoRegister) {
            document.getElementById('referral-text-register').textContent = text;
            elements.referralInfoRegister.style.display = 'flex';
          }
        } else {
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
          const text = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ';
          
          if (elements.referralInfo) {
            document.getElementById('referral-text').textContent = text;
            elements.referralInfo.style.display = 'flex';
          }
          
          if (elements.referralInfoRegister) {
            document.getElementById('referral-text-register').textContent = text;
            elements.referralInfoRegister.style.display = 'flex';
          }
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      function processReferralRegistration(userId) {
        if (!currentRefCode || !userId) return null;
        
        try {
          console.log('üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userId);
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
          let result = null;
          
          if (typeof UserSystem !== 'undefined' && UserSystem.useReferralLink) {
            result = UserSystem.useReferralLink(currentRefCode, userId);
          } else {
            return {
              success: false,
              message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞'
            };
          }
          
          if (result && result.success) {
            console.log('‚úÖ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞:', result);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            showReferralSuccessNotification(result);
            
            // –û—á–∏—â–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
            const url = new URL(window.location);
            url.searchParams.delete('ref');
            window.history.replaceState({}, '', url);
          }
          
          return result;
        } catch (error) {
          console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
          return {
            success: false,
            message: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏'
          };
        }
      }
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      function showReferralSuccessNotification(result) {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, #00FFFF 0%, #9400D3 100%);
          color: white;
          padding: 12px 16px;
          border-radius: var(--radius-medium);
          box-shadow: var(--shadow-card);
          z-index: 10000;
          animation: fadeIn 0.3s ease;
          max-width: 280px;
          font-size: 13px;
          word-break: break-word;
        `;
        
        let message = 'üéâ –í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!';
        
        if (result.bonus && result.bonus > 0) {
          message += `\n–ü–æ–ª—É—á–µ–Ω–æ –±–æ–Ω—É—Å–æ–≤: ${result.bonus}`;
        }
        
        if (result.referrer && result.referrer.nickname) {
          message += `\n–ü—Ä–∏–≥–ª–∞—Å–∏–≤—à–∏–π: ${result.referrer.nickname}`;
        }
        
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          notification.style.transition = 'all 0.3s ease';
          
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 300);
        }, 5000);
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
      function setupPasswordToggle(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);
        
        if (!input || !button) return;
        
        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        button.addEventListener('touchstart', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          
          // –ê–Ω–∏–º–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏
          button.style.transform = 'scale(0.8)';
          setTimeout(() => {
            button.style.transform = 'scale(1)';
          }, 150);
          
          button.innerHTML = `<span class="material-icons">${isPassword ? 'visibility' : 'visibility_off'}</span>`;
          button.setAttribute('aria-label', isPassword ? '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
        });
        
        // –î–ª—è –¥–µ—Å–∫—Ç–æ–ø–æ–≤
        button.addEventListener('click', function(e) {
          e.preventDefault();
          
          const isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          
          button.innerHTML = `<span class="material-icons">${isPassword ? 'visibility' : 'visibility_off'}</span>`;
          button.setAttribute('aria-label', isPassword ? '–°–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å' : '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if ('ontouchstart' in window) {
          input.addEventListener('blur', function() {
            if (input.type === 'text') {
              setTimeout(() => {
                if (input.type === 'text') {
                  input.type = 'password';
                  button.innerHTML = `<span class="material-icons">visibility_off</span>`;
                  button.setAttribute('aria-label', '–ü–æ–∫–∞–∑–∞—Ç—å –ø–∞—Ä–æ–ª—å');
                }
              }, 3000);
            }
          });
        }
      }
      
      // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞
      function setupAvatarUpload() {
        const avatarInput = document.getElementById('avatar-input');
        const avatarPreview = document.getElementById('avatar-preview');
        const avatarIcon = document.getElementById('avatar-icon');
        const avatarImage = document.getElementById('avatar-image');
        
        if (!avatarInput || !avatarPreview) return;
        
        const avatarButton = document.getElementById('btn-avatar');
        if (avatarButton) {
          avatarButton.addEventListener('click', () => {
            avatarInput.click();
          });
        }
        
        avatarInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            if (file.size > 5 * 1024 * 1024) { // 5MB –ª–∏–º–∏—Ç
              alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
              return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
              avatarImage.src = e.target.result;
              avatarImage.style.display = 'block';
              avatarIcon.style.display = 'none';
              avatarPreview.classList.add('has-image');
              
              // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
              avatarImage.style.opacity = '0';
              avatarImage.style.transition = 'opacity 0.3s ease';
              setTimeout(() => {
                avatarImage.style.opacity = '1';
              }, 10);
            };
            reader.readAsDataURL(file);
          } else if (file) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
          }
        });
        
        // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
        avatarPreview.addEventListener('dragover', (e) => {
          e.preventDefault();
          avatarPreview.style.borderColor = 'var(--accent-cyan)';
        });
        
        avatarPreview.addEventListener('dragleave', () => {
          avatarPreview.style.borderColor = '';
        });
        
        avatarPreview.addEventListener('drop', (e) => {
          e.preventDefault();
          avatarPreview.style.borderColor = '';
          
          const file = e.dataTransfer.files[0];
          if (file && file.type.startsWith('image/')) {
            avatarInput.files = e.dataTransfer.files;
            avatarInput.dispatchEvent(new Event('change'));
          }
        });
      }
      
      // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —Ñ–æ—Ä–º–∞–º–∏
      function setupNavigation() {
        console.log('üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏');
        
        // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
        const btnLoginView = document.getElementById('btn-login-view');
        const btnRegisterView = document.getElementById('btn-register-view');
        
        if (btnLoginView) {
          btnLoginView.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì± –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –í–æ–π—Ç–∏');
            showView('login');
          });
        }
        
        if (btnRegisterView) {
          btnRegisterView.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì± –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
            showView('register');
          });
        }
        
        // –°—Å—ã–ª–∫–∏
        const linkToRegister = document.getElementById('link-to-register');
        if (linkToRegister) {
          linkToRegister.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì± –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
            showView('register');
          });
        }
        
        const linkToLogin = document.getElementById('link-to-login');
        if (linkToLogin) {
          linkToLogin.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì± –ü–µ—Ä–µ—Ö–æ–¥ –∫–æ –≤—Ö–æ–¥—É');
            showView('login');
          });
        }
        
        const linkForgot = document.getElementById('link-forgot');
        if (linkForgot) {
          linkForgot.addEventListener('click', (e) => {
            e.preventDefault();
            console.log('üì± –ü–µ—Ä–µ—Ö–æ–¥ –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ø–∞—Ä–æ–ª—è');
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –º–µ—Ç–æ–¥–∞ —Å–±—Ä–æ—Å–∞
            showMethodSelection();
          });
        }
        
        const linkBackToLoginFromEmail = document.getElementById('link-back-to-login-from-email');
        if (linkBackToLoginFromEmail) {
          linkBackToLoginFromEmail.addEventListener('click', (e) => {
            e.preventDefault();
            showView('login');
          });
        }
        
        const linkBackToEmail = document.getElementById('link-back-to-email');
        if (linkBackToEmail) {
          linkBackToEmail.addEventListener('click', (e) => {
            e.preventDefault();
            showView('forgot-email');
          });
        }
        
        const linkBackToEmailReset = document.getElementById('link-back-to-email-reset');
        if (linkBackToEmailReset) {
          linkBackToEmailReset.addEventListener('click', (e) => {
            e.preventDefault();
            showView('forgot-email');
          });
        }
        
        const linkBackToLoginFromTelegram = document.getElementById('link-back-to-login-from-telegram');
        if (linkBackToLoginFromTelegram) {
          linkBackToLoginFromTelegram.addEventListener('click', (e) => {
            e.preventDefault();
            showView('login');
          });
        }
        
        const linkBackToTelegram = document.getElementById('link-back-to-telegram');
        if (linkBackToTelegram) {
          linkBackToTelegram.addEventListener('click', (e) => {
            e.preventDefault();
            showView('forgot-telegram');
          });
        }
        
        // –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        const btnGoogle = document.getElementById('btn-google');
        if (btnGoogle) {
          btnGoogle.addEventListener('click', (e) => {
            e.preventDefault();
            alert('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Google –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
          });
        }
        
        const btnApple = document.getElementById('btn-apple');
        if (btnApple) {
          btnApple.addEventListener('click', (e) => {
            e.preventDefault();
            alert('–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Apple –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ');
          });
        }
      }
      
      // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–¥–∞ —Å–±—Ä–æ—Å–∞
      function showMethodSelection() {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
        const choiceDialog = document.createElement('div');
        choiceDialog.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.3s ease;
          padding: 20px;
          box-sizing: border-box;
        `;
        
        choiceDialog.innerHTML = `
          <div style="
            background: var(--bg-secondary);
            border-radius: var(--radius-large);
            padding: 20px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            box-shadow: var(--shadow-card);
            animation: slideUp 0.3s ease;
            box-sizing: border-box;
          ">
            <h2 style="
              font-size: 20px;
              font-weight: 600;
              margin-bottom: 20px;
              color: var(--text-primary);
              background: linear-gradient(135deg, var(--accent-cyan), var(--accent-violet));
              -webkit-background-clip: text;
              background-clip: text;
              color: transparent;
            ">
              –í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px; font-size: 14px;">
              –ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è?
            </p>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <button id="choice-telegram" style="
                width: 100%;
                padding: 14px;
                background: linear-gradient(135deg, #0088cc, #34b7f1);
                border: none;
                border-radius: var(--radius-medium);
                color: white;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all var(--transition-fast);
                min-height: 48px;
                box-sizing: border-box;
              ">
                <span class="material-icons">telegram</span>
                –ß–µ—Ä–µ–∑ Telegram
              </button>
              <button id="choice-email" style="
                width: 100%;
                padding: 14px;
                background: var(--gradient-primary);
                border: none;
                border-radius: var(--radius-medium);
                color: white;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
                transition: all var(--transition-fast);
                min-height: 48px;
                box-sizing: border-box;
              ">
                <span class="material-icons">email</span>
                –ß–µ—Ä–µ–∑ Email
              </button>
              <button id="choice-cancel" style="
                width: 100%;
                padding: 14px;
                background: var(--bg-surface);
                border: 1px solid var(--border-default);
                border-radius: var(--radius-medium);
                color: var(--text-primary);
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                transition: all var(--transition-fast);
                min-height: 48px;
                box-sizing: border-box;
              ">
                –û—Ç–º–µ–Ω–∞
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(choiceDialog);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        const choiceTelegram = document.getElementById('choice-telegram');
        const choiceEmail = document.getElementById('choice-email');
        const choiceCancel = document.getElementById('choice-cancel');
        
        if (choiceTelegram) {
          choiceTelegram.addEventListener('click', () => {
            choiceDialog.remove();
            showView('forgot-telegram');
          });
        }
        
        if (choiceEmail) {
          choiceEmail.addEventListener('click', () => {
            choiceDialog.remove();
            showView('forgot-email');
          });
        }
        
        if (choiceCancel) {
          choiceCancel.addEventListener('click', () => {
            choiceDialog.remove();
            showView('login');
          });
        }
        
      }
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
      function setupPasswordValidation() {
        const registerConfirm = document.getElementById('register-confirm');
        const newPasswordConfirm = document.getElementById('new-password-confirm');
        
        if (registerConfirm) {
          registerConfirm.addEventListener('input', function() {
            const password = document.getElementById('register-password').value;
            const confirm = this.value;
            const error = document.getElementById('confirm-error');
            
            if (confirm && password !== confirm) {
              error.style.display = 'flex';
            } else {
              error.style.display = 'none';
            }
          });
        }
        
        if (newPasswordConfirm) {
          newPasswordConfirm.addEventListener('input', function() {
            const password = document.getElementById('new-password').value;
            const confirm = this.value;
            const error = document.getElementById('new-password-confirm-error');
            
            if (confirm && password !== confirm) {
              error.style.display = 'flex';
            } else {
              error.style.display = 'none';
            }
          });
        }
      }
      
      // –õ–æ–≥–∏–∫–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      function setupCodeInputs() {
        elements.codeInputs.forEach((input, index) => {
          if (!input) return;
          
          input.addEventListener('input', (e) => {
            const value = e.target.value;
            
            // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω –Ω–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–∏–º–≤–æ–ª
            if (value && !/^\d$/.test(value)) {
              e.target.value = '';
              return;
            }
            
            // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
            if (value.length === 1 && index < elements.codeInputs.length - 1) {
              elements.codeInputs[index + 1].focus();
            }
            
            // –ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
            if (index === elements.codeInputs.length - 1 && value.length === 1) {
              const allFilled = elements.codeInputs.every(input => input.value.length === 1);
              if (allFilled) {
                document.getElementById('forgot-code-form').dispatchEvent(new Event('submit'));
              }
            }
          });
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
              elements.codeInputs[index - 1].focus();
            }
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
            if (e.key === 'ArrowLeft' && index > 0) {
              elements.codeInputs[index - 1].focus();
              e.preventDefault();
            }
            
            if (e.key === 'ArrowRight' && index < elements.codeInputs.length - 1) {
              elements.codeInputs[index + 1].focus();
              e.preventDefault();
            }
          });
          
          // –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
            
            if (pastedData.length === 6) {
              pastedData.split('').forEach((char, i) => {
                if (elements.codeInputs[i]) {
                  elements.codeInputs[i].value = char;
                }
              });
              
              // –§–æ–∫—É—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–æ–ª–µ
              if (elements.codeInputs[5]) {
                elements.codeInputs[5].focus();
              }
              
              // –ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞
              setTimeout(() => {
                document.getElementById('forgot-code-form').dispatchEvent(new Event('submit'));
              }, 100);
            }
          });
        });
      }
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram –∫–æ–¥–æ–≤
      function setupTelegramCodeInputs() {
        elements.tgCodeInputs.forEach((input, index) => {
          if (!input) return;
          
          input.addEventListener('input', (e) => {
            const value = e.target.value;
            
            // –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –≤–≤–µ–¥–µ–Ω –Ω–µ —Ü–∏—Ñ—Ä–æ–≤–æ–π —Å–∏–º–≤–æ–ª
            if (value && !/^\d$/.test(value)) {
              e.target.value = '';
              return;
            }
            
            // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
            if (value.length === 1 && index < elements.tgCodeInputs.length - 1) {
              elements.tgCodeInputs[index + 1].focus();
            }
            
            // –ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –ø–æ–ª–µ–π
            if (index === elements.tgCodeInputs.length - 1 && value.length === 1) {
              const allFilled = elements.tgCodeInputs.every(input => input.value.length === 1);
              if (allFilled) {
                document.getElementById('forgot-telegram-code-form').dispatchEvent(new Event('submit'));
              }
            }
          });
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && e.target.value.length === 0 && index > 0) {
              elements.tgCodeInputs[index - 1].focus();
            }
            
            // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
            if (e.key === 'ArrowLeft' && index > 0) {
              elements.tgCodeInputs[index - 1].focus();
              e.preventDefault();
            }
            
            if (e.key === 'ArrowRight' && index < elements.tgCodeInputs.length - 1) {
              elements.tgCodeInputs[index + 1].focus();
              e.preventDefault();
            }
          });
          
          // –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
          input.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
            
            if (pastedData.length === 6) {
              pastedData.split('').forEach((char, i) => {
                if (elements.tgCodeInputs[i]) {
                  elements.tgCodeInputs[i].value = char;
                }
              });
              
              // –§–æ–∫—É—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–æ–ª–µ
              if (elements.tgCodeInputs[5]) {
                elements.tgCodeInputs[5].focus();
              }
              
              // –ê–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞
              setTimeout(() => {
                document.getElementById('forgot-telegram-code-form').dispatchEvent(new Event('submit'));
              }, 100);
            }
          });
        });
      }
      
      // –¢–∞–π–º–µ—Ä –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
      function startTimer() {
        clearInterval(resetTimer);
        timeLeft = 300; // 5 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        updateTimerDisplay();
        
        const timerElement = document.getElementById('timer');
        const resendBtn = document.getElementById('resend-btn');
        
        if (timerElement) {
          timerElement.style.display = 'block';
          timerElement.style.opacity = '1';
        }
        if (resendBtn) {
          resendBtn.disabled = true;
          resendBtn.style.opacity = '0.5';
        }
        
        resetTimer = setInterval(() => {
          timeLeft--;
          updateTimerDisplay();
          
          if (timeLeft <= 0) {
            clearInterval(resetTimer);
            if (timerElement) {
              // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Ç–∞–π–º–µ—Ä–∞
              timerElement.style.opacity = '0';
              setTimeout(() => {
                timerElement.style.display = 'none';
              }, 300);
            }
            if (resendBtn) {
              resendBtn.disabled = false;
              resendBtn.style.opacity = '1';
              // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
              resendBtn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                resendBtn.style.transform = 'scale(1)';
              }, 150);
            }
          }
        }, 1000);
      }
      
      function updateTimerDisplay() {
        const timeLeftElement = document.getElementById('time-left');
        if (timeLeftElement) {
          const minutes = Math.floor(timeLeft / 60);
          const seconds = timeLeft % 60;
          timeLeftElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          
          // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
          if (timeLeft < 60) {
            timeLeftElement.style.color = 'var(--border-error)';
            timeLeftElement.style.fontWeight = 'bold';
          } else if (timeLeft < 120) {
            timeLeftElement.style.color = '#FFA500';
          } else {
            timeLeftElement.style.color = 'var(--accent-cyan)';
          }
        }
      }
      
      // –¢–∞–π–º–µ—Ä –¥–ª—è Telegram
      function startTelegramTimer() {
        clearInterval(tgTimer);
        tgTimeLeft = 600; // 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        updateTelegramTimerDisplay();
        
        const timerElement = document.getElementById('tg-timer');
        const resendBtn = document.getElementById('tg-resend-btn');
        
        if (timerElement) {
          timerElement.style.display = 'block';
          timerElement.style.opacity = '1';
        }
        if (resendBtn) {
          resendBtn.disabled = true;
          resendBtn.style.opacity = '0.5';
        }
        
        tgTimer = setInterval(() => {
          tgTimeLeft--;
          updateTelegramTimerDisplay();
          
          if (tgTimeLeft <= 0) {
            clearInterval(tgTimer);
            if (timerElement) {
              timerElement.style.opacity = '0';
              setTimeout(() => {
                timerElement.style.display = 'none';
              }, 300);
            }
            if (resendBtn) {
              resendBtn.disabled = false;
              resendBtn.style.opacity = '1';
              resendBtn.style.transform = 'scale(0.95)';
              setTimeout(() => {
                resendBtn.style.transform = 'scale(1)';
              }, 150);
            }
          }
        }, 1000);
      }
      
      function updateTelegramTimerDisplay() {
        const timeLeftElement = document.getElementById('tg-time-left');
        if (timeLeftElement) {
          const minutes = Math.floor(tgTimeLeft / 60);
          const seconds = tgTimeLeft % 60;
          timeLeftElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          
          if (tgTimeLeft < 60) {
            timeLeftElement.style.color = 'var(--border-error)';
            timeLeftElement.style.fontWeight = 'bold';
          } else if (tgTimeLeft < 120) {
            timeLeftElement.style.color = '#FFA500';
          } else {
            timeLeftElement.style.color = 'var(--accent-cyan)';
          }
        }
      }
      
      // –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞
      function setupLoginForm() {
        const loginForm = document.getElementById('login-form');
        if (!loginForm) return;
        
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const identity = document.getElementById('login-identity').value.trim();
          const password = document.getElementById('login-password').value.trim();
          const error = document.getElementById('login-error');
          
          hideAllMessages();
          elements.spinner.style.display = 'block';
          
          if (!identity || !password) {
            elements.spinner.style.display = 'none';
            error.style.display = 'flex';
            return;
          }
          
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è UX
          setTimeout(() => {
            try {
              console.log('üîê –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —Å –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º:', identity);
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ UserSystem
              let user = null;
              
              if (typeof UserSystem !== 'undefined' && UserSystem.login) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem, –µ—Å–ª–∏ –æ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω
                user = UserSystem.login(identity, password);
              } else {
                // –ë–µ–∑ –¥–µ–º–æ-—Ä–µ–∂–∏–º–∞
                elements.spinner.style.display = 'none';
                document.getElementById('login-error-text').textContent = '–°–∏—Å—Ç–µ–º–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                error.style.display = 'flex';
                return;
              }
              
              if (user) {
                // –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥
                console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', user.nickname || user.email);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
                localStorage.setItem('last_login', new Date().toISOString());
                
                // –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É
                elements.spinner.style.display = 'block';
                
                setTimeout(() => {
                  window.location.href = 'map.html';
                }, 800);
              } else {
                elements.spinner.style.display = 'none';
                document.getElementById('login-error-text').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞';
                error.style.display = 'flex';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                loginForm.classList.add('shake');
                setTimeout(() => {
                  loginForm.classList.remove('shake');
                }, 500);
              }
            } catch (error) {
              console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
              elements.spinner.style.display = 'none';
              
              // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
              const errorElement = document.getElementById('login-error');
              if (errorElement) {
                document.getElementById('login-error-text').textContent = error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
                errorElement.style.display = 'flex';
              }
              
              // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
              loginForm.classList.add('shake');
              setTimeout(() => {
                loginForm.classList.remove('shake');
              }, 500);
            }
          }, 500);
        });
      }
      
      // –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
      function setupRegisterForm() {
        const registerForm = document.getElementById('register-form');
        if (!registerForm) return;
        
        registerForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const nickname = document.getElementById('register-nickname').value.trim();
          const email = document.getElementById('register-email').value.trim().toLowerCase();
          const password = document.getElementById('register-password').value;
          const confirm = document.getElementById('register-confirm').value;
          
          hideAllMessages();
          
          let hasErrors = false;
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∏–∫–Ω–µ–π–º–∞
          const nicknameError = document.getElementById('nickname-error');
          if (!nickname) {
            document.getElementById('nickname-error-text').textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º';
            nicknameError.style.display = 'flex';
            hasErrors = true;
          } else if (nickname.length < 3) {
            document.getElementById('nickname-error-text').textContent = '–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤';
            nicknameError.style.display = 'flex';
            hasErrors = true;
          } else {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –Ω–∏–∫–Ω–µ–π–º–∞
            try {
              if (typeof UserSystem !== 'undefined' && UserSystem.isNicknameUsed) {
                if (UserSystem.isNicknameUsed(nickname)) {
                  document.getElementById('nickname-error-text').textContent = '–ù–∏–∫–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç';
                  nicknameError.style.display = 'flex';
                  hasErrors = true;
                }
              } else {
                elements.spinner.style.display = 'none';
                document.getElementById('nickname-error-text').textContent = '–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                nicknameError.style.display = 'flex';
                return;
              }
            } catch (error) {
              console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∏–∫–Ω–µ–π–º–∞:', error);
              hasErrors = true;
            }
          }
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è email
          const emailError = document.getElementById('email-error');
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          
          if (!email) {
            document.getElementById('email-error-text').textContent = '–í–≤–µ–¥–∏—Ç–µ email';
            emailError.style.display = 'flex';
            hasErrors = true;
          } else if (!emailRegex.test(email)) {
            document.getElementById('email-error-text').textContent = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email';
            emailError.style.display = 'flex';
            hasErrors = true;
          } else {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ email
            try {
              if (typeof UserSystem !== 'undefined' && UserSystem.isEmailUsed) {
                if (UserSystem.isEmailUsed(email)) {
                  document.getElementById('email-error-text').textContent = 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è';
                  emailError.style.display = 'flex';
                  hasErrors = true;
                }
              } else {
                elements.spinner.style.display = 'none';
                document.getElementById('email-error-text').textContent = '–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                emailError.style.display = 'flex';
                return;
              }
            } catch (error) {
              console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ email:', error);
              hasErrors = true;
            }
          }
          
          // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
          const passwordError = document.getElementById('password-error');
          if (!password || password.length < 8) {
            passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤';
            passwordError.style.display = 'flex';
            hasErrors = true;
          } else if (!/[a-zA-Z]/.test(password)) {
            passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã';
            passwordError.style.display = 'flex';
            hasErrors = true;
          } else if (!/\d/.test(password)) {
            passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã';
            passwordError.style.display = 'flex';
            hasErrors = true;
          }
          
          // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
          if (password !== confirm) {
            document.getElementById('confirm-error').style.display = 'flex';
            hasErrors = true;
          }
          
          if (hasErrors) return;
          
          // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          elements.spinner.style.display = 'block';
          
          try {
            let avatarData = '';
            const avatarFile = document.getElementById('avatar-input').files[0];
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ base64
            const fileToBase64 = (file) => {
              return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
              });
            };
            
            if (avatarFile) {
              avatarData = await fileToBase64(avatarFile);
            }
            
            const newUser = {
              email: email,
              nickname: nickname,
              password: password,
              avatar: avatarData,
              position: [55.751244, 37.618423],
              referredBy: currentRefCode ? { code: currentRefCode } : null
            };
            
            let createdUser = null;
            
            if (typeof UserSystem !== 'undefined' && UserSystem.createUser) {
              createdUser = UserSystem.createUser(newUser);
            } else {
              throw new Error('–°–∏—Å—Ç–µ–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
            }
            
            if (createdUser) {
              // ‚≠ê –í–ê–ñ–ù–û: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
              if (currentRefCode) {
                const referralResult = processReferralRegistration(createdUser.id);
                
                if (referralResult && !referralResult.success) {
                  console.log('‚ö†Ô∏è –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω');
                  // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å–µ —Ä–∞–≤–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞
                }
              }
              
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
              if (typeof UserSystem !== 'undefined' && UserSystem.setCurrentUser) {
                UserSystem.setCurrentUser(createdUser);
              }
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
              localStorage.setItem('user_registered', 'true');
              localStorage.setItem('registration_date', new Date().toISOString());
              
              // –ï—Å–ª–∏ –±—ã–ª —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–µ–º
              if (currentRefCode) {
                localStorage.setItem('referral_used', currentRefCode);
                localStorage.setItem('referral_date', new Date().toISOString());
              }
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
              setTimeout(() => {
                window.location.href = 'map.html';
              }, 1000);
            } else {
              throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            }
            
          } catch (error) {
            elements.spinner.style.display = 'none';
            
            // –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            const errorMsg = document.createElement('div');
            errorMsg.style.cssText = `
              position: fixed;
              top: 20px;
              left: 50%;
              transform: translateX(-50%);
              background: rgba(255, 68, 68, 0.9);
              color: white;
              padding: 10px 16px;
              border-radius: 8px;
              z-index: 10000;
              font-size: 13px;
              max-width: 90%;
              text-align: center;
              word-break: break-word;
            `;
            errorMsg.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            document.body.appendChild(errorMsg);
            
            setTimeout(() => {
              if (errorMsg.parentNode) {
                errorMsg.parentNode.removeChild(errorMsg);
              }
            }, 3000);
            
            console.error('Registration error:', error);
          }
        });
      }
      
      // –§–æ—Ä–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è
      function setupForgotPasswordForms() {
        // –§–æ—Ä–º–∞ email
        const forgotEmailForm = document.getElementById('forgot-email-form');
        if (forgotEmailForm) {
          forgotEmailForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgot-email').value.trim().toLowerCase();
            const error = document.getElementById('forgot-email-error');
            const success = document.getElementById('forgot-email-success');
            
            hideAllMessages();
            
            if (!email) {
              document.getElementById('forgot-email-error-text').textContent = '–í–≤–µ–¥–∏—Ç–µ email';
              error.style.display = 'flex';
              return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let userExists = false;
            try {
              if (typeof UserSystem !== 'undefined' && UserSystem.findUser) {
                const user = UserSystem.findUser(email);
                userExists = !!user;
              } else {
                elements.spinner.style.display = 'none';
                document.getElementById('forgot-email-error-text').textContent = '–°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                error.style.display = 'flex';
                return;
              }
            } catch (error) {
              console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
              elements.spinner.style.display = 'none';
              document.getElementById('forgot-email-error-text').textContent = '–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
              error.style.display = 'flex';
              return;
            }
            
            if (!userExists) {
              document.getElementById('forgot-email-error-text').textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω';
              error.style.display = 'flex';
              return;
            }
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
              if (typeof UserSystem !== 'undefined' && UserSystem.sendPasswordResetCode) {
                const resetResult = UserSystem.sendPasswordResetCode(email);
                
                if (resetResult.success) {
                  resetEmail = email;
                  
                  elements.spinner.style.display = 'none';
                  success.style.display = 'flex';
                  
                  console.log('‚úÖ –ö–æ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞:', email);
                  
                  setTimeout(() => {
                    const userEmailElement = document.getElementById('user-email');
                    if (userEmailElement) {
                      userEmailElement.textContent = email;
                    }
                    showView('forgot-code');
                    startTimer();
                  }, 1500);
                  
                } else {
                  elements.spinner.style.display = 'none';
                  document.getElementById('forgot-email-error-text').textContent = resetResult.message;
                  error.style.display = 'flex';
                }
              } else {
                throw new Error('–°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
              
            } catch (error) {
              elements.spinner.style.display = 'none';
              document.getElementById('forgot-email-error-text').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞';
              error.style.display = 'flex';
            }
          });
        }
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞
        const resendBtn = document.getElementById('resend-btn');
        if (resendBtn) {
          resendBtn.addEventListener('click', async function() {
            if (!resetEmail) return;
            
            this.disabled = true;
            this.style.opacity = '0.5';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            const timerElement = document.getElementById('timer');
            if (timerElement) {
              timerElement.style.display = 'block';
              timerElement.style.opacity = '1';
            }
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
              if (typeof UserSystem !== 'undefined' && UserSystem.sendPasswordResetCode) {
                const resetResult = UserSystem.sendPasswordResetCode(resetEmail);
                
                if (resetResult.success) {
                  elements.spinner.style.display = 'none';
                  
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                  const notification = document.createElement('div');
                  notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #00FFFF 0%, #9400D3 100%);
                    color: white;
                    padding: 10px 16px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 13px;
                    max-width: 90%;
                    text-align: center;
                    animation: fadeIn 0.3s ease;
                  `;
                  notification.textContent = '‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!';
                  document.body.appendChild(notification);
                  
                  setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) translateY(-10px)';
                    setTimeout(() => {
                      if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                      }
                    }, 300);
                  }, 2000);
                  
                  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–Ω–æ–≤–æ
                  startTimer();
                } else {
                  elements.spinner.style.display = 'none';
                  
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                  const errorElement = document.getElementById('code-error');
                  if (errorElement) {
                    errorElement.textContent = resetResult.message;
                    errorElement.style.display = 'flex';
                  }
                }
              } else {
                throw new Error('–°–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
            } catch (error) {
              console.error('Error resending code:', error);
              elements.spinner.style.display = 'none';
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
              const errorElement = document.getElementById('code-error');
              if (errorElement) {
                errorElement.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞';
                errorElement.style.display = 'flex';
              }
            }
          });
        }
        
        // –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞
        const forgotCodeForm = document.getElementById('forgot-code-form');
        if (forgotCodeForm) {
          forgotCodeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = elements.codeInputs.map(input => input.value).join('');
            const error = document.getElementById('code-error');
            
            hideAllMessages();
            
            if (code.length !== 6) {
              if (error) error.style.display = 'flex';
              return;
            }
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞
            if (typeof UserSystem !== 'undefined' && UserSystem.verifyPasswordResetCode) {
              const verifyResult = UserSystem.verifyPasswordResetCode(resetEmail, code);
              
              if (verifyResult.success) {
                showView('new-password');
              } else {
                if (error) error.style.display = 'flex';
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                elements.codeInputs.forEach(input => {
                  input.style.borderColor = 'var(--border-error)';
                  setTimeout(() => {
                    input.style.borderColor = '';
                  }, 1000);
                });
              }
            } else {
              if (error) {
                error.textContent = '–°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                error.style.display = 'flex';
              }
            }
          });
        }
        
        // –§–æ—Ä–º–∞ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
        const newPasswordForm = document.getElementById('new-password-form');
        if (newPasswordForm) {
          newPasswordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const code = elements.codeInputs.map(input => input.value).join('');
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('new-password-confirm').value;
            
            hideAllMessages();
            
            let hasErrors = false;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
            const passwordError = document.getElementById('new-password-error');
            if (!newPassword || newPassword.length < 8) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            } else if (!/[a-zA-Z]/.test(newPassword)) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            } else if (!/\d/.test(newPassword)) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            }
            
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
            if (newPassword !== confirmPassword) {
              const confirmError = document.getElementById('new-password-confirm-error');
              if (confirmError) confirmError.style.display = 'flex';
              hasErrors = true;
            }
            
            if (hasErrors) return;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
            if (typeof UserSystem !== 'undefined' && UserSystem.resetPassword) {
              const resetResult = UserSystem.resetPassword(resetEmail, code, newPassword);
              
              if (resetResult.success) {
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                elements.codeInputs.forEach(input => input.value = '');
                document.getElementById('new-password').value = '';
                document.getElementById('new-password-confirm').value = '';
                
                elements.spinner.style.display = 'none';
                const successElement = document.getElementById('password-reset-success');
                if (successElement) successElement.style.display = 'flex';
                
                setTimeout(() => {
                  showView('login');
                  resetEmail = '';
                  clearInterval(resetTimer);
                  resetTimer = null;
                }, 2000);
              } else {
                const codeError = document.getElementById('code-error');
                if (codeError) {
                  codeError.textContent = resetResult.message;
                  codeError.style.display = 'flex';
                }
              }
            } else {
              const codeError = document.getElementById('code-error');
              if (codeError) {
                codeError.textContent = '–°–∏—Å—Ç–µ–º–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                codeError.style.display = 'flex';
              }
            }
          });
        }
      }
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
      function setupTelegramReset() {
        // –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ Telegram username
        const telegramForm = document.getElementById('forgot-telegram-form');
        if (telegramForm) {
          telegramForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const usernameInput = telegramForm.querySelector('#telegram-username-reset');
            if (!usernameInput) return;
            
            const username = usernameInput.value.trim().replace('@', '');
            const error = telegramForm.querySelector('#telegram-username-error');
            const success = telegramForm.querySelector('#telegram-username-success');
            
            hideAllMessages();
            
            if (!username) {
              const errorText = error.querySelector('#telegram-username-error-text');
              if (errorText) errorText.textContent = '–í–≤–µ–¥–∏—Ç–µ Telegram username';
              if (error) error.style.display = 'flex';
              return;
            }
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ UserSystem
              if (typeof UserSystem !== 'undefined' && UserSystem.requestPasswordResetViaTelegram) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
                const resetResult = await UserSystem.requestPasswordResetViaTelegram(username);
                
                if (resetResult.success) {
                  currentTelegramUsername = resetResult.username || username;
                  currentTelegramUserId = resetResult.userId;
                  
                  elements.spinner.style.display = 'none';
                  
                  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                  if (success) {
                    const successText = document.getElementById('telegram-success-text');
                    if (successText) {
                      successText.textContent = resetResult.message;
                    }
                    success.style.display = 'flex';
                  }
                  
                  console.log(`üì± Telegram username: @${currentTelegramUsername}`);
                  
                  // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –∫–æ–¥–∞ —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
                  setTimeout(() => {
                    const usernameDisplay = document.getElementById('telegram-username-display');
                    if (usernameDisplay) {
                      usernameDisplay.textContent = '@' + currentTelegramUsername;
                    }
                    showView('forgot-telegram-code');
                    startTelegramTimer();
                  }, 1500);
                  
                } else {
                  elements.spinner.style.display = 'none';
                  const errorText = document.querySelector('#telegram-username-error-text');
                  if (errorText) errorText.textContent = resetResult.message;
                  const errorElement = document.getElementById('telegram-username-error');
                  if (errorElement) errorElement.style.display = 'flex';
                }
              } else {
                throw new Error('Telegram —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
              
            } catch (error) {
              elements.spinner.style.display = 'none';
              const errorText = document.querySelector('#telegram-username-error-text');
              if (errorText) errorText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞';
              const errorElement = document.getElementById('telegram-username-error');
              if (errorElement) errorElement.style.display = 'flex';
              console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å–±—Ä–æ—Å–∞ —á–µ—Ä–µ–∑ Telegram:', error);
            }
          });
        }
        
        // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ Telegram –∫–æ–¥–∞
        const tgResendBtn = document.getElementById('tg-resend-btn');
        if (tgResendBtn) {
          tgResendBtn.addEventListener('click', async function() {
            if (!currentTelegramUsername) return;
            
            this.disabled = true;
            this.style.opacity = '0.5';
            
            const timerElement = document.getElementById('tg-timer');
            if (timerElement) {
              timerElement.style.display = 'block';
              timerElement.style.opacity = '1';
            }
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞
              if (typeof UserSystem !== 'undefined' && UserSystem.requestPasswordResetViaTelegram) {
                const resetResult = await UserSystem.requestPasswordResetViaTelegram(currentTelegramUsername);
                
                if (resetResult.success) {
                  elements.spinner.style.display = 'none';
                  
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                  const notification = document.createElement('div');
                  notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, #0088cc, #34b7f1);
                    color: white;
                    padding: 10px 16px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-size: 13px;
                    max-width: 90%;
                    text-align: center;
                    animation: fadeIn 0.3s ease;
                  `;
                  
                  notification.textContent = '‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!';
                  
                  document.body.appendChild(notification);
                  
                  setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(-50%) translateY(-10px)';
                    setTimeout(() => {
                      if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                      }
                    }, 300);
                  }, 2000);
                  
                  // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –∑–∞–Ω–æ–≤–æ
                  startTelegramTimer();
                } else {
                  elements.spinner.style.display = 'none';
                  
                  const errorElement = document.getElementById('tg-code-error');
                  if (errorElement) {
                    const errorText = document.getElementById('tg-error-text');
                    if (errorText) {
                      errorText.textContent = resetResult.message;
                    }
                    errorElement.style.display = 'flex';
                  }
                }
              } else {
                throw new Error('Telegram —Å–∏—Å—Ç–µ–º–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
            } catch (error) {
              console.error('Error resending Telegram code:', error);
              elements.spinner.style.display = 'none';
              
              const errorElement = document.getElementById('tg-code-error');
              if (errorElement) {
                const errorText = document.getElementById('tg-error-text');
                if (errorText) {
                  errorText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–¥–∞';
                }
                errorElement.style.display = 'flex';
              }
            }
          });
        }
        
        // –§–æ—Ä–º–∞ –≤–≤–æ–¥–∞ Telegram –∫–æ–¥–∞
        const telegramCodeForm = document.getElementById('forgot-telegram-code-form');
        if (telegramCodeForm) {
          telegramCodeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const code = elements.tgCodeInputs.map(input => input.value).join('');
            const error = document.getElementById('tg-code-error');
            
            hideAllMessages();
            
            if (code.length !== 6) {
              if (error) {
                const errorText = document.getElementById('tg-error-text');
                if (errorText) {
                  errorText.textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥';
                }
                error.style.display = 'flex';
              }
              return;
            }
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ —á–µ—Ä–µ–∑ UserSystem –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
              if (typeof UserSystem !== 'undefined' && UserSystem.verifyTelegramResetCode) {
                const verifyResult = UserSystem.verifyTelegramResetCode(currentTelegramUsername, code);
                
                if (verifyResult.success) {
                  // –ö–æ–¥ –≤–µ—Ä–Ω—ã–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è
                  showView('new-password');
                  
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è
                  localStorage.setItem('tg_reset_username', currentTelegramUsername);
                  localStorage.setItem('tg_reset_code', code);
                  localStorage.setItem('tg_reset_userId', verifyResult.userId);
                  
                } else {
                  if (error) {
                    const errorText = document.getElementById('tg-error-text');
                    if (errorText) {
                      errorText.textContent = verifyResult.message;
                    }
                    error.style.display = 'flex';
                  }
                  
                  // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                  elements.tgCodeInputs.forEach(input => {
                    input.style.borderColor = 'var(--border-error)';
                    setTimeout(() => {
                      input.style.borderColor = '';
                    }, 1000);
                  });
                }
              } else {
                throw new Error('Telegram —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
            } catch (error) {
              console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Telegram –∫–æ–¥–∞:', error);
              const errorElement = document.getElementById('tg-code-error');
              if (errorElement) {
                const errorText = document.getElementById('tg-error-text');
                if (errorText) {
                  errorText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞';
                }
                errorElement.style.display = 'flex';
              }
            } finally {
              elements.spinner.style.display = 'none';
            }
          });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è –¥–ª—è Telegram
        const newPasswordForm = document.getElementById('new-password-form');
        if (newPasswordForm) {
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–ª—è Telegram
          newPasswordForm.addEventListener('submit', async function(e) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏ –º—ã Telegram —Å–±—Ä–æ—Å
            const tgUsername = localStorage.getItem('tg_reset_username');
            const tgCode = localStorage.getItem('tg_reset_code');
            
            if (!tgUsername || !tgCode) {
              // –≠—Ç–æ –Ω–µ Telegram —Å–±—Ä–æ—Å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
              return;
            }
            
            e.preventDefault();
            
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('new-password-confirm').value;
            
            hideAllMessages();
            
            let hasErrors = false;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
            const passwordError = document.getElementById('new-password-error');
            if (!newPassword || newPassword.length < 8) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            } else if (!/[a-zA-Z]/.test(newPassword)) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –±—É–∫–≤—ã';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            } else if (!/\d/.test(newPassword)) {
              if (passwordError) {
                passwordError.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ü–∏—Ñ—Ä—ã';
                passwordError.style.display = 'flex';
              }
              hasErrors = true;
            }
            
            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
            if (newPassword !== confirmPassword) {
              const confirmError = document.getElementById('new-password-confirm-error');
              if (confirmError) confirmError.style.display = 'flex';
              hasErrors = true;
            }
            
            if (hasErrors) return;
            
            elements.spinner.style.display = 'block';
            
            try {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º UserSystem –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Telegram
              if (typeof UserSystem !== 'undefined' && UserSystem.resetPasswordWithTelegram) {
                const resetResult = UserSystem.resetPasswordWithTelegram(
                  tgUsername, 
                  tgCode, 
                  newPassword
                );
                
                if (resetResult.success) {
                  // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                  localStorage.removeItem('tg_reset_username');
                  localStorage.removeItem('tg_reset_code');
                  localStorage.removeItem('tg_reset_userId');
                  
                  elements.spinner.style.display = 'none';
                  
                  const successElement = document.getElementById('password-reset-success');
                  if (successElement) {
                    successElement.textContent = resetResult.message;
                    successElement.style.display = 'flex';
                  }
                  
                  // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                  elements.tgCodeInputs.forEach(input => input.value = '');
                  document.getElementById('new-password').value = '';
                  document.getElementById('new-password-confirm').value = '';
                  
                  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ –≤—Ö–æ–¥—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                  setTimeout(() => {
                    showView('login');
                    clearInterval(tgTimer);
                    tgTimer = null;
                    currentTelegramUsername = '';
                    currentTelegramUserId = '';
                  }, 2000);
                  
                } else {
                  elements.spinner.style.display = 'none';
                  
                  const errorElement = document.getElementById('new-password-error');
                  if (errorElement) {
                    errorElement.textContent = resetResult.message;
                    errorElement.style.display = 'flex';
                  }
                }
              } else {
                throw new Error('Telegram —Å–∏—Å—Ç–µ–º–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
              }
            } catch (error) {
              elements.spinner.style.display = 'none';
              console.error('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è —á–µ—Ä–µ–∑ Telegram:', error);
              
              const errorElement = document.getElementById('new-password-error');
              if (errorElement) {
                errorElement.textContent = '–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è';
                errorElement.style.display = 'flex';
              }
            }
          }, true);
        }
      }
      
      // PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
      function setupPWA() {
        // Service Worker - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º service worker —Å —Ç–µ–∫—É—â–µ–≥–æ –ø—É—Ç–∏
            navigator.serviceWorker.register('/service-worker.js')
              .then(registration => {
                console.log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration.scope);
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
                registration.addEventListener('updatefound', () => {
                  console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ Service Worker');
                });
              })
              .catch(error => {
                console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
              });
          });
        }
        
        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PWA
        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏
          if (elements.installBtn) {
            elements.installBtn.style.display = 'flex';
            
            elements.installBtn.addEventListener('click', async () => {
              if (!deferredPrompt) return;
              
              deferredPrompt.prompt();
              const { outcome } = await deferredPrompt.userChoice;
              
              console.log(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${outcome === 'accepted' ? '–ø—Ä–∏–Ω—è–ª' : '–æ—Ç–∫–ª–æ–Ω–∏–ª'} —É—Å—Ç–∞–Ω–æ–≤–∫—É`);
              
              deferredPrompt = null;
              elements.installBtn.style.display = 'none';
            });
          }
        });
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        window.addEventListener('appinstalled', () => {
          console.log('‚úÖ PWA —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
          if (elements.installBtn) {
            elements.installBtn.style.display = 'none';
          }
          deferredPrompt = null;
        });
      }
      
      // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤–æ–º –ø–æ–ª–µ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ñ–æ—Ä–º
      function setupAutoFocus() {
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
              const activeView = document.querySelector('.form-view.active');
              if (activeView) {
                const firstInput = activeView.querySelector('input:not([type="file"]):not([type="hidden"])');
                if (firstInput) {
                  setTimeout(() => {
                    firstInput.focus();
                  }, 100);
                }
              }
            }
          });
        });
        
        elements.views.forEach(view => {
          observer.observe(view, { attributes: true });
        });
      }
      
      // –û—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º
      function setupOfflineDetection() {
        window.addEventListener('online', () => {
          console.log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        });
        
        window.addEventListener('offline', () => {
          console.log('‚ö†Ô∏è –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ');
        });
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
      function checkCurrentUser() {
        try {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º UserSystem
          if (typeof UserSystem !== 'undefined' && UserSystem.getCurrentUser) {
            return UserSystem.getCurrentUser();
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
          const currentUserJson = localStorage.getItem('current_user');
          if (currentUserJson) {
            return JSON.parse(currentUserJson);
          }
          
          return null;
        } catch (error) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
          return null;
        }
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      function init() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ö–∞—Ä—Ç–∞ –¥—Ä—É–∑–µ–π');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥
        console.log('üì± –¢–µ–∫—É—â–∏–π –∞–∫—Ç–∏–≤–Ω—ã–π –≤–∏–¥:', document.querySelector('.form-view.active')?.id);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Bot API
        if (typeof TelegramBotAPI !== 'undefined') {
          TelegramBotAPI.init();
          console.log('ü§ñ Telegram Bot API –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–æ—Ç–æ–º
          TelegramBotAPI.testConnection().then(result => {
            if (result.ok) {
              console.log('‚úÖ Telegram Bot –¥–æ—Å—Ç—É–ø–µ–Ω:', result.result.username);
            } else {
              console.warn('‚ö†Ô∏è Telegram Bot –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω');
            }
          });
        } else {
          console.warn('‚ö†Ô∏è TelegramBotAPI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        const currentUser = checkCurrentUser();
        if (currentUser) {
          console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', currentUser.nickname || currentUser.email);
          console.log('üîó –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...');
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00FFFF 0%, #9400D3 100%);
            color: white;
            padding: 10px 16px;
            border-radius: var(--radius-medium);
            z-index: 10000;
            font-size: 13px;
            max-width: 90%;
            text-align: center;
            animation: fadeIn 0.3s ease;
            word-break: break-word;
          `;
          notification.textContent = `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, ${currentUser.nickname || currentUser.email.split('@')[0]}! –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É...`;
          document.body.appendChild(notification);
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –∫–∞—Ä—Ç—É
          setTimeout(() => {
            window.location.href = 'map.html';
          }, 2000);
          
          return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkReferralCode();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
        setupNavigation();
        setupPasswordToggle('login-password', 'toggle-login-password');
        setupPasswordToggle('register-password', 'toggle-register-password');
        setupPasswordToggle('new-password', 'toggle-new-password');
        setupAvatarUpload();
        setupPasswordValidation();
        setupCodeInputs();
        setupTelegramCodeInputs();
        setupLoginForm();
        setupRegisterForm();
        setupForgotPasswordForms();
        setupTelegramReset();
        setupPWA();
        setupAutoFocus();
        setupOfflineDetection();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞–π–º–µ—Ä–æ–≤ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.style.display = 'none';
        }
        
        const tgTimerElement = document.getElementById('tg-timer');
        if (tgTimerElement) {
          tgTimerElement.style.display = 'none';
        }
        
        const resendBtn = document.getElementById('resend-btn');
        if (resendBtn) {
          resendBtn.disabled = true;
          resendBtn.style.opacity = '0.5';
        }
        
        const tgResendBtn = document.getElementById('tg-resend-btn');
        if (tgResendBtn) {
          tgResendBtn.disabled = true;
          tgResendBtn.style.opacity = '0.5';
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
        const lastLogin = localStorage.getItem('last_login');
        if (lastLogin) {
          const lastLoginDate = new Date(lastLogin);
          const now = new Date();
          const hoursDiff = (now - lastLoginDate) / (1000 * 60 * 60);
          
          if (hoursDiff < 24) {
            console.log('üîÑ –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥ –±—ã–ª:', lastLoginDate.toLocaleString());
          }
        }
        
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        if (currentRefCode) {
          console.log('üîó –ê–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:', currentRefCode);
          console.log('üìä –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É index.html?ref=' + currentRefCode);
        }
        
        console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
      }
      
      // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
      // –≠–∫—Å–ø–æ—Ä—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
      window.App = {
        showView,
        hideAllMessages,
        startTimer,
        updateTimerDisplay,
        startTelegramTimer,
        updateTelegramTimerDisplay,
        checkReferralCode,
        processReferralRegistration,
        checkCurrentUser
      };
    })();
  </script>
</body>
</html>
